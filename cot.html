<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>COT Dashboard - Futures Only</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh; color: #e4e4e7; padding: 20px;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    header { text-align: center; margin-bottom: 30px; }
    h1 { font-size: 2rem; font-weight: 700; margin-bottom: 8px; 
         background: linear-gradient(90deg, #60a5fa, #a78bfa); 
         -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .subtitle { color: #9ca3af; font-size: 0.9rem; }
    .report-date { background: #374151; padding: 8px 16px; border-radius: 8px; 
                   display: inline-block; margin-top: 10px; font-weight: 600; color: #fbbf24; }
    
    .controls { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; }
    .btn { padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; 
           font-weight: 600; transition: all 0.2s; display: flex; align-items: center; gap: 8px; }
    .btn-primary { background: #3b82f6; color: white; }
    .btn-primary:hover { background: #2563eb; }
    .btn-primary:disabled { background: #4b5563; cursor: not-allowed; }
    .btn-secondary { background: #374151; color: #e4e4e7; border: 1px solid #4b5563; }
    .btn-secondary:hover { background: #4b5563; }
    .btn-success { background: #22c55e; color: white; }
    .btn-success:hover { background: #16a34a; }
    
    .status { text-align: center; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; }
    .status.loading { background: rgba(251, 191, 36, 0.1); color: #fbbf24; }
    .status.success { background: rgba(34, 197, 94, 0.1); color: #4ade80; }
    .status.error { background: rgba(239, 68, 68, 0.1); color: #f87171; }
    .status.hidden { display: none; }
    
    .section { margin-bottom: 30px; }
    .section-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; 
                     color: #9ca3af; border-bottom: 1px solid #374151; padding-bottom: 8px; }
    
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; }
    
    .card { background: rgba(55, 65, 81, 0.5); border-radius: 12px; padding: 16px;
            border: 1px solid #4b5563; transition: all 0.2s; }
    .card:hover { border-color: #6b7280; transform: translateY(-2px); }
    
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .pair-name { font-weight: 700; font-size: 1.1rem; }
    .sentiment { padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
    .bullish { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
    .bearish { background: rgba(239, 68, 68, 0.2); color: #f87171; }
    .neutral { background: rgba(156, 163, 175, 0.2); color: #9ca3af; }
    
    .value-box { background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; margin-top: 10px; }
    .value-label { font-size: 0.7rem; color: #9ca3af; margin-bottom: 4px; text-transform: uppercase; }
    .value-number { font-size: 1.1rem; font-weight: 700; }
    .value-number.positive { color: #4ade80; }
    .value-number.negative { color: #f87171; }
    
    .bar-container { height: 6px; background: #4b5563; border-radius: 3px; overflow: hidden; margin-top: 6px; }
    .bar { height: 100%; border-radius: 3px; transition: width 0.3s; }
    .bar.positive { background: linear-gradient(90deg, #22c55e, #4ade80); }
    .bar.negative { background: linear-gradient(90deg, #f87171, #ef4444); }
    
    .base-contracts { margin-top: 40px; padding-top: 20px; border-top: 1px solid #374151; }
    .base-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }
    .base-card { background: rgba(55, 65, 81, 0.3); padding: 12px; border-radius: 8px; text-align: center; }
    .base-id { font-weight: 700; font-size: 1rem; margin-bottom: 4px; }
    .base-value { font-size: 0.9rem; font-weight: 600; }
    .base-value.positive { color: #4ade80; }
    .base-value.negative { color: #f87171; }
    
    .footer { text-align: center; margin-top: 40px; padding-top: 20px; 
              border-top: 1px solid #374151; color: #6b7280; font-size: 0.8rem; }
    
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center; }
    .tab { padding: 8px 16px; border-radius: 8px; cursor: pointer; background: #374151; 
           border: 1px solid #4b5563; transition: all 0.2s; }
    .tab:hover { background: #4b5563; }
    .tab.active { background: #3b82f6; border-color: #3b82f6; }
    
    .hidden { display: none; }
    
    .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid #4b5563;
               border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .last-updated { font-size: 0.8rem; color: #6b7280; margin-top: 10px; }
    
    .info-box { background: rgba(59, 130, 246, 0.1); border: 1px solid #3b82f6; 
                border-radius: 8px; padding: 15px; margin-bottom: 20px; text-align: center; }
    .info-box p { color: #93c5fd; font-size: 0.85rem; }
    
    .nav-link { color: #60a5fa; text-decoration: none; margin-left: 15px; }
    .nav-link:hover { text-decoration: underline; }
    
    .backtest-controls { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; flex-wrap: wrap; }
    
    .backtest-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    .backtest-table th, .backtest-table td { padding: 8px; text-align: left; border-bottom: 1px solid #374151; }
    .backtest-table th { color: #9ca3af; font-weight: 600; }
    .backtest-table .win { color: #4ade80; }
    .backtest-table .loss { color: #f87171; }
    .backtest-table .be { color: #fbbf24; }
    .backtest-table .neutral { color: #9ca3af; }
    .backtest-table .delete-btn { background: none; border: none; color: #6b7280; cursor: pointer; font-size: 1rem; }
    .backtest-table .delete-btn:hover { color: #f87171; }
    
    .backtest-table select, .backtest-table input { 
      padding: 4px 6px; border-radius: 4px; border: 1px solid #4b5563; 
      background: #1f2937; color: #e4e4e7; font-size: 0.8rem; 
    }
    .backtest-table select { width: 70px; }
    .backtest-table input[type="number"] { width: 60px; }
    .backtest-table input[type="text"] { width: 120px; }
    
    .backtest-stats { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
    .stat-box { background: rgba(55, 65, 81, 0.5); padding: 12px 20px; border-radius: 8px; text-align: center; }
    .stat-label { font-size: 0.7rem; color: #9ca3af; text-transform: uppercase; }
    .stat-value { font-size: 1.3rem; font-weight: 700; }
    .stat-value.positive { color: #4ade80; }
    .stat-value.negative { color: #f87171; }
    
    @media (max-width: 768px) {
      .grid { grid-template-columns: 1fr; }
      h1 { font-size: 1.5rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üìä COT Weekly Bias Dashboard</h1>
      <p class="subtitle">CFTC Commitment of Traders - Non-Commercial Net Position Changes (Futures Only)</p>
      <div class="report-date" id="report-date">Loading...</div>
      <div class="last-updated" id="last-updated"></div>
    </header>
    
    <div class="info-box">
      <p>üÜì <strong>No API key required!</strong> Data fetched directly from official CFTC Public Reporting API
        <a href="journal.html" class="nav-link">üìù Open Trading Journal</a>
      </p>
    </div>
    
    <div class="controls">
      <button class="btn btn-primary" id="fetch-btn" onclick="fetchAllData()">
        <span id="fetch-btn-text">üîÑ Fetch Latest Data</span>
      </button>
      <button class="btn btn-secondary" onclick="clearCache()">üóëÔ∏è Clear Cache</button>
      <button class="btn btn-success" onclick="exportToJournal()">üì• Export for Journal</button>
    </div>
    
    <div id="status" class="status hidden"></div>
    
    <div class="tabs">
      <div class="tab active" onclick="showSection('all', this)">All</div>
      <div class="tab" onclick="showSection('currencies', this)">Majors</div>
      <div class="tab" onclick="showSection('minors', this)">Strength</div>
      <div class="tab" onclick="showSection('crosses', this)">Crosses</div>
      <div class="tab" onclick="showSection('commodities', this)">Commodities</div>
      <div class="tab" onclick="showSection('agriculture', this)">Agriculture</div>
      <div class="tab" onclick="showSection('softs', this)">Softs</div>
      <div class="tab" onclick="showSection('indices', this)">Indices</div>
      <div class="tab" onclick="showSection('bonds', this)">Bonds</div>
      <div class="tab" onclick="showSection('backtest', this)">Backtest</div>
    </div>
    
    <div id="currencies" class="section">
      <div class="section-title">üí± Major Currency Pairs (Sorted by Strength)</div>
      <div class="grid" id="currency-grid"></div>
    </div>
    
    <div id="minors" class="section">
      <div class="section-title">üí™ Currency Strength (Sorted by Strength)</div>
      <div class="grid" id="minors-grid"></div>
    </div>
    
    <div id="crosses" class="section">
      <div class="section-title">üîÑ Cross Pairs (Sorted by Strength)</div>
      <div class="grid" id="crosses-grid"></div>
    </div>
    
    <div id="commodities" class="section">
      <div class="section-title">üõ¢Ô∏è Commodities (Sorted by Strength)</div>
      <div class="grid" id="commodities-grid"></div>
    </div>
    
    <div id="agriculture" class="section">
      <div class="section-title">üåæ Agriculture (Sorted by Strength)</div>
      <div class="grid" id="agriculture-grid"></div>
    </div>
    
    <div id="softs" class="section">
      <div class="section-title">‚òï Softs (Sorted by Strength)</div>
      <div class="grid" id="softs-grid"></div>
    </div>
    
    <div id="indices" class="section">
      <div class="section-title">üìà Indices (Sorted by Strength)</div>
      <div class="grid" id="indices-grid"></div>
    </div>
    
    <div id="bonds" class="section">
      <div class="section-title">üè¶ Bonds (Sorted by Strength)</div>
      <div class="grid" id="bonds-grid"></div>
    </div>
    
    <div id="backtest" class="section">
      <div class="section-title">üìä COT Backtest Journal</div>
      
      <div class="backtest-stats" id="backtest-stats"></div>
      
      <div class="backtest-controls">
        <button class="btn btn-primary" onclick="addWeekToBacktest()">üì• Add Current Week</button>
        <button class="btn btn-secondary" onclick="clearBacktest()">üóëÔ∏è Clear All</button>
        <input type="date" id="bt-week-date" style="padding: 8px 12px; border-radius: 6px; border: 1px solid #4b5563; background: #1f2937; color: #e4e4e7;" />
      </div>
      
      <table class="backtest-table">
        <thead>
          <tr>
            <th>Week</th>
            <th>Pair</th>
            <th>Bias</th>
            <th>COT Val</th>
            <th>Zone</th>
            <th>Result</th>
            <th>R</th>
            <th>Note</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="backtest-body"></tbody>
      </table>
    </div>
    
    <div class="base-contracts">
      <div class="section-title">üìã Raw Net Position Changes - Sorted Most Bullish ‚Üí Most Bearish</div>
      <div class="base-grid" id="base-grid"></div>
    </div>
    
    <footer class="footer">
      <p>Data Source: <a href="https://publicreporting.cftc.gov" target="_blank" style="color: #60a5fa;">CFTC Public Reporting API</a> - Futures Only (6dca-aqww)</p>
      <p style="margin-top: 5px;">Net Change = Non-Commercial Long Change ‚àí Short Change | New data every Friday ~3:30 PM ET</p>
    </footer>
  </div>

  <script>
    // CFTC API Endpoint - Futures Only
    const API_FUTURES_ONLY = 'https://publicreporting.cftc.gov/resource/6dca-aqww.json';
    
    // Contract mappings - Using EXACT contract names from CFTC reports
    const CONTRACT_MAP = {
      DXY: { search: 'U.S. DOLLAR INDEX', exchange: 'ICE FUTURES U.S.', code: '098662' },
      EUR: { search: 'EURO FX', exchange: 'CHICAGO MERCANTILE EXCHANGE', code: '099741' },
      GBP: { search: 'BRITISH POUND', exchange: 'CHICAGO MERCANTILE EXCHANGE', code: '096742' },
      JPY: { search: 'JAPANESE YEN', exchange: 'CHICAGO MERCANTILE EXCHANGE', code: '097741' },
      AUD: { search: 'AUSTRALIAN DOLLAR', exchange: 'CHICAGO MERCANTILE EXCHANGE', code: '232741' },
      CAD: { search: 'CANADIAN DOLLAR', exchange: 'CHICAGO MERCANTILE EXCHANGE', code: '090741' },
      NZD: { search: 'NZ DOLLAR', exchange: 'CHICAGO MERCANTILE EXCHANGE', code: '112741' },
      CHF: { search: 'SWISS FRANC', exchange: 'CHICAGO MERCANTILE EXCHANGE', code: '092741' },
      MXN: { search: 'MEXICAN PESO', exchange: 'CHICAGO MERCANTILE EXCHANGE', code: '095741' },
      ZAR: { search: 'SO AFRICAN RAND', exchange: 'CHICAGO MERCANTILE EXCHANGE', code: '122741' },
      XAU: { search: 'GOLD', exchange: 'COMMODITY EXCHANGE INC', code: '088691' },
      XAG: { search: 'SILVER', exchange: 'COMMODITY EXCHANGE INC', code: '084691' },
      XPT: { search: 'PLATINUM', exchange: 'NEW YORK MERCANTILE EXCHANGE', code: '076651' },
      XPD: { search: 'PALLADIUM', exchange: 'NEW YORK MERCANTILE EXCHANGE', code: '075651' },
      COPPER: { search: 'COPPER', exchange: 'COMMODITY EXCHANGE', code: '085692' },
      WTI: { search: 'CRUDE OIL, LIGHT SWEET', exchange: 'NEW YORK MERCANTILE EXCHANGE', code: '067651' },
      NATGAS: { search: 'NAT GAS NYME', exchange: 'NEW YORK MERCANTILE EXCHANGE', code: '023651' },
      CORN: { search: 'CORN', exchange: 'CHICAGO BOARD OF TRADE', code: '002602' },
      WHEAT: { search: 'WHEAT-SRW', exchange: 'CHICAGO BOARD OF TRADE', code: '001602' },
      SOYBEAN: { search: 'SOYBEANS', exchange: 'CHICAGO BOARD OF TRADE', code: '005602' },
      US500: { search: 'E-MINI S&P 500', exchange: 'CHICAGO MERCANTILE EXCHANGE', code: '13874A', exactMatch: 'E-MINI S&P 500 - CHICAGO MERCANTILE EXCHANGE' },
      US100: { search: 'NASDAQ MINI', exchange: 'CHICAGO MERCANTILE EXCHANGE', code: '209742', exactMatch: 'NASDAQ MINI - CHICAGO MERCANTILE EXCHANGE' },
      US30: { search: 'DJIA', exchange: 'CHICAGO BOARD OF TRADE', code: '124603' },
      US2000: { search: 'RUSSELL E-MINI', exchange: 'CHICAGO MERCANTILE EXCHANGE', code: '239742', exactMatch: 'RUSSELL E-MINI - CHICAGO MERCANTILE EXCHANGE' },
      NIKKEI: { search: 'NIKKEI STOCK AVERAGE', exchange: 'CHICAGO MERCANTILE EXCHANGE', code: '240743' },
      US10Y: { search: 'UST 10Y NOTE', exchange: 'CHICAGO BOARD OF TRADE', code: '043602' },
      US30Y: { search: 'UST BOND', exchange: 'CHICAGO BOARD OF TRADE', code: '020601' },
      US5Y: { search: 'UST 5Y NOTE', exchange: 'CHICAGO BOARD OF TRADE', code: '044601' },
      US2Y: { search: 'UST 2Y NOTE', exchange: 'CHICAGO BOARD OF TRADE', code: '042601' },
      COTTON: { search: 'COTTON', exchange: 'ICE FUTURES U.S.', code: '033661' },
      SUGAR: { search: 'SUGAR', exchange: 'ICE FUTURES U.S.', code: '080732' },
      COFFEE: { search: 'COFFEE', exchange: 'ICE FUTURES U.S.', code: '083731' },
      COCOA: { search: 'COCOA', exchange: 'ICE FUTURES U.S.', code: '073732' },
    };

    // Data storage
    let futuresData = {
      DXY: 0, EUR: 0, GBP: 0, JPY: 0, AUD: 0, CAD: 0, NZD: 0, CHF: 0, MXN: 0, ZAR: 0,
      XAU: 0, XAG: 0, XPT: 0, XPD: 0, COPPER: 0, WTI: 0, NATGAS: 0,
      CORN: 0, WHEAT: 0, SOYBEAN: 0,
      COTTON: 0, SUGAR: 0, COFFEE: 0, COCOA: 0,
      US500: 0, US100: 0, US30: 0, US2000: 0, NIKKEI: 0,
      US10Y: 0, US30Y: 0, US5Y: 0, US2Y: 0,
    };
    
    let reportDate = '';

    const pairs = {
      currencies: [
        { pair: 'DXY', base: 'DXY', quote: null },
        { pair: 'EUR/USD', base: 'EUR', quote: 'USD' },
        { pair: 'GBP/USD', base: 'GBP', quote: 'USD' },
        { pair: 'AUD/USD', base: 'AUD', quote: 'USD' },
        { pair: 'NZD/USD', base: 'NZD', quote: 'USD' },
        { pair: 'USD/JPY', base: 'USD', quote: 'JPY' },
        { pair: 'USD/CAD', base: 'USD', quote: 'CAD' },
        { pair: 'USD/CHF', base: 'USD', quote: 'CHF' },
        { pair: 'USD/MXN', base: 'USD', quote: 'MXN' },
        { pair: 'USD/ZAR', base: 'USD', quote: 'ZAR' },
      ],
      minors: [
        { pair: 'EUR', base: 'EUR', quote: null },
        { pair: 'GBP', base: 'GBP', quote: null },
        { pair: 'AUD', base: 'AUD', quote: null },
        { pair: 'JPY', base: 'JPY', quote: null },
        { pair: 'CAD', base: 'CAD', quote: null },
        { pair: 'NZD', base: 'NZD', quote: null },
        { pair: 'CHF', base: 'CHF', quote: null },
        { pair: 'MXN', base: 'MXN', quote: null },
        { pair: 'ZAR', base: 'ZAR', quote: null },
      ],
      crosses: [
        { pair: 'EUR/GBP', base: 'EUR', quote: 'GBP' },
        { pair: 'EUR/JPY', base: 'EUR', quote: 'JPY' },
        { pair: 'EUR/AUD', base: 'EUR', quote: 'AUD' },
        { pair: 'EUR/CAD', base: 'EUR', quote: 'CAD' },
        { pair: 'EUR/NZD', base: 'EUR', quote: 'NZD' },
        { pair: 'EUR/CHF', base: 'EUR', quote: 'CHF' },
        { pair: 'GBP/JPY', base: 'GBP', quote: 'JPY' },
        { pair: 'GBP/AUD', base: 'GBP', quote: 'AUD' },
        { pair: 'GBP/CAD', base: 'GBP', quote: 'CAD' },
        { pair: 'GBP/NZD', base: 'GBP', quote: 'NZD' },
        { pair: 'GBP/CHF', base: 'GBP', quote: 'CHF' },
        { pair: 'AUD/JPY', base: 'AUD', quote: 'JPY' },
        { pair: 'AUD/CAD', base: 'AUD', quote: 'CAD' },
        { pair: 'AUD/NZD', base: 'AUD', quote: 'NZD' },
        { pair: 'AUD/CHF', base: 'AUD', quote: 'CHF' },
        { pair: 'NZD/JPY', base: 'NZD', quote: 'JPY' },
        { pair: 'NZD/CAD', base: 'NZD', quote: 'CAD' },
        { pair: 'NZD/CHF', base: 'NZD', quote: 'CHF' },
        { pair: 'CAD/JPY', base: 'CAD', quote: 'JPY' },
        { pair: 'CAD/CHF', base: 'CAD', quote: 'CHF' },
        { pair: 'CHF/JPY', base: 'CHF', quote: 'JPY' },
      ],
      commodities: [
        { pair: 'XAU/USD', base: 'XAU', quote: 'USD' },
        { pair: 'XAG/USD', base: 'XAG', quote: 'USD' },
        { pair: 'XPT', base: 'XPT', quote: null },
        { pair: 'XPD', base: 'XPD', quote: null },
        { pair: 'COPPER', base: 'COPPER', quote: null },
        { pair: 'WTI', base: 'WTI', quote: null },
        { pair: 'NATGAS', base: 'NATGAS', quote: null },
      ],
      agriculture: [
        { pair: 'CORN', base: 'CORN', quote: null },
        { pair: 'WHEAT', base: 'WHEAT', quote: null },
        { pair: 'SOYBEAN', base: 'SOYBEAN', quote: null },
      ],
      softs: [
        { pair: 'COTTON', base: 'COTTON', quote: null },
        { pair: 'SUGAR', base: 'SUGAR', quote: null },
        { pair: 'COFFEE', base: 'COFFEE', quote: null },
        { pair: 'COCOA', base: 'COCOA', quote: null },
      ],
      indices: [
        { pair: 'US500', base: 'US500', quote: null },
        { pair: 'US100', base: 'US100', quote: null },
        { pair: 'US30', base: 'US30', quote: null },
        { pair: 'US2000', base: 'US2000', quote: null },
        { pair: 'NIKKEI', base: 'NIKKEI', quote: null },
      ],
      bonds: [
        { pair: 'US10Y', base: 'US10Y', quote: null },
        { pair: 'US30Y', base: 'US30Y', quote: null },
        { pair: 'US5Y', base: 'US5Y', quote: null },
        { pair: 'US2Y', base: 'US2Y', quote: null },
      ]
    };

    function loadSavedData() {
      const saved = localStorage.getItem('cot-dashboard-v3-fixed');
      if (saved) {
        const parsed = JSON.parse(saved);
        futuresData = parsed.futuresData || futuresData;
        reportDate = parsed.reportDate || reportDate;
        if (parsed.fetchedAt) {
          document.getElementById('last-updated').textContent = 
            `Last fetched: ${new Date(parsed.fetchedAt).toLocaleString()}`;
        }
      }
      updateUI();
    }

    function showStatus(message, type) {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = `status ${type}`;
    }

    async function fetchContractData(id, config) {
      let whereClause;
      if (config.exactMatch) {
        whereClause = `market_and_exchange_names = '${config.exactMatch}'`;
      } else if (config.code) {
        whereClause = `cftc_contract_market_code = '${config.code}'`;
      } else {
        whereClause = `market_and_exchange_names like '%${config.search}%' AND market_and_exchange_names like '%${config.exchange}%'`;
      }
      
      const query = new URLSearchParams({
        '$where': whereClause,
        '$order': 'report_date_as_yyyy_mm_dd DESC',
        '$limit': '5'
      });
      
      const url = `${API_FUTURES_ONLY}?${query}`;
      console.log(`Fetching ${id}:`, url);
      
      const response = await fetch(url);
      
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      
      let data = await response.json();
      console.log(`${id} raw data:`, data);
      
      if (id === 'XAU' || id === 'XAG') {
        data = data.filter(d => !d.market_and_exchange_names.includes('MICRO'));
      }
      
      if (data.length < 2) {
        console.warn(`${id}: Not enough data points (got ${data.length})`);
        return null;
      }
      
      const latest = data[0];
      const previous = data[1];
      
      console.log(`${id} contract name:`, latest.market_and_exchange_names);
      
      const currentLong = parseInt(latest.noncomm_positions_long_all || 0);
      const currentShort = parseInt(latest.noncomm_positions_short_all || 0);
      const prevLong = parseInt(previous.noncomm_positions_long_all || 0);
      const prevShort = parseInt(previous.noncomm_positions_short_all || 0);
      
      const longChange = currentLong - prevLong;
      const shortChange = currentShort - prevShort;
      const netChange = longChange - shortChange;
      
      console.log(`${id} calculation:`, {
        currentLong, prevLong, longChange,
        currentShort, prevShort, shortChange,
        netChange
      });
      
      return {
        netChange,
        reportDate: latest.report_date_as_yyyy_mm_dd,
        contractName: latest.market_and_exchange_names
      };
    }

    async function fetchAllData() {
      const btn = document.getElementById('fetch-btn');
      const btnText = document.getElementById('fetch-btn-text');
      btn.disabled = true;
      btnText.innerHTML = '<span class="spinner"></span> Fetching...';
      showStatus('Fetching data from CFTC API (Futures Only)...', 'loading');

      let latestDate = '';
      let successCount = 0;
      let errorCount = 0;
      const errors = [];

      try {
        for (const [id, config] of Object.entries(CONTRACT_MAP)) {
          try {
            const result = await fetchContractData(id, config);
            if (result) {
              futuresData[id] = result.netChange;
              if (result.reportDate > latestDate) latestDate = result.reportDate;
              successCount++;
              console.log(`‚úÖ ${id}: ${result.netChange} (${result.contractName})`);
            }
          } catch (err) {
            console.error(`‚ùå ${id}:`, err);
            errors.push(id);
            errorCount++;
          }
          await new Promise(r => setTimeout(r, 100));
        }

        reportDate = latestDate || reportDate;
        
        localStorage.setItem('cot-dashboard-v3-fixed', JSON.stringify({
          futuresData, reportDate,
          fetchedAt: new Date().toISOString()
        }));

        document.getElementById('last-updated').textContent = 
          `Last fetched: ${new Date().toLocaleString()}`;

        updateUI();
        
        if (errorCount > 0) {
          showStatus(`Updated ${successCount} contracts. Errors: ${errors.join(', ')}`, 'success');
        } else {
          showStatus(`Successfully updated all ${successCount} contracts!`, 'success');
        }

      } catch (error) {
        console.error('Fetch error:', error);
        showStatus(`Error: ${error.message}`, 'error');
      } finally {
        btn.disabled = false;
        btnText.textContent = 'üîÑ Fetch Latest Data';
      }
    }

    function clearCache() {
      localStorage.removeItem('cot-dashboard-v3-fixed');
      location.reload();
    }
    
    // ============================================
    // EXPORT TO JOURNAL FUNCTION
    // ============================================
    function exportToJournal() {
      const backtests = [];
      const timestamp = Date.now();
      const exportDate = reportDate || new Date().toISOString().split('T')[0];
      
      const cotStrategy = {
        id: 'strat_cot_weekly',
        name: 'COT Weekly Bias',
        description: 'Trades based on CFTC Commitment of Traders weekly positioning data',
        entryRules: ['Check weekly COT net change', 'Bullish when net > 5000', 'Bearish when net < -5000'],
        exitRules: ['Exit when COT bias reverses'],
        timeframes: 'D1, W1',
        sessions: 'All',
        riskNotes: 'COT data updates weekly on Friday',
        color: '#3b82f6'
      };
      
      const allPairs = [
        ...pairs.currencies, ...pairs.crosses, ...pairs.commodities,
        ...pairs.agriculture, ...pairs.softs, ...pairs.indices, ...pairs.bonds
      ];
      
      allPairs.forEach((pairData, index) => {
        const value = calculatePairValue(pairData);
        if (Math.abs(value) > 1000) {
          const direction = value > 0 ? 'Long' : 'Short';
          const sentiment = value > 5000 ? 'Strong Bullish' : value > 0 ? 'Bullish' : value < -5000 ? 'Strong Bearish' : 'Bearish';
          backtests.push({
            id: 'bt_cot_' + timestamp + '_' + index,
            strategy: 'strat_cot_weekly',
            date: exportDate,
            pair: pairData.pair.replace('/', ''),
            direction: direction,
            result: 'Win',
            rr: Math.abs(value) > 10000 ? 2.0 : 1.5,
            notes: 'COT Bias: ' + sentiment + ' | Net Change: ' + formatNumber(value) + ' | Report: ' + exportDate
          });
        }
      });
      
      const exportData = {
        trades: [],
        accounts: [],
        strategies: [cotStrategy],
        backtests: backtests,
        exportDate: new Date().toISOString(),
        source: 'COT Dashboard',
        reportDate: reportDate
      };
      
      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'cot_journal_export_' + exportDate + '.json';
      a.click();
      
      showStatus('‚úÖ Exported ' + backtests.length + ' backtest entries! Import this file in your Trading Journal.', 'success');
    }

    function calculatePairValue(pair) {
      const baseVal = futuresData[pair.base] || 0;
      const quoteVal = pair.quote ? (futuresData[pair.quote] || 0) : 0;
      
      if (!pair.quote) return baseVal;
      if (pair.quote === 'USD') return baseVal;
      if (pair.base === 'USD') return -quoteVal;
      return baseVal - quoteVal;
    }

    function getSentimentLabel(value) {
      if (value > 5000) return { label: 'Bullish', class: 'bullish' };
      if (value < -5000) return { label: 'Bearish', class: 'bearish' };
      return { label: 'Neutral', class: 'neutral' };
    }

    function formatNumber(num) {
      return new Intl.NumberFormat('en-US', { signDisplay: 'always' }).format(num);
    }

    function createCard(pair) {
      const value = calculatePairValue(pair);
      const sentiment = getSentimentLabel(value);
      const maxVal = 50000;
      const barWidth = Math.min(Math.abs(value) / maxVal * 100, 100);
      
      return `
        <div class="card">
          <div class="card-header">
            <span class="pair-name">${pair.pair}</span>
            <span class="sentiment ${sentiment.class}">${sentiment.label}</span>
          </div>
          <div class="value-box">
            <div class="value-label">üìä Net Change</div>
            <div class="value-number ${value >= 0 ? 'positive' : 'negative'}">${formatNumber(value)}</div>
            <div class="bar-container">
              <div class="bar ${value >= 0 ? 'positive' : 'negative'}" style="width: ${barWidth}%"></div>
            </div>
          </div>
        </div>
      `;
    }

    function createBaseCard(id, value) {
      const names = {
        DXY: 'USD Index', EUR: 'Euro', GBP: 'Pound', JPY: 'Yen', AUD: 'Aussie', CAD: 'Loonie',
        NZD: 'Kiwi', CHF: 'Franc', MXN: 'Peso', ZAR: 'Rand',
        XAU: 'Gold', XAG: 'Silver', XPT: 'Platinum', XPD: 'Palladium', COPPER: 'Copper',
        WTI: 'Oil', NATGAS: 'Nat Gas',
        CORN: 'Corn', WHEAT: 'Wheat', SOYBEAN: 'Soybeans',
        COTTON: 'Cotton', SUGAR: 'Sugar', COFFEE: 'Coffee', COCOA: 'Cocoa',
        US500: 'S&P 500', US100: 'Nasdaq', US30: 'Dow', US2000: 'Russell', NIKKEI: 'Nikkei',
        US10Y: '10Y Treasury', US30Y: '30Y Treasury', US5Y: '5Y Treasury', US2Y: '2Y Treasury'
      };
      return `
        <div class="base-card">
          <div class="base-id">${id}</div>
          <div class="base-value ${value >= 0 ? 'positive' : 'negative'}">${formatNumber(value)}</div>
          <div style="font-size: 0.7rem; color: #6b7280; margin-top: 4px;">${names[id] || ''}</div>
        </div>
      `;
    }

    function sortPairsByValue(pairsArray) {
      return [...pairsArray].sort((a, b) => {
        const valA = calculatePairValue(a);
        const valB = calculatePairValue(b);
        return valB - valA;
      });
    }

    function getSortedBaseContracts() {
      return Object.entries(futuresData)
        .sort((a, b) => b[1] - a[1])
        .map(([id, value]) => ({ id, value }));
    }

    function updateUI() {
      document.getElementById('report-date').textContent = `Report Date: ${reportDate || 'Not loaded'}`;
      
      document.getElementById('currency-grid').innerHTML = 
        sortPairsByValue(pairs.currencies).map(createCard).join('');
      document.getElementById('minors-grid').innerHTML = 
        sortPairsByValue(pairs.minors).map(createCard).join('');
      document.getElementById('crosses-grid').innerHTML = 
        sortPairsByValue(pairs.crosses).map(createCard).join('');
      document.getElementById('commodities-grid').innerHTML = 
        sortPairsByValue(pairs.commodities).map(createCard).join('');
      document.getElementById('agriculture-grid').innerHTML = 
        sortPairsByValue(pairs.agriculture).map(createCard).join('');
      document.getElementById('softs-grid').innerHTML = 
        sortPairsByValue(pairs.softs).map(createCard).join('');
      document.getElementById('indices-grid').innerHTML = 
        sortPairsByValue(pairs.indices).map(createCard).join('');
      document.getElementById('bonds-grid').innerHTML = 
        sortPairsByValue(pairs.bonds).map(createCard).join('');
      
      document.getElementById('base-grid').innerHTML = 
        getSortedBaseContracts().map(({ id, value }) => createBaseCard(id, value)).join('');
    }

    function showSection(section, element) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      element.classList.add('active');
      
      const sections = ['currencies', 'minors', 'crosses', 'commodities', 'agriculture', 'softs', 'indices', 'bonds', 'backtest'];
      sections.forEach(s => {
        document.getElementById(s).classList.toggle('hidden', section !== 'all' && section !== s);
      });
    }

    // ============================================
    // BACKTEST FUNCTIONALITY
    // ============================================
    let backtestData = [];
    
    const backtestPairs = [
      'EUR/USD', 'GBP/USD', 'AUD/USD', 'NZD/USD', 'USD/JPY', 'USD/CAD', 'USD/CHF', 'USD/MXN', 'USD/ZAR',
      'XAU/USD', 'XAG/USD', 'XPT', 'XPD', 'COPPER', 'WTI', 'NATGAS',
      'CORN', 'WHEAT', 'SOYBEAN', 'COTTON', 'SUGAR', 'COFFEE', 'COCOA',
      'US500', 'US100', 'US30', 'US2000', 'NIKKEI',
      'US10Y', 'US30Y', 'US5Y', 'US2Y'
    ];
    
    function loadBacktestData() {
      const saved = localStorage.getItem('cot-backtest-data');
      if (saved) {
        backtestData = JSON.parse(saved);
      }
      renderBacktest();
    }
    
    function saveBacktestData() {
      localStorage.setItem('cot-backtest-data', JSON.stringify(backtestData));
    }
    
    function getBiasForPair(pairName) {
      const pairMap = {
        'EUR/USD': { base: 'EUR', quote: 'USD' },
        'GBP/USD': { base: 'GBP', quote: 'USD' },
        'AUD/USD': { base: 'AUD', quote: 'USD' },
        'NZD/USD': { base: 'NZD', quote: 'USD' },
        'USD/JPY': { base: 'USD', quote: 'JPY' },
        'USD/CAD': { base: 'USD', quote: 'CAD' },
        'USD/CHF': { base: 'USD', quote: 'CHF' },
        'USD/MXN': { base: 'USD', quote: 'MXN' },
        'USD/ZAR': { base: 'USD', quote: 'ZAR' },
        'XAU/USD': { base: 'XAU', quote: 'USD' },
        'XAG/USD': { base: 'XAG', quote: 'USD' },
      };
      
      const mapping = pairMap[pairName];
      let value = 0;
      
      if (mapping) {
        const baseVal = futuresData[mapping.base] || 0;
        const quoteVal = futuresData[mapping.quote] || 0;
        if (mapping.quote === 'USD') value = baseVal;
        else if (mapping.base === 'USD') value = -quoteVal;
        else value = baseVal - quoteVal;
      } else {
        value = futuresData[pairName] || 0;
      }
      
      return {
        value,
        bias: value > 5000 ? 'Bullish' : value < -5000 ? 'Bearish' : 'Neutral'
      };
    }
    
    function addWeekToBacktest() {
      const dateInput = document.getElementById('bt-week-date');
      const weekDate = dateInput.value || new Date().toISOString().split('T')[0];
      
      const existingWeek = backtestData.find(e => e.date === weekDate);
      if (existingWeek) {
        if (!confirm('This week already has entries. Add anyway?')) return;
      }
      
      backtestPairs.forEach(pair => {
        const { value, bias } = getBiasForPair(pair);
        backtestData.push({
          id: Date.now() + Math.random(),
          date: weekDate,
          pair,
          bias,
          cotValue: value,
          zone: '',
          result: '',
          r: 0,
          note: ''
        });
      });
      
      saveBacktestData();
      renderBacktest();
    }
    
    function updateBacktestEntry(id, field, value) {
      const entry = backtestData.find(e => e.id === id);
      if (entry) {
        if (field === 'r') {
          entry[field] = parseFloat(value) || 0;
        } else {
          entry[field] = value;
        }
        saveBacktestData();
        renderBacktest();
      }
    }
    
    function deleteBacktestEntry(id) {
      backtestData = backtestData.filter(e => e.id !== id);
      saveBacktestData();
      renderBacktest();
    }
    
    function clearBacktest() {
      if (confirm('Clear all backtest data?')) {
        backtestData = [];
        saveBacktestData();
        renderBacktest();
      }
    }
    
    function renderBacktest() {
      const tbody = document.getElementById('backtest-body');
      const statsDiv = document.getElementById('backtest-stats');
      
      const sorted = [...backtestData].sort((a, b) => {
        if (b.date !== a.date) return new Date(b.date) - new Date(a.date);
        return a.pair.localeCompare(b.pair);
      });
      
      tbody.innerHTML = sorted.map(e => `
        <tr>
          <td>${e.date}</td>
          <td>${e.pair}</td>
          <td class="${e.bias === 'Bullish' ? 'win' : e.bias === 'Bearish' ? 'loss' : 'neutral'}">${e.bias}</td>
          <td class="${e.cotValue >= 0 ? 'win' : 'loss'}">${e.cotValue > 0 ? '+' : ''}${e.cotValue.toLocaleString()}</td>
          <td>
            <select onchange="updateBacktestEntry(${e.id}, 'zone', this.value)">
              <option value="">-</option>
              <option value="W" ${e.zone === 'W' ? 'selected' : ''}>W</option>
              <option value="D" ${e.zone === 'D' ? 'selected' : ''}>D</option>
              <option value="4H" ${e.zone === '4H' ? 'selected' : ''}>4H</option>
              <option value="1H" ${e.zone === '1H' ? 'selected' : ''}>1H</option>
            </select>
          </td>
          <td>
            <select onchange="updateBacktestEntry(${e.id}, 'result', this.value)">
              <option value="">-</option>
              <option value="Win" ${e.result === 'Win' ? 'selected' : ''}>Win</option>
              <option value="Loss" ${e.result === 'Loss' ? 'selected' : ''}>Loss</option>
              <option value="BE" ${e.result === 'BE' ? 'selected' : ''}>BE</option>
              <option value="Skip" ${e.result === 'Skip' ? 'selected' : ''}>Skip</option>
            </select>
          </td>
          <td>
            <input type="number" step="0.1" value="${e.r || ''}" placeholder="R"
                   onchange="updateBacktestEntry(${e.id}, 'r', this.value)" />
          </td>
          <td>
            <input type="text" value="${e.note || ''}" placeholder="note"
                   onchange="updateBacktestEntry(${e.id}, 'note', this.value)" />
          </td>
          <td><button class="delete-btn" onclick="deleteBacktestEntry(${e.id})">‚úï</button></td>
        </tr>
      `).join('');
      
      const completed = backtestData.filter(e => e.result && e.result !== 'Skip');
      const wins = completed.filter(e => e.result === 'Win').length;
      const losses = completed.filter(e => e.result === 'Loss').length;
      const totalR = completed.reduce((sum, e) => sum + (e.r || 0), 0);
      const winRate = completed.length > 0 ? ((wins / (wins + losses)) * 100).toFixed(1) : 0;
      const avgR = completed.length > 0 ? (totalR / completed.length).toFixed(2) : 0;
      
      statsDiv.innerHTML = `
        <div class="stat-box">
          <div class="stat-label">Total Trades</div>
          <div class="stat-value">${completed.length}</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Win Rate</div>
          <div class="stat-value ${parseFloat(winRate) >= 50 ? 'positive' : 'negative'}">${winRate}%</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Wins / Losses</div>
          <div class="stat-value"><span class="positive">${wins}</span> / <span class="negative">${losses}</span></div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Total R</div>
          <div class="stat-value ${totalR >= 0 ? 'positive' : 'negative'}">${totalR > 0 ? '+' : ''}${totalR.toFixed(1)}R</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Avg R/Trade</div>
          <div class="stat-value ${avgR >= 0 ? 'positive' : 'negative'}">${avgR}R</div>
        </div>
      `;
    }

    // Initialize
    loadSavedData();
    loadBacktestData();
    
    document.getElementById('bt-week-date').valueAsDate = new Date();
  </script>
</body>
</html>
