<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>S&D Trading Journal Pro</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#000;--bg2:#0a0a0a;--bg3:#141414;--gold:#FFD700;--gold2:#FFA500;--green:#00C853;--red:#FF1744;--blue:#448AFF;--purple:#E040FB;--text:#fff;--text2:#888;--border:#2a2a2a}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
#loginScreen{position:fixed;top:0;left:0;width:100%;height:100%;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:9999}
#loginScreen.hidden{display:none}
.login-box{background:var(--bg3);padding:40px;border-radius:16px;border:1px solid var(--border);text-align:center;max-width:400px;width:90%}
.login-box .logo-icon{width:60px;height:60px;background:linear-gradient(135deg,var(--gold),var(--gold2));border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:2rem;margin:0 auto 20px}
.login-box h2{color:var(--gold);margin-bottom:10px}
.login-box p{color:var(--text2);margin-bottom:25px;font-size:.9rem}
.login-box input{width:100%;padding:15px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:1rem;margin-bottom:15px;text-align:center;letter-spacing:2px}
.login-box input:focus{outline:none;border-color:var(--gold)}
.login-box button{width:100%;padding:15px;background:linear-gradient(135deg,var(--gold),var(--gold2));border:none;border-radius:8px;color:#000;font-weight:600;font-size:1rem;cursor:pointer}
.login-box button:hover{transform:scale(1.02)}
.login-error{color:var(--red);font-size:.85rem;margin-top:10px;display:none}
#mainApp{display:none}
#mainApp.visible{display:block}
.container{max-width:1800px;margin:0 auto;padding:20px}
header{display:flex;justify-content:space-between;align-items:center;padding:20px 0;border-bottom:1px solid var(--border);margin-bottom:25px;flex-wrap:wrap;gap:15px}
.logo{display:flex;align-items:center;gap:12px}
.logo-icon{width:45px;height:45px;background:linear-gradient(135deg,var(--gold),var(--gold2));border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.5rem}
header h1{font-size:1.5rem;color:var(--gold)}
.header-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.daily-limit{padding:8px 15px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;font-size:.85rem}
.daily-limit.danger{border-color:var(--red);background:rgba(255,23,68,.1);animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
.btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:.9rem;transition:all .2s}
.btn-primary{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#000}
.btn-secondary{background:var(--bg3);color:var(--text);border:1px solid var(--border)}
.btn-icon{width:38px;height:38px;padding:0;display:flex;align-items:center;justify-content:center;border-radius:8px;background:var(--bg3);border:1px solid var(--border);color:var(--text2);cursor:pointer}
.tabs{display:flex;gap:5px;margin-bottom:25px;background:var(--bg2);padding:6px;border-radius:12px;border:1px solid var(--border);overflow-x:auto}
.tab{padding:12px 20px;background:transparent;border:none;color:var(--text2);cursor:pointer;border-radius:8px;font-weight:500;white-space:nowrap}
.tab.active{background:var(--gold);color:#000}
.tab:hover:not(.active){background:var(--bg3);color:var(--text)}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:25px}
.stat-card{background:var(--bg3);padding:18px;border-radius:12px;border:1px solid var(--border)}
.stat-card.highlight{border-color:var(--gold);background:linear-gradient(135deg,rgba(255,215,0,.05),rgba(255,165,0,.05))}
.stat-label{color:var(--text2);font-size:.8rem;margin-bottom:6px;text-transform:uppercase}
.stat-value{font-size:1.6rem;font-weight:700}
.stat-value.positive,.positive{color:var(--green)}
.stat-value.negative,.negative{color:var(--red)}
.stat-value.gold{color:var(--gold)}
.tab-content{display:none}.tab-content.active{display:block}
.card{background:var(--bg3);border-radius:16px;border:1px solid var(--border);overflow:hidden}
.card-header{padding:18px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}
.card-body{padding:20px}
.form-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:20px}
.form-group{display:flex;flex-direction:column;gap:8px}
.form-group.col-2{grid-column:span 2}.form-group.col-4{grid-column:span 4}
.form-group label{color:var(--text2);font-size:.85rem}
.form-group input,.form-group select,.form-group textarea{padding:12px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:.95rem}
.form-group input:focus,.form-group select:focus{outline:none;border-color:var(--gold)}
.form-group textarea{min-height:80px;resize:vertical}
.form-actions{display:flex;gap:15px;margin-top:25px;padding-top:25px;border-top:1px solid var(--border)}
.toggle-group{display:flex;gap:10px}
.toggle-btn{flex:1;padding:12px;border:2px solid var(--border);background:var(--bg2);color:var(--text2);border-radius:8px;cursor:pointer;font-weight:600;text-align:center}
.toggle-btn.long.selected{border-color:var(--green);background:rgba(0,200,83,.1);color:var(--green)}
.toggle-btn.short.selected{border-color:var(--red);background:rgba(255,23,68,.1);color:var(--red)}
.toggle-btn.demand.selected{border-color:var(--blue);background:rgba(68,138,255,.1);color:var(--blue)}
.toggle-btn.supply.selected{border-color:var(--gold2);background:rgba(255,165,0,.1);color:var(--gold2)}
.rr-display{background:var(--bg2);padding:15px;border-radius:8px;text-align:center;border:1px solid var(--border)}
.rr-value{font-size:1.8rem;font-weight:700;color:var(--gold)}
.rr-label{color:var(--text2);font-size:.8rem}
.emotion-rating{display:flex;gap:8px}
.emotion-btn{width:45px;height:45px;border-radius:10px;border:2px solid var(--border);background:var(--bg2);cursor:pointer;font-size:1.3rem}
.emotion-btn.selected{border-color:var(--gold);background:rgba(255,215,0,.1)}
.rating-btn{width:50px;height:45px;border-radius:8px;border:2px solid var(--border);background:var(--bg2);cursor:pointer;font-weight:700;color:var(--text2)}
.rating-btn.selected.a{border-color:var(--green);color:var(--green)}
.rating-btn.selected.b{border-color:var(--gold);color:var(--gold)}
.rating-btn.selected.c{border-color:var(--red);color:var(--red)}
.mistake-tags{display:flex;flex-wrap:wrap;gap:8px}
.mistake-tag{padding:8px 14px;border-radius:20px;border:1px solid var(--border);background:var(--bg2);cursor:pointer;font-size:.85rem;color:var(--text2)}
.mistake-tag.selected{border-color:var(--red);color:var(--red)}
table{width:100%;border-collapse:collapse}
th{padding:14px 12px;text-align:left;color:var(--text2);font-weight:600;font-size:.8rem;border-bottom:1px solid var(--border);background:var(--bg2)}
td{padding:14px 12px;border-bottom:1px solid var(--border)}
tr:hover{background:rgba(255,255,255,.02)}
.badge{padding:5px 10px;border-radius:6px;font-size:.8rem;font-weight:600}
.badge-long{background:rgba(0,200,83,.15);color:var(--green)}
.badge-short{background:rgba(255,23,68,.15);color:var(--red)}
.badge-demand{background:rgba(68,138,255,.15);color:var(--blue)}
.badge-supply{background:rgba(255,165,0,.15);color:var(--gold2)}
.badge-win{background:rgba(0,200,83,.15);color:var(--green)}
.badge-loss{background:rgba(255,23,68,.15);color:var(--red)}
.badge-be,.badge-open{background:rgba(136,136,136,.15);color:var(--text2)}
.action-btns{display:flex;gap:6px}
.action-btn{padding:6px 10px;border:none;border-radius:6px;cursor:pointer;font-size:.85rem}
.action-btn.view{background:rgba(255,215,0,.1);color:var(--gold)}
.action-btn.edit{background:rgba(68,138,255,.1);color:var(--blue)}
.action-btn.delete{background:rgba(255,23,68,.1);color:var(--red)}
.charts-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:20px;margin-bottom:25px}
.chart-card{background:var(--bg3);padding:20px;border-radius:16px;border:1px solid var(--border)}
.chart-card h3{margin-bottom:15px;font-size:.95rem}
.chart-container{height:250px}
.filter-bar{display:flex;gap:10px;flex-wrap:wrap}
.filter-select{padding:8px 15px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;color:var(--text)}
.account-select{padding:8px 15px;background:var(--bg2);border:1px solid var(--gold);border-radius:8px;color:var(--gold);font-weight:600;cursor:pointer;min-width:150px}
.strategies-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:20px}
.strategy-card{background:var(--bg2);border-radius:12px;border:1px solid var(--border);overflow:hidden;transition:all .2s}
.strategy-card:hover{border-color:var(--gold);transform:translateY(-2px)}
.strategy-card-header{padding:15px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.strategy-card-body{padding:15px}
.strategy-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:15px;padding-top:15px;border-top:1px solid var(--border)}
.strategy-stat{text-align:center}
.strategy-stat-value{font-size:1.1rem;font-weight:700}
.strategy-stat-label{font-size:.7rem;color:var(--text2)}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);z-index:1000;align-items:center;justify-content:center;padding:20px}
.modal.active{display:flex}
.modal-content{background:var(--bg3);border-radius:16px;max-width:800px;width:100%;max-height:90vh;overflow-y:auto;border:1px solid var(--border)}
.modal-header{display:flex;justify-content:space-between;align-items:center;padding:20px;border-bottom:1px solid var(--border)}
.modal-close{background:none;border:none;color:var(--text2);font-size:1.8rem;cursor:pointer}
.modal-body{padding:20px}
.trade-detail-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-bottom:20px}
.trade-detail-item{background:var(--bg2);padding:15px;border-radius:8px}
.trade-detail-item label{display:block;font-size:.8rem;color:var(--text2);margin-bottom:5px}
.trade-detail-item span{font-size:1.1rem;font-weight:600}
.gallery-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:15px}
.gallery-item{position:relative;border-radius:12px;overflow:hidden;cursor:pointer;border:1px solid var(--border)}
.gallery-item:hover{border-color:var(--gold)}
.gallery-item img{width:100%;height:180px;object-fit:cover}
.gallery-item-info{padding:12px;background:var(--bg2)}
.empty-state{text-align:center;padding:60px 20px;color:var(--text2)}
.empty-state-icon{font-size:4rem;margin-bottom:20px}
.toast{position:fixed;bottom:30px;right:30px;padding:15px 25px;background:var(--green);color:#000;border-radius:8px;font-weight:600;transform:translateY(100px);opacity:0;transition:all .3s;z-index:1001}
.toast.show{transform:translateY(0);opacity:1}
.toast.error{background:var(--red);color:#fff}
@media(max-width:1200px){.form-grid{grid-template-columns:repeat(2,1fr)}.charts-grid{grid-template-columns:1fr}}
@media(max-width:768px){.form-grid{grid-template-columns:1fr}.form-group.col-2,.form-group.col-4{grid-column:span 1}.stats-grid{grid-template-columns:repeat(2,1fr)}.trade-detail-grid{grid-template-columns:repeat(2,1fr)}}
</style>
</head>
<body>

<div id="loginScreen">
<div class="login-box">
<div class="logo-icon">üîê</div>
<h2>S&D Trading Journal</h2>
<p>Enter password to access your journal</p>
<input type="password" id="passwordInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeypress="if(event.key==='Enter')checkPassword()">
<button onclick="checkPassword()">üîì Unlock</button>
<div class="login-error" id="loginError">Incorrect password</div>
</div>
</div>

<div id="mainApp">
<div class="container">
<header>
<div class="logo"><div class="logo-icon">üìä</div><h1>S&D Journal Pro</h1></div>
<div class="header-actions">
<select id="accountSelect" class="account-select" onchange="switchAccount()">
<option value="all">üìä All Accounts</option>
</select>
<button class="btn-icon" onclick="openAccountManager()" title="Manage Accounts">üè¶</button>
<div class="daily-limit" id="dailyLimitDisplay">Today: <span id="todayPnL">$0</span> / <span id="dailyLimit">-$200</span></div>
<button class="btn-icon" onclick="openSettings()">‚öôÔ∏è</button>
<button class="btn btn-secondary" onclick="exportData()">üì• Export</button>
<button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">üì§ Import</button>
<input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
<button class="btn btn-primary" onclick="showTab('entry')">+ New Trade</button>
</div>
</header>

<div class="tabs">
<button class="tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
<button class="tab" onclick="showTab('entry')">‚úèÔ∏è New Trade</button>
<button class="tab" onclick="showTab('history')">üìú History</button>
<button class="tab" onclick="showTab('analytics')">üìà Analytics</button>
<button class="tab" onclick="showTab('strategies')">üìã Strategies</button>
<button class="tab" onclick="showTab('gallery')">üñºÔ∏è Screenshots</button>
</div>

<div id="dashboard" class="tab-content active">
<div class="stats-grid" id="statsGrid"></div>
<div class="charts-grid">
<div class="chart-card"><h3>üìà Equity Curve</h3><div class="chart-container"><canvas id="equityChart"></canvas></div></div>
<div class="chart-card"><h3>üéØ Win/Loss</h3><div class="chart-container"><canvas id="winLossChart"></canvas></div></div>
</div>
</div>

<div id="entry" class="tab-content">
<div class="card"><div class="card-header"><h3>‚úèÔ∏è Log Trade</h3><span id="editIndicator" style="display:none;color:var(--gold)">Editing</span></div>
<div class="card-body">
<form id="tradeForm"><input type="hidden" id="editId">
<div class="form-grid">
<div class="form-group"><label>Account</label><select id="tradeAccount"></select></div>
<div class="form-group"><label>Strategy</label><select id="tradeStrategy"><option value="">No Strategy</option></select></div>
<div class="form-group"><label>Date & Time</label><input type="datetime-local" id="tradeDate" required></div>
<div class="form-group"><label>Session</label><select id="tradeSession" required><option value="">Select...</option><option>Asian</option><option>London</option><option>New York</option><option>Overlap</option></select></div>
<div class="form-group"><label>Pair</label><select id="tradePair" required><option value="">Select...</option>
<optgroup label="Forex Majors"><option>EURUSD</option><option>GBPUSD</option><option>USDJPY</option><option>USDCHF</option><option>AUDUSD</option><option>USDCAD</option><option>NZDUSD</option></optgroup>
<optgroup label="Metals"><option>XAUUSD</option><option>XAGUSD</option></optgroup>
<optgroup label="Indices"><option>US30</option><option>US500</option><option>NAS100</option></optgroup>
</select></div>
<div class="form-group"><label>Timeframe</label><select id="tradeTimeframe" required><option value="">Select...</option><option>M1</option><option>M5</option><option>M15</option><option>M30</option><option>H1</option><option>H4</option><option>D1</option></select></div>
<div class="form-group"><label>Direction</label><div class="toggle-group"><button type="button" class="toggle-btn long" onclick="setDirection('Long')">üü¢ LONG</button><button type="button" class="toggle-btn short" onclick="setDirection('Short')">üî¥ SHORT</button></div><input type="hidden" id="tradeDirection" required></div>
<div class="form-group"><label>Zone Type</label><div class="toggle-group"><button type="button" class="toggle-btn demand" onclick="setZone('Demand')">üü¶ DEMAND</button><button type="button" class="toggle-btn supply" onclick="setZone('Supply')">üüß SUPPLY</button></div><input type="hidden" id="tradeZone" required></div>
<div class="form-group"><label>Setup</label><select id="tradeSetup" required><option value="">Select...</option><option>Fresh Zone</option><option>1st Touch</option><option>2nd Touch</option><option>Confluence</option><option>HTF Alignment</option></select></div>
<div class="form-group"><label>Entry Price</label><input type="number" id="tradeEntry" step="any" required oninput="calculateRR()"></div>
<div class="form-group"><label>Stop Loss</label><input type="number" id="tradeSL" step="any" required oninput="calculateRR()"></div>
<div class="form-group"><label>Take Profit</label><input type="number" id="tradeTP" step="any" required oninput="calculateRR()"></div>
<div class="form-group"><label>R:R Ratio</label><div class="rr-display"><div class="rr-value" id="rrDisplay">-</div><div class="rr-label">Risk : Reward</div></div></div>
<div class="form-group"><label>Position Size</label><input type="number" id="tradeSize" step="0.01" required></div>
<div class="form-group"><label>Risk ($)</label><input type="number" id="tradeRisk" step="0.01" required></div>
<div class="form-group"><label>Outcome</label><select id="tradeOutcome" required onchange="togglePnL()"><option value="Open">‚è≥ Open</option><option value="Win">‚úÖ Win</option><option value="Loss">‚ùå Loss</option><option value="BE">‚ûñ BE</option></select></div>
<div class="form-group" id="pnlGroup"><label>P&L ($)</label><input type="number" id="tradePnL" step="0.01"></div>
<div class="form-group col-2"><label>Mental State</label><div class="emotion-rating"><button type="button" class="emotion-btn" onclick="setEmotion(1)" data-v="1">üò´</button><button type="button" class="emotion-btn" onclick="setEmotion(2)" data-v="2">üòï</button><button type="button" class="emotion-btn selected" onclick="setEmotion(3)" data-v="3">üòê</button><button type="button" class="emotion-btn" onclick="setEmotion(4)" data-v="4">üôÇ</button><button type="button" class="emotion-btn" onclick="setEmotion(5)" data-v="5">üòé</button></div><input type="hidden" id="tradeEmotion" value="3"></div>
<div class="form-group col-2"><label>Rating</label><div style="display:flex;gap:8px"><button type="button" class="rating-btn a" onclick="setRating('A')">A</button><button type="button" class="rating-btn b" onclick="setRating('B')">B</button><button type="button" class="rating-btn c" onclick="setRating('C')">C</button></div><input type="hidden" id="tradeRating"></div>
<div class="form-group col-4"><label>Mistakes</label><div class="mistake-tags" id="mistakeTags"><button type="button" class="mistake-tag" data-v="FOMO">FOMO</button><button type="button" class="mistake-tag" data-v="Revenge">Revenge</button><button type="button" class="mistake-tag" data-v="Moved SL">Moved SL</button><button type="button" class="mistake-tag" data-v="Early Exit">Early Exit</button></div><input type="hidden" id="tradeMistakes"></div>
<div class="form-group col-2"><label>Screenshot</label><input type="file" id="tradeScreenshot" accept="image/*" onchange="previewImg()"><img id="imgPreview" style="max-width:100%;max-height:150px;border-radius:8px;margin-top:10px;display:none"></div>
<div class="form-group col-2"><label>Notes</label><textarea id="tradeNotes" placeholder="Notes..."></textarea></div>
</div>
<div class="form-actions"><button type="submit" class="btn btn-primary">üíæ Save Trade</button><button type="button" class="btn btn-secondary" onclick="resetForm()">üîÑ Reset</button></div>
</form></div></div>
</div>

<div id="history" class="tab-content">
<div class="card"><div class="card-header"><h3>üìú Trade History</h3>
<div class="filter-bar">
<select class="filter-select" id="filterOutcome" onchange="filterTrades()"><option value="">All</option><option value="Win">Wins</option><option value="Loss">Losses</option><option value="Open">Open</option></select>
<select class="filter-select" id="filterPair" onchange="filterTrades()"><option value="">All Pairs</option></select>
</div>
</div>
<div style="overflow-x:auto"><table><thead><tr><th>#</th><th>Account</th><th>Date</th><th>Pair</th><th>Dir</th><th>Zone</th><th>R:R</th><th>Result</th><th>P&L</th><th>Actions</th></tr></thead><tbody id="tradesTable"></tbody></table></div></div>
</div>

<div id="analytics" class="tab-content">
<div class="stats-grid" style="margin-bottom:25px">
<div class="stat-card"><div class="stat-label">üî• Current Streak</div><div class="stat-value" id="currentStreak">-</div></div>
<div class="stat-card"><div class="stat-label">üèÜ Best Streak</div><div class="stat-value positive" id="bestStreak">-</div></div>
<div class="stat-card"><div class="stat-label">üìâ Worst Streak</div><div class="stat-value negative" id="worstStreak">-</div></div>
</div>
<div class="charts-grid">
<div class="chart-card"><h3>üí± By Pair</h3><div class="chart-container"><canvas id="pairChart"></canvas></div></div>
<div class="chart-card"><h3>‚è∞ By Session</h3><div class="chart-container"><canvas id="sessionChart"></canvas></div></div>
</div>
</div>

<div id="strategies" class="tab-content">
<div class="card" style="margin-bottom:20px">
<div class="card-header"><h3>üìã My Strategies</h3><button class="btn btn-primary" onclick="openStrategyEditor()">+ New Strategy</button></div>
<div class="card-body"><div id="strategiesList" class="strategies-grid"></div></div>
</div>
<div class="card">
<div class="card-header"><h3>üß™ Strategy Backtester</h3><button class="btn btn-primary" onclick="openBacktestModal()">+ Add Backtest</button></div>
<div class="card-body">
<p style="color:var(--text2);margin-bottom:15px;font-size:.9rem">Log backtested trades to track strategy win rates. Import from COT Dashboard!</p>
<div id="backtestStats" class="stats-grid" style="margin-bottom:20px"></div>
<div style="overflow-x:auto"><table><thead><tr><th>Strategy</th><th>Date</th><th>Pair</th><th>Direction</th><th>Result</th><th>R:R</th><th>Notes</th><th>Actions</th></tr></thead><tbody id="backtestTable"></tbody></table></div>
</div>
</div>
</div>

<div id="gallery" class="tab-content">
<div class="card"><div class="card-header"><h3>üñºÔ∏è Screenshots</h3><select class="filter-select" id="galleryFilter" onchange="updateGallery()"><option value="">All</option><option value="Win">Wins</option><option value="Loss">Losses</option></select></div>
<div class="card-body"><div class="gallery-grid" id="galleryGrid"></div></div></div>
</div>

</div><!-- container -->
</div><!-- mainApp -->

<div class="modal" id="tradeModal"><div class="modal-content"><div class="modal-header"><h3>Trade Details</h3><button class="modal-close" onclick="closeModal('tradeModal')">√ó</button></div><div class="modal-body" id="tradeModalBody"></div></div></div>
<div class="modal" id="settingsModal"><div class="modal-content" style="max-width:550px"><div class="modal-header"><h3>‚öôÔ∏è Settings</h3><button class="modal-close" onclick="closeModal('settingsModal')">√ó</button></div><div class="modal-body">
<div class="setting-item" style="display:flex;justify-content:space-between;padding:15px;background:var(--bg2);border-radius:8px;margin-bottom:10px"><label>Daily Loss Limit ($)</label><input type="number" id="setLimit" value="200" onchange="saveSettings()" style="padding:8px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;color:var(--text);width:120px"></div>
<div class="setting-item" style="display:flex;justify-content:space-between;padding:15px;background:var(--bg2);border-radius:8px;margin-bottom:10px"><label>Default Risk ($)</label><input type="number" id="setRisk" value="50" onchange="saveSettings()" style="padding:8px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;color:var(--text);width:120px"></div>
<div style="margin-top:20px;padding-top:20px;border-top:1px solid var(--border)"><button class="btn" style="background:var(--red);color:#fff" onclick="clearAll()">üóëÔ∏è Delete All Data</button></div>
</div></div></div>
<div class="modal" id="accountModal"><div class="modal-content" style="max-width:600px"><div class="modal-header"><h3>üè¶ Manage Accounts</h3><button class="modal-close" onclick="closeModal('accountModal')">√ó</button></div><div class="modal-body">
<div style="margin-bottom:20px"><div style="display:flex;gap:10px"><input type="text" id="newAccountName" placeholder="Account name" style="flex:1;padding:12px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"><input type="text" id="newAccountColor" placeholder="#FFD700" value="#FFD700" style="width:100px;padding:12px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"><button class="btn btn-primary" onclick="addAccount()">+ Add</button></div></div>
<div id="accountsList"></div>
</div></div></div>
<div class="modal" id="strategyModal"><div class="modal-content" style="max-width:700px"><div class="modal-header"><h3 id="strategyModalTitle">üìã New Strategy</h3><button class="modal-close" onclick="closeModal('strategyModal')">√ó</button></div><div class="modal-body">
<input type="hidden" id="editStrategyId">
<div class="form-group" style="margin-bottom:15px"><label>Strategy Name</label><input type="text" id="strategyName" placeholder="e.g. Fresh Zone Reversal" style="width:100%;padding:12px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"></div>
<div class="form-group" style="margin-bottom:15px"><label>Description</label><textarea id="strategyDesc" placeholder="Description..." style="width:100%;padding:12px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);min-height:60px"></textarea></div>
<div class="form-group" style="margin-bottom:15px"><label>Entry Rules</label><textarea id="strategyEntryRules" placeholder="1. Rule one&#10;2. Rule two" style="width:100%;padding:12px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);min-height:100px"></textarea></div>
<div class="form-group" style="margin-bottom:15px"><label>Exit Rules</label><textarea id="strategyExitRules" placeholder="1. TP at...&#10;2. SL at..." style="width:100%;padding:12px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);min-height:80px"></textarea></div>
<div class="form-group" style="margin-bottom:20px"><label>Color</label><input type="color" id="strategyColor" value="#FFD700" style="width:60px;height:40px;border:none;border-radius:8px;cursor:pointer"></div>
<div style="display:flex;gap:10px"><button class="btn btn-primary" onclick="saveStrategy()">üíæ Save</button><button class="btn btn-secondary" onclick="closeModal('strategyModal')">Cancel</button></div>
</div></div></div>
<div class="modal" id="backtestModal"><div class="modal-content" style="max-width:600px"><div class="modal-header"><h3>üß™ Add Backtest</h3><button class="modal-close" onclick="closeModal('backtestModal')">√ó</button></div><div class="modal-body">
<input type="hidden" id="editBacktestId">
<div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
<div class="form-group"><label>Strategy</label><select id="backtestStrategy" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"></select></div>
<div class="form-group"><label>Date</label><input type="date" id="backtestDate" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"></div>
<div class="form-group"><label>Pair</label><input type="text" id="backtestPair" placeholder="EURUSD" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"></div>
<div class="form-group"><label>Direction</label><select id="backtestDirection" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"><option>Long</option><option>Short</option></select></div>
<div class="form-group"><label>Result</label><select id="backtestResult" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"><option>Win</option><option>Loss</option><option>BE</option></select></div>
<div class="form-group"><label>R:R</label><input type="number" id="backtestRR" step="0.1" placeholder="2.0" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"></div>
</div>
<div class="form-group" style="margin-top:15px"><label>Notes</label><textarea id="backtestNotes" placeholder="Notes..." style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);min-height:60px"></textarea></div>
<div style="display:flex;gap:10px;margin-top:20px"><button class="btn btn-primary" onclick="saveBacktest()">üíæ Save</button><button class="btn btn-secondary" onclick="closeModal('backtestModal')">Cancel</button></div>
</div></div></div>

<div class="toast" id="toast"></div>

<script>
let trades=JSON.parse(localStorage.getItem('sdPro'))||[];
let accounts=JSON.parse(localStorage.getItem('sdAccounts'))||[{id:'default',name:'Main Account',color:'#FFD700'}];
let strategies=JSON.parse(localStorage.getItem('sdStrategies'))||[];
let backtests=JSON.parse(localStorage.getItem('sdBacktests'))||[];
let currentAccount='all';
let settings=JSON.parse(localStorage.getItem('sdSettings'))||{limit:200,risk:50};
let charts={};

document.addEventListener('DOMContentLoaded',function(){loadSettings();setDefaultDate();updateAccountSelectors();updateStrategySelectors();updateAll()});

function updateAccountSelectors(){
var sel=document.getElementById('accountSelect');
var formSel=document.getElementById('tradeAccount');
sel.innerHTML='<option value="all">üìä All Accounts</option>'+accounts.map(function(a){return '<option value="'+a.id+'">'+a.name+'</option>'}).join('');
sel.value=currentAccount;
if(formSel)formSel.innerHTML=accounts.map(function(a){return '<option value="'+a.id+'">'+a.name+'</option>'}).join('')}

function switchAccount(){currentAccount=document.getElementById('accountSelect').value;updateAll()}
function getFilteredTrades(){if(currentAccount==='all')return trades;return trades.filter(function(t){return t.account===currentAccount||(currentAccount==='default'&&!t.account)})}
function openAccountManager(){
var html=accounts.map(function(a){return '<div style="display:flex;align-items:center;gap:10px;padding:15px;background:var(--bg2);border-radius:8px;margin-bottom:10px;border-left:4px solid '+a.color+'"><span style="flex:1;font-weight:600">'+a.name+'</span><span style="color:var(--text2)">'+trades.filter(function(t){return t.account===a.id}).length+' trades</span>'+(a.id!=='default'?'<button class="btn-icon" onclick="deleteAccount(\''+a.id+'\')" style="color:var(--red)">üóëÔ∏è</button>':'')+'</div>'}).join('');
document.getElementById('accountsList').innerHTML=html;openModal('accountModal')}
function addAccount(){
var name=document.getElementById('newAccountName').value.trim();
var color=document.getElementById('newAccountColor').value||'#FFD700';
if(!name){showToast('Enter name','error');return}
accounts.push({id:'acc_'+Date.now(),name:name,color:color});
localStorage.setItem('sdAccounts',JSON.stringify(accounts));
document.getElementById('newAccountName').value='';
updateAccountSelectors();openAccountManager();showToast('Added!')}
function deleteAccount(id){
if(!confirm('Delete account?'))return;
trades.forEach(function(t){if(t.account===id)t.account='default'});
accounts=accounts.filter(function(a){return a.id!==id});
localStorage.setItem('sdAccounts',JSON.stringify(accounts));
saveTrades();updateAccountSelectors();openAccountManager();showToast('Deleted')}

function updateStrategySelectors(){
var formSel=document.getElementById('tradeStrategy');
if(formSel)formSel.innerHTML='<option value="">No Strategy</option>'+strategies.map(function(s){return '<option value="'+s.id+'">'+s.name+'</option>'}).join('')}
function openStrategyEditor(id){
document.getElementById('editStrategyId').value='';
document.getElementById('strategyName').value='';
document.getElementById('strategyDesc').value='';
document.getElementById('strategyEntryRules').value='';
document.getElementById('strategyExitRules').value='';
document.getElementById('strategyColor').value='#FFD700';
document.getElementById('strategyModalTitle').textContent='üìã New Strategy';
if(id){var s=strategies.find(function(x){return x.id===id});if(s){
document.getElementById('editStrategyId').value=id;
document.getElementById('strategyName').value=s.name;
document.getElementById('strategyDesc').value=s.description||'';
document.getElementById('strategyEntryRules').value=(s.entryRules||[]).join('\n');
document.getElementById('strategyExitRules').value=(s.exitRules||[]).join('\n');
document.getElementById('strategyColor').value=s.color||'#FFD700';
document.getElementById('strategyModalTitle').textContent='üìã Edit Strategy'}}
openModal('strategyModal')}
function saveStrategy(){
var name=document.getElementById('strategyName').value.trim();
if(!name){showToast('Enter name','error');return}
var id=document.getElementById('editStrategyId').value||'strat_'+Date.now();
var strategy={id:id,name:name,description:document.getElementById('strategyDesc').value,entryRules:document.getElementById('strategyEntryRules').value.split('\n').filter(Boolean),exitRules:document.getElementById('strategyExitRules').value.split('\n').filter(Boolean),color:document.getElementById('strategyColor').value};
var idx=strategies.findIndex(function(s){return s.id===id});
if(idx!==-1)strategies[idx]=strategy;else strategies.push(strategy);
localStorage.setItem('sdStrategies',JSON.stringify(strategies));
updateStrategySelectors();updateStrategies();closeModal('strategyModal');showToast('Saved!')}
function deleteStrategy(id){
if(!confirm('Delete?'))return;
strategies=strategies.filter(function(s){return s.id!==id});
localStorage.setItem('sdStrategies',JSON.stringify(strategies));
updateStrategySelectors();updateStrategies();showToast('Deleted')}
function updateStrategies(){
var list=document.getElementById('strategiesList');
if(!list)return;
if(!strategies.length){list.innerHTML='<div class="empty-state" style="grid-column:1/-1"><div class="empty-state-icon">üìã</div><h3>No strategies</h3></div>';return}
list.innerHTML=strategies.map(function(s){
var st=trades.filter(function(t){return t.strategy===s.id&&t.outcome!=='Open'});
var wins=st.filter(function(t){return t.outcome==='Win'}).length;
var wr=st.length?(wins/st.length*100):0;
var pnl=st.reduce(function(sum,t){return sum+(t.pnl||0)},0);
return '<div class="strategy-card" style="border-left:4px solid '+s.color+'"><div class="strategy-card-header"><h4>'+s.name+'</h4><div class="action-btns"><button class="action-btn edit" onclick="openStrategyEditor(\''+s.id+'\')">‚úèÔ∏è</button><button class="action-btn delete" onclick="deleteStrategy(\''+s.id+'\')">üóëÔ∏è</button></div></div><div class="strategy-card-body"><div class="strategy-stats"><div class="strategy-stat"><div class="strategy-stat-value">'+st.length+'</div><div class="strategy-stat-label">Trades</div></div><div class="strategy-stat"><div class="strategy-stat-value '+(wr>=50?'positive':'negative')+'">'+wr.toFixed(0)+'%</div><div class="strategy-stat-label">Win Rate</div></div><div class="strategy-stat"><div class="strategy-stat-value '+(pnl>=0?'positive':'negative')+'">$'+pnl.toFixed(0)+'</div><div class="strategy-stat-label">P&L</div></div></div></div></div>'}).join('')}

function openBacktestModal(id){
document.getElementById('editBacktestId').value='';
document.getElementById('backtestDate').value=new Date().toISOString().split('T')[0];
document.getElementById('backtestPair').value='';
document.getElementById('backtestDirection').value='Long';
document.getElementById('backtestResult').value='Win';
document.getElementById('backtestRR').value='';
document.getElementById('backtestNotes').value='';
var stratSel=document.getElementById('backtestStrategy');
stratSel.innerHTML='<option value="">Select...</option>'+strategies.map(function(s){return '<option value="'+s.id+'">'+s.name+'</option>'}).join('');
if(id){var bt=backtests.find(function(b){return b.id===id});if(bt){
document.getElementById('editBacktestId').value=id;
stratSel.value=bt.strategy||'';
document.getElementById('backtestDate').value=bt.date||'';
document.getElementById('backtestPair').value=bt.pair||'';
document.getElementById('backtestDirection').value=bt.direction||'Long';
document.getElementById('backtestResult').value=bt.result||'Win';
document.getElementById('backtestRR').value=bt.rr||'';
document.getElementById('backtestNotes').value=bt.notes||''}}
openModal('backtestModal')}
function saveBacktest(){
var pair=document.getElementById('backtestPair').value.trim().toUpperCase();
if(!pair){showToast('Enter pair','error');return}
var id=document.getElementById('editBacktestId').value||'bt_'+Date.now();
var bt={id:id,strategy:document.getElementById('backtestStrategy').value,date:document.getElementById('backtestDate').value,pair:pair,direction:document.getElementById('backtestDirection').value,result:document.getElementById('backtestResult').value,rr:parseFloat(document.getElementById('backtestRR').value)||0,notes:document.getElementById('backtestNotes').value};
var idx=backtests.findIndex(function(b){return b.id===id});
if(idx!==-1)backtests[idx]=bt;else backtests.unshift(bt);
localStorage.setItem('sdBacktests',JSON.stringify(backtests));
updateBacktests();closeModal('backtestModal');showToast('Saved!')}
function deleteBacktest(id){
if(!confirm('Delete?'))return;
backtests=backtests.filter(function(b){return b.id!==id});
localStorage.setItem('sdBacktests',JSON.stringify(backtests));
updateBacktests();showToast('Deleted')}
function updateBacktests(){
var table=document.getElementById('backtestTable');
var stats=document.getElementById('backtestStats');
if(!table)return;
if(!backtests.length){table.innerHTML='<tr><td colspan="8" style="text-align:center;color:var(--text2);padding:30px">No backtests. Add manually or import from COT!</td></tr>';stats.innerHTML='';return}
var wins=backtests.filter(function(b){return b.result==='Win'}).length;
var wr=backtests.length?(wins/backtests.length*100):0;
var avgRR=backtests.filter(function(b){return b.rr>0}).reduce(function(s,b,_,a){return s+b.rr/a.length},0);
stats.innerHTML='<div class="stat-card"><div class="stat-label">Total Backtests</div><div class="stat-value gold">'+backtests.length+'</div></div><div class="stat-card"><div class="stat-label">Win Rate</div><div class="stat-value '+(wr>=50?'positive':'negative')+'">'+wr.toFixed(1)+'%</div></div><div class="stat-card"><div class="stat-label">Wins/Losses</div><div class="stat-value"><span class="positive">'+wins+'</span>/<span class="negative">'+(backtests.length-wins)+'</span></div></div><div class="stat-card"><div class="stat-label">Avg R:R</div><div class="stat-value gold">'+avgRR.toFixed(2)+'</div></div>';
table.innerHTML=backtests.map(function(b){
var strat=strategies.find(function(s){return s.id===b.strategy});
return '<tr><td>'+(strat?'<span style="color:'+strat.color+'">'+strat.name+'</span>':'-')+'</td><td>'+b.date+'</td><td><strong>'+b.pair+'</strong></td><td><span class="badge badge-'+b.direction.toLowerCase()+'">'+b.direction+'</span></td><td><span class="badge badge-'+b.result.toLowerCase()+'">'+b.result+'</span></td><td>'+(b.rr?'1:'+b.rr.toFixed(1):'-')+'</td><td style="max-width:150px;overflow:hidden;text-overflow:ellipsis">'+(b.notes||'-')+'</td><td><div class="action-btns"><button class="action-btn edit" onclick="openBacktestModal(\''+b.id+'\')">‚úèÔ∏è</button><button class="action-btn delete" onclick="deleteBacktest(\''+b.id+'\')">üóëÔ∏è</button></div></td></tr>'}).join('')}

function updateAll(){updateDashboard();updateHistory();updateAnalytics();updateGallery();updateStrategies();updateBacktests();updateDailyLimit()}
function showTab(id){document.querySelectorAll('.tab-content').forEach(function(t){t.classList.remove('active')});document.querySelectorAll('.tab').forEach(function(t){t.classList.remove('active')});document.getElementById(id).classList.add('active');var btn=document.querySelector('.tab[onclick="showTab(\''+id+'\')"]');if(btn)btn.classList.add('active')}
function setDefaultDate(){var n=new Date();n.setMinutes(n.getMinutes()-n.getTimezoneOffset());document.getElementById('tradeDate').value=n.toISOString().slice(0,16);document.getElementById('tradeRisk').value=settings.risk}
function setDirection(d){document.getElementById('tradeDirection').value=d;document.querySelectorAll('.toggle-btn.long,.toggle-btn.short').forEach(function(b){b.classList.remove('selected')});document.querySelector('.toggle-btn.'+d.toLowerCase()).classList.add('selected');calculateRR()}
function setZone(z){document.getElementById('tradeZone').value=z;document.querySelectorAll('.toggle-btn.demand,.toggle-btn.supply').forEach(function(b){b.classList.remove('selected')});document.querySelector('.toggle-btn.'+z.toLowerCase()).classList.add('selected')}
function setEmotion(v){document.getElementById('tradeEmotion').value=v;document.querySelectorAll('.emotion-btn').forEach(function(b){b.classList.remove('selected')});document.querySelector('.emotion-btn[data-v="'+v+'"]').classList.add('selected')}
function setRating(v){document.getElementById('tradeRating').value=v;document.querySelectorAll('.rating-btn').forEach(function(b){b.classList.remove('selected')});document.querySelector('.rating-btn.'+v.toLowerCase()).classList.add('selected')}
document.querySelectorAll('.mistake-tag').forEach(function(t){t.addEventListener('click',function(){t.classList.toggle('selected');document.getElementById('tradeMistakes').value=Array.from(document.querySelectorAll('.mistake-tag.selected')).map(function(x){return x.dataset.v}).join(',')})});
function calculateRR(){var e=parseFloat(document.getElementById('tradeEntry').value),s=parseFloat(document.getElementById('tradeSL').value),t=parseFloat(document.getElementById('tradeTP').value),d=document.getElementById('tradeDirection').value;if(e&&s&&t&&d){var r=d==='Long'?(t-e)/(e-s):(e-t)/(s-e);var disp=document.getElementById('rrDisplay');if(r>0&&isFinite(r)){disp.textContent='1:'+r.toFixed(2);disp.style.color=r>=2?'var(--green)':'var(--gold)'}else{disp.textContent='Invalid';disp.style.color='var(--red)'}}}
function togglePnL(){document.getElementById('pnlGroup').style.display=document.getElementById('tradeOutcome').value==='Open'?'none':'block'}
function previewImg(){var f=document.getElementById('tradeScreenshot').files[0];if(!f)return;var reader=new FileReader();reader.onload=function(e){var preview=document.getElementById('imgPreview');preview.src=e.target.result;preview.style.display='block';preview.dataset.local='true'};reader.readAsDataURL(f)}
function saveTrades(){localStorage.setItem('sdPro',JSON.stringify(trades))}

document.getElementById('tradeForm').addEventListener('submit',function(e){e.preventDefault();
var dir=document.getElementById('tradeDirection').value;
var zone=document.getElementById('tradeZone').value;
if(!dir){showToast('Select Direction','error');return}
if(!zone){showToast('Select Zone','error');return}
var editId=document.getElementById('editId').value;
var entry=parseFloat(document.getElementById('tradeEntry').value),sl=parseFloat(document.getElementById('tradeSL').value),tp=parseFloat(document.getElementById('tradeTP').value);
var rr=dir==='Long'?(tp-entry)/(entry-sl):(entry-tp)/(sl-entry);
var trade={id:editId||Date.now().toString(),account:document.getElementById('tradeAccount').value||'default',strategy:document.getElementById('tradeStrategy').value||'',date:document.getElementById('tradeDate').value,session:document.getElementById('tradeSession').value,pair:document.getElementById('tradePair').value,direction:dir,zone:zone,timeframe:document.getElementById('tradeTimeframe').value,setup:document.getElementById('tradeSetup').value,entry:entry,sl:sl,tp:tp,size:parseFloat(document.getElementById('tradeSize').value),risk:parseFloat(document.getElementById('tradeRisk').value),rr:rr,outcome:document.getElementById('tradeOutcome').value,pnl:parseFloat(document.getElementById('tradePnL').value)||0,emotion:parseInt(document.getElementById('tradeEmotion').value)||3,rating:document.getElementById('tradeRating').value,mistakes:document.getElementById('tradeMistakes').value,notes:document.getElementById('tradeNotes').value,screenshot:''};
var preview=document.getElementById('imgPreview');
trade.screenshot=preview.src||'';
if(editId){var i=trades.findIndex(function(t){return t.id===editId});if(i!==-1)trades[i]=trade}else trades.unshift(trade);
saveTrades();resetForm();updateAll();showTab('history');showToast(editId?'Updated!':'Saved!')});

function resetForm(){document.getElementById('tradeForm').reset();document.getElementById('editId').value='';document.getElementById('editIndicator').style.display='none';var preview=document.getElementById('imgPreview');preview.style.display='none';preview.src='';preview.dataset.local='';document.querySelectorAll('.toggle-btn,.emotion-btn,.rating-btn,.mistake-tag').forEach(function(b){b.classList.remove('selected')});document.querySelector('.emotion-btn[data-v="3"]').classList.add('selected');document.getElementById('rrDisplay').textContent='-';setDefaultDate()}

function updateDashboard(){
var closed=getFilteredTrades().filter(function(t){return t.outcome!=='Open'});
var wins=closed.filter(function(t){return t.outcome==='Win'});
var losses=closed.filter(function(t){return t.outcome==='Loss'});
var totalPnL=closed.reduce(function(s,t){return s+(t.pnl||0)},0);
var winRate=closed.length?(wins.length/closed.length*100):0;
var avgWin=wins.length?wins.reduce(function(s,t){return s+t.pnl},0)/wins.length:0;
var avgLoss=losses.length?Math.abs(losses.reduce(function(s,t){return s+t.pnl},0)/losses.length):0;
var pf=avgLoss?(avgWin*wins.length)/(avgLoss*losses.length):0;
document.getElementById('statsGrid').innerHTML='<div class="stat-card highlight"><div class="stat-label">Total P&L</div><div class="stat-value '+(totalPnL>=0?'positive':'negative')+'">$'+totalPnL.toFixed(2)+'</div></div><div class="stat-card"><div class="stat-label">Win Rate</div><div class="stat-value '+(winRate>=50?'positive':'negative')+'">'+winRate.toFixed(1)+'%</div></div><div class="stat-card"><div class="stat-label">Profit Factor</div><div class="stat-value '+(pf>=1.5?'positive':'negative')+'">'+pf.toFixed(2)+'</div></div><div class="stat-card"><div class="stat-label">Avg Win</div><div class="stat-value positive">$'+avgWin.toFixed(2)+'</div></div><div class="stat-card"><div class="stat-label">Avg Loss</div><div class="stat-value negative">-$'+avgLoss.toFixed(2)+'</div></div><div class="stat-card"><div class="stat-label">Total Trades</div><div class="stat-value">'+closed.length+'</div></div>';
updateEquityChart();updateWinLossChart()}
function getTodayPnL(){var today=new Date().toISOString().split('T')[0];return getFilteredTrades().filter(function(t){return t.date&&t.date.startsWith(today)&&t.outcome!=='Open'}).reduce(function(s,t){return s+(t.pnl||0)},0)}
function updateDailyLimit(){var pnl=getTodayPnL();document.getElementById('todayPnL').textContent='$'+pnl.toFixed(0);document.getElementById('dailyLimit').textContent='-$'+settings.limit;var d=document.getElementById('dailyLimitDisplay');d.classList.remove('danger');if(pnl<=-settings.limit)d.classList.add('danger')}
function updateEquityChart(){var ctx=document.getElementById('equityChart');if(!ctx)return;var closed=trades.filter(function(t){return t.outcome!=='Open'}).reverse();var running=0;var data=closed.map(function(t){running+=t.pnl||0;return running});if(charts.equity)charts.equity.destroy();charts.equity=new Chart(ctx,{type:'line',data:{labels:data.map(function(_,i){return i+1}),datasets:[{data:data,borderColor:'#FFD700',backgroundColor:'rgba(255,215,0,.1)',fill:true,tension:.4,pointRadius:2}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{grid:{color:'#2a2a2a'},ticks:{color:'#888'}},y:{grid:{color:'#2a2a2a'},ticks:{color:'#888'}}}}})}
function updateWinLossChart(){var ctx=document.getElementById('winLossChart');if(!ctx)return;var closed=trades.filter(function(t){return t.outcome!=='Open'});var w=closed.filter(function(t){return t.outcome==='Win'}).length;var l=closed.filter(function(t){return t.outcome==='Loss'}).length;var b=closed.filter(function(t){return t.outcome==='BE'}).length;if(charts.winLoss)charts.winLoss.destroy();charts.winLoss=new Chart(ctx,{type:'doughnut',data:{labels:['Wins','Losses','BE'],datasets:[{data:[w,l,b],backgroundColor:['#00C853','#FF1744','#555'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{color:'#888'}}}}})}

function updateHistory(){filterTrades();var pairs=[];trades.forEach(function(t){if(t.pair&&pairs.indexOf(t.pair)===-1)pairs.push(t.pair)});pairs.sort();document.getElementById('filterPair').innerHTML='<option value="">All Pairs</option>'+pairs.map(function(p){return '<option>'+p+'</option>'}).join('')}
function filterTrades(){var out=document.getElementById('filterOutcome').value,pair=document.getElementById('filterPair').value;var f=getFilteredTrades().slice();if(out)f=f.filter(function(t){return t.outcome===out});if(pair)f=f.filter(function(t){return t.pair===pair});var tb=document.getElementById('tradesTable');if(!f.length){tb.innerHTML='<tr><td colspan="10"><div class="empty-state"><div class="empty-state-icon">üì≠</div><h3>No trades</h3></div></td></tr>';return}tb.innerHTML=f.map(function(t,i){var acc=accounts.find(function(a){return a.id===t.account})||accounts[0];return '<tr><td>'+(f.length-i)+'</td><td><span style="color:'+acc.color+'">'+acc.name+'</span></td><td>'+(t.date?new Date(t.date).toLocaleDateString():'-')+'</td><td><strong>'+t.pair+'</strong></td><td><span class="badge badge-'+(t.direction||'').toLowerCase()+'">'+(t.direction||'-')+'</span></td><td><span class="badge badge-'+(t.zone||'').toLowerCase()+'">'+(t.zone||'-')+'</span></td><td>1:'+(t.rr||0).toFixed(2)+'</td><td><span class="badge badge-'+(t.outcome||'').toLowerCase()+'">'+(t.outcome||'-')+'</span></td><td class="'+((t.pnl||0)>=0?'positive':'negative')+'">$'+(t.pnl||0).toFixed(2)+'</td><td><div class="action-btns"><button class="action-btn view" onclick="viewTrade(\''+t.id+'\')">üëÅÔ∏è</button><button class="action-btn edit" onclick="editTrade(\''+t.id+'\')">‚úèÔ∏è</button><button class="action-btn delete" onclick="deleteTrade(\''+t.id+'\')">üóëÔ∏è</button></div></td></tr>'}).join('')}

function viewTrade(id){var t=trades.find(function(x){return x.id===id});if(!t)return;var acc=accounts.find(function(a){return a.id===t.account})||accounts[0];document.getElementById('tradeModalBody').innerHTML='<div class="trade-detail-grid"><div class="trade-detail-item"><label>Account</label><span style="color:'+acc.color+'">'+acc.name+'</span></div><div class="trade-detail-item"><label>Date</label><span>'+(t.date?new Date(t.date).toLocaleString():'-')+'</span></div><div class="trade-detail-item"><label>Pair</label><span>'+t.pair+'</span></div><div class="trade-detail-item"><label>Direction</label><span class="badge badge-'+(t.direction||'').toLowerCase()+'">'+t.direction+'</span></div><div class="trade-detail-item"><label>Zone</label><span class="badge badge-'+(t.zone||'').toLowerCase()+'">'+t.zone+'</span></div><div class="trade-detail-item"><label>R:R</label><span style="color:var(--gold)">1:'+(t.rr||0).toFixed(2)+'</span></div><div class="trade-detail-item"><label>Outcome</label><span class="badge badge-'+(t.outcome||'').toLowerCase()+'">'+t.outcome+'</span></div><div class="trade-detail-item"><label>P&L</label><span class="'+((t.pnl||0)>=0?'positive':'negative')+'">$'+(t.pnl||0).toFixed(2)+'</span></div><div class="trade-detail-item"><label>Rating</label><span>'+(t.rating||'-')+'</span></div></div>'+(t.notes?'<div style="margin-top:15px"><strong>Notes:</strong><p style="background:var(--bg2);padding:10px;border-radius:6px;margin-top:5px">'+t.notes+'</p></div>':'')+(t.screenshot?'<img src="'+t.screenshot+'" style="width:100%;border-radius:8px;margin-top:15px">':'');openModal('tradeModal')}
function editTrade(id){var t=trades.find(function(x){return x.id===id});if(!t)return;document.getElementById('editId').value=id;document.getElementById('editIndicator').style.display='inline';document.getElementById('tradeAccount').value=t.account||'default';document.getElementById('tradeStrategy').value=t.strategy||'';document.getElementById('tradeDate').value=t.date||'';document.getElementById('tradeSession').value=t.session||'';document.getElementById('tradePair').value=t.pair||'';if(t.direction)setDirection(t.direction);if(t.zone)setZone(t.zone);document.getElementById('tradeTimeframe').value=t.timeframe||'';document.getElementById('tradeSetup').value=t.setup||'';document.getElementById('tradeEntry').value=t.entry;document.getElementById('tradeSL').value=t.sl;document.getElementById('tradeTP').value=t.tp;document.getElementById('tradeSize').value=t.size;document.getElementById('tradeRisk').value=t.risk;document.getElementById('tradeOutcome').value=t.outcome;document.getElementById('tradePnL').value=t.pnl;setEmotion(t.emotion||3);if(t.rating)setRating(t.rating);document.getElementById('tradeNotes').value=t.notes||'';var preview=document.getElementById('imgPreview');preview.dataset.local='';if(t.screenshot){preview.src=t.screenshot;preview.style.display='block'}else{preview.src='';preview.style.display='none'}calculateRR();togglePnL();showTab('entry')}
function deleteTrade(id){if(confirm('Delete?')){trades=trades.filter(function(t){return t.id!==id});saveTrades();updateAll();showToast('Deleted','error')}}

function updateAnalytics(){var closed=getFilteredTrades().filter(function(t){return t.outcome!=='Open'});
var sortedTrades=closed.slice().sort(function(a,b){return new Date(a.date)-new Date(b.date)});
var currentStreak=0,bestWinStreak=0,worstLossStreak=0,tempStreak=0,lastOutcome='';
sortedTrades.forEach(function(t){if(t.outcome==='Win'){if(lastOutcome==='Win'||lastOutcome==='')tempStreak++;else tempStreak=1;if(tempStreak>bestWinStreak)bestWinStreak=tempStreak}else if(t.outcome==='Loss'){if(lastOutcome==='Loss'||lastOutcome==='')tempStreak--;else tempStreak=-1;if(tempStreak<worstLossStreak)worstLossStreak=tempStreak}else{tempStreak=0}lastOutcome=t.outcome;currentStreak=tempStreak});
document.getElementById('currentStreak').textContent=(currentStreak>0?'+':'')+currentStreak+'W';
document.getElementById('currentStreak').className='stat-value '+(currentStreak>0?'positive':currentStreak<0?'negative':'');
document.getElementById('bestStreak').textContent='+'+bestWinStreak+'W';
document.getElementById('worstStreak').textContent=worstLossStreak+'L';
var pairs=[];closed.forEach(function(t){if(pairs.indexOf(t.pair)===-1)pairs.push(t.pair)});var pairData=pairs.map(function(p){return closed.filter(function(t){return t.pair===p}).reduce(function(s,t){return s+(t.pnl||0)},0)});createBar('pairChart','pair',pairs,pairData);
var sessions=['Asian','London','New York','Overlap'];var sessData=sessions.map(function(s){var st=closed.filter(function(t){return t.session===s});return st.length?(st.filter(function(t){return t.outcome==='Win'}).length/st.length*100):0});createBar('sessionChart','session',sessions,sessData,'#FFD700')}
function createBar(canvasId,key,labels,data,color){var ctx=document.getElementById(canvasId);if(!ctx)return;if(charts[key])charts[key].destroy();charts[key]=new Chart(ctx,{type:'bar',data:{labels:labels,datasets:[{data:data,backgroundColor:color||data.map(function(d){return d>=0?'#00C853':'#FF1744'})}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{grid:{color:'#2a2a2a'},ticks:{color:'#888'}},y:{grid:{color:'#2a2a2a'},ticks:{color:'#888'}}}}})}

function updateGallery(){var f=document.getElementById('galleryFilter').value;var filtered=getFilteredTrades().filter(function(t){return t.screenshot&&t.screenshot.length>10});if(f)filtered=filtered.filter(function(t){return t.outcome===f});var grid=document.getElementById('galleryGrid');if(!filtered.length){grid.innerHTML='<div class="empty-state" style="grid-column:1/-1"><div class="empty-state-icon">üì∑</div><h3>No screenshots</h3></div>';return}grid.innerHTML=filtered.map(function(t){return '<div class="gallery-item" onclick="viewTrade(\''+t.id+'\')"><img src="'+t.screenshot+'"><div class="gallery-item-info"><h4>'+t.pair+' - '+t.direction+'</h4><p>'+new Date(t.date).toLocaleDateString()+' | $'+(t.pnl||0).toFixed(2)+'</p></div></div>'}).join('')}

function openSettings(){document.getElementById('setLimit').value=settings.limit;document.getElementById('setRisk').value=settings.risk;openModal('settingsModal')}
function saveSettings(){settings.limit=parseFloat(document.getElementById('setLimit').value)||200;settings.risk=parseFloat(document.getElementById('setRisk').value)||50;localStorage.setItem('sdSettings',JSON.stringify(settings));updateDailyLimit();showToast('Saved!')}
function loadSettings(){var s=localStorage.getItem('sdSettings');if(s)settings=JSON.parse(s)}
function clearAll(){if(confirm('Delete ALL?')&&confirm('Sure?')){trades=[];saveTrades();updateAll();closeModal('settingsModal');showToast('Cleared','error')}}

function openModal(id){document.getElementById(id).classList.add('active')}
function closeModal(id){document.getElementById(id).classList.remove('active')}
document.querySelectorAll('.modal').forEach(function(m){m.addEventListener('click',function(e){if(e.target===m)m.classList.remove('active')})});

function exportData(){
var data={trades:trades,accounts:accounts,strategies:strategies,backtests:backtests,settings:settings,exportDate:new Date().toISOString()};
var blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
var a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='sd_journal_'+new Date().toISOString().split('T')[0]+'.json';a.click();showToast('Exported!')}

// ============================================
// UPDATED IMPORT - NOW ACCEPTS COT BACKTESTS!
// ============================================
function importData(event){
var file=event.target.files[0];
if(!file)return;
var reader=new FileReader();
reader.onload=function(e){
try{
var data=JSON.parse(e.target.result);
// Accept files with trades OR backtests (for COT import)
if(!data.trades&&!data.backtests){showToast('Invalid file - no trades or backtests found','error');return}
var newTradesCount=0,newBacktestsCount=0,newStratsCount=0;
// Build confirmation message
var confirmMsg='Import ';
if(data.trades&&data.trades.length)confirmMsg+=data.trades.length+' trades';
if(data.backtests&&data.backtests.length){
if(data.trades&&data.trades.length)confirmMsg+=' + ';
confirmMsg+=data.backtests.length+' backtests'}
if(data.source)confirmMsg+=' from '+data.source;
confirmMsg+='?\n\nThis will MERGE with existing data.';
if(!confirm(confirmMsg)){return}
// Import strategies first (needed for backtest references)
if(data.strategies&&data.strategies.length){
var existingStratIds=strategies.map(function(s){return s.id});
data.strategies.forEach(function(s){
if(existingStratIds.indexOf(s.id)===-1){
strategies.push(s);
newStratsCount++}});
localStorage.setItem('sdStrategies',JSON.stringify(strategies))}
// Import trades
if(data.trades&&data.trades.length){
var existingIds=trades.map(function(t){return t.id});
var newTrades=data.trades.filter(function(t){return existingIds.indexOf(t.id)===-1});
trades=trades.concat(newTrades);
newTradesCount=newTrades.length;
saveTrades()}
// Import backtests (for COT data)
if(data.backtests&&data.backtests.length){
var existingBtIds=backtests.map(function(b){return b.id});
var newBacktests=data.backtests.filter(function(b){return existingBtIds.indexOf(b.id)===-1});
backtests=backtests.concat(newBacktests);
newBacktestsCount=newBacktests.length;
localStorage.setItem('sdBacktests',JSON.stringify(backtests))}
// Import accounts
if(data.accounts&&data.accounts.length){
var existingAccIds=accounts.map(function(a){return a.id});
data.accounts.forEach(function(a){if(existingAccIds.indexOf(a.id)===-1)accounts.push(a)});
localStorage.setItem('sdAccounts',JSON.stringify(accounts))}
updateAccountSelectors();
updateStrategySelectors();
updateAll();
// Build success message
var successMsg='Imported: ';
var parts=[];
if(newTradesCount)parts.push(newTradesCount+' trades');
if(newBacktestsCount)parts.push(newBacktestsCount+' backtests');
if(newStratsCount)parts.push(newStratsCount+' strategies');
successMsg+=parts.length?parts.join(', '):'No new items (all duplicates)';
showToast(successMsg);
}catch(err){console.error(err);showToast('Error: '+err.message,'error')}
};
reader.readAsText(file);
event.target.value=''}

function showToast(msg,type){var t=document.getElementById('toast');t.textContent=msg;t.className='toast show '+(type||'');setTimeout(function(){t.classList.remove('show')},3000)}

var APP_PASSWORD='Swingelite1313-';
function checkPassword(){var input=document.getElementById('passwordInput').value;if(input===APP_PASSWORD){document.getElementById('loginScreen').classList.add('hidden');document.getElementById('mainApp').classList.add('visible');sessionStorage.setItem('journalAuth','true')}else{document.getElementById('loginError').style.display='block';document.getElementById('passwordInput').value='';setTimeout(function(){document.getElementById('loginError').style.display='none'},2000)}}
if(sessionStorage.getItem('journalAuth')==='true'){document.getElementById('loginScreen').classList.add('hidden');document.getElementById('mainApp').classList.add('visible')}
</script>
</body>
</html>
