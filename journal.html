<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>S&D Trading Journal Pro</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#000;--bg2:#0a0a0a;--bg3:#141414;--gold:#FFD700;--gold2:#FFA500;--green:#00C853;--red:#FF1744;--blue:#448AFF;--purple:#E040FB;--text:#fff;--text2:#888;--border:#2a2a2a}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}

/* Password Screen */
#loginScreen{position:fixed;top:0;left:0;width:100%;height:100%;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:9999}
#loginScreen.hidden{display:none}
.login-box{background:var(--bg3);padding:40px;border-radius:16px;border:1px solid var(--border);text-align:center;max-width:400px;width:90%}
.login-box .logo-icon{width:60px;height:60px;background:linear-gradient(135deg,var(--gold),var(--gold2));border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:2rem;margin:0 auto 20px}
.login-box h2{color:var(--gold);margin-bottom:10px}
.login-box p{color:var(--text2);margin-bottom:25px;font-size:.9rem}
.login-box input{width:100%;padding:15px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:1rem;margin-bottom:15px;text-align:center;letter-spacing:2px}
.login-box input:focus{outline:none;border-color:var(--gold)}
.login-box button{width:100%;padding:15px;background:linear-gradient(135deg,var(--gold),var(--gold2));border:none;border-radius:8px;color:#000;font-weight:600;font-size:1rem;cursor:pointer}
.login-box button:hover{transform:scale(1.02)}
.login-error{color:var(--red);font-size:.85rem;margin-top:10px;display:none}
#mainApp{display:none}
#mainApp.visible{display:block}

.container{max-width:1800px;margin:0 auto;padding:20px}
header{display:flex;justify-content:space-between;align-items:center;padding:20px 0;border-bottom:1px solid var(--border);margin-bottom:25px;flex-wrap:wrap;gap:15px}
.logo{display:flex;align-items:center;gap:12px}
.logo-icon{width:45px;height:45px;background:linear-gradient(135deg,var(--gold),var(--gold2));border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.5rem}
header h1{font-size:1.5rem;color:var(--gold)}
.header-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.daily-limit{padding:8px 15px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;font-size:.85rem}
.daily-limit.danger{border-color:var(--red);background:rgba(255,23,68,.1);animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
.btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:.9rem;transition:all .2s}
.btn-primary{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#000}
.btn-secondary{background:var(--bg3);color:var(--text);border:1px solid var(--border)}
.btn-icon{width:38px;height:38px;padding:0;display:flex;align-items:center;justify-content:center;border-radius:8px;background:var(--bg3);border:1px solid var(--border);color:var(--text2);cursor:pointer}
.tabs{display:flex;gap:5px;margin-bottom:25px;background:var(--bg2);padding:6px;border-radius:12px;border:1px solid var(--border);overflow-x:auto}
.tab{padding:12px 20px;background:transparent;border:none;color:var(--text2);cursor:pointer;border-radius:8px;font-weight:500;white-space:nowrap}
.tab.active{background:var(--gold);color:#000}
.tab:hover:not(.active){background:var(--bg3);color:var(--text)}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:25px}
.stat-card{background:var(--bg3);padding:18px;border-radius:12px;border:1px solid var(--border)}
.stat-card.highlight{border-color:var(--gold);background:linear-gradient(135deg,rgba(255,215,0,.05),rgba(255,165,0,.05))}
.stat-label{color:var(--text2);font-size:.8rem;margin-bottom:6px;text-transform:uppercase}
.stat-value{font-size:1.6rem;font-weight:700}
.stat-value.positive,.positive{color:var(--green)}
.stat-value.negative,.negative{color:var(--red)}
.stat-value.gold{color:var(--gold)}
.tab-content{display:none}.tab-content.active{display:block}
.card{background:var(--bg3);border-radius:16px;border:1px solid var(--border);overflow:hidden}
.card-header{padding:18px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}
.card-body{padding:20px}
.form-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:20px}
.form-group{display:flex;flex-direction:column;gap:8px}
.form-group.col-2{grid-column:span 2}.form-group.col-4{grid-column:span 4}
.form-group label{color:var(--text2);font-size:.85rem}
.form-group input,.form-group select,.form-group textarea{padding:12px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:.95rem}
.form-group input:focus,.form-group select:focus{outline:none;border-color:var(--gold)}
.form-group textarea{min-height:80px;resize:vertical}
.form-actions{display:flex;gap:15px;margin-top:25px;padding-top:25px;border-top:1px solid var(--border)}
.toggle-group{display:flex;gap:10px}
.toggle-btn{flex:1;padding:12px;border:2px solid var(--border);background:var(--bg2);color:var(--text2);border-radius:8px;cursor:pointer;font-weight:600;text-align:center}
.toggle-btn.long.selected{border-color:var(--green);background:rgba(0,200,83,.1);color:var(--green)}
.toggle-btn.short.selected{border-color:var(--red);background:rgba(255,23,68,.1);color:var(--red)}
.toggle-btn.demand.selected{border-color:var(--blue);background:rgba(68,138,255,.1);color:var(--blue)}
.toggle-btn.supply.selected{border-color:var(--gold2);background:rgba(255,165,0,.1);color:var(--gold2)}
.rr-display{background:var(--bg2);padding:15px;border-radius:8px;text-align:center;border:1px solid var(--border)}
.rr-value{font-size:1.8rem;font-weight:700;color:var(--gold)}
.rr-label{color:var(--text2);font-size:.8rem}
.emotion-rating{display:flex;gap:8px}
.emotion-btn{width:45px;height:45px;border-radius:10px;border:2px solid var(--border);background:var(--bg2);cursor:pointer;font-size:1.3rem}
.emotion-btn.selected{border-color:var(--gold);background:rgba(255,215,0,.1)}
.rating-btn{width:50px;height:45px;border-radius:8px;border:2px solid var(--border);background:var(--bg2);cursor:pointer;font-weight:700;color:var(--text2)}
.rating-btn.selected.a{border-color:var(--green);color:var(--green)}
.rating-btn.selected.b{border-color:var(--gold);color:var(--gold)}
.rating-btn.selected.c{border-color:var(--red);color:var(--red)}
.mistake-tags{display:flex;flex-wrap:wrap;gap:8px}
.mistake-tag{padding:8px 14px;border-radius:20px;border:1px solid var(--border);background:var(--bg2);cursor:pointer;font-size:.85rem;color:var(--text2)}
.mistake-tag.selected{border-color:var(--red);color:var(--red)}
table{width:100%;border-collapse:collapse}
th{padding:14px 12px;text-align:left;color:var(--text2);font-weight:600;font-size:.8rem;border-bottom:1px solid var(--border);background:var(--bg2)}
td{padding:14px 12px;border-bottom:1px solid var(--border)}
tr:hover{background:rgba(255,255,255,.02)}
.badge{padding:5px 10px;border-radius:6px;font-size:.8rem;font-weight:600}
.badge-long{background:rgba(0,200,83,.15);color:var(--green)}
.badge-short{background:rgba(255,23,68,.15);color:var(--red)}
.badge-demand{background:rgba(68,138,255,.15);color:var(--blue)}
.badge-supply{background:rgba(255,165,0,.15);color:var(--gold2)}
.badge-win{background:rgba(0,200,83,.15);color:var(--green)}
.badge-loss{background:rgba(255,23,68,.15);color:var(--red)}
.badge-be,.badge-open{background:rgba(136,136,136,.15);color:var(--text2)}
.action-btns{display:flex;gap:6px}
.action-btn{padding:6px 10px;border:none;border-radius:6px;cursor:pointer;font-size:.85rem}
.action-btn.view{background:rgba(255,215,0,.1);color:var(--gold)}
.action-btn.edit{background:rgba(68,138,255,.1);color:var(--blue)}
.action-btn.delete{background:rgba(255,23,68,.1);color:var(--red)}
.charts-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:20px;margin-bottom:25px}
.chart-card{background:var(--bg3);padding:20px;border-radius:16px;border:1px solid var(--border)}
.chart-card h3{margin-bottom:15px;font-size:.95rem}
.chart-container{height:250px}
.calendar-container{background:var(--bg3);border-radius:16px;border:1px solid var(--border);overflow:hidden}
.calendar-header{display:flex;justify-content:space-between;align-items:center;padding:20px}
.calendar-nav{display:flex;gap:10px;align-items:center}
.calendar-nav h3{min-width:200px;text-align:center}
.calendar-grid{display:grid;grid-template-columns:repeat(7,1fr)}
.calendar-day-header{padding:15px;text-align:center;font-weight:600;color:var(--text2);border-bottom:1px solid var(--border);background:var(--bg2)}
.calendar-day{min-height:100px;padding:10px;border-right:1px solid var(--border);border-bottom:1px solid var(--border);cursor:pointer;position:relative}
.calendar-day:nth-child(7n){border-right:none}
.calendar-day:hover{background:var(--bg2)}
.calendar-day.other-month{opacity:.5}
.calendar-day.today .day-number{background:var(--gold);color:#000;border-radius:50%;width:28px;height:28px;display:flex;align-items:center;justify-content:center}
.day-number{font-weight:600;margin-bottom:8px}
.day-trade{font-size:.75rem;padding:4px 8px;border-radius:4px;margin-bottom:4px}
.day-trade.win{background:rgba(0,200,83,.2);color:var(--green)}
.day-trade.loss{background:rgba(255,23,68,.2);color:var(--red)}
.day-pnl{position:absolute;bottom:5px;right:8px;font-size:.8rem;font-weight:600}
.calendar-summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;padding:20px;background:var(--bg2)}
.weekly-summary{background:linear-gradient(135deg,rgba(255,215,0,.05),rgba(255,165,0,.05));border:1px solid var(--gold);border-radius:16px;padding:25px;margin-bottom:25px}
.weekly-summary h3{color:var(--gold);margin-bottom:20px}
.weekly-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:20px}
.streak-badge{padding:4px 10px;border-radius:20px;font-size:.8rem;font-weight:600}
.streak-badge.win-streak{background:rgba(0,200,83,.15);color:var(--green)}
.streak-badge.loss-streak{background:rgba(255,23,68,.15);color:var(--red)}
.breakdown-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px}
.breakdown-card{background:var(--bg3);padding:20px;border-radius:16px;border:1px solid var(--border)}
.breakdown-card h3{margin-bottom:15px}
.breakdown-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border)}
.breakdown-row:last-child{border-bottom:none}
.breakdown-label{color:var(--text2)}
.breakdown-value{font-weight:600}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);z-index:1000;align-items:center;justify-content:center;padding:20px}
.modal.active{display:flex}
.modal-content{background:var(--bg3);border-radius:16px;max-width:800px;width:100%;max-height:90vh;overflow-y:auto;border:1px solid var(--border)}
.modal-header{display:flex;justify-content:space-between;align-items:center;padding:20px;border-bottom:1px solid var(--border)}
.modal-close{background:none;border:none;color:var(--text2);font-size:1.8rem;cursor:pointer}
.modal-body{padding:20px}
.trade-detail-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-bottom:20px}
.trade-detail-item{background:var(--bg2);padding:15px;border-radius:8px}
.trade-detail-item label{display:block;font-size:.8rem;color:var(--text2);margin-bottom:5px}
.trade-detail-item span{font-size:1.1rem;font-weight:600}
.settings-grid{display:grid;gap:20px}
.setting-item{display:flex;justify-content:space-between;align-items:center;padding:15px;background:var(--bg2);border-radius:8px}
.setting-item input{padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;color:var(--text);width:120px;text-align:right}
.gallery-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:15px}
.gallery-item{position:relative;border-radius:12px;overflow:hidden;cursor:pointer;border:1px solid var(--border)}
.gallery-item:hover{border-color:var(--gold)}
.gallery-item img{width:100%;height:180px;object-fit:cover}
.gallery-item-info{padding:12px;background:var(--bg2)}
.gallery-item-badge{position:absolute;top:10px;right:10px}
.filter-bar{display:flex;gap:10px;flex-wrap:wrap}
.filter-select{padding:8px 15px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;color:var(--text)}
.account-select{padding:8px 15px;background:var(--bg2);border:1px solid var(--gold);border-radius:8px;color:var(--gold);font-weight:600;cursor:pointer;min-width:150px}
.account-select:focus{outline:none}
.strategies-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:20px}
.strategy-card{background:var(--bg2);border-radius:12px;border:1px solid var(--border);overflow:hidden;transition:all .2s}
.strategy-card:hover{border-color:var(--gold);transform:translateY(-2px)}
.strategy-card-header{padding:15px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.strategy-card-header h4{font-size:1rem;display:flex;align-items:center;gap:8px}
.strategy-card-body{padding:15px}
.strategy-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:15px;padding-top:15px;border-top:1px solid var(--border)}
.strategy-stat{text-align:center}
.strategy-stat-value{font-size:1.1rem;font-weight:700}
.strategy-stat-label{font-size:.7rem;color:var(--text2)}
.toast{position:fixed;bottom:30px;right:30px;padding:15px 25px;background:var(--green);color:#000;border-radius:8px;font-weight:600;transform:translateY(100px);opacity:0;transition:all .3s;z-index:1001}
.toast.show{transform:translateY(0);opacity:1}
.toast.error{background:var(--red);color:#fff}
@media(max-width:1200px){.form-grid{grid-template-columns:repeat(2,1fr)}.charts-grid{grid-template-columns:1fr}}
@media(max-width:768px){.form-grid{grid-template-columns:1fr}.form-group.col-2,.form-group.col-4{grid-column:span 1}.stats-grid{grid-template-columns:repeat(2,1fr)}.trade-detail-grid{grid-template-columns:repeat(2,1fr)}}
</style>
</head>
<body>

<!-- PASSWORD SCREEN -->
<div id="loginScreen">
<div class="login-box">
<div class="logo-icon">ğŸ”</div>
<h2>S&D Trading Journal</h2>
<p>Enter password to access your journal</p>
<input type="password" id="passwordInput" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeypress="if(event.key==='Enter')checkPassword()">
<button onclick="checkPassword()">ğŸ”“ Unlock</button>
<div class="login-error" id="loginError">Incorrect password</div>
</div>
</div>

<!-- MAIN APP -->
<div id="mainApp">
<div class="container">
<header>
<div class="logo"><div class="logo-icon">ğŸ“Š</div><h1>S&D Journal Pro</h1></div>
<div class="header-actions">
<select id="accountSelect" class="account-select" onchange="switchAccount()">
<option value="all">ğŸ“Š All Accounts</option>
</select>
<div class="daily-limit" id="dailyLimitDisplay">Today: <span id="todayPnL">$0</span> / <span id="dailyLimit">-$200</span></div>
<button class="btn-icon" onclick="openSettings()">âš™ï¸</button>
<button class="btn btn-secondary" onclick="exportData()">ğŸ“¥ Export</button>
<button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">ğŸ“¤ Import</button>
<input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
<button class="btn btn-primary" onclick="showTab('entry')">+ New Trade</button>
</div>
</header>

<div class="tabs">
<button class="tab active" onclick="showTab('dashboard')">ğŸ“Š Dashboard</button>
<button class="tab" onclick="showTab('calendar')">ğŸ“… Calendar</button>
<button class="tab" onclick="showTab('entry')">âœï¸ New Trade</button>
<button class="tab" onclick="showTab('history')">ğŸ“œ History</button>
<button class="tab" onclick="showTab('analytics')">ğŸ“ˆ Analytics</button>
<button class="tab" onclick="showTab('strategies')">ğŸ“‹ Strategies</button>
<button class="tab" onclick="showTab('gallery')">ğŸ–¼ï¸ Screenshots</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="tab-content active">
<div class="weekly-summary" id="weeklySummary"></div>
<div class="stats-grid" id="statsGrid"></div>
<div class="charts-grid">
<div class="chart-card"><h3>ğŸ“ˆ Equity Curve</h3><div class="chart-container"><canvas id="equityChart"></canvas></div></div>
<div class="chart-card"><h3>ğŸ¯ Win/Loss</h3><div class="chart-container"><canvas id="winLossChart"></canvas></div></div>
</div>
<div class="breakdown-grid" id="breakdownGrid"></div>
</div>

<!-- CALENDAR -->
<div id="calendar" class="tab-content">
<div class="calendar-container">
<div class="calendar-header">
<div class="calendar-nav">
<button class="btn-icon" onclick="changeMonth(-1)">â—€</button>
<h3 id="calendarTitle">January 2025</h3>
<button class="btn-icon" onclick="changeMonth(1)">â–¶</button>
</div>
<button class="btn btn-secondary" onclick="goToToday()">Today</button>
</div>
<div class="calendar-grid" id="calendarGrid"></div>
<div class="calendar-summary" id="calendarSummary"></div>
</div>
</div>

<!-- ENTRY FORM -->
<div id="entry" class="tab-content">
<div class="card"><div class="card-header"><h3>âœï¸ Log Trade</h3></div>
<div class="card-body">
<form id="tradeForm"><input type="hidden" id="editId">
<div class="form-grid">
<div class="form-group"><label>Account</label><select id="tradeAccount"></select></div>
<div class="form-group"><label>Strategy</label><select id="tradeStrategy"><option value="">No Strategy</option></select></div>
<div class="form-group"><label>Date & Time</label><input type="datetime-local" id="tradeDate" required></div>
<div class="form-group"><label>Session</label><select id="tradeSession" required><option value="">Select...</option><option>Asian</option><option>London</option><option>New York</option><option>Overlap</option></select></div>
<div class="form-group"><label>Pair</label><select id="tradePair" required><option value="">Select...</option>
<optgroup label="Forex Majors"><option>EURUSD</option><option>GBPUSD</option><option>USDJPY</option><option>USDCHF</option><option>AUDUSD</option><option>USDCAD</option><option>NZDUSD</option></optgroup>
<optgroup label="Forex Minors"><option>EURGBP</option><option>EURJPY</option><option>GBPJPY</option><option>AUDJPY</option><option>EURAUD</option><option>GBPAUD</option></optgroup>
<optgroup label="Metals"><option>XAUUSD</option><option>XAGUSD</option></optgroup>
<optgroup label="Indices"><option>US30</option><option>US500</option><option>NAS100</option><option>GER40</option><option>UK100</option></optgroup>
</select></div>
<div class="form-group"><label>Timeframe</label><select id="tradeTimeframe" required><option value="">Select...</option><option>M1</option><option>M5</option><option>M15</option><option>M30</option><option>H1</option><option>H4</option><option>D1</option></select></div>
<div class="form-group"><label>Direction</label><div class="toggle-group"><button type="button" class="toggle-btn long" onclick="setDirection('Long')">ğŸŸ¢ LONG</button><button type="button" class="toggle-btn short" onclick="setDirection('Short')">ğŸ”´ SHORT</button></div><input type="hidden" id="tradeDirection" required></div>
<div class="form-group"><label>Zone Type</label><div class="toggle-group"><button type="button" class="toggle-btn demand" onclick="setZone('Demand')">ğŸŸ¦ DEMAND</button><button type="button" class="toggle-btn supply" onclick="setZone('Supply')">ğŸŸ§ SUPPLY</button></div><input type="hidden" id="tradeZone" required></div>
<div class="form-group"><label>Setup</label><select id="tradeSetup" required><option value="">Select...</option><option>Fresh Zone</option><option>1st Touch</option><option>2nd Touch</option><option>Confluence</option><option>HTF Alignment</option><option>Liquidity Grab</option><option>BOS Entry</option></select></div>
<div class="form-group"><label>Entry Price</label><input type="number" id="tradeEntry" step="any" required oninput="calculateRR()"></div>
<div class="form-group"><label>Stop Loss</label><input type="number" id="tradeSL" step="any" required oninput="calculateRR()"></div>
<div class="form-group"><label>Take Profit</label><input type="number" id="tradeTP" step="any" required oninput="calculateRR()"></div>
<div class="form-group"><label>R:R Ratio</label><div class="rr-display"><div class="rr-value" id="rrDisplay">-</div><div class="rr-label">Risk : Reward</div></div></div>
<div class="form-group"><label>Position Size</label><input type="number" id="tradeSize" step="0.01" required></div>
<div class="form-group"><label>Risk ($)</label><input type="number" id="tradeRisk" step="0.01" required></div>
<div class="form-group"><label>Outcome</label><select id="tradeOutcome" required onchange="togglePnL()"><option value="Open">â³ Open</option><option value="Win">âœ… Win</option><option value="Loss">âŒ Loss</option><option value="BE">â– BE</option></select></div>
<div class="form-group" id="pnlGroup"><label>P&L ($)</label><input type="number" id="tradePnL" step="0.01"></div>
<div class="form-group col-2"><label>Mental State</label><div class="emotion-rating"><button type="button" class="emotion-btn" onclick="setEmotion(1)" data-v="1">ğŸ˜«</button><button type="button" class="emotion-btn" onclick="setEmotion(2)" data-v="2">ğŸ˜•</button><button type="button" class="emotion-btn selected" onclick="setEmotion(3)" data-v="3">ğŸ˜</button><button type="button" class="emotion-btn" onclick="setEmotion(4)" data-v="4">ğŸ™‚</button><button type="button" class="emotion-btn" onclick="setEmotion(5)" data-v="5">ğŸ˜</button></div><input type="hidden" id="tradeEmotion" value="3"></div>
<div class="form-group col-2"><label>Rating</label><div style="display:flex;gap:8px"><button type="button" class="rating-btn a" onclick="setRating('A')">A</button><button type="button" class="rating-btn b" onclick="setRating('B')">B</button><button type="button" class="rating-btn c" onclick="setRating('C')">C</button></div><input type="hidden" id="tradeRating"></div>
<div class="form-group col-4"><label>Mistakes</label><div class="mistake-tags" id="mistakeTags"><button type="button" class="mistake-tag" data-v="FOMO">FOMO</button><button type="button" class="mistake-tag" data-v="Revenge">Revenge</button><button type="button" class="mistake-tag" data-v="Moved SL">Moved SL</button><button type="button" class="mistake-tag" data-v="Early Exit">Early Exit</button><button type="button" class="mistake-tag" data-v="Late Entry">Late Entry</button><button type="button" class="mistake-tag" data-v="Wrong Size">Wrong Size</button></div><input type="hidden" id="tradeMistakes"></div>
<div class="form-group col-2"><label>Screenshot</label><input type="file" id="tradeScreenshot" accept="image/*" onchange="previewImg()"><img id="imgPreview" style="max-width:100%;max-height:150px;border-radius:8px;margin-top:10px;display:none"></div>
<div class="form-group col-2"><label>Notes</label><textarea id="tradeNotes" placeholder="Analysis..."></textarea></div>
</div>
<div class="form-actions"><button type="submit" class="btn btn-primary">ğŸ’¾ Save Trade</button><button type="button" class="btn btn-secondary" onclick="resetForm()">ğŸ”„ Reset</button></div>
</form></div></div>
</div>

<!-- HISTORY -->
<div id="history" class="tab-content">
<div class="card"><div class="card-header"><h3>ğŸ“œ Trade History</h3>
<div class="filter-bar">
<select class="filter-select" id="filterOutcome" onchange="filterTrades()"><option value="">All</option><option value="Win">Wins</option><option value="Loss">Losses</option><option value="Open">Open</option></select>
<select class="filter-select" id="filterPair" onchange="filterTrades()"><option value="">All Pairs</option></select>
</div>
</div>
<div style="overflow-x:auto"><table><thead><tr><th>Date</th><th>Pair</th><th>Dir</th><th>Zone</th><th>TF</th><th>R:R</th><th>Rating</th><th>Result</th><th>P&L</th><th>Actions</th></tr></thead><tbody id="tradesTable"></tbody></table></div></div>
</div>

<!-- ANALYTICS -->
<div id="analytics" class="tab-content">
<div class="stats-grid" style="margin-bottom:25px">
<div class="stat-card"><div class="stat-label">ğŸ”¥ Current Streak</div><div class="stat-value" id="currentStreak">-</div></div>
<div class="stat-card"><div class="stat-label">ğŸ† Best Streak</div><div class="stat-value positive" id="bestStreak">-</div></div>
<div class="stat-card"><div class="stat-label">ğŸ“‰ Worst Streak</div><div class="stat-value negative" id="worstStreak">-</div></div>
<div class="stat-card"><div class="stat-label">ğŸ“… Best Day</div><div class="stat-value gold" id="bestDay">-</div></div>
</div>
<div class="charts-grid">
<div class="chart-card"><h3>ğŸ“… Monthly P&L</h3><div class="chart-container"><canvas id="monthlyChart"></canvas></div></div>
<div class="chart-card"><h3>ğŸ“† By Day of Week</h3><div class="chart-container"><canvas id="dowChart"></canvas></div></div>
<div class="chart-card"><h3>ğŸ’± By Pair</h3><div class="chart-container"><canvas id="pairChart"></canvas></div></div>
<div class="chart-card"><h3>â° By Session</h3><div class="chart-container"><canvas id="sessionChart"></canvas></div></div>
</div>
</div>

<!-- STRATEGIES -->
<div id="strategies" class="tab-content">
<div class="card" style="margin-bottom:20px">
<div class="card-header"><h3>ğŸ“‹ My Trading Strategies</h3><button class="btn btn-primary" onclick="openStrategyEditor()">+ New Strategy</button></div>
<div class="card-body"><div id="strategiesList" class="strategies-grid"></div></div>
</div>

<div class="card" style="margin-bottom:20px">
<div class="card-header"><h3>ğŸ§ª Strategy Backtester</h3><button class="btn btn-primary" onclick="openBacktestModal()">+ Add Backtest</button></div>
<div class="card-body">
<p style="color:var(--text2);margin-bottom:15px;font-size:.9rem">Log backtested trades to track strategy win rates before going live.</p>

<!-- COT BIAS PANEL - NEW -->
<div id="cotBacktestPanel" style="background:linear-gradient(135deg,rgba(68,138,255,.05),rgba(68,138,255,.1));border:1px solid var(--blue);border-radius:12px;padding:15px;margin-bottom:20px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
<h4 style="color:var(--blue);margin:0">ğŸ“Š COT Bias</h4>
<span id="cotBacktestDate" style="color:var(--text2);font-size:.8rem"></span>
</div>
<div id="cotBacktestGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:6px"></div>
</div>

<div id="backtestStats" class="stats-grid" style="margin-bottom:20px"></div>
<div style="overflow-x:auto"><table><thead><tr><th>Strategy</th><th>Date</th><th>Pair</th><th>Direction</th><th>Result</th><th>R:R</th><th>Notes</th><th>Actions</th></tr></thead><tbody id="backtestTable"></tbody></table></div>
</div>
</div>
</div>

<!-- GALLERY -->
<div id="gallery" class="tab-content">
<div class="card"><div class="card-header"><h3>ğŸ–¼ï¸ Screenshots</h3><select class="filter-select" id="galleryFilter" onchange="updateGallery()"><option value="">All</option><option value="Win">Wins</option><option value="Loss">Losses</option></select></div>
<div class="card-body"><div class="gallery-grid" id="galleryGrid"></div></div></div>
</div>

<!-- MODALS -->
<div class="modal" id="tradeModal"><div class="modal-content"><div class="modal-header"><h3>Trade Details</h3><button class="modal-close" onclick="closeModal('tradeModal')">Ã—</button></div><div class="modal-body" id="tradeModalBody"></div></div></div>

<div class="modal" id="settingsModal"><div class="modal-content" style="max-width:500px"><div class="modal-header"><h3>âš™ï¸ Settings</h3><button class="modal-close" onclick="closeModal('settingsModal')">Ã—</button></div><div class="modal-body"><div class="settings-grid">
<div class="setting-item"><label>Daily Loss Limit ($)</label><input type="number" id="setLimit" value="200" onchange="saveSettings()"></div>
<div class="setting-item"><label>Default Risk ($)</label><input type="number" id="setRisk" value="50" onchange="saveSettings()"></div>
<div class="setting-item"><label>Account Size ($)</label><input type="number" id="setAccount" value="10000" onchange="saveSettings()"></div>
</div>
<div style="margin-top:20px;padding-top:20px;border-top:1px solid var(--border)"><button class="btn" style="background:var(--red);color:#fff" onclick="clearAll()">ğŸ—‘ï¸ Delete All Data</button></div></div></div></div>

<div class="modal" id="strategyModal"><div class="modal-content" style="max-width:600px"><div class="modal-header"><h3>ğŸ“‹ New Strategy</h3><button class="modal-close" onclick="closeModal('strategyModal')">Ã—</button></div><div class="modal-body">
<input type="hidden" id="editStrategyId">
<div class="form-group" style="margin-bottom:15px"><label>Strategy Name</label><input type="text" id="strategyName" placeholder="e.g. Fresh Zone Reversal" style="width:100%;padding:12px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"></div>
<div class="form-group" style="margin-bottom:15px"><label>Description</label><textarea id="strategyDesc" placeholder="Entry rules, exit rules..." style="width:100%;padding:12px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);min-height:100px"></textarea></div>
<div class="form-group" style="margin-bottom:15px"><label>Color</label><input type="color" id="strategyColor" value="#FFD700" style="width:60px;height:40px;border:none;border-radius:8px;cursor:pointer"></div>
<div style="display:flex;gap:10px"><button class="btn btn-primary" onclick="saveStrategy()">ğŸ’¾ Save Strategy</button><button class="btn btn-secondary" onclick="closeModal('strategyModal')">Cancel</button></div>
</div></div></div>

<div class="modal" id="backtestModal"><div class="modal-content" style="max-width:600px"><div class="modal-header"><h3>ğŸ§ª Add Backtest Trade</h3><button class="modal-close" onclick="closeModal('backtestModal')">Ã—</button></div><div class="modal-body">
<input type="hidden" id="editBacktestId">
<div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
<div class="form-group"><label>Strategy</label><select id="backtestStrategy" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"></select></div>
<div class="form-group"><label>Date</label><input type="date" id="backtestDate" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"></div>
<div class="form-group"><label>Pair</label><input type="text" id="backtestPair" placeholder="EURUSD" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"></div>
<div class="form-group"><label>Direction</label><select id="backtestDirection" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"><option>Long</option><option>Short</option></select></div>
<div class="form-group"><label>Result</label><select id="backtestResult" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"><option>Win</option><option>Loss</option><option>BE</option></select></div>
<div class="form-group"><label>R:R Achieved</label><input type="number" id="backtestRR" step="0.1" placeholder="2.5" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"></div>
</div>
<div class="form-group" style="margin-top:15px"><label>Notes</label><textarea id="backtestNotes" placeholder="What made this setup good/bad..." style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);min-height:60px"></textarea></div>
<div style="display:flex;gap:10px;margin-top:20px"><button class="btn btn-primary" onclick="saveBacktest()">ğŸ’¾ Save Backtest</button><button class="btn btn-secondary" onclick="closeModal('backtestModal')">Cancel</button></div>
</div></div></div>

<div class="toast" id="toast"></div>

<script>
let trades=JSON.parse(localStorage.getItem('sdTrades'))||[];
let accounts=JSON.parse(localStorage.getItem('sdAccounts'))||[{id:'default',name:'Main Account',color:'#FFD700'}];
let strategies=JSON.parse(localStorage.getItem('sdStrategies'))||[];
let backtests=JSON.parse(localStorage.getItem('sdBacktests'))||[];
let currentAccount='all';
let settings=JSON.parse(localStorage.getItem('sdSettings'))||{limit:200,risk:50,account:10000};
let charts={},currentMonth=new Date();

// ============================================
// COT DATA FOR BACKTESTER
// ============================================
function loadCotForBacktest(){
var saved=localStorage.getItem('cot-journal-export');
var panel=document.getElementById('cotBacktestPanel');
if(!saved||!panel){if(panel)panel.style.display='none';return}
var cot=JSON.parse(saved);
panel.style.display='block';
document.getElementById('cotBacktestDate').textContent='('+cot.date+')';
var sorted=Object.entries(cot.pairs).filter(function(p){return Math.abs(p[1])>3000}).sort(function(a,b){return Math.abs(b[1])-Math.abs(a[1])}).slice(0,24);
document.getElementById('cotBacktestGrid').innerHTML=sorted.map(function(p){var pair=p[0],val=p[1],color=val>5000?'var(--green)':val<-5000?'var(--red)':'var(--text2)',bg=val>5000?'rgba(0,200,83,.15)':val<-5000?'rgba(255,23,68,.15)':'var(--bg2)',bias=val>5000?'ğŸŸ¢':val<-5000?'ğŸ”´':'âšª';return '<div style="background:'+bg+';padding:6px;border-radius:6px;text-align:center"><div style="font-size:.75rem;font-weight:600">'+bias+' '+pair+'</div><div style="color:'+color+';font-size:.8rem;font-weight:700">'+(val>0?'+':'')+Math.round(val/1000)+'k</div></div>'}).join('')}

document.addEventListener('DOMContentLoaded',function(){
loadSettings();setDefaultDate();loadCotForBacktest();
updateAccountSelectors();updateStrategySelectors();updateAll()});

function saveTrades(){localStorage.setItem('sdTrades',JSON.stringify(trades))}
function updateAccountSelectors(){
var sel=document.getElementById('accountSelect');
var formSel=document.getElementById('tradeAccount');
sel.innerHTML='<option value="all">ğŸ“Š All Accounts</option>'+accounts.map(function(a){return '<option value="'+a.id+'">'+a.name+'</option>'}).join('');
sel.value=currentAccount;
if(formSel)formSel.innerHTML=accounts.map(function(a){return '<option value="'+a.id+'">'+a.name+'</option>'}).join('')}
function switchAccount(){currentAccount=document.getElementById('accountSelect').value;updateAll()}
function getFilteredTrades(){if(currentAccount==='all')return trades;return trades.filter(function(t){return t.account===currentAccount})}
function updateStrategySelectors(){
var formSel=document.getElementById('tradeStrategy');
if(formSel)formSel.innerHTML='<option value="">No Strategy</option>'+strategies.map(function(s){return '<option value="'+s.id+'">'+s.name+'</option>'}).join('')}

function updateAll(){updateDashboard();updateCalendar();updateHistory();updateAnalytics();updateGallery();updateStrategies();updateBacktests();populateFilters();updateDailyLimit()}
function showTab(id){document.querySelectorAll('.tab-content').forEach(function(t){t.classList.remove('active')});document.querySelectorAll('.tab').forEach(function(t){t.classList.remove('active')});document.getElementById(id).classList.add('active');var btn=document.querySelector('.tab[onclick="showTab(\''+id+'\')"]');if(btn)btn.classList.add('active');if(id==='strategies')loadCotForBacktest()}
function setDefaultDate(){var n=new Date();n.setMinutes(n.getMinutes()-n.getTimezoneOffset());document.getElementById('tradeDate').value=n.toISOString().slice(0,16);document.getElementById('tradeRisk').value=settings.risk}
function setDirection(d){document.getElementById('tradeDirection').value=d;document.querySelectorAll('.toggle-btn.long,.toggle-btn.short').forEach(function(b){b.classList.remove('selected')});document.querySelector('.toggle-btn.'+d.toLowerCase()).classList.add('selected');calculateRR()}
function setZone(z){document.getElementById('tradeZone').value=z;document.querySelectorAll('.toggle-btn.demand,.toggle-btn.supply').forEach(function(b){b.classList.remove('selected')});document.querySelector('.toggle-btn.'+z.toLowerCase()).classList.add('selected')}
function setEmotion(v){document.getElementById('tradeEmotion').value=v;document.querySelectorAll('.emotion-btn').forEach(function(b){b.classList.remove('selected')});document.querySelector('.emotion-btn[data-v="'+v+'"]').classList.add('selected')}
function setRating(v){document.getElementById('tradeRating').value=v;document.querySelectorAll('.rating-btn').forEach(function(b){b.classList.remove('selected')});document.querySelector('.rating-btn.'+v.toLowerCase()).classList.add('selected')}
function calculateRR(){var e=parseFloat(document.getElementById('tradeEntry').value),s=parseFloat(document.getElementById('tradeSL').value),t=parseFloat(document.getElementById('tradeTP').value),d=document.getElementById('tradeDirection').value;if(e&&s&&t&&d){var r=d==='Long'?(t-e)/(e-s):(e-t)/(s-e);var disp=document.getElementById('rrDisplay');if(r>0&&isFinite(r)){disp.textContent='1:'+r.toFixed(2);disp.style.color=r>=2?'var(--green)':'var(--gold)'}else{disp.textContent='Invalid';disp.style.color='var(--red)'}}}
function togglePnL(){document.getElementById('pnlGroup').style.display=document.getElementById('tradeOutcome').value==='Open'?'none':'block'}
function previewImg(){var f=document.getElementById('tradeScreenshot').files[0];if(!f)return;var reader=new FileReader();reader.onload=function(e){var img=document.getElementById('imgPreview');img.src=e.target.result;img.style.display='block'};reader.readAsDataURL(f)}

document.getElementById('tradeForm').addEventListener('submit',function(e){e.preventDefault();
var dir=document.getElementById('tradeDirection').value;
var zone=document.getElementById('tradeZone').value;
if(!dir||!zone){showToast('Select Direction and Zone','error');return}
var editId=document.getElementById('editId').value;
var entry=parseFloat(document.getElementById('tradeEntry').value);
var sl=parseFloat(document.getElementById('tradeSL').value);
var tp=parseFloat(document.getElementById('tradeTP').value);
var rr=dir==='Long'?(tp-entry)/(entry-sl):(entry-tp)/(sl-entry);
var trade={id:editId||Date.now().toString(),account:document.getElementById('tradeAccount').value||'default',strategy:document.getElementById('tradeStrategy').value||'',date:document.getElementById('tradeDate').value,session:document.getElementById('tradeSession').value,pair:document.getElementById('tradePair').value,direction:dir,zone:zone,timeframe:document.getElementById('tradeTimeframe').value,setup:document.getElementById('tradeSetup').value,entry:entry,sl:sl,tp:tp,size:parseFloat(document.getElementById('tradeSize').value),risk:parseFloat(document.getElementById('tradeRisk').value),rr:rr,outcome:document.getElementById('tradeOutcome').value,pnl:parseFloat(document.getElementById('tradePnL').value)||0,emotion:parseInt(document.getElementById('tradeEmotion').value)||3,rating:document.getElementById('tradeRating').value,mistakes:document.getElementById('tradeMistakes').value,notes:document.getElementById('tradeNotes').value,screenshot:document.getElementById('imgPreview').src||''};
if(editId){var i=trades.findIndex(function(t){return t.id===editId});if(i!==-1)trades[i]=trade}else trades.unshift(trade);
saveTrades();resetForm();updateAll();showTab('history');showToast(editId?'Updated!':'Saved!')});

function resetForm(){document.getElementById('tradeForm').reset();document.getElementById('editId').value='';document.getElementById('imgPreview').style.display='none';document.querySelectorAll('.toggle-btn,.emotion-btn,.rating-btn,.mistake-tag').forEach(function(b){b.classList.remove('selected')});document.querySelector('.emotion-btn[data-v="3"]').classList.add('selected');document.getElementById('rrDisplay').textContent='-';setDefaultDate()}

function updateDashboard(){
var allTrades=getFilteredTrades();
var closed=allTrades.filter(function(t){return t.outcome!=='Open'});
var wins=closed.filter(function(t){return t.outcome==='Win'});
var losses=closed.filter(function(t){return t.outcome==='Loss'});
var totalPnL=closed.reduce(function(s,t){return s+(t.pnl||0)},0);
var winRate=closed.length?(wins.length/closed.length*100):0;
var avgWin=wins.length?wins.reduce(function(s,t){return s+t.pnl},0)/wins.length:0;
var avgLoss=losses.length?Math.abs(losses.reduce(function(s,t){return s+t.pnl},0)/losses.length):0;
var pf=avgLoss?(avgWin*wins.length)/(avgLoss*losses.length):0;
var streak=calcStreak();
var weekStart=getWeekStart(new Date());
var weekTrades=closed.filter(function(t){return new Date(t.date)>=weekStart});
var weekWins=weekTrades.filter(function(t){return t.outcome==='Win'}).length;
var weekPnL=weekTrades.reduce(function(s,t){return s+(t.pnl||0)},0);
var weekWR=weekTrades.length?(weekWins/weekTrades.length*100):0;

document.getElementById('weeklySummary').innerHTML='<h3>ğŸ“… This Week</h3><div class="weekly-stats"><div><div class="stat-label">Trades</div><div class="stat-value">'+weekTrades.length+'</div></div><div><div class="stat-label">Win Rate</div><div class="stat-value '+(weekWR>=50?'positive':'negative')+'">'+weekWR.toFixed(1)+'%</div></div><div><div class="stat-label">P&L</div><div class="stat-value '+(weekPnL>=0?'positive':'negative')+'">$'+weekPnL.toFixed(2)+'</div></div><div><div class="stat-label">Streak</div><div class="stat-value"><span class="streak-badge '+streak.type+'-streak">'+(streak.type==='win'?'ğŸ”¥':'â„ï¸')+' '+streak.count+'</span></div></div></div>';
document.getElementById('statsGrid').innerHTML='<div class="stat-card highlight"><div class="stat-label">Total P&L</div><div class="stat-value '+(totalPnL>=0?'positive':'negative')+'">$'+totalPnL.toFixed(2)+'</div></div><div class="stat-card"><div class="stat-label">Win Rate</div><div class="stat-value '+(winRate>=50?'positive':'negative')+'">'+winRate.toFixed(1)+'%</div></div><div class="stat-card"><div class="stat-label">Profit Factor</div><div class="stat-value '+(pf>=1.5?'positive':'gold')+'">'+pf.toFixed(2)+'</div></div><div class="stat-card"><div class="stat-label">Avg Win</div><div class="stat-value positive">$'+avgWin.toFixed(2)+'</div></div><div class="stat-card"><div class="stat-label">Avg Loss</div><div class="stat-value negative">-$'+avgLoss.toFixed(2)+'</div></div><div class="stat-card"><div class="stat-label">Total Trades</div><div class="stat-value">'+closed.length+'</div></div>';
updateEquityChart();updateWinLossChart()}

function calcStreak(){var c=trades.filter(function(t){return t.outcome==='Win'||t.outcome==='Loss'});if(!c.length)return{type:'win',count:0};var count=1,first=c[0].outcome;for(var i=1;i<c.length;i++){if(c[i].outcome===first)count++;else break}return{type:first.toLowerCase(),count:count}}
function getWeekStart(d){var day=d.getDay(),diff=d.getDate()-day+(day===0?-6:1);return new Date(d.setDate(diff))}
function getTodayPnL(){var today=new Date().toISOString().split('T')[0];return getFilteredTrades().filter(function(t){return t.date&&t.date.startsWith(today)&&t.outcome!=='Open'}).reduce(function(s,t){return s+(t.pnl||0)},0)}
function updateDailyLimit(){var pnl=getTodayPnL();document.getElementById('todayPnL').textContent='$'+pnl.toFixed(0);document.getElementById('dailyLimit').textContent='-$'+settings.limit;var d=document.getElementById('dailyLimitDisplay');d.classList.remove('danger');if(pnl<=-settings.limit)d.classList.add('danger')}

function updateEquityChart(){var ctx=document.getElementById('equityChart');if(!ctx)return;var closed=trades.filter(function(t){return t.outcome!=='Open'}).reverse();var running=0;var data=closed.map(function(t){running+=t.pnl||0;return running});if(charts.equity)charts.equity.destroy();charts.equity=new Chart(ctx,{type:'line',data:{labels:data.map(function(_,i){return i+1}),datasets:[{data:data,borderColor:'#FFD700',backgroundColor:'rgba(255,215,0,.1)',fill:true,tension:.4,pointRadius:2}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{grid:{color:'#2a2a2a'},ticks:{color:'#888'}},y:{grid:{color:'#2a2a2a'},ticks:{color:'#888'}}}}})}

function updateWinLossChart(){var ctx=document.getElementById('winLossChart');if(!ctx)return;var closed=trades.filter(function(t){return t.outcome!=='Open'});var w=closed.filter(function(t){return t.outcome==='Win'}).length;var l=closed.filter(function(t){return t.outcome==='Loss'}).length;var b=closed.filter(function(t){return t.outcome==='BE'}).length;if(charts.winLoss)charts.winLoss.destroy();charts.winLoss=new Chart(ctx,{type:'doughnut',data:{labels:['Wins','Losses','BE'],datasets:[{data:[w,l,b],backgroundColor:['#00C853','#FF1744','#555'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{color:'#888'}}}}})}

function updateCalendar(){var y=currentMonth.getFullYear(),m=currentMonth.getMonth();document.getElementById('calendarTitle').textContent=currentMonth.toLocaleDateString('en-US',{month:'long',year:'numeric'});var first=new Date(y,m,1),last=new Date(y,m+1,0),startDay=first.getDay()||7;var html=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(function(d){return '<div class="calendar-day-header">'+d+'</div>'}).join('');var prev=new Date(y,m,0);for(var i=startDay-1;i>0;i--)html+='<div class="calendar-day other-month"><div class="day-number">'+(prev.getDate()-i+1)+'</div></div>';var today=new Date();for(var d=1;d<=last.getDate();d++){var ds=y+'-'+String(m+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');var dayT=getFilteredTrades().filter(function(t){return t.date&&t.date.startsWith(ds)});var dayPnL=dayT.filter(function(t){return t.outcome!=='Open'}).reduce(function(s,t){return s+(t.pnl||0)},0);var isToday=today.getDate()===d&&today.getMonth()===m&&today.getFullYear()===y;html+='<div class="calendar-day '+(isToday?'today':'')+'"><div class="day-number">'+d+'</div>'+(dayT.length?'<div class="day-pnl '+(dayPnL>=0?'positive':'negative')+'">$'+dayPnL.toFixed(0)+'</div>':'')+'</div>'}document.getElementById('calendarGrid').innerHTML=html}
function changeMonth(d){currentMonth.setMonth(currentMonth.getMonth()+d);updateCalendar()}
function goToToday(){currentMonth=new Date();updateCalendar()}

function updateHistory(){filterTrades();populateFilters()}
function filterTrades(){var out=document.getElementById('filterOutcome').value,pair=document.getElementById('filterPair').value;var f=getFilteredTrades().slice();if(out)f=f.filter(function(t){return t.outcome===out});if(pair)f=f.filter(function(t){return t.pair===pair});var tb=document.getElementById('tradesTable');if(!f.length){tb.innerHTML='<tr><td colspan="10" style="text-align:center;color:var(--text2);padding:30px">No trades</td></tr>';return}tb.innerHTML=f.map(function(t){return '<tr><td>'+(t.date?new Date(t.date).toLocaleDateString():'-')+'</td><td><strong>'+t.pair+'</strong></td><td><span class="badge badge-'+t.direction.toLowerCase()+'">'+t.direction+'</span></td><td><span class="badge badge-'+t.zone.toLowerCase()+'">'+t.zone+'</span></td><td>'+t.timeframe+'</td><td>1:'+t.rr.toFixed(2)+'</td><td>'+t.rating+'</td><td><span class="badge badge-'+t.outcome.toLowerCase()+'">'+t.outcome+'</span></td><td class="'+(t.pnl>=0?'positive':'negative')+'">$'+t.pnl.toFixed(2)+'</td><td><div class="action-btns"><button class="action-btn view" onclick="viewTrade(\''+t.id+'\')">ğŸ‘ï¸</button><button class="action-btn edit" onclick="editTrade(\''+t.id+'\')">âœï¸</button><button class="action-btn delete" onclick="deleteTrade(\''+t.id+'\')">ğŸ—‘ï¸</button></div></td></tr>'}).join('')}
function populateFilters(){var pairs=[];trades.forEach(function(t){if(t.pair&&pairs.indexOf(t.pair)===-1)pairs.push(t.pair)});pairs.sort();document.getElementById('filterPair').innerHTML='<option value="">All Pairs</option>'+pairs.map(function(p){return '<option>'+p+'</option>'}).join('')}

function viewTrade(id){var t=trades.find(function(x){return x.id===id});if(!t)return;document.getElementById('tradeModalBody').innerHTML='<div class="trade-detail-grid"><div class="trade-detail-item"><label>Date</label><span>'+new Date(t.date).toLocaleString()+'</span></div><div class="trade-detail-item"><label>Pair</label><span>'+t.pair+'</span></div><div class="trade-detail-item"><label>Direction</label><span class="badge badge-'+t.direction.toLowerCase()+'">'+t.direction+'</span></div><div class="trade-detail-item"><label>Zone</label><span class="badge badge-'+t.zone.toLowerCase()+'">'+t.zone+'</span></div><div class="trade-detail-item"><label>R:R</label><span style="color:var(--gold)">1:'+t.rr.toFixed(2)+'</span></div><div class="trade-detail-item"><label>Outcome</label><span class="badge badge-'+t.outcome.toLowerCase()+'">'+t.outcome+'</span></div><div class="trade-detail-item"><label>P&L</label><span class="'+(t.pnl>=0?'positive':'negative')+'">$'+t.pnl.toFixed(2)+'</span></div></div>'+(t.notes?'<div style="margin-top:15px"><strong>Notes:</strong><p style="background:var(--bg2);padding:10px;border-radius:6px;margin-top:5px">'+t.notes+'</p></div>':'')+(t.screenshot?'<img src="'+t.screenshot+'" style="width:100%;border-radius:8px;margin-top:15px">':'');openModal('tradeModal')}
function editTrade(id){var t=trades.find(function(x){return x.id===id});if(!t)return;document.getElementById('editId').value=id;document.getElementById('tradeAccount').value=t.account||'default';document.getElementById('tradeStrategy').value=t.strategy||'';document.getElementById('tradeDate').value=t.date||'';document.getElementById('tradeSession').value=t.session||'';document.getElementById('tradePair').value=t.pair||'';if(t.direction)setDirection(t.direction);if(t.zone)setZone(t.zone);document.getElementById('tradeTimeframe').value=t.timeframe||'';document.getElementById('tradeSetup').value=t.setup||'';document.getElementById('tradeEntry').value=t.entry;document.getElementById('tradeSL').value=t.sl;document.getElementById('tradeTP').value=t.tp;document.getElementById('tradeSize').value=t.size;document.getElementById('tradeRisk').value=t.risk;document.getElementById('tradeOutcome').value=t.outcome;document.getElementById('tradePnL').value=t.pnl;setEmotion(t.emotion||3);if(t.rating)setRating(t.rating);document.getElementById('tradeNotes').value=t.notes||'';if(t.screenshot){document.getElementById('imgPreview').src=t.screenshot;document.getElementById('imgPreview').style.display='block'}calculateRR();togglePnL();showTab('entry')}
function deleteTrade(id){if(confirm('Delete this trade?')){trades=trades.filter(function(t){return t.id!==id});saveTrades();updateAll();showToast('Deleted','error')}}

function updateAnalytics(){var closed=getFilteredTrades().filter(function(t){return t.outcome!=='Open'});var sortedTrades=closed.slice().sort(function(a,b){return new Date(a.date)-new Date(b.date)});var currentStreak=0,bestWinStreak=0,worstLossStreak=0,tempStreak=0,lastOutcome='';sortedTrades.forEach(function(t){if(t.outcome==='Win'){if(lastOutcome==='Win'||lastOutcome==='')tempStreak++;else tempStreak=1;if(tempStreak>bestWinStreak)bestWinStreak=tempStreak}else if(t.outcome==='Loss'){if(lastOutcome==='Loss'||lastOutcome==='')tempStreak--;else tempStreak=-1;if(tempStreak<worstLossStreak)worstLossStreak=tempStreak}else tempStreak=0;lastOutcome=t.outcome;currentStreak=tempStreak});document.getElementById('currentStreak').textContent=(currentStreak>0?'+':'')+currentStreak+'W';document.getElementById('bestStreak').textContent='+'+bestWinStreak+'W';document.getElementById('worstStreak').textContent=worstLossStreak+'L';var days=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];var dayWinRates=days.map(function(_,i){var dt=closed.filter(function(t){return new Date(t.date).getDay()===i});var wins=dt.filter(function(t){return t.outcome==='Win'}).length;return dt.length>=3?{day:days[i],rate:wins/dt.length*100}:null}).filter(Boolean);var bestDayObj=dayWinRates.sort(function(a,b){return b.rate-a.rate})[0];document.getElementById('bestDay').textContent=bestDayObj?bestDayObj.day+' ('+bestDayObj.rate.toFixed(0)+'%)':'-';var pairs=[];closed.forEach(function(t){if(pairs.indexOf(t.pair)===-1)pairs.push(t.pair)});var pairData=pairs.map(function(p){return closed.filter(function(t){return t.pair===p}).reduce(function(s,t){return s+(t.pnl||0)},0)});createBar('pairChart','pair',pairs,pairData);var sessions=['Asian','London','New York','Overlap'];var sessData=sessions.map(function(s){var st=closed.filter(function(t){return t.session===s});return st.length?(st.filter(function(t){return t.outcome==='Win'}).length/st.length*100):0});createBar('sessionChart','session',sessions,sessData,'#FFD700');var monthly={};closed.forEach(function(t){var m=new Date(t.date).toLocaleDateString('en-US',{year:'numeric',month:'short'});monthly[m]=(monthly[m]||0)+(t.pnl||0)});var months=Object.keys(monthly).slice(-12);createBar('monthlyChart','monthly',months,months.map(function(m){return monthly[m]}));var dowData=days.map(function(_,i){return closed.filter(function(t){return new Date(t.date).getDay()===i}).reduce(function(s,t){return s+(t.pnl||0)},0)});createBar('dowChart','dow',days,dowData)}
function createBar(canvasId,key,labels,data,color){var ctx=document.getElementById(canvasId);if(!ctx)return;if(charts[key])charts[key].destroy();charts[key]=new Chart(ctx,{type:'bar',data:{labels:labels,datasets:[{data:data,backgroundColor:color||data.map(function(d){return d>=0?'#00C853':'#FF1744'})}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{grid:{color:'#2a2a2a'},ticks:{color:'#888'}},y:{grid:{color:'#2a2a2a'},ticks:{color:'#888'}}}}})}

function updateGallery(){var f=document.getElementById('galleryFilter').value;var filtered=getFilteredTrades().filter(function(t){return t.screenshot});if(f)filtered=filtered.filter(function(t){return t.outcome===f});var grid=document.getElementById('galleryGrid');if(!filtered.length){grid.innerHTML='<div style="grid-column:1/-1;text-align:center;color:var(--text2);padding:40px">No screenshots</div>';return}grid.innerHTML=filtered.map(function(t){return '<div class="gallery-item" onclick="viewTrade(\''+t.id+'\')"><img src="'+t.screenshot+'"><div class="gallery-item-badge"><span class="badge badge-'+t.outcome.toLowerCase()+'">'+t.outcome+'</span></div><div class="gallery-item-info"><h4>'+t.pair+'</h4><p>'+new Date(t.date).toLocaleDateString()+'</p></div></div>'}).join('')}

function updateStrategies(){var list=document.getElementById('strategiesList');if(!strategies.length){list.innerHTML='<div style="grid-column:1/-1;text-align:center;color:var(--text2);padding:40px">No strategies yet</div>';return}list.innerHTML=strategies.map(function(s){var stratTrades=trades.filter(function(t){return t.strategy===s.id&&t.outcome!=='Open'});var wins=stratTrades.filter(function(t){return t.outcome==='Win'}).length;var winRate=stratTrades.length?(wins/stratTrades.length*100):0;var pnl=stratTrades.reduce(function(sum,t){return sum+(t.pnl||0)},0);return '<div class="strategy-card" style="border-left:4px solid '+s.color+'"><div class="strategy-card-header"><h4><span style="color:'+s.color+'">â—</span> '+s.name+'</h4><div class="action-btns"><button class="action-btn edit" onclick="openStrategyEditor(\''+s.id+'\')">âœï¸</button><button class="action-btn delete" onclick="deleteStrategy(\''+s.id+'\')">ğŸ—‘ï¸</button></div></div><div class="strategy-card-body">'+(s.description?'<p style="color:var(--text2);font-size:.85rem">'+s.description+'</p>':'')+'<div class="strategy-stats"><div class="strategy-stat"><div class="strategy-stat-value">'+stratTrades.length+'</div><div class="strategy-stat-label">Trades</div></div><div class="strategy-stat"><div class="strategy-stat-value '+(winRate>=50?'positive':'negative')+'">'+winRate.toFixed(0)+'%</div><div class="strategy-stat-label">Win Rate</div></div><div class="strategy-stat"><div class="strategy-stat-value '+(pnl>=0?'positive':'negative')+'">$'+pnl.toFixed(0)+'</div><div class="strategy-stat-label">P&L</div></div></div></div></div>'}).join('')}
function openStrategyEditor(id){document.getElementById('editStrategyId').value='';document.getElementById('strategyName').value='';document.getElementById('strategyDesc').value='';document.getElementById('strategyColor').value='#FFD700';if(id){var s=strategies.find(function(x){return x.id===id});if(s){document.getElementById('editStrategyId').value=id;document.getElementById('strategyName').value=s.name;document.getElementById('strategyDesc').value=s.description||'';document.getElementById('strategyColor').value=s.color||'#FFD700'}}openModal('strategyModal')}
function saveStrategy(){var name=document.getElementById('strategyName').value.trim();if(!name){showToast('Enter strategy name','error');return}var id=document.getElementById('editStrategyId').value||'strat_'+Date.now();var strategy={id:id,name:name,description:document.getElementById('strategyDesc').value,color:document.getElementById('strategyColor').value};var idx=strategies.findIndex(function(s){return s.id===id});if(idx!==-1)strategies[idx]=strategy;else strategies.push(strategy);localStorage.setItem('sdStrategies',JSON.stringify(strategies));updateStrategySelectors();updateStrategies();closeModal('strategyModal');showToast('Strategy saved!')}
function deleteStrategy(id){if(!confirm('Delete this strategy?'))return;strategies=strategies.filter(function(s){return s.id!==id});localStorage.setItem('sdStrategies',JSON.stringify(strategies));updateStrategySelectors();updateStrategies();showToast('Strategy deleted')}

function openBacktestModal(id){document.getElementById('editBacktestId').value='';document.getElementById('backtestDate').value=new Date().toISOString().split('T')[0];document.getElementById('backtestPair').value='';document.getElementById('backtestDirection').value='Long';document.getElementById('backtestResult').value='Win';document.getElementById('backtestRR').value='';document.getElementById('backtestNotes').value='';var stratSel=document.getElementById('backtestStrategy');stratSel.innerHTML='<option value="">Select strategy...</option>'+strategies.map(function(s){return '<option value="'+s.id+'">'+s.name+'</option>'}).join('');if(id){var bt=backtests.find(function(b){return b.id===id});if(bt){document.getElementById('editBacktestId').value=id;stratSel.value=bt.strategy||'';document.getElementById('backtestDate').value=bt.date||'';document.getElementById('backtestPair').value=bt.pair||'';document.getElementById('backtestDirection').value=bt.direction||'Long';document.getElementById('backtestResult').value=bt.result||'Win';document.getElementById('backtestRR').value=bt.rr||'';document.getElementById('backtestNotes').value=bt.notes||''}}openModal('backtestModal')}
function saveBacktest(){var pair=document.getElementById('backtestPair').value.trim().toUpperCase();if(!pair){showToast('Enter pair','error');return}var id=document.getElementById('editBacktestId').value||'bt_'+Date.now();var bt={id:id,strategy:document.getElementById('backtestStrategy').value,date:document.getElementById('backtestDate').value,pair:pair,direction:document.getElementById('backtestDirection').value,result:document.getElementById('backtestResult').value,rr:parseFloat(document.getElementById('backtestRR').value)||0,notes:document.getElementById('backtestNotes').value};var idx=backtests.findIndex(function(b){return b.id===id});if(idx!==-1)backtests[idx]=bt;else backtests.unshift(bt);localStorage.setItem('sdBacktests',JSON.stringify(backtests));updateBacktests();closeModal('backtestModal');showToast('Backtest saved!')}
function deleteBacktest(id){if(!confirm('Delete this backtest?'))return;backtests=backtests.filter(function(b){return b.id!==id});localStorage.setItem('sdBacktests',JSON.stringify(backtests));updateBacktests();showToast('Deleted')}
function updateBacktests(){var table=document.getElementById('backtestTable');var stats=document.getElementById('backtestStats');if(!backtests.length){table.innerHTML='<tr><td colspan="8" style="text-align:center;color:var(--text2);padding:30px">No backtests yet</td></tr>';stats.innerHTML='';return}var wins=backtests.filter(function(b){return b.result==='Win'}).length;var losses=backtests.filter(function(b){return b.result==='Loss'}).length;var winRate=backtests.length?(wins/backtests.length*100):0;var avgRR=backtests.filter(function(b){return b.rr>0}).reduce(function(s,b,i,a){return s+b.rr/a.length},0);stats.innerHTML='<div class="stat-card"><div class="stat-label">Total Backtests</div><div class="stat-value gold">'+backtests.length+'</div></div><div class="stat-card"><div class="stat-label">Win Rate</div><div class="stat-value '+(winRate>=50?'positive':'negative')+'">'+winRate.toFixed(1)+'%</div></div><div class="stat-card"><div class="stat-label">Wins / Losses</div><div class="stat-value"><span class="positive">'+wins+'</span> / <span class="negative">'+losses+'</span></div></div><div class="stat-card"><div class="stat-label">Avg R:R</div><div class="stat-value gold">'+avgRR.toFixed(2)+'</div></div>';table.innerHTML=backtests.map(function(b){var strat=strategies.find(function(s){return s.id===b.strategy});return '<tr><td>'+(strat?'<span style="color:'+strat.color+'">'+strat.name+'</span>':'-')+'</td><td>'+b.date+'</td><td><strong>'+b.pair+'</strong></td><td><span class="badge badge-'+b.direction.toLowerCase()+'">'+b.direction+'</span></td><td><span class="badge badge-'+b.result.toLowerCase()+'">'+b.result+'</span></td><td>'+(b.rr?'1:'+b.rr.toFixed(1):'-')+'</td><td style="max-width:150px;overflow:hidden;text-overflow:ellipsis">'+(b.notes||'-')+'</td><td><div class="action-btns"><button class="action-btn edit" onclick="openBacktestModal(\''+b.id+'\')">âœï¸</button><button class="action-btn delete" onclick="deleteBacktest(\''+b.id+'\')">ğŸ—‘ï¸</button></div></td></tr>'}).join('')}

function openSettings(){document.getElementById('setLimit').value=settings.limit;document.getElementById('setRisk').value=settings.risk;document.getElementById('setAccount').value=settings.account;openModal('settingsModal')}
function saveSettings(){settings.limit=parseFloat(document.getElementById('setLimit').value)||200;settings.risk=parseFloat(document.getElementById('setRisk').value)||50;settings.account=parseFloat(document.getElementById('setAccount').value)||10000;localStorage.setItem('sdSettings',JSON.stringify(settings));updateDailyLimit();showToast('Saved!')}
function loadSettings(){var s=localStorage.getItem('sdSettings');if(s)settings=JSON.parse(s)}
function clearAll(){if(confirm('Delete ALL trades?')&&confirm('Are you sure?')){trades=[];saveTrades();updateAll();closeModal('settingsModal');showToast('Cleared','error')}}

function openModal(id){document.getElementById(id).classList.add('active')}
function closeModal(id){document.getElementById(id).classList.remove('active')}
document.querySelectorAll('.modal').forEach(function(m){m.addEventListener('click',function(e){if(e.target===m)m.classList.remove('active')})});

function exportData(){var data={trades:trades,accounts:accounts,strategies:strategies,backtests:backtests,settings:settings};var blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});var a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='journal_backup_'+new Date().toISOString().split('T')[0]+'.json';a.click();showToast('Exported!')}
function importData(event){var file=event.target.files[0];if(!file)return;var reader=new FileReader();reader.onload=function(e){try{var data=JSON.parse(e.target.result);if(data.trades){trades=data.trades;saveTrades()}if(data.accounts){accounts=data.accounts;localStorage.setItem('sdAccounts',JSON.stringify(accounts))}if(data.strategies){strategies=data.strategies;localStorage.setItem('sdStrategies',JSON.stringify(strategies))}if(data.backtests){backtests=data.backtests;localStorage.setItem('sdBacktests',JSON.stringify(backtests))}updateAccountSelectors();updateStrategySelectors();updateAll();showToast('Imported!')}catch(err){showToast('Error','error')}};reader.readAsText(file);event.target.value=''}

function showToast(msg,type){var t=document.getElementById('toast');t.textContent=msg;t.className='toast show '+(type||'');setTimeout(function(){t.classList.remove('show')},3000)}

// Password
var APP_PASSWORD='Swingelite1313-';
function checkPassword(){var input=document.getElementById('passwordInput').value;if(input===APP_PASSWORD){document.getElementById('loginScreen').classList.add('hidden');document.getElementById('mainApp').classList.add('visible');sessionStorage.setItem('journalAuth','true')}else{document.getElementById('loginError').style.display='block';document.getElementById('passwordInput').value='';setTimeout(function(){document.getElementById('loginError').style.display='none'},2000)}}
if(sessionStorage.getItem('journalAuth')==='true'){document.getElementById('loginScreen').classList.add('hidden');document.getElementById('mainApp').classList.add('visible')}

// Mistake tags
document.querySelectorAll('.mistake-tag').forEach(function(t){t.addEventListener('click',function(){t.classList.toggle('selected');document.getElementById('tradeMistakes').value=Array.from(document.querySelectorAll('.mistake-tag.selected')).map(function(x){return x.dataset.v}).join(',')})});
</script>
</div>
</div>
</body>
</html>
