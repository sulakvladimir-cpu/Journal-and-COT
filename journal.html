<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>S&D Trading Journal Pro</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#000;--bg2:#0a0a0a;--bg3:#141414;--gold:#FFD700;--gold2:#FFA500;--green:#00C853;--red:#FF1744;--blue:#448AFF;--purple:#E040FB;--text:#fff;--text2:#888;--border:#2a2a2a}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}

/* Password Screen */
#loginScreen{position:fixed;top:0;left:0;width:100%;height:100%;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:9999}
#loginScreen.hidden{display:none}
.login-box{background:var(--bg3);padding:40px;border-radius:16px;border:1px solid var(--border);text-align:center;max-width:400px;width:90%}
.login-box .logo-icon{width:60px;height:60px;background:linear-gradient(135deg,var(--gold),var(--gold2));border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:2rem;margin:0 auto 20px}
.login-box h2{color:var(--gold);margin-bottom:10px}
.login-box p{color:var(--text2);margin-bottom:25px;font-size:.9rem}
.login-box input{width:100%;padding:15px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:1rem;margin-bottom:15px;text-align:center;letter-spacing:2px}
.login-box input:focus{outline:none;border-color:var(--gold)}
.login-box button{width:100%;padding:15px;background:linear-gradient(135deg,var(--gold),var(--gold2));border:none;border-radius:8px;color:#000;font-weight:600;font-size:1rem;cursor:pointer}
.login-box button:hover{transform:scale(1.02)}
.login-error{color:var(--red);font-size:.85rem;margin-top:10px;display:none}
#mainApp{display:none}
#mainApp.visible{display:block}

.container{max-width:1800px;margin:0 auto;padding:20px}
header{display:flex;justify-content:space-between;align-items:center;padding:20px 0;border-bottom:1px solid var(--border);margin-bottom:25px;flex-wrap:wrap;gap:15px}
.logo{display:flex;align-items:center;gap:12px}
.logo-icon{width:45px;height:45px;background:linear-gradient(135deg,var(--gold),var(--gold2));border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.5rem}
header h1{font-size:1.5rem;color:var(--gold)}
.header-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.daily-limit{padding:8px 15px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;font-size:.85rem}
.daily-limit.danger{border-color:var(--red);background:rgba(255,23,68,.1);animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
.btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:.9rem;transition:all .2s}
.btn-primary{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#000}
.btn-secondary{background:var(--bg3);color:var(--text);border:1px solid var(--border)}
.btn-icon{width:38px;height:38px;padding:0;display:flex;align-items:center;justify-content:center;border-radius:8px;background:var(--bg3);border:1px solid var(--border);color:var(--text2);cursor:pointer}
.tabs{display:flex;gap:5px;margin-bottom:25px;background:var(--bg2);padding:6px;border-radius:12px;border:1px solid var(--border);overflow-x:auto}
.tab{padding:12px 20px;background:transparent;border:none;color:var(--text2);cursor:pointer;border-radius:8px;font-weight:500;white-space:nowrap}
.tab.active{background:var(--gold);color:#000}
.tab:hover:not(.active){background:var(--bg3);color:var(--text)}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:25px}
.stat-card{background:var(--bg3);padding:18px;border-radius:12px;border:1px solid var(--border)}
.stat-card.highlight{border-color:var(--gold);background:linear-gradient(135deg,rgba(255,215,0,.05),rgba(255,165,0,.05))}
.stat-label{color:var(--text2);font-size:.8rem;margin-bottom:6px;text-transform:uppercase}
.stat-value{font-size:1.6rem;font-weight:700}
.stat-value.positive,.positive{color:var(--green)}
.stat-value.negative,.negative{color:var(--red)}
.stat-value.gold{color:var(--gold)}
.tab-content{display:none}.tab-content.active{display:block}
.card{background:var(--bg3);border-radius:16px;border:1px solid var(--border);overflow:hidden}
.card-header{padding:18px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}
.card-body{padding:20px}
.form-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:20px}
.form-group{display:flex;flex-direction:column;gap:8px}
.form-group.col-2{grid-column:span 2}.form-group.col-4{grid-column:span 4}
.form-group label{color:var(--text2);font-size:.85rem}
.form-group input,.form-group select,.form-group textarea{padding:12px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:.95rem}
.form-group input:focus,.form-group select:focus{outline:none;border-color:var(--gold)}
.form-group textarea{min-height:80px;resize:vertical}
.form-actions{display:flex;gap:15px;margin-top:25px;padding-top:25px;border-top:1px solid var(--border)}
.toggle-group{display:flex;gap:10px}
.toggle-btn{flex:1;padding:12px;border:2px solid var(--border);background:var(--bg2);color:var(--text2);border-radius:8px;cursor:pointer;font-weight:600;text-align:center}
.toggle-btn.long.selected{border-color:var(--green);background:rgba(0,200,83,.1);color:var(--green)}
.toggle-btn.short.selected{border-color:var(--red);background:rgba(255,23,68,.1);color:var(--red)}
.toggle-btn.demand.selected{border-color:var(--blue);background:rgba(68,138,255,.1);color:var(--blue)}
.toggle-btn.supply.selected{border-color:var(--gold2);background:rgba(255,165,0,.1);color:var(--gold2)}
.rr-display{background:var(--bg2);padding:15px;border-radius:8px;text-align:center;border:1px solid var(--border)}
.rr-value{font-size:1.8rem;font-weight:700;color:var(--gold)}
.rr-label{color:var(--text2);font-size:.8rem}
.emotion-rating{display:flex;gap:8px}
.emotion-btn{width:45px;height:45px;border-radius:10px;border:2px solid var(--border);background:var(--bg2);cursor:pointer;font-size:1.3rem}
.emotion-btn.selected{border-color:var(--gold);background:rgba(255,215,0,.1)}
.rating-btn{width:50px;height:45px;border-radius:8px;border:2px solid var(--border);background:var(--bg2);cursor:pointer;font-weight:700;color:var(--text2)}
.rating-btn.selected.a{border-color:var(--green);color:var(--green)}
.rating-btn.selected.b{border-color:var(--gold);color:var(--gold)}
.rating-btn.selected.c{border-color:var(--red);color:var(--red)}
.mistake-tags{display:flex;flex-wrap:wrap;gap:8px}
.mistake-tag{padding:8px 14px;border-radius:20px;border:1px solid var(--border);background:var(--bg2);cursor:pointer;font-size:.85rem;color:var(--text2)}
.mistake-tag.selected{border-color:var(--red);color:var(--red)}
table{width:100%;border-collapse:collapse}
th{padding:14px 12px;text-align:left;color:var(--text2);font-weight:600;font-size:.8rem;border-bottom:1px solid var(--border);background:var(--bg2)}
td{padding:14px 12px;border-bottom:1px solid var(--border)}
tr:hover{background:rgba(255,255,255,.02)}
.badge{padding:5px 10px;border-radius:6px;font-size:.8rem;font-weight:600}
.badge-long{background:rgba(0,200,83,.15);color:var(--green)}
.badge-short{background:rgba(255,23,68,.15);color:var(--red)}
.badge-demand{background:rgba(68,138,255,.15);color:var(--blue)}
.badge-supply{background:rgba(255,165,0,.15);color:var(--gold2)}
.badge-win{background:rgba(0,200,83,.15);color:var(--green)}
.badge-loss{background:rgba(255,23,68,.15);color:var(--red)}
.badge-be,.badge-open{background:rgba(136,136,136,.15);color:var(--text2)}
.action-btns{display:flex;gap:6px}
.action-btn{padding:6px 10px;border:none;border-radius:6px;cursor:pointer;font-size:.85rem}
.action-btn.view{background:rgba(255,215,0,.1);color:var(--gold)}
.action-btn.edit{background:rgba(68,138,255,.1);color:var(--blue)}
.action-btn.delete{background:rgba(255,23,68,.1);color:var(--red)}
.charts-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:20px;margin-bottom:25px}
.chart-card{background:var(--bg3);padding:20px;border-radius:16px;border:1px solid var(--border)}
.chart-card h3{margin-bottom:15px;font-size:.95rem}
.chart-container{height:250px}
.calendar-container{background:var(--bg3);border-radius:16px;border:1px solid var(--border);overflow:hidden}
.calendar-header{display:flex;justify-content:space-between;align-items:center;padding:20px}
.calendar-nav{display:flex;gap:10px;align-items:center}
.calendar-nav h3{min-width:200px;text-align:center}
.calendar-grid{display:grid;grid-template-columns:repeat(7,1fr)}
.calendar-day-header{padding:15px;text-align:center;font-weight:600;color:var(--text2);border-bottom:1px solid var(--border);background:var(--bg2)}
.calendar-day{min-height:100px;padding:10px;border-right:1px solid var(--border);border-bottom:1px solid var(--border);cursor:pointer;position:relative}
.calendar-day:nth-child(7n){border-right:none}
.calendar-day:hover{background:var(--bg2)}
.calendar-day.other-month{opacity:.5}
.calendar-day.today .day-number{background:var(--gold);color:#000;border-radius:50%;width:28px;height:28px;display:flex;align-items:center;justify-content:center}
.day-number{font-weight:600;margin-bottom:8px}
.day-trade{font-size:.75rem;padding:4px 8px;border-radius:4px;margin-bottom:4px}
.day-trade.win{background:rgba(0,200,83,.2);color:var(--green)}
.day-trade.loss{background:rgba(255,23,68,.2);color:var(--red)}
.day-pnl{position:absolute;bottom:5px;right:8px;font-size:.8rem;font-weight:600}
.calendar-summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;padding:20px;background:var(--bg2)}
.weekly-summary{background:linear-gradient(135deg,rgba(255,215,0,.05),rgba(255,165,0,.05));border:1px solid var(--gold);border-radius:16px;padding:25px;margin-bottom:25px}
.weekly-summary h3{color:var(--gold);margin-bottom:20px}
.weekly-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:20px}
.streak-badge{padding:4px 10px;border-radius:20px;font-size:.8rem;font-weight:600}
.streak-badge.win-streak{background:rgba(0,200,83,.15);color:var(--green)}
.streak-badge.loss-streak{background:rgba(255,23,68,.15);color:var(--red)}
.breakdown-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px}
.breakdown-card{background:var(--bg3);padding:20px;border-radius:16px;border:1px solid var(--border)}
.breakdown-card h3{margin-bottom:15px}
.breakdown-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border)}
.breakdown-row:last-child{border-bottom:none}
.breakdown-label{color:var(--text2)}
.breakdown-value{font-weight:600}
.checklist-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:20px}
.checklist-section{background:var(--bg3);padding:20px;border-radius:16px;border:1px solid var(--border)}
.checklist-section h3{margin-bottom:15px;color:var(--gold)}
.checklist-item{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border)}
.checklist-item:last-child{border-bottom:none}
.checklist-item input{width:20px;height:20px;accent-color:var(--gold)}
.checklist-item input:checked+label{color:var(--text2);text-decoration:line-through}
.progress-bar{height:8px;background:var(--border);border-radius:4px;overflow:hidden;margin-top:10px}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--gold),var(--gold2));transition:width .3s}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);z-index:1000;align-items:center;justify-content:center;padding:20px}
.modal.active{display:flex}
.modal-content{background:var(--bg3);border-radius:16px;max-width:800px;width:100%;max-height:90vh;overflow-y:auto;border:1px solid var(--border)}
.modal-header{display:flex;justify-content:space-between;align-items:center;padding:20px;border-bottom:1px solid var(--border)}
.modal-close{background:none;border:none;color:var(--text2);font-size:1.8rem;cursor:pointer}
.modal-body{padding:20px}
.trade-detail-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-bottom:20px}
.trade-detail-item{background:var(--bg2);padding:15px;border-radius:8px}
.trade-detail-item label{display:block;font-size:.8rem;color:var(--text2);margin-bottom:5px}
.trade-detail-item span{font-size:1.1rem;font-weight:600}
.settings-grid{display:grid;gap:20px}
.setting-item{display:flex;justify-content:space-between;align-items:center;padding:15px;background:var(--bg2);border-radius:8px}
.setting-item input{padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;color:var(--text);width:120px;text-align:right}
.gallery-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:15px}
.gallery-item{position:relative;border-radius:12px;overflow:hidden;cursor:pointer;border:1px solid var(--border)}
.gallery-item:hover{border-color:var(--gold)}
.gallery-item img{width:100%;height:180px;object-fit:cover}
.gallery-item-info{padding:12px;background:var(--bg2)}
.gallery-item-badge{position:absolute;top:10px;right:10px}
.filter-bar{display:flex;gap:10px;flex-wrap:wrap}
.filter-select{padding:8px 15px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;color:var(--text)}
.account-select{padding:8px 15px;background:var(--bg2);border:1px solid var(--gold);border-radius:8px;color:var(--gold);font-weight:600;cursor:pointer;min-width:150px}
.account-select:focus{outline:none}
.account-badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:.7rem;margin-left:5px}
.strategies-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:20px}
.strategy-card{background:var(--bg2);border-radius:12px;border:1px solid var(--border);overflow:hidden;transition:all .2s}
.strategy-card:hover{border-color:var(--gold);transform:translateY(-2px)}
.strategy-card-header{padding:15px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.strategy-card-header h4{font-size:1rem;display:flex;align-items:center;gap:8px}
.strategy-card-body{padding:15px}
.strategy-rules{font-size:.85rem;color:var(--text2);margin-bottom:10px}
.strategy-rules strong{color:var(--text);display:block;margin-bottom:5px}
.strategy-meta{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.strategy-meta span{font-size:.75rem;padding:4px 8px;background:var(--bg3);border-radius:4px;color:var(--text2)}
.strategy-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:15px;padding-top:15px;border-top:1px solid var(--border)}
.strategy-stat{text-align:center}
.strategy-stat-value{font-size:1.1rem;font-weight:700}
.strategy-stat-label{font-size:.7rem;color:var(--text2)}
.customize-section{background:var(--bg2);padding:15px;border-radius:12px;border:1px solid var(--border)}
.custom-list{display:flex;flex-wrap:wrap;gap:8px}
.custom-item{display:flex;align-items:center;gap:6px;padding:6px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;font-size:.85rem}
.custom-item input{background:transparent;border:none;color:var(--text);width:100px;font-size:.85rem}
.custom-item input:focus{outline:none}
.custom-item button{background:none;border:none;color:var(--red);cursor:pointer;font-size:.9rem;padding:0 4px}
.custom-input{flex:1;padding:8px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;color:var(--text)}
.btn-sm{padding:8px 15px;font-size:.85rem}
.empty-state{text-align:center;padding:60px 20px;color:var(--text2)}
.empty-state-icon{font-size:4rem;margin-bottom:20px}
.toast{position:fixed;bottom:30px;right:30px;padding:15px 25px;background:var(--green);color:#000;border-radius:8px;font-weight:600;transform:translateY(100px);opacity:0;transition:all .3s;z-index:1001}
.toast.show{transform:translateY(0);opacity:1}
.toast.error{background:var(--red);color:#fff}
@media(max-width:1200px){.form-grid{grid-template-columns:repeat(2,1fr)}.charts-grid{grid-template-columns:1fr}}
@media(max-width:768px){.form-grid{grid-template-columns:1fr}.form-group.col-2,.form-group.col-4{grid-column:span 1}.stats-grid{grid-template-columns:repeat(2,1fr)}.trade-detail-grid{grid-template-columns:repeat(2,1fr)}}
</style>
</head>
<body>

<!-- PASSWORD SCREEN -->
<div id="loginScreen">
<div class="login-box">
<div class="logo-icon">ğŸ”</div>
<h2>S&D Trading Journal</h2>
<p>Enter password to access your journal</p>
<input type="password" id="passwordInput" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeypress="if(event.key==='Enter')checkPassword()">
<button onclick="checkPassword()">ğŸ”“ Unlock</button>
<div class="login-error" id="loginError">Incorrect password</div>
</div>
</div>

<!-- MAIN APP (hidden until login) -->
<div id="mainApp">
<div class="container">
<header>
<div class="logo"><div class="logo-icon">ğŸ“Š</div><h1>S&D Journal Pro</h1></div>
<div class="header-actions">
<select id="accountSelect" class="account-select" onchange="switchAccount()">
<option value="all">ğŸ“Š All Accounts</option>
</select>
<button class="btn-icon" onclick="openAccountManager()" title="Manage Accounts">ğŸ¦</button>
<div class="daily-limit" id="dailyLimitDisplay">Today: <span id="todayPnL">$0</span> / <span id="dailyLimit">-$200</span></div>
<span id="storageIndicator" style="font-size:.75rem;color:var(--text2);cursor:pointer" onclick="showStorageInfo()" title="Click for storage info">ğŸ’¾</span>
<button class="btn-icon" onclick="openSettings()">âš™ï¸</button>
<button class="btn btn-secondary" onclick="exportData()">ğŸ“¥ Export</button>
<button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">ğŸ“¤ Import</button>
<input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
<button class="btn btn-primary" onclick="showTab('entry')">+ New Trade</button>
</div>
</header>
<div class="tabs">
<button class="tab active" onclick="showTab('dashboard')">ğŸ“Š Dashboard</button>
<button class="tab" onclick="showTab('calendar')">ğŸ“… Calendar</button>
<button class="tab" onclick="showTab('entry')">âœï¸ New Trade</button>
<button class="tab" onclick="showTab('history')">ğŸ“œ History</button>
<button class="tab" onclick="showTab('analytics')">ğŸ“ˆ Analytics</button>
<button class="tab" onclick="showTab('strategies')">ğŸ“‹ Strategies</button>
<button class="tab" onclick="showTab('pairanalysis')">ğŸ”¬ Pair Analysis</button>
<button class="tab" onclick="showTab('checklist')">âœ… Quality Scorer</button>
<button class="tab" onclick="showTab('tradingplan')">ğŸ“ Trading Plan</button>
<button class="tab" onclick="showTab('seasonality')">ğŸ—“ï¸ Seasonality</button>
<button class="tab" onclick="showTab('gallery')">ğŸ–¼ï¸ Screenshots</button>
<button class="tab" onclick="showTab('customize')">ğŸ¨ Customize</button>
</div>

<div id="dashboard" class="tab-content active">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
<h2 style="margin:0">ğŸ“Š Dashboard</h2>
<button class="btn btn-primary" onclick="generateWeeklyReport()">ğŸ“„ Weekly PDF Report</button>
</div>
<div class="weekly-summary" id="weeklySummary"></div>
<div class="stats-grid" id="statsGrid"></div>
<div class="charts-grid">
<div class="chart-card"><h3>ğŸ“ˆ Equity Curve</h3><div class="chart-container"><canvas id="equityChart"></canvas></div></div>
<div class="chart-card"><h3>ğŸ¯ Win/Loss</h3><div class="chart-container"><canvas id="winLossChart"></canvas></div></div>
</div>
<div class="breakdown-grid" id="breakdownGrid"></div>
</div>

<div id="calendar" class="tab-content">
<div class="calendar-container">
<div class="calendar-header">
<div class="calendar-nav">
<button class="btn-icon" onclick="changeMonth(-1)">â—€</button>
<h3 id="calendarTitle">January 2025</h3>
<button class="btn-icon" onclick="changeMonth(1)">â–¶</button>
</div>
<button class="btn btn-secondary" onclick="goToToday()">Today</button>
</div>
<div class="calendar-grid" id="calendarGrid"></div>
<div class="calendar-summary" id="calendarSummary"></div>
</div>
</div>

<div id="entry" class="tab-content">
<div class="card"><div class="card-header"><h3>âœï¸ Log Trade</h3><span id="editIndicator" style="display:none;color:var(--gold)">Editing</span></div>
<div class="card-body">
<form id="tradeForm"><input type="hidden" id="editId">
<div class="form-grid">
<div class="form-group"><label>Account</label><select id="tradeAccount"></select></div>
<div class="form-group"><label>Strategy</label><select id="tradeStrategy"><option value="">No Strategy</option></select></div>
<div class="form-group"><label>Date & Time</label><input type="datetime-local" id="tradeDate" required></div>
<div class="form-group"><label>Session</label><select id="tradeSession" required><option value="">Select...</option><option>Asian</option><option>London</option><option>New York</option><option>Overlap</option></select></div>
<div class="form-group"><label>Pair</label><select id="tradePair" required><option value="">Select...</option>
<optgroup label="Forex Majors"><option>EURUSD</option><option>GBPUSD</option><option>USDJPY</option><option>USDCHF</option><option>AUDUSD</option><option>USDCAD</option><option>NZDUSD</option></optgroup>
<optgroup label="Forex Minors"><option>EURGBP</option><option>EURJPY</option><option>GBPJPY</option><option>AUDJPY</option><option>EURAUD</option><option>GBPAUD</option><option>EURCHF</option><option>GBPCHF</option><option>AUDNZD</option><option>NZDJPY</option><option>CADJPY</option><option>CHFJPY</option><option>EURCAD</option><option>GBPCAD</option><option>AUDCAD</option><option>GBPNZD</option><option>EURNZD</option></optgroup>
<optgroup label="Exotics"><option>USDZAR</option><option>USDMXN</option><option>USDTRY</option><option>USDSEK</option><option>USDNOK</option><option>USDSGD</option><option>USDCNH</option></optgroup>
<optgroup label="Metals"><option>XAUUSD</option><option>XAGUSD</option><option>XPTUSD</option></optgroup>
<optgroup label="US Indices"><option>US30</option><option>US500</option><option>NAS100</option><option>US2000</option></optgroup>
<optgroup label="EU Indices"><option>GER40</option><option>UK100</option><option>FRA40</option><option>EU50</option></optgroup>
<optgroup label="Asia Indices"><option>JPN225</option><option>AUS200</option><option>HK50</option><option>CHINA50</option></optgroup>
<optgroup label="Crypto"><option>BTCUSD</option><option>ETHUSD</option><option>LTCUSD</option><option>XRPUSD</option><option>SOLUSD</option><option>BNBUSD</option><option>ADAUSD</option><option>DOGEUSD</option></optgroup>
<optgroup label="Commodities"><option>USOIL</option><option>UKOIL</option><option>NATGAS</option><option>COPPER</option></optgroup>
<optgroup label="Agriculture"><option>WHEAT</option><option>CORN</option><option>SOYBEAN</option><option>COFFEE</option><option>SUGAR</option><option>COCOA</option><option>COTTON</option><option>OJ</option><option>RICE</option><option>OATS</option><option>CATTLE</option><option>HOGS</option></optgroup>
<optgroup label="NASDAQ Stocks"><option>AAPL</option><option>MSFT</option><option>GOOGL</option><option>GOOG</option><option>AMZN</option><option>NVDA</option><option>META</option><option>TSLA</option><option>AMD</option><option>NFLX</option><option>ADBE</option><option>INTC</option><option>CSCO</option><option>AVGO</option><option>COST</option><option>PEP</option><option>CMCSA</option><option>QCOM</option><option>TMUS</option><option>AMGN</option><option>SBUX</option><option>INTU</option><option>ISRG</option><option>MDLZ</option><option>GILD</option><option>VRTX</option><option>ADI</option><option>REGN</option><option>LRCX</option><option>PANW</option><option>KLAC</option><option>SNPS</option><option>CDNS</option><option>MRVL</option><option>FTNT</option><option>ABNB</option><option>CRWD</option><option>DXCM</option><option>MELI</option><option>ORLY</option><option>WDAY</option><option>TEAM</option><option>AZN</option><option>MRNA</option><option>DDOG</option><option>ZS</option><option>OKTA</option><option>MDB</option><option>NET</option><option>SNOW</option><option>SMCI</option><option>ARM</option><option>PLTR</option><option>COIN</option><option>HOOD</option><option>RIVN</option><option>LCID</option><option>SOFI</option><option>AFRM</option><option>U</option><option>RBLX</option><option>SHOP</option><option>ROKU</option><option>ZM</option><option>PYPL</option><option>UBER</option><option>LYFT</option></optgroup>
<optgroup label="S&P 500 Stocks"><option>JPM</option><option>V</option><option>JNJ</option><option>WMT</option><option>PG</option><option>MA</option><option>HD</option><option>CVX</option><option>MRK</option><option>ABBV</option><option>KO</option><option>BAC</option><option>PFE</option><option>TMO</option><option>ORCL</option><option>DIS</option><option>CRM</option><option>ACN</option><option>VZ</option><option>NKE</option><option>MCD</option><option>XOM</option><option>T</option><option>UNH</option><option>LLY</option><option>BRK.B</option><option>SPY</option><option>SQ</option><option>RACE</option></optgroup>
<optgroup label="DOW 30 Stocks"><option>CAT</option><option>BA</option><option>GS</option><option>MMM</option><option>IBM</option><option>TRV</option><option>AXP</option><option>HON</option><option>DOW</option><option>WBA</option></optgroup>
<optgroup label="Russell 2000"><option>IWM</option><option>AMC</option><option>GME</option><option>SPCE</option><option>PLUG</option><option>FCEL</option><option>BBBY</option><option>CLOV</option><option>WISH</option><option>SKLZ</option></optgroup>
</select></div>
<div class="form-group"><label>Timeframe</label><select id="tradeTimeframe" required><option value="">Select...</option><option>M1</option><option>M3</option><option>M5</option><option>M15</option><option>M30</option><option>H1</option><option>H2</option><option>H4</option><option>H8</option><option>D1</option><option>W1</option><option>MN</option></select></div>
<div class="form-group"><label>Direction</label><div class="toggle-group"><button type="button" class="toggle-btn long" onclick="setDirection('Long')">ğŸŸ¢ LONG</button><button type="button" class="toggle-btn short" onclick="setDirection('Short')">ğŸ”´ SHORT</button></div><input type="hidden" id="tradeDirection" required></div>
<div class="form-group"><label>Zone Type</label><div class="toggle-group"><button type="button" class="toggle-btn demand" onclick="setZone('Demand')">ğŸŸ¦ DEMAND</button><button type="button" class="toggle-btn supply" onclick="setZone('Supply')">ğŸŸ§ SUPPLY</button></div><input type="hidden" id="tradeZone" required></div>
<div class="form-group"><label>Setup Quality</label><select id="tradeSetup" required><option value="">Select...</option><option>Fresh Zone</option><option>1st Touch</option><option>2nd Touch</option><option>3rd+ Touch</option><option>Confluence</option><option>HTF Alignment</option><option>Liquidity Grab</option><option>BOS Entry</option><option>Flip Zone</option></select></div>
<div class="form-group"><label>HTF Bias</label><select id="tradeHTFBias"><option value="">Select...</option><option>Bullish</option><option>Bearish</option><option>Ranging</option></select></div>
<div class="form-group"><label>HTF Trend (W1/D1)</label><select id="tradeHTFTrend"><option value="">Select...</option><option value="Strong Up">ğŸ“ˆ Strong Uptrend</option><option value="Weak Up">â†—ï¸ Weak Uptrend</option><option value="Ranging">â†”ï¸ Ranging</option><option value="Weak Down">â†˜ï¸ Weak Downtrend</option><option value="Strong Down">ğŸ“‰ Strong Downtrend</option></select></div>
<div class="form-group"><label>Execution TF</label><select id="tradeExecTF"><option value="">Select...</option><option>M1</option><option>M3</option><option>M5</option><option>M15</option><option>M30</option><option>H1</option><option>H2</option><option>H4</option><option>H8</option><option>D1</option><option>W1</option><option>MN</option></select></div>
<div class="form-group"><label>Exec TF Trend</label><select id="tradeExecTrend"><option value="">Select...</option><option value="With HTF">âœ… With HTF</option><option value="Against HTF">âš ï¸ Against HTF</option><option value="Reversal">ğŸ”„ Reversal Play</option></select></div>
</div>
<div class="card" style="margin-top:20px;border-color:var(--blue)"><div class="card-header" style="background:rgba(68,138,255,.1)"><h3>ğŸ¯ OTC Zone Quality Score</h3></div><div class="card-body"><div class="form-grid">
<div class="form-group"><label>Liquidity Context</label><select id="tradeLiquidity"><option value="">Select...</option><option value="2">2 - Liquidity Taken First</option><option value="1">1 - Unclear</option><option value="0">0 - None</option></select></div>
<div class="form-group"><label>Arrival Quality</label><select id="tradeArrival"><option value="">Select...</option><option value="2">2 - Fast & Clean</option><option value="1">1 - Choppy</option></select></div>
<div class="form-group"><label>Base Quality (Candles)</label><select id="tradeBaseCandles"><option value="">Select...</option><option value="1">1 Candle</option><option value="2">2 Candles</option><option value="3">3 Candles</option><option value="4">4 Candles</option><option value="5">5 Candles</option><option value="6">6 Candles (Max)</option></select></div>
<div class="form-group"><label>Base Volume Score</label><input type="number" id="tradeBaseVolume" min="0.1" max="100" step="0.1" placeholder="0.1 - 100"></div>
<div class="form-group"><label>Leg-Out Strength</label><select id="tradeLegOut"><option value="">Select...</option><option value="Massive">ğŸ’ª Massive</option><option value="Normal">ğŸ“Š Normal</option></select></div>
<div class="form-group"><label>Zone Freshness</label><select id="tradeZoneFresh"><option value="">Select...</option><option value="Fresh">âœ¨ Fresh</option><option value="1 Touch">1st Touch</option><option value="2 Touch">2nd Touch</option><option value="3+ Touch">3rd+ Touch</option></select></div>
<div class="form-group"><label>Big Brother (HTF Zone)</label><select id="tradeBigBro"><option value="">Select TF...</option><option>MN</option><option>W1</option><option>D1</option><option>H4</option><option>H1</option><option>None</option></select></div>
<div class="form-group"><label>Small Brother (LTF Zone)</label><select id="tradeSmallBro"><option value="">Select TF...</option><option>H4</option><option>H1</option><option>M30</option><option>M15</option><option>M5</option><option>M1</option><option>None</option></select></div>
<div class="form-group"><label>Flip Zone?</label><select id="tradeFlipZone"><option value="">Select...</option><option value="Yes">âœ… Yes</option><option value="No">âŒ No</option></select></div>
<div class="form-group"><label>Zone Score</label><div class="rr-display" style="padding:10px"><div class="rr-value" id="zoneScoreDisplay">-</div><div class="rr-label">Auto-calculated</div></div></div>
</div></div></div>
<div class="card" style="margin-top:20px"><div class="card-header"><h3>ğŸ’° Position & Risk</h3></div><div class="card-body"><div class="form-grid">
<div class="form-group"><label>Entry Price</label><input type="number" id="tradeEntry" step="any" required oninput="calculateRR()"></div>
<div class="form-group"><label>Stop Loss</label><input type="number" id="tradeSL" step="any" required oninput="calculateRR()"></div>
<div class="form-group"><label>Take Profit</label><input type="number" id="tradeTP" step="any" required oninput="calculateRR()"></div>
<div class="form-group"><label>R:R Ratio</label><div class="rr-display"><div class="rr-value" id="rrDisplay">-</div><div class="rr-label">Risk : Reward</div></div></div>
<div class="form-group"><label>Position Size</label><input type="number" id="tradeSize" step="0.01" required></div>
<div class="form-group"><label>Risk ($)</label><input type="number" id="tradeRisk" step="0.01" required></div>
<div class="form-group"><label>Outcome</label><select id="tradeOutcome" required onchange="togglePnL()"><option value="Open">â³ Open</option><option value="Win">âœ… Win</option><option value="Loss">âŒ Loss</option><option value="BE">â– BE</option></select></div>
<div class="form-group" id="pnlGroup"><label>P&L ($)</label><input type="number" id="tradePnL" step="0.01"></div>
<div class="form-group col-2"><label>Mental State (1-5)</label><div class="emotion-rating"><button type="button" class="emotion-btn" onclick="setEmotion(1)" data-v="1">ğŸ˜«</button><button type="button" class="emotion-btn" onclick="setEmotion(2)" data-v="2">ğŸ˜•</button><button type="button" class="emotion-btn selected" onclick="setEmotion(3)" data-v="3">ğŸ˜</button><button type="button" class="emotion-btn" onclick="setEmotion(4)" data-v="4">ğŸ™‚</button><button type="button" class="emotion-btn" onclick="setEmotion(5)" data-v="5">ğŸ˜</button></div><input type="hidden" id="tradeEmotion" value="3"></div>
<div class="form-group col-2"><label>Execution Rating</label><div style="display:flex;gap:8px"><button type="button" class="rating-btn a" onclick="setRating('A')">A</button><button type="button" class="rating-btn b" onclick="setRating('B')">B</button><button type="button" class="rating-btn c" onclick="setRating('C')">C</button></div><input type="hidden" id="tradeRating"></div>
<div class="form-group col-4"><label>Mistakes</label><div class="mistake-tags" id="mistakeTags"><button type="button" class="mistake-tag" data-v="FOMO">FOMO</button><button type="button" class="mistake-tag" data-v="Revenge">Revenge</button><button type="button" class="mistake-tag" data-v="Moved SL">Moved SL</button><button type="button" class="mistake-tag" data-v="Early Exit">Early Exit</button><button type="button" class="mistake-tag" data-v="Late Entry">Late Entry</button><button type="button" class="mistake-tag" data-v="Wrong Size">Wrong Size</button><button type="button" class="mistake-tag" data-v="No Confirm">No Confirm</button><button type="button" class="mistake-tag" data-v="Against HTF">Against HTF</button><button type="button" class="mistake-tag" data-v="Overtrading">Overtrading</button><button type="button" class="mistake-tag" data-v="Tired">Tired</button></div><input type="hidden" id="tradeMistakes"></div>
<div class="form-group col-2"><label>Screenshot</label><input type="file" id="tradeScreenshot" accept="image/*" onchange="previewImg()"><img id="imgPreview" style="max-width:100%;max-height:150px;border-radius:8px;margin-top:10px;display:none"></div>
<div class="form-group col-2"><label>Pre-Trade Notes</label><textarea id="tradePreNotes" placeholder="Analysis..."></textarea></div>
<div class="form-group col-2"><label>Post-Trade Review</label><textarea id="tradePostNotes" placeholder="What happened..."></textarea></div>
<div class="form-group col-2"><label>Lessons Learned</label><textarea id="tradeLessons" placeholder="Key takeaway..."></textarea></div>
</div></div></div>
<div class="form-actions"><button type="submit" class="btn btn-primary">ğŸ’¾ Save Trade</button><button type="button" class="btn btn-secondary" onclick="resetForm()">ğŸ”„ Reset</button></div>
</form></div></div>
</div>

<div id="history" class="tab-content">
<div class="card"><div class="card-header"><h3>ğŸ“œ Trade History</h3>
<div class="filter-bar">
<select class="filter-select" id="filterOutcome" onchange="filterTrades()"><option value="">All</option><option value="Win">Wins</option><option value="Loss">Losses</option><option value="Open">Open</option></select>
<select class="filter-select" id="filterPair" onchange="filterTrades()"><option value="">All Pairs</option></select>
<select class="filter-select" id="filterZone" onchange="filterTrades()"><option value="">All Zones</option><option value="Demand">Demand</option><option value="Supply">Supply</option></select>
<input type="date" class="filter-select" id="filterFrom" onchange="filterTrades()">
<input type="date" class="filter-select" id="filterTo" onchange="filterTrades()">
</div>
</div>
<div style="overflow-x:auto"><table><thead><tr><th>#</th><th>Account</th><th>Date</th><th>Session</th><th>Pair</th><th>Dir</th><th>Zone</th><th>TF</th><th>Setup</th><th>R:R</th><th>Rating</th><th>Result</th><th>P&L</th><th>Actions</th></tr></thead><tbody id="tradesTable"></tbody></table></div></div>
</div>

<div id="analytics" class="tab-content">
<!-- TOP STATS ROW -->
<div class="stats-grid" style="margin-bottom:25px">
<div class="stat-card"><div class="stat-label">ğŸ”¥ Current Streak</div><div class="stat-value" id="currentStreak">-</div></div>
<div class="stat-card"><div class="stat-label">ğŸ† Best Streak</div><div class="stat-value positive" id="bestStreak">-</div></div>
<div class="stat-card"><div class="stat-label">ğŸ“‰ Worst Streak</div><div class="stat-value negative" id="worstStreak">-</div></div>
<div class="stat-card"><div class="stat-label">ğŸ“… Best Day</div><div class="stat-value gold" id="bestDay">-</div></div>
<div class="stat-card"><div class="stat-label">â° Best Session</div><div class="stat-value gold" id="bestSession">-</div></div>
</div>

<!-- COMPARISON CARDS -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:20px;margin-bottom:25px">
<div class="card" style="background:var(--bg2)">
<div class="card-header"><h4>ğŸ“Š Backtest vs Live Win Rate</h4></div>
<div class="card-body" id="backtestVsLiveComparison"></div>
</div>
<div class="card" style="background:var(--bg2)">
<div class="card-header"><h4>ğŸ† Best Performing Pairs</h4></div>
<div class="card-body" id="bestPairsRanking"></div>
</div>
<div class="card" style="background:var(--bg2)">
<div class="card-header"><h4>ğŸ’© Worst Performing Pairs</h4></div>
<div class="card-body" id="worstPairsRanking"></div>
</div>
</div>

<!-- CHARTS -->
<div class="charts-grid">
<div class="chart-card"><h3>ğŸ“… Monthly P&L</h3><div class="chart-container"><canvas id="monthlyChart"></canvas></div></div>
<div class="chart-card"><h3>ğŸ“† By Day of Week</h3><div class="chart-container"><canvas id="dowChart"></canvas></div></div>
<div class="chart-card"><h3>ğŸ’± By Pair</h3><div class="chart-container"><canvas id="pairChart"></canvas></div></div>
<div class="chart-card"><h3>â° By Session</h3><div class="chart-container"><canvas id="sessionChart"></canvas></div></div>
<div class="chart-card"><h3>ğŸ“Š By Timeframe</h3><div class="chart-container"><canvas id="tfChart"></canvas></div></div>
<div class="chart-card"><h3>ğŸ¯ By Setup</h3><div class="chart-container"><canvas id="setupChart"></canvas></div></div>
<div class="chart-card"><h3>ğŸ§  By Mental State</h3><div class="chart-container"><canvas id="emotionChart"></canvas></div></div>
<div class="chart-card"><h3>âš ï¸ Common Mistakes</h3><div class="chart-container"><canvas id="mistakesChart"></canvas></div></div>
</div>
</div>

<div id="strategies" class="tab-content">
<div class="card" style="margin-bottom:20px">
<div class="card-header"><h3>ğŸ“‹ My Trading Strategies</h3><button class="btn btn-primary" onclick="openStrategyEditor()">+ New Strategy</button></div>
<div class="card-body"><div id="strategiesList" class="strategies-grid"></div></div>
</div>
<div class="card" style="margin-bottom:20px">
<div class="card-header"><h3>ğŸ“Š Strategy Performance (Live Trades)</h3></div>
<div class="card-body"><div id="strategyPerformance"></div></div>
</div>
<div class="card" style="margin-bottom:20px">
<div class="card-header"><h3>ğŸ§ª Strategy Backtester</h3><button class="btn btn-primary" onclick="openBacktestModal()">+ Add Backtest</button></div>
<div class="card-body">
<p style="color:var(--text2);margin-bottom:15px;font-size:.9rem">Log backtested trades to track strategy win rates before going live.</p>
<div id="backtestStats" class="stats-grid" style="margin-bottom:20px"></div>
<div style="overflow-x:auto"><table><thead><tr><th>Strategy</th><th>Date</th><th>Pair</th><th>Direction</th><th>Result</th><th>R:R</th><th>Notes</th><th>Actions</th></tr></thead><tbody id="backtestTable"></tbody></table></div>
</div>
</div>
<div class="card">
<div class="card-header"><h3>ğŸš« Trades Not Taken</h3><button class="btn btn-primary" onclick="openMissedTradeModal()">+ Add Missed Trade</button></div>
<div class="card-body">
<p style="color:var(--text2);margin-bottom:15px;font-size:.9rem">Track setups you identified but didn't take. See what you're missing!</p>
<div id="missedStats" class="stats-grid" style="margin-bottom:20px"></div>
<div style="overflow-x:auto"><table><thead><tr><th>Strategy</th><th>Date</th><th>Pair</th><th>Direction</th><th>Zone</th><th>Would Have Won?</th><th>Reason</th><th>Screenshot</th><th>Actions</th></tr></thead><tbody id="missedTable"></tbody></table></div>
</div>
</div>
</div>

<div id="pairanalysis" class="tab-content">
<div class="card">
<div class="card-header">
<h3>ğŸ”¬ Backtested Pair Analysis</h3>
<div style="display:flex;gap:10px;align-items:center">
<select id="pairAnalysisFilter" class="filter-select" onchange="updatePairAnalysisTable()" style="min-width:150px">
<option value="">ğŸ“Š All Pairs</option>
</select>
<button class="btn btn-secondary" onclick="openColumnManager()">âš™ï¸ Manage Columns</button>
<button class="btn btn-primary" onclick="openPairAnalysisModal()">+ Add Entry</button>
</div>
</div>
<div class="card-body">
<p style="color:var(--text2);margin-bottom:15px;font-size:.9rem">Track your pair analysis and backtesting results. Customize columns to match your analysis criteria.</p>

<!-- PAIR ANALYSIS STATS -->
<div id="pairAnalyticsStats" class="stats-grid" style="margin-bottom:25px"></div>

<!-- DETAILED ANALYTICS -->
<div id="pairAnalyticsDetailed" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:25px"></div>

<div style="overflow-x:auto">
<table id="pairAnalysisTable">
<thead><tr id="pairAnalysisHeader"></tr></thead>
<tbody id="pairAnalysisBody"></tbody>
</table>
</div>
</div>
</div>
</div>

<!-- TRADING PLAN SECTION -->
<div id="tradingplan" class="tab-content">
<div class="card">
<div class="card-header">
<h3>ğŸ“ My Trading Plan</h3>
<button class="btn btn-primary" onclick="saveTradingPlan()">ğŸ’¾ Save Plan</button>
</div>
<div class="card-body">
<p style="color:var(--text2);margin-bottom:20px">Document your complete trading plan. This is your rulebook - review it before every trading session!</p>

<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:20px">

<!-- TRADING IDENTITY -->
<div class="trading-plan-section" style="background:var(--bg2);border-radius:12px;padding:20px;border-left:4px solid var(--gold)">
<h4 style="color:var(--gold);margin-bottom:15px">ğŸ¯ Trading Identity</h4>
<div class="form-group" style="margin-bottom:15px">
<label style="color:var(--text2);font-size:.85rem">What type of trader am I?</label>
<textarea id="planIdentity" placeholder="e.g., I am a supply & demand trader focused on 4H/Daily zones with LTF confirmation..." style="width:100%;min-height:80px;padding:12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);resize:vertical"></textarea>
</div>
<div class="form-group">
<label style="color:var(--text2);font-size:.85rem">My trading goals</label>
<textarea id="planGoals" placeholder="e.g., Consistent 5% monthly return, max 2% daily drawdown..." style="width:100%;min-height:80px;padding:12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);resize:vertical"></textarea>
</div>
</div>

<!-- MARKET CONDITIONS -->
<div class="trading-plan-section" style="background:var(--bg2);border-radius:12px;padding:20px;border-left:4px solid var(--green)">
<h4 style="color:var(--green);margin-bottom:15px">ğŸ“Š When I Trade</h4>
<div class="form-group" style="margin-bottom:15px">
<label style="color:var(--text2);font-size:.85rem">Sessions I trade</label>
<textarea id="planSessions" placeholder="e.g., London session (8:00-12:00), NY open (14:30-17:00)..." style="width:100%;min-height:60px;padding:12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);resize:vertical"></textarea>
</div>
<div class="form-group" style="margin-bottom:15px">
<label style="color:var(--text2);font-size:.85rem">Pairs I trade</label>
<textarea id="planPairs" placeholder="e.g., EURUSD, GBPUSD, XAUUSD only..." style="width:100%;min-height:60px;padding:12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);resize:vertical"></textarea>
</div>
<div class="form-group">
<label style="color:var(--text2);font-size:.85rem">Conditions I avoid</label>
<textarea id="planAvoid" placeholder="e.g., High impact news, Friday afternoons, low volume Asia..." style="width:100%;min-height:60px;padding:12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);resize:vertical"></textarea>
</div>
</div>

<!-- ENTRY RULES -->
<div class="trading-plan-section" style="background:var(--bg2);border-radius:12px;padding:20px;border-left:4px solid #448AFF">
<h4 style="color:#448AFF;margin-bottom:15px">ğŸ“¥ Entry Rules</h4>
<div class="form-group" style="margin-bottom:15px">
<label style="color:var(--text2);font-size:.85rem">HTF Analysis (D1/4H)</label>
<textarea id="planHTF" placeholder="e.g., Identify HTF trend, locate fresh S&D zones, mark key levels..." style="width:100%;min-height:80px;padding:12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);resize:vertical"></textarea>
</div>
<div class="form-group" style="margin-bottom:15px">
<label style="color:var(--text2);font-size:.85rem">LTF Entry (15m/5m/1m)</label>
<textarea id="planLTF" placeholder="e.g., Wait for LTF CHoCH, enter on FVG or OB, confirm with volume..." style="width:100%;min-height:80px;padding:12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);resize:vertical"></textarea>
</div>
<div class="form-group">
<label style="color:var(--text2);font-size:.85rem">Entry Checklist</label>
<textarea id="planEntryChecklist" placeholder="1. HTF zone identified
2. Price in premium/discount
3. LTF structure shift
4. Entry model confirmed
5. R:R minimum 2:1" style="width:100%;min-height:100px;padding:12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);resize:vertical"></textarea>
</div>
</div>

<!-- EXIT RULES -->
<div class="trading-plan-section" style="background:var(--bg2);border-radius:12px;padding:20px;border-left:4px solid #E040FB">
<h4 style="color:#E040FB;margin-bottom:15px">ğŸ“¤ Exit Rules</h4>
<div class="form-group" style="margin-bottom:15px">
<label style="color:var(--text2);font-size:.85rem">Take Profit Rules</label>
<textarea id="planTP" placeholder="e.g., TP1 at 1:1 (partials), TP2 at opposing zone, trail after 2R..." style="width:100%;min-height:80px;padding:12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);resize:vertical"></textarea>
</div>
<div class="form-group">
<label style="color:var(--text2);font-size:.85rem">Stop Loss Rules</label>
<textarea id="planSL" placeholder="e.g., SL below/above zone, never move SL against trade, max 1% risk per trade..." style="width:100%;min-height:80px;padding:12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);resize:vertical"></textarea>
</div>
</div>

<!-- RISK MANAGEMENT -->
<div class="trading-plan-section" style="background:var(--bg2);border-radius:12px;padding:20px;border-left:4px solid var(--red)">
<h4 style="color:var(--red);margin-bottom:15px">âš ï¸ Risk Management</h4>
<div class="form-group" style="margin-bottom:15px">
<label style="color:var(--text2);font-size:.85rem">Position Sizing</label>
<textarea id="planRisk" placeholder="e.g., 1% risk per trade, max 2 trades per day, max 3% daily drawdown..." style="width:100%;min-height:80px;padding:12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);resize:vertical"></textarea>
</div>
<div class="form-group">
<label style="color:var(--text2);font-size:.85rem">Drawdown Rules</label>
<textarea id="planDrawdown" placeholder="e.g., Stop trading after 3 consecutive losses, reduce size by 50% after 5% drawdown..." style="width:100%;min-height:80px;padding:12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);resize:vertical"></textarea>
</div>
</div>

<!-- PSYCHOLOGY -->
<div class="trading-plan-section" style="background:var(--bg2);border-radius:12px;padding:20px;border-left:4px solid #FF9800">
<h4 style="color:#FF9800;margin-bottom:15px">ğŸ§  Psychology Rules</h4>
<div class="form-group" style="margin-bottom:15px">
<label style="color:var(--text2);font-size:.85rem">Pre-Trading Routine</label>
<textarea id="planPreRoutine" placeholder="e.g., Review trading plan, check economic calendar, mark key levels, meditate 5min..." style="width:100%;min-height:80px;padding:12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);resize:vertical"></textarea>
</div>
<div class="form-group" style="margin-bottom:15px">
<label style="color:var(--text2);font-size:.85rem">Rules to Follow</label>
<textarea id="planRules" placeholder="1. No revenge trading
2. No trading when tired/emotional
3. Accept every loss as cost of business
4. Stick to the plan no matter what
5. Journal every trade" style="width:100%;min-height:100px;padding:12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);resize:vertical"></textarea>
</div>
<div class="form-group">
<label style="color:var(--text2);font-size:.85rem">Post-Trading Routine</label>
<textarea id="planPostRoutine" placeholder="e.g., Journal all trades, review screenshots, calculate daily P&L, weekly review on Sunday..." style="width:100%;min-height:80px;padding:12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);resize:vertical"></textarea>
</div>
</div>

</div>

<!-- NOTES SECTION -->
<div style="margin-top:20px;background:var(--bg2);border-radius:12px;padding:20px">
<h4 style="color:var(--gold);margin-bottom:15px">ğŸ“‹ Additional Notes</h4>
<textarea id="planNotes" placeholder="Any other rules, reminders, or notes for yourself..." style="width:100%;min-height:120px;padding:12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);resize:vertical"></textarea>
</div>

<div style="margin-top:20px;display:flex;gap:10px">
<button class="btn btn-primary" onclick="saveTradingPlan()">ğŸ’¾ Save Trading Plan</button>
<button class="btn btn-secondary" onclick="exportTradingPlan()">ğŸ“„ Export as PDF</button>
<button class="btn btn-secondary" onclick="showPlanBeforeTrade()">ğŸ‘ï¸ Show Before Each Trade</button>
</div>

</div>
</div>
</div>

<!-- SEASONALITY SECTION -->
<div id="seasonality" class="tab-content">
<div class="card">
<div class="card-header">
<h3>ğŸ—“ï¸ Seasonal Tendencies</h3>
<div style="display:flex;gap:10px;align-items:center">
<select id="seasonalityMonth" class="filter-select" onchange="filterSeasonality()">
<option value="">All Months</option>
<option value="1">January</option>
<option value="2">February</option>
<option value="3">March</option>
<option value="4">April</option>
<option value="5">May</option>
<option value="6">June</option>
<option value="7">July</option>
<option value="8">August</option>
<option value="9">September</option>
<option value="10">October</option>
<option value="11">November</option>
<option value="12">December</option>
</select>
<select id="seasonalityCategory" class="filter-select" onchange="filterSeasonality()">
<option value="">All Categories</option>
<option value="indices">Indices</option>
<option value="forex">Forex</option>
<option value="metals">Metals</option>
<option value="energy">Energy</option>
<option value="agriculture">Agriculture</option>
<option value="crypto">Crypto</option>
</select>
<button class="btn btn-secondary" onclick="openAddSeasonalModal()">+ Add Custom</button>
</div>
</div>
<div class="card-body">
<p style="color:var(--text2);margin-bottom:20px">Historical seasonal patterns based on decades of market data. Use as confluence, not as standalone signals!</p>

<!-- CURRENT MONTH HIGHLIGHT -->
<div id="currentMonthSeasonals" style="margin-bottom:30px"></div>

<!-- ALL SEASONALS BY MONTH -->
<div id="seasonalityGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:20px"></div>

</div>
</div>
</div>

<!-- ADD SEASONAL MODAL -->
<div class="modal" id="addSeasonalModal"><div class="modal-content" style="max-width:500px"><div class="modal-header"><h3>â• Add Custom Seasonal</h3><button class="modal-close" onclick="closeModal('addSeasonalModal')">Ã—</button></div><div class="modal-body">
<div class="form-group" style="margin-bottom:15px"><label>Instrument</label><input type="text" id="seasonalInstrument" placeholder="e.g., XAUUSD, Sugar, SPX" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"></div>
<div class="form-group" style="margin-bottom:15px"><label>Month(s)</label><input type="text" id="seasonalMonths" placeholder="e.g., December or Nov-Jan" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"></div>
<div class="form-group" style="margin-bottom:15px"><label>Direction</label><select id="seasonalDirection" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"><option value="bullish">ğŸŸ¢ Bullish</option><option value="bearish">ğŸ”´ Bearish</option></select></div>
<div class="form-group" style="margin-bottom:15px"><label>Win Rate %</label><input type="number" id="seasonalWinRate" placeholder="e.g., 75" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"></div>
<div class="form-group" style="margin-bottom:15px"><label>Category</label><select id="seasonalCategory" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"><option value="indices">Indices</option><option value="forex">Forex</option><option value="metals">Metals</option><option value="energy">Energy</option><option value="agriculture">Agriculture</option><option value="crypto">Crypto</option></select></div>
<div class="form-group" style="margin-bottom:15px"><label>Description</label><textarea id="seasonalDescription" placeholder="e.g., Santa Claus Rally - last 5 trading days + first 2 of new year" style="width:100%;min-height:80px;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"></textarea></div>
<div style="display:flex;gap:10px"><button class="btn btn-primary" onclick="saveCustomSeasonal()">ğŸ’¾ Save</button><button class="btn btn-secondary" onclick="closeModal('addSeasonalModal')">Cancel</button></div>
</div></div></div>

<div id="gallery" class="tab-content">
<div class="card"><div class="card-header"><h3>ğŸ–¼ï¸ Screenshots</h3><select class="filter-select" id="galleryFilter" onchange="updateGallery()"><option value="">All</option><option value="Win">Wins</option><option value="Loss">Losses</option></select></div>
<div class="card-body"><div class="gallery-grid" id="galleryGrid"></div></div></div>
</div>

<div id="checklist" class="tab-content">
<div class="card">
<div class="card-header">
<h3>ğŸ“‹ Trade Quality Scorer</h3>
<div style="display:flex;gap:10px">
<select id="qualityStrategy" class="filter-select" onchange="loadQualityChecklist()" style="min-width:150px">
<option value="">Select Strategy...</option>
</select>
<button class="btn btn-secondary" onclick="openQualityEditor()">âš™ï¸ Edit Checklists</button>
</div>
</div>
<div class="card-body">

<!-- QUALITY SCORE DISPLAY -->
<div style="display:grid;grid-template-columns:1fr 300px;gap:30px;margin-bottom:30px">
<div id="qualityChecklistArea">
<p style="color:var(--text2);text-align:center;padding:40px">Select a strategy to load its checklist</p>
</div>

<!-- SCORE PANEL -->
<div style="background:var(--bg2);border-radius:12px;padding:20px">
<div style="text-align:center;margin-bottom:20px">
<div style="font-size:3rem;font-weight:700" id="qualityScoreValue">-</div>
<div style="color:var(--text2)">Quality Score</div>
</div>
<div style="display:flex;justify-content:center;gap:30px;margin-bottom:20px">
<div style="text-align:center"><div style="font-size:1.5rem;color:var(--green)" id="qualityPro">0</div><div style="font-size:.8rem;color:var(--text2)">âœ“ PRO</div></div>
<div style="text-align:center"><div style="font-size:1.5rem;color:var(--red)" id="qualityCon">0</div><div style="font-size:.8rem;color:var(--text2)">âœ— PROTI</div></div>
</div>
<div style="background:var(--bg3);border-radius:8px;padding:15px;text-align:center">
<div style="font-size:.9rem;color:var(--text2)">Setup Grade</div>
<div style="font-size:1.5rem;font-weight:700" id="qualityGrade">-</div>
</div>
<button class="btn btn-primary" style="width:100%;margin-top:15px" onclick="copyQualityToTrade()">ğŸ“‹ Copy to New Trade</button>
<button class="btn btn-secondary" style="width:100%;margin-top:10px" onclick="resetQualityChecklist()">ğŸ”„ Reset</button>
</div>
</div>

</div>
</div>
</div>

<!-- QUALITY CHECKLIST EDITOR MODAL -->
<div class="modal" id="qualityEditorModal"><div class="modal-content" style="max-width:900px;max-height:90vh;overflow-y:auto"><div class="modal-header"><h3>âš™ï¸ Edit Quality Checklists</h3><button class="modal-close" onclick="closeModal('qualityEditorModal')">Ã—</button></div><div class="modal-body">
<p style="color:var(--text2);margin-bottom:20px">Create custom checklists for each strategy. Items checked count as PRO, unchecked as PROTI.</p>

<div style="display:flex;gap:10px;margin-bottom:20px">
<select id="editQualityStrategy" class="filter-select" onchange="loadQualityEditorItems()" style="flex:1">
<option value="">Select strategy to edit...</option>
</select>
<button class="btn btn-primary" onclick="createNewQualitySection()">+ Add Section</button>
</div>

<div id="qualityEditorSections"></div>

<div style="display:flex;gap:10px;margin-top:20px">
<button class="btn btn-primary" onclick="saveQualityConfig()">ğŸ’¾ Save Changes</button>
<button class="btn btn-secondary" onclick="closeModal('qualityEditorModal')">Cancel</button>
</div>
</div></div></div>
</div>

<div id="customize" class="tab-content">
<div class="card"><div class="card-header"><h3>ğŸ¨ Customize Everything</h3><button class="btn btn-secondary" onclick="resetCustomConfig()">Reset to Defaults</button></div>
<div class="card-body">
<p style="color:var(--text2);margin-bottom:20px">Customize all dropdowns, toggles, and options in your trade form. Changes save automatically.</p>

<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px">

<div class="customize-section">
<h4 style="color:var(--gold);margin-bottom:10px">ğŸ“Š Sessions</h4>
<div id="customSessions" class="custom-list"></div>
<div style="display:flex;gap:8px;margin-top:10px"><input type="text" id="newSession" placeholder="New session..." class="custom-input"><button class="btn btn-primary btn-sm" onclick="addCustomItem('sessions')">+</button></div>
</div>

<div class="customize-section">
<h4 style="color:var(--gold);margin-bottom:10px">â±ï¸ Timeframes</h4>
<div id="customTimeframes" class="custom-list"></div>
<div style="display:flex;gap:8px;margin-top:10px"><input type="text" id="newTimeframe" placeholder="New timeframe..." class="custom-input"><button class="btn btn-primary btn-sm" onclick="addCustomItem('timeframes')">+</button></div>
</div>

<div class="customize-section">
<h4 style="color:var(--gold);margin-bottom:10px">ğŸ¯ Setup Types</h4>
<div id="customSetups" class="custom-list"></div>
<div style="display:flex;gap:8px;margin-top:10px"><input type="text" id="newSetup" placeholder="New setup..." class="custom-input"><button class="btn btn-primary btn-sm" onclick="addCustomItem('setups')">+</button></div>
</div>

<div class="customize-section">
<h4 style="color:var(--gold);margin-bottom:10px">âŒ Mistake Tags</h4>
<div id="customMistakes" class="custom-list"></div>
<div style="display:flex;gap:8px;margin-top:10px"><input type="text" id="newMistake" placeholder="New mistake..." class="custom-input"><button class="btn btn-primary btn-sm" onclick="addCustomItem('mistakes')">+</button></div>
</div>

<div class="customize-section">
<h4 style="color:var(--gold);margin-bottom:10px">ğŸ“ˆ HTF Bias</h4>
<div id="customHtfBias" class="custom-list"></div>
<div style="display:flex;gap:8px;margin-top:10px"><input type="text" id="newHtfBias" placeholder="New bias..." class="custom-input"><button class="btn btn-primary btn-sm" onclick="addCustomItem('htfBias')">+</button></div>
</div>

<div class="customize-section">
<h4 style="color:var(--gold);margin-bottom:10px">ğŸ“Š HTF Trend</h4>
<div id="customHtfTrend" class="custom-list"></div>
<div style="display:flex;gap:8px;margin-top:10px"><input type="text" id="newHtfTrend" placeholder="New trend..." class="custom-input"><button class="btn btn-primary btn-sm" onclick="addCustomItem('htfTrend')">+</button></div>
</div>

<div class="customize-section">
<h4 style="color:var(--gold);margin-bottom:10px">ğŸ”„ Exec TF Trend</h4>
<div id="customExecTrend" class="custom-list"></div>
<div style="display:flex;gap:8px;margin-top:10px"><input type="text" id="newExecTrend" placeholder="New option..." class="custom-input"><button class="btn btn-primary btn-sm" onclick="addCustomItem('execTrend')">+</button></div>
</div>

<div class="customize-section">
<h4 style="color:var(--gold);margin-bottom:10px">ğŸ’§ Liquidity Options</h4>
<div id="customLiquidity" class="custom-list"></div>
<div style="display:flex;gap:8px;margin-top:10px"><input type="text" id="newLiquidity" placeholder="New option..." class="custom-input"><button class="btn btn-primary btn-sm" onclick="addCustomItem('liquidity')">+</button></div>
</div>

<div class="customize-section">
<h4 style="color:var(--gold);margin-bottom:10px">ğŸš€ Arrival Quality</h4>
<div id="customArrival" class="custom-list"></div>
<div style="display:flex;gap:8px;margin-top:10px"><input type="text" id="newArrival" placeholder="New option..." class="custom-input"><button class="btn btn-primary btn-sm" onclick="addCustomItem('arrival')">+</button></div>
</div>

<div class="customize-section">
<h4 style="color:var(--gold);margin-bottom:10px">ğŸ’ª Leg-Out Strength</h4>
<div id="customLegOut" class="custom-list"></div>
<div style="display:flex;gap:8px;margin-top:10px"><input type="text" id="newLegOut" placeholder="New option..." class="custom-input"><button class="btn btn-primary btn-sm" onclick="addCustomItem('legOut')">+</button></div>
</div>

<div class="customize-section">
<h4 style="color:var(--gold);margin-bottom:10px">âœ¨ Zone Freshness</h4>
<div id="customZoneFresh" class="custom-list"></div>
<div style="display:flex;gap:8px;margin-top:10px"><input type="text" id="newZoneFresh" placeholder="New option..." class="custom-input"><button class="btn btn-primary btn-sm" onclick="addCustomItem('zoneFresh')">+</button></div>
</div>

<div class="customize-section">
<h4 style="color:var(--gold);margin-bottom:10px">ğŸ“Š Outcomes</h4>
<div id="customOutcomes" class="custom-list"></div>
<div style="display:flex;gap:8px;margin-top:10px"><input type="text" id="newOutcome" placeholder="New outcome..." class="custom-input"><button class="btn btn-primary btn-sm" onclick="addCustomItem('outcomes')">+</button></div>
</div>

<div class="customize-section">
<h4 style="color:var(--gold);margin-bottom:10px">â­ Ratings</h4>
<div id="customRatings" class="custom-list"></div>
<div style="display:flex;gap:8px;margin-top:10px"><input type="text" id="newRating" placeholder="New rating..." class="custom-input"><button class="btn btn-primary btn-sm" onclick="addCustomItem('ratings')">+</button></div>
</div>

<div class="customize-section">
<h4 style="color:var(--gold);margin-bottom:10px">ğŸ˜Š Emotions</h4>
<div id="customEmotions" class="custom-list"></div>
<div style="display:flex;gap:8px;margin-top:10px"><input type="text" id="newEmotion" placeholder="Emoji..." class="custom-input" style="width:60px"><button class="btn btn-primary btn-sm" onclick="addCustomItem('emotions')">+</button></div>
</div>

<div class="customize-section" style="grid-column:1/-1">
<h4 style="color:var(--gold);margin-bottom:10px">ğŸ“ˆ Custom Pairs / Instruments</h4>
<p style="color:var(--text2);font-size:.85rem;margin-bottom:10px">Add your own pairs. They appear at the top of the Pair dropdown.</p>
<div id="customPairs" class="custom-list"></div>
<div style="display:flex;gap:8px;margin-top:10px"><input type="text" id="newPair" placeholder="New pair (e.g. AUDCHF)..." class="custom-input" style="max-width:200px"><button class="btn btn-primary btn-sm" onclick="addCustomItem('pairs')">+</button></div>
</div>

</div>
</div></div>
</div>

<div class="modal" id="tradeModal"><div class="modal-content"><div class="modal-header"><h3>Trade Details</h3><button class="modal-close" onclick="closeModal('tradeModal')">Ã—</button></div><div class="modal-body" id="tradeModalBody"></div></div></div>
<div class="modal" id="settingsModal"><div class="modal-content" style="max-width:550px"><div class="modal-header"><h3>âš™ï¸ Settings</h3><button class="modal-close" onclick="closeModal('settingsModal')">Ã—</button></div><div class="modal-body"><div class="settings-grid">
<div class="setting-item"><label>Daily Loss Limit ($)</label><input type="number" id="setLimit" value="200" onchange="saveSettings()"></div>
<div class="setting-item"><label>Default Risk ($)</label><input type="number" id="setRisk" value="50" onchange="saveSettings()"></div>
<div class="setting-item"><label>Account Size ($)</label><input type="number" id="setAccount" value="10000" onchange="saveSettings()"></div>
</div>
<div style="margin-top:20px;padding-top:20px;border-top:1px solid var(--border)">
<h4 style="color:var(--gold);margin-bottom:15px">ğŸ“¸ Screenshot Storage</h4>
<p style="color:var(--text2);font-size:.85rem;margin-bottom:15px">Choose where to store your screenshots. Cloudinary recommended for permanent storage.</p>

<div style="padding:15px;background:var(--bg2);border-radius:8px;margin-bottom:15px">
<p style="color:var(--green);font-weight:600;margin-bottom:10px">âœ… Option 1: Cloudinary (Recommended)</p>
<p style="color:var(--text2);font-size:.8rem;margin-bottom:10px">Free 25GB, permanent storage, you control it.</p>
<div class="setting-item" style="margin-bottom:10px"><label>Cloud Name</label><input type="text" id="setCloudName" placeholder="From Cloudinary Dashboard" style="width:100%;padding:10px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;color:var(--text)"></div>
<div class="setting-item" style="margin-bottom:10px"><label>Upload Preset</label><input type="text" id="setUploadPreset" placeholder="Create unsigned preset in Settingsâ†’Upload" style="width:100%;padding:10px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;color:var(--text)"></div>
<p style="color:var(--text2);font-size:.75rem">Setup: <a href="https://cloudinary.com" target="_blank" style="color:var(--gold)">cloudinary.com</a> â†’ Dashboard (Cloud Name) â†’ Settings â†’ Upload â†’ Add upload preset (Unsigned)</p>
</div>

<div style="padding:15px;background:var(--bg2);border-radius:8px;margin-bottom:15px">
<p style="color:var(--gold);font-weight:600;margin-bottom:10px">âš ï¸ Option 2: Imgur (Backup)</p>
<p style="color:var(--text2);font-size:.8rem;margin-bottom:10px">Free but images may be deleted after 6 months of inactivity.</p>
<div class="setting-item"><label>Imgur Client ID (optional)</label><input type="text" id="setImgurClientId" placeholder="Get from api.imgur.com" style="width:100%;padding:10px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;color:var(--text)"></div>
<p style="color:var(--text2);font-size:.75rem;margin-top:5px">Get yours: <a href="https://api.imgur.com/oauth2/addclient" target="_blank" style="color:var(--gold)">api.imgur.com</a> â†’ Register Application â†’ Anonymous usage</p>
</div>

<button class="btn btn-primary" onclick="saveCloudinarySettings()">ğŸ’¾ Save Image Settings</button>
<button class="btn btn-secondary" style="margin-left:10px" onclick="testImageUpload()">ğŸ§ª Test Upload</button>
<p id="imageSettingsStatus" style="color:var(--text2);font-size:.8rem;margin-top:10px"></p>
</div>
<div style="margin-top:20px;padding-top:20px;border-top:1px solid var(--border)"><button class="btn" style="background:var(--red);color:#fff" onclick="clearAll()">ğŸ—‘ï¸ Delete All Data</button></div></div></div></div>
<div class="modal" id="dayModal"><div class="modal-content"><div class="modal-header"><h3 id="dayModalTitle">Day</h3><button class="modal-close" onclick="closeModal('dayModal')">Ã—</button></div><div class="modal-body" id="dayModalBody"></div></div></div>
<div class="modal" id="accountModal"><div class="modal-content" style="max-width:600px"><div class="modal-header"><h3>ğŸ¦ Manage Accounts</h3><button class="modal-close" onclick="closeModal('accountModal')">Ã—</button></div><div class="modal-body">
<div style="margin-bottom:20px"><div style="display:flex;gap:10px"><input type="text" id="newAccountName" placeholder="Account name (e.g. FTMO 100k, Personal, IC Markets)" style="flex:1;padding:12px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"><input type="text" id="newAccountColor" placeholder="#FFD700" value="#FFD700" style="width:100px;padding:12px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"><button class="btn btn-primary" onclick="addAccount()">+ Add</button></div></div>
<div id="accountsList"></div>
</div></div></div>

<div class="modal" id="strategyModal"><div class="modal-content" style="max-width:700px"><div class="modal-header"><h3 id="strategyModalTitle">ğŸ“‹ New Strategy</h3><button class="modal-close" onclick="closeModal('strategyModal')">Ã—</button></div><div class="modal-body">
<input type="hidden" id="editStrategyId">
<div class="form-group" style="margin-bottom:15px"><label>Strategy Name</label><input type="text" id="strategyName" placeholder="e.g. Fresh Zone Reversal, Liquidity Grab, BOS Continuation..." style="width:100%;padding:12px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"></div>
<div class="form-group" style="margin-bottom:15px"><label>Description</label><textarea id="strategyDesc" placeholder="Brief description of when to use this strategy..." style="width:100%;padding:12px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);min-height:60px"></textarea></div>
<div class="form-group" style="margin-bottom:15px"><label>ğŸ“¸ Strategy Screenshot (example setup)</label><input type="file" id="strategyScreenshot" accept="image/*" onchange="previewStrategyImg()"><img id="strategyImgPreview" style="max-width:100%;max-height:200px;border-radius:8px;margin-top:10px;display:none"></div>
<div class="form-group" style="margin-bottom:15px"><label>Entry Rules (one per line)</label><textarea id="strategyEntryRules" placeholder="1. Wait for price to reach fresh S&D zone&#10;2. Look for rejection candle on M15&#10;3. Enter on break of rejection candle high/low&#10;4. Minimum 1:2 R:R" style="width:100%;padding:12px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);min-height:120px;font-family:monospace"></textarea></div>
<div class="form-group" style="margin-bottom:15px"><label>Exit Rules (one per line)</label><textarea id="strategyExitRules" placeholder="1. TP at opposing zone&#10;2. Move SL to BE after 1R&#10;3. Trail stop after 2R" style="width:100%;padding:12px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);min-height:80px;font-family:monospace"></textarea></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px">
<div class="form-group"><label>Ideal Timeframes</label><input type="text" id="strategyTimeframes" placeholder="M15, H1, H4" style="width:100%;padding:12px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"></div>
<div class="form-group"><label>Best Sessions</label><input type="text" id="strategySessions" placeholder="London, New York" style="width:100%;padding:12px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"></div>
</div>
<div class="form-group" style="margin-bottom:15px"><label>Risk Management Notes</label><textarea id="strategyRisk" placeholder="Max 1% risk per trade, max 2 trades per day with this strategy..." style="width:100%;padding:12px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);min-height:60px"></textarea></div>
<div class="form-group" style="margin-bottom:20px"><label>Strategy Color</label><input type="color" id="strategyColor" value="#FFD700" style="width:60px;height:40px;border:none;border-radius:8px;cursor:pointer"></div>
<div style="display:flex;gap:10px"><button class="btn btn-primary" onclick="saveStrategy()">ğŸ’¾ Save Strategy</button><button class="btn btn-secondary" onclick="closeModal('strategyModal')">Cancel</button></div>
</div></div></div>

<div class="modal" id="backtestModal"><div class="modal-content" style="max-width:600px"><div class="modal-header"><h3>ğŸ§ª Add Backtest Trade</h3><button class="modal-close" onclick="closeModal('backtestModal')">Ã—</button></div><div class="modal-body">
<input type="hidden" id="editBacktestId">
<div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
<div class="form-group"><label>Strategy</label><select id="backtestStrategy" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"></select></div>
<div class="form-group"><label>Date</label><input type="date" id="backtestDate" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"></div>
<div class="form-group"><label>Pair</label><input type="text" id="backtestPair" placeholder="EURUSD" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"></div>
<div class="form-group"><label>Direction</label><select id="backtestDirection" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"><option>Long</option><option>Short</option></select></div>
<div class="form-group"><label>Result</label><select id="backtestResult" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"><option>Win</option><option>Loss</option><option>BE</option></select></div>
<div class="form-group"><label>R:R Achieved</label><input type="number" id="backtestRR" step="0.1" placeholder="2.5" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"></div>
</div>
<div class="form-group" style="margin-top:15px"><label>Notes</label><textarea id="backtestNotes" placeholder="What made this setup good/bad..." style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);min-height:60px"></textarea></div>
<div class="form-group" style="margin-top:15px"><label>Screenshot</label><input type="file" id="backtestScreenshot" accept="image/*" onchange="previewBacktestImg()"><img id="backtestImgPreview" style="max-width:100%;max-height:150px;border-radius:8px;margin-top:10px;display:none"></div>
<div style="display:flex;gap:10px;margin-top:20px"><button class="btn btn-primary" onclick="saveBacktest()">ğŸ’¾ Save Backtest</button><button class="btn btn-secondary" onclick="closeModal('backtestModal')">Cancel</button></div>
</div></div></div>

<div class="modal" id="missedTradeModal"><div class="modal-content" style="max-width:600px"><div class="modal-header"><h3>ğŸš« Add Missed Trade</h3><button class="modal-close" onclick="closeModal('missedTradeModal')">Ã—</button></div><div class="modal-body">
<input type="hidden" id="editMissedId">
<div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
<div class="form-group"><label>Strategy</label><select id="missedStrategy" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"><option value="">No Strategy</option></select></div>
<div class="form-group"><label>Date</label><input type="date" id="missedDate" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"></div>
<div class="form-group"><label>Pair</label><input type="text" id="missedPair" placeholder="EURUSD" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"></div>
<div class="form-group"><label>Direction</label><select id="missedDirection" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"><option>Long</option><option>Short</option></select></div>
<div class="form-group"><label>Zone</label><select id="missedZone" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"><option>Demand</option><option>Supply</option></select></div>
<div class="form-group"><label>Would Have Won?</label><select id="missedResult" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"><option value="Win">âœ… Yes - Win</option><option value="Loss">âŒ No - Loss</option><option value="BE">â– Break Even</option><option value="Unknown">â“ Unknown</option></select></div>
<div class="form-group"><label>Potential R:R</label><input type="number" id="missedRR" step="0.1" placeholder="2.5" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"></div>
</div>
<div class="form-group" style="margin-top:15px"><label>Reason Not Taken</label><select id="missedReason" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"><option>Not at screen</option><option>Hesitation/Fear</option><option>Waiting for better entry</option><option>Already in trade</option><option>Hit daily limit</option><option>News event</option><option>Didn't trust setup</option><option>Forgot to set alert</option><option>Other</option></select></div>
<div class="form-group" style="margin-top:15px"><label>Notes</label><textarea id="missedNotes" placeholder="What you learned..." style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);min-height:60px"></textarea></div>
<div class="form-group" style="margin-top:15px"><label>Screenshot</label><input type="file" id="missedScreenshot" accept="image/*" onchange="previewMissedImg()"><img id="missedImgPreview" style="max-width:100%;max-height:150px;border-radius:8px;margin-top:10px;display:none"></div>
<div style="display:flex;gap:10px;margin-top:20px"><button class="btn btn-primary" onclick="saveMissedTrade()">ğŸ’¾ Save Missed Trade</button><button class="btn btn-secondary" onclick="closeModal('missedTradeModal')">Cancel</button></div>
</div></div></div>

<div class="modal" id="pairAnalysisModal"><div class="modal-content" style="max-width:700px"><div class="modal-header"><h3 id="pairAnalysisModalTitle">ğŸ”¬ Add Pair Analysis</h3><button class="modal-close" onclick="closeModal('pairAnalysisModal')">Ã—</button></div><div class="modal-body">
<input type="hidden" id="editPairAnalysisId">
<div id="pairAnalysisForm"></div>
<div style="display:flex;gap:10px;margin-top:20px"><button class="btn btn-primary" onclick="savePairAnalysis()">ğŸ’¾ Save</button><button class="btn btn-secondary" onclick="closeModal('pairAnalysisModal')">Cancel</button></div>
</div></div></div>

<div class="modal" id="columnManagerModal"><div class="modal-content" style="max-width:600px"><div class="modal-header"><h3>âš™ï¸ Manage Columns</h3><button class="modal-close" onclick="closeModal('columnManagerModal')">Ã—</button></div><div class="modal-body">
<p style="color:var(--text2);margin-bottom:15px;font-size:.9rem">Add, edit, or remove columns for your pair analysis table.</p>
<div id="columnList" style="margin-bottom:20px"></div>
<div style="display:flex;gap:10px;padding:15px;background:var(--bg2);border-radius:8px">
<input type="text" id="newColumnName" placeholder="Column name..." style="flex:1;padding:10px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;color:var(--text)">
<select id="newColumnType" style="padding:10px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;color:var(--text)">
<option value="text">Text</option>
<option value="yesno">Yes/No</option>
<option value="select">Dropdown</option>
<option value="number">Number</option>
</select>
<button class="btn btn-primary" onclick="addPairColumn()">+ Add</button>
</div>
<div id="columnOptionsDiv" style="display:none;margin-top:15px;padding:15px;background:var(--bg2);border-radius:8px">
<label style="color:var(--text2);font-size:.85rem">Dropdown options (comma separated):</label>
<input type="text" id="newColumnOptions" placeholder="Option 1, Option 2, Option 3..." style="width:100%;padding:10px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;color:var(--text);margin-top:8px">
</div>
</div></div></div>

<div class="toast" id="toast"></div>

<script>
let trades=JSON.parse(localStorage.getItem('sdPro'))||[];
let accounts=JSON.parse(localStorage.getItem('sdAccounts'))||[{id:'default',name:'Main Account',color:'#FFD700'}];
let strategies=JSON.parse(localStorage.getItem('sdStrategies'))||[];
let backtests=JSON.parse(localStorage.getItem('sdBacktests'))||[];
let missedTrades=JSON.parse(localStorage.getItem('sdMissed'))||[];
let pairAnalysis=JSON.parse(localStorage.getItem('sdPairAnalysis'))||[];
var defaultPairColumns=[
{id:'pair',name:'Pair',type:'pairselect',locked:true},
{id:'weeklyCoverage',name:'Weekly Coverage',type:'yesno'},
{id:'dailyZone',name:'Daily Zone',type:'yesno'},
{id:'entryZone',name:'Entry Zone TF',type:'select',options:['MN','W','D','16H','12H','8H','4H','2H','1H','30M','15M','5M','1M']},
{id:'reversalPattern',name:'Reversal Pattern',type:'select',options:['No','Daily Hammer','Daily Shooting Star','Daily Engulfing','4H Hammer','4H Shooting Star','4H Engulfing']},
{id:'shortTermVal',name:'Short Term Valuation',type:'yesno'},
{id:'longTermVal',name:'Long Term Valuation',type:'yesno'},
{id:'pocHighVol',name:'POC High Volume',type:'yesno'},
{id:'timeToR',name:'2R Time',type:'text'},
{id:'maxToOpposing',name:'Max to Opposing Valuation',type:'text'},
{id:'result',name:'Result',type:'select',options:['Win','SL','BE']}
];
let pairColumns=JSON.parse(localStorage.getItem('sdPairColumns'))||JSON.parse(JSON.stringify(defaultPairColumns));
var defaultCustomConfig={
sessions:['Asian','London','New York','Overlap'],
timeframes:['M1','M3','M5','M15','M30','H1','H2','H4','H8','D1','W1','MN'],
setups:['Fresh Zone','1st Touch','2nd Touch','3rd+ Touch','Confluence','HTF Alignment','Liquidity Grab','BOS Entry','Flip Zone'],
mistakes:['FOMO','Revenge','Moved SL','Early Exit','Late Entry','Wrong Size','No Confirm','Against HTF','Overtrading','Tired'],
htfBias:['Bullish','Bearish','Ranging'],
htfTrend:['ğŸ“ˆ Strong Up','â†—ï¸ Weak Up','â†”ï¸ Ranging','â†˜ï¸ Weak Down','ğŸ“‰ Strong Down'],
execTrend:['âœ… With HTF','âš ï¸ Against HTF','ğŸ”„ Reversal'],
liquidity:['2 - Taken First','1 - Unclear','0 - None'],
arrival:['2 - Fast & Clean','1 - Choppy'],
legOut:['ğŸ’ª Massive','ğŸ“Š Normal'],
zoneFresh:['âœ¨ Fresh','1st Touch','2nd Touch','3rd+ Touch'],
outcomes:['â³ Open','âœ… Win','âŒ Loss','â– BE'],
ratings:['A','B','C'],
emotions:['ğŸ˜«','ğŸ˜•','ğŸ˜','ğŸ™‚','ğŸ˜'],
pairs:[]
};
let customConfig=JSON.parse(localStorage.getItem('sdCustom'))||JSON.parse(JSON.stringify(defaultCustomConfig));
let currentAccount='all';
let settings=JSON.parse(localStorage.getItem('sdSettings'))||{limit:200,risk:50,account:10000};
let charts={},currentMonth=new Date();

document.addEventListener('DOMContentLoaded',function(){loadSettings();setDefaultDate();updateAccountSelectors();updateStrategySelectors();setupZoneScoreListeners();updateStorageIndicator();buildCustomLists();rebuildFormSelects();initQualityScorer();loadTradingPlan();renderSeasonality();updateAll()});

function updateStorageIndicator(){
var used=getStorageUsage();
var limit=5*1024*1024;
var pct=Math.round(used/limit*100);
var ind=document.getElementById('storageIndicator');
if(ind){
ind.textContent='ğŸ’¾ '+pct+'%';
ind.style.color=pct>80?'var(--red)':pct>50?'var(--gold)':'var(--green)';
}}

function showStorageInfo(){
var used=getStorageUsage();
var limit=5*1024*1024;
var pct=Math.round(used/limit*100);
var usedMB=(used/1024/1024).toFixed(2);
var screenshotCount=trades.filter(function(t){return t.screenshot}).length;
var msg='Storage: '+usedMB+'MB / 5MB ('+pct+'%)\n\n';
msg+='Trades with screenshots: '+screenshotCount+'\n\n';
msg+='Clear all screenshots to free space?';
if(screenshotCount>0&&confirm(msg)){
trades.forEach(function(t){t.screenshot=''});
saveTrades();
updateStorageIndicator();
updateGallery();
showToast('Screenshots cleared! Storage freed.');
}else if(screenshotCount===0){
alert('Storage: '+usedMB+'MB / 5MB ('+pct+'%)\n\nNo screenshots to clear.');
}}

function setupZoneScoreListeners(){document.querySelectorAll('#tradeLiquidity,#tradeArrival,#tradeBaseCandles,#tradeBaseVolume,#tradeLegOut,#tradeZoneFresh,#tradeBigBro,#tradeSmallBro,#tradeFlipZone').forEach(function(el){el.addEventListener('change',calculateZoneScore);el.addEventListener('input',calculateZoneScore)})}

function updateAccountSelectors(){
var sel=document.getElementById('accountSelect');
var formSel=document.getElementById('tradeAccount');
sel.innerHTML='<option value="all">ğŸ“Š All Accounts</option>'+accounts.map(function(a){return '<option value="'+a.id+'" style="color:'+a.color+'">'+a.name+'</option>'}).join('');
sel.value=currentAccount;
if(formSel){formSel.innerHTML=accounts.map(function(a){return '<option value="'+a.id+'">'+a.name+'</option>'}).join('')}
}
function switchAccount(){currentAccount=document.getElementById('accountSelect').value;updateAll()}
function getFilteredTrades(){if(currentAccount==='all')return trades;return trades.filter(function(t){return t.account===currentAccount||(currentAccount==='default'&&!t.account)})}
function openAccountManager(){
var html=accounts.map(function(a,i){return '<div style="display:flex;align-items:center;gap:10px;padding:15px;background:var(--bg2);border-radius:8px;margin-bottom:10px;border-left:4px solid '+a.color+'"><span style="flex:1;font-weight:600">'+a.name+'</span><span style="color:var(--text2)">'+trades.filter(function(t){return t.account===a.id||(a.id==='default'&&!t.account)}).length+' trades</span>'+(a.id!=='default'?'<button class="btn-icon" onclick="deleteAccount(\''+a.id+'\')" style="color:var(--red)">ğŸ—‘ï¸</button>':'')+'</div>'}).join('');
document.getElementById('accountsList').innerHTML=html;
openModal('accountModal')}
function addAccount(){
var name=document.getElementById('newAccountName').value.trim();
var color=document.getElementById('newAccountColor').value||'#FFD700';
if(!name){showToast('Enter account name','error');return}
var id='acc_'+Date.now();
accounts.push({id:id,name:name,color:color});
localStorage.setItem('sdAccounts',JSON.stringify(accounts));
document.getElementById('newAccountName').value='';
updateAccountSelectors();
openAccountManager();
showToast('Account added!')}
function deleteAccount(id){
if(!confirm('Delete this account? Trades will be moved to Main Account.'))return;
trades.forEach(function(t){if(t.account===id)t.account='default'});
accounts=accounts.filter(function(a){return a.id!==id});
localStorage.setItem('sdAccounts',JSON.stringify(accounts));
saveTrades();
updateAccountSelectors();
openAccountManager();
showToast('Account deleted')}

function updateStrategySelectors(){
var formSel=document.getElementById('tradeStrategy');
if(formSel){formSel.innerHTML='<option value="">No Strategy</option>'+strategies.map(function(s){return '<option value="'+s.id+'" style="color:'+s.color+'">'+s.name+'</option>'}).join('')}
initQualityScorer();
}
function openStrategyEditor(id){
document.getElementById('editStrategyId').value='';
document.getElementById('strategyName').value='';
document.getElementById('strategyDesc').value='';
document.getElementById('strategyEntryRules').value='';
document.getElementById('strategyExitRules').value='';
document.getElementById('strategyTimeframes').value='';
document.getElementById('strategySessions').value='';
document.getElementById('strategyRisk').value='';
document.getElementById('strategyColor').value='#FFD700';
document.getElementById('strategyModalTitle').textContent='ğŸ“‹ New Strategy';
if(id){
var s=strategies.find(function(x){return x.id===id});
if(s){
document.getElementById('editStrategyId').value=id;
document.getElementById('strategyName').value=s.name;
document.getElementById('strategyDesc').value=s.description||'';
document.getElementById('strategyEntryRules').value=(s.entryRules||[]).join('\n');
document.getElementById('strategyExitRules').value=(s.exitRules||[]).join('\n');
document.getElementById('strategyTimeframes').value=s.timeframes||'';
document.getElementById('strategySessions').value=s.sessions||'';
document.getElementById('strategyRisk').value=s.riskNotes||'';
document.getElementById('strategyColor').value=s.color||'#FFD700';
var stratPreview=document.getElementById('strategyImgPreview');
if(s.screenshot){stratPreview.src=s.screenshot;stratPreview.style.display='block'}else{stratPreview.src='';stratPreview.style.display='none'}
stratPreview.dataset.local='';
document.getElementById('strategyModalTitle').textContent='ğŸ“‹ Edit Strategy';
}}
openModal('strategyModal')}

function previewStrategyImg(){
var f=document.getElementById('strategyScreenshot').files[0];
if(!f)return;
var preview=document.getElementById('strategyImgPreview');
var reader=new FileReader();
reader.onload=function(e){preview.src=e.target.result;preview.style.display='block';preview.dataset.local='true'};
reader.readAsDataURL(f)}

function saveStrategy(){
var name=document.getElementById('strategyName').value.trim();
if(!name){showToast('Enter strategy name','error');return}
var id=document.getElementById('editStrategyId').value||'strat_'+Date.now();
var preview=document.getElementById('strategyImgPreview');
var hasNewImg=preview.style.display==='block'&&preview.src&&preview.dataset.local==='true';
var existingStrat=strategies.find(function(s){return s.id===id});
var doSave=function(imgUrl){
var strategy={
id:id,
name:name,
description:document.getElementById('strategyDesc').value,
screenshot:imgUrl,
entryRules:document.getElementById('strategyEntryRules').value.split('\n').filter(function(r){return r.trim()}),
exitRules:document.getElementById('strategyExitRules').value.split('\n').filter(function(r){return r.trim()}),
timeframes:document.getElementById('strategyTimeframes').value,
sessions:document.getElementById('strategySessions').value,
riskNotes:document.getElementById('strategyRisk').value,
color:document.getElementById('strategyColor').value
};
var idx=strategies.findIndex(function(s){return s.id===id});
if(idx!==-1)strategies[idx]=strategy;
else strategies.push(strategy);
localStorage.setItem('sdStrategies',JSON.stringify(strategies));
updateStrategySelectors();
updateStrategies();
closeModal('strategyModal');
showToast('Strategy saved!')};
if(hasNewImg){
uploadImage(preview.src,function(url){doSave(url)});
}else{
doSave(preview.src||(existingStrat?existingStrat.screenshot:''))}}
function deleteStrategy(id){
if(!confirm('Delete this strategy?'))return;
strategies=strategies.filter(function(s){return s.id!==id});
localStorage.setItem('sdStrategies',JSON.stringify(strategies));
updateStrategySelectors();
updateStrategies();
showToast('Strategy deleted')}
function updateStrategies(){
var list=document.getElementById('strategiesList');
var perf=document.getElementById('strategyPerformance');
if(!list)return;
if(!strategies.length){
list.innerHTML='<div class="empty-state" style="grid-column:1/-1"><div class="empty-state-icon">ğŸ“‹</div><h3>No strategies yet</h3><p>Create your first trading strategy to track performance</p></div>';
perf.innerHTML='';
return}
list.innerHTML=strategies.map(function(s){
var stratTrades=trades.filter(function(t){return t.strategy===s.id&&t.outcome!=='Open'});
var wins=stratTrades.filter(function(t){return t.outcome==='Win'}).length;
var winRate=stratTrades.length?(wins/stratTrades.length*100):0;
var pnl=stratTrades.reduce(function(sum,t){return sum+(t.pnl||0)},0);
return '<div class="strategy-card" style="border-left:4px solid '+s.color+'"><div class="strategy-card-header"><h4><span style="color:'+s.color+'">â—</span> '+s.name+'</h4><div class="action-btns"><button class="action-btn view" onclick="viewStrategy(\''+s.id+'\')">ğŸ‘ï¸</button><button class="action-btn edit" onclick="openStrategyEditor(\''+s.id+'\')">âœï¸</button><button class="action-btn delete" onclick="deleteStrategy(\''+s.id+'\')">ğŸ—‘ï¸</button></div></div><div class="strategy-card-body">'+(s.screenshot?'<img src="'+s.screenshot+'" style="width:100%;height:120px;object-fit:cover;border-radius:8px;margin-bottom:10px;cursor:pointer" onclick="window.open(\''+s.screenshot+'\')">':'')+(s.description?'<p style="color:var(--text2);font-size:.85rem;margin-bottom:10px">'+s.description+'</p>':'')+'<div class="strategy-meta">'+(s.timeframes?'<span>â±ï¸ '+s.timeframes+'</span>':'')+(s.sessions?'<span>ğŸŒ '+s.sessions+'</span>':'')+'</div><div class="strategy-stats"><div class="strategy-stat"><div class="strategy-stat-value">'+stratTrades.length+'</div><div class="strategy-stat-label">Trades</div></div><div class="strategy-stat"><div class="strategy-stat-value '+(winRate>=50?'positive':'negative')+'">'+winRate.toFixed(0)+'%</div><div class="strategy-stat-label">Win Rate</div></div><div class="strategy-stat"><div class="strategy-stat-value '+(pnl>=0?'positive':'negative')+'">$'+pnl.toFixed(0)+'</div><div class="strategy-stat-label">P&L</div></div></div></div></div>'}).join('');
var perfData=strategies.map(function(s){
var stratTrades=trades.filter(function(t){return t.strategy===s.id&&t.outcome!=='Open'});
var wins=stratTrades.filter(function(t){return t.outcome==='Win'}).length;
return{name:s.name,color:s.color,trades:stratTrades.length,winRate:stratTrades.length?(wins/stratTrades.length*100):0,pnl:stratTrades.reduce(function(sum,t){return sum+(t.pnl||0)},0)}}).filter(function(p){return p.trades>0}).sort(function(a,b){return b.pnl-a.pnl});
if(perfData.length){
perf.innerHTML='<table><thead><tr><th>Strategy</th><th>Trades</th><th>Win Rate</th><th>P&L</th></tr></thead><tbody>'+perfData.map(function(p){return '<tr><td><span style="color:'+p.color+';font-weight:600">â— '+p.name+'</span></td><td>'+p.trades+'</td><td class="'+(p.winRate>=50?'positive':'negative')+'">'+p.winRate.toFixed(1)+'%</td><td class="'+(p.pnl>=0?'positive':'negative')+'">$'+p.pnl.toFixed(2)+'</td></tr>'}).join('')+'</tbody></table>'}
else{perf.innerHTML='<p style="color:var(--text2);text-align:center;padding:20px">Take some trades with strategies to see performance data</p>'}}
function viewStrategy(id){
var s=strategies.find(function(x){return x.id===id});
if(!s)return;
var stratTrades=trades.filter(function(t){return t.strategy===s.id&&t.outcome!=='Open'});
var wins=stratTrades.filter(function(t){return t.outcome==='Win'}).length;
var winRate=stratTrades.length?(wins/stratTrades.length*100):0;
var pnl=stratTrades.reduce(function(sum,t){return sum+(t.pnl||0)},0);
document.getElementById('tradeModalBody').innerHTML='<div style="border-left:4px solid '+s.color+';padding-left:15px;margin-bottom:20px"><h2 style="color:'+s.color+';margin-bottom:5px">'+s.name+'</h2>'+(s.description?'<p style="color:var(--text2)">'+s.description+'</p>':'')+'</div>'+(s.screenshot?'<img src="'+s.screenshot+'" style="width:100%;max-height:300px;object-fit:contain;border-radius:8px;margin-bottom:20px">':'')+'<div class="trade-detail-grid" style="margin-bottom:20px"><div class="trade-detail-item"><label>Total Trades</label><span>'+stratTrades.length+'</span></div><div class="trade-detail-item"><label>Win Rate</label><span class="'+(winRate>=50?'positive':'negative')+'">'+winRate.toFixed(1)+'%</span></div><div class="trade-detail-item"><label>Total P&L</label><span class="'+(pnl>=0?'positive':'negative')+'">$'+pnl.toFixed(2)+'</span></div></div>'+(s.entryRules&&s.entryRules.length?'<div style="margin-bottom:15px"><strong style="color:var(--green)">ğŸ“¥ Entry Rules:</strong><ul style="margin-top:8px;padding-left:20px;color:var(--text2)">'+s.entryRules.map(function(r){return '<li style="margin-bottom:5px">'+r+'</li>'}).join('')+'</ul></div>':'')+(s.exitRules&&s.exitRules.length?'<div style="margin-bottom:15px"><strong style="color:var(--red)">ğŸ“¤ Exit Rules:</strong><ul style="margin-top:8px;padding-left:20px;color:var(--text2)">'+s.exitRules.map(function(r){return '<li style="margin-bottom:5px">'+r+'</li>'}).join('')+'</ul></div>':'')+(s.riskNotes?'<div style="margin-bottom:15px"><strong style="color:var(--gold)">âš ï¸ Risk Management:</strong><p style="margin-top:8px;padding:10px;background:var(--bg2);border-radius:6px;color:var(--text2)">'+s.riskNotes+'</p></div>':'')+'<div style="display:flex;gap:10px;flex-wrap:wrap">'+(s.timeframes?'<span style="padding:6px 12px;background:var(--bg2);border-radius:6px;font-size:.85rem">â±ï¸ '+s.timeframes+'</span>':'')+(s.sessions?'<span style="padding:6px 12px;background:var(--bg2);border-radius:6px;font-size:.85rem">ğŸŒ '+s.sessions+'</span>':'')+'</div>';
openModal('tradeModal')}

// ============================================
// BACKTEST FUNCTIONS
// ============================================
function openBacktestModal(id){
document.getElementById('editBacktestId').value='';
document.getElementById('backtestDate').value=new Date().toISOString().split('T')[0];
document.getElementById('backtestPair').value='';
document.getElementById('backtestDirection').value='Long';
document.getElementById('backtestResult').value='Win';
document.getElementById('backtestRR').value='';
document.getElementById('backtestNotes').value='';
document.getElementById('backtestImgPreview').style.display='none';
document.getElementById('backtestImgPreview').src='';
document.getElementById('backtestImgPreview').dataset.local='';
var stratSel=document.getElementById('backtestStrategy');
stratSel.innerHTML='<option value="">Select strategy...</option>'+strategies.map(function(s){return '<option value="'+s.id+'">'+s.name+'</option>'}).join('');
if(id){
var bt=backtests.find(function(b){return b.id===id});
if(bt){
document.getElementById('editBacktestId').value=id;
stratSel.value=bt.strategy||'';
document.getElementById('backtestDate').value=bt.date||'';
document.getElementById('backtestPair').value=bt.pair||'';
document.getElementById('backtestDirection').value=bt.direction||'Long';
document.getElementById('backtestResult').value=bt.result||'Win';
document.getElementById('backtestRR').value=bt.rr||'';
document.getElementById('backtestNotes').value=bt.notes||'';
if(bt.screenshot){document.getElementById('backtestImgPreview').src=bt.screenshot;document.getElementById('backtestImgPreview').style.display='block'}
}}
openModal('backtestModal')}

function previewBacktestImg(){
var f=document.getElementById('backtestScreenshot').files[0];
if(!f)return;
var preview=document.getElementById('backtestImgPreview');
var reader=new FileReader();
reader.onload=function(e){preview.src=e.target.result;preview.style.display='block';preview.dataset.local='true'};
reader.readAsDataURL(f)}

function saveBacktest(){
var strategy=document.getElementById('backtestStrategy').value;
var pair=document.getElementById('backtestPair').value.trim().toUpperCase();
if(!pair){showToast('Enter pair','error');return}
var id=document.getElementById('editBacktestId').value||'bt_'+Date.now();
var preview=document.getElementById('backtestImgPreview');
var hasNewImg=preview.style.display==='block'&&preview.src&&preview.dataset.local==='true';
var doSave=function(imgUrl){
var bt={
id:id,
strategy:strategy,
date:document.getElementById('backtestDate').value,
pair:pair,
direction:document.getElementById('backtestDirection').value,
result:document.getElementById('backtestResult').value,
rr:parseFloat(document.getElementById('backtestRR').value)||0,
notes:document.getElementById('backtestNotes').value,
screenshot:imgUrl
};
var idx=backtests.findIndex(function(b){return b.id===id});
if(idx!==-1)backtests[idx]=bt;
else backtests.unshift(bt);
localStorage.setItem('sdBacktests',JSON.stringify(backtests));
updateBacktests();
closeModal('backtestModal');
showToast('Backtest saved!')};
if(hasNewImg){uploadImage(preview.src,function(url){doSave(url)})}
else{doSave(preview.src||'')}}

function deleteBacktest(id){
if(!confirm('Delete this backtest?'))return;
backtests=backtests.filter(function(b){return b.id!==id});
localStorage.setItem('sdBacktests',JSON.stringify(backtests));
updateBacktests();
showToast('Deleted')}

function updateBacktests(){
var table=document.getElementById('backtestTable');
var stats=document.getElementById('backtestStats');
if(!table)return;
if(!backtests.length){
table.innerHTML='<tr><td colspan="8" style="text-align:center;color:var(--text2);padding:30px">No backtests yet. Add your first backtest trade!</td></tr>';
stats.innerHTML='';
return}
var wins=backtests.filter(function(b){return b.result==='Win'}).length;
var losses=backtests.filter(function(b){return b.result==='Loss'}).length;
var winRate=backtests.length?(wins/backtests.length*100):0;
var avgRR=backtests.filter(function(b){return b.rr>0}).reduce(function(s,b,i,a){return s+b.rr/a.length},0);
stats.innerHTML='<div class="stat-card"><div class="stat-label">Total Backtests</div><div class="stat-value gold">'+backtests.length+'</div></div><div class="stat-card"><div class="stat-label">Backtest Win Rate</div><div class="stat-value '+(winRate>=50?'positive':'negative')+'">'+winRate.toFixed(1)+'%</div></div><div class="stat-card"><div class="stat-label">Wins / Losses</div><div class="stat-value"><span class="positive">'+wins+'</span> / <span class="negative">'+losses+'</span></div></div><div class="stat-card"><div class="stat-label">Avg R:R</div><div class="stat-value gold">'+avgRR.toFixed(2)+'</div></div>';
table.innerHTML=backtests.map(function(b){
var strat=strategies.find(function(s){return s.id===b.strategy});
return '<tr><td>'+(strat?'<span style="color:'+strat.color+'">'+strat.name+'</span>':'<span style="color:var(--text2)">-</span>')+'</td><td>'+b.date+'</td><td><strong>'+b.pair+'</strong></td><td><span class="badge badge-'+b.direction.toLowerCase()+'">'+b.direction+'</span></td><td><span class="badge badge-'+b.result.toLowerCase()+'">'+b.result+'</span></td><td>'+(b.rr?'1:'+b.rr.toFixed(1):'-')+'</td><td style="max-width:150px;overflow:hidden;text-overflow:ellipsis">'+(b.notes||'-')+'</td><td><div class="action-btns"><button class="action-btn edit" onclick="openBacktestModal(\''+b.id+'\')">âœï¸</button><button class="action-btn delete" onclick="deleteBacktest(\''+b.id+'\')">ğŸ—‘ï¸</button></div></td></tr>'}).join('')}

// ============================================
// MISSED TRADES FUNCTIONS
// ============================================
function openMissedTradeModal(id){
document.getElementById('editMissedId').value='';
document.getElementById('missedDate').value=new Date().toISOString().split('T')[0];
document.getElementById('missedPair').value='';
document.getElementById('missedDirection').value='Long';
document.getElementById('missedZone').value='Demand';
document.getElementById('missedResult').value='Win';
document.getElementById('missedRR').value='';
document.getElementById('missedReason').value='Not at screen';
document.getElementById('missedNotes').value='';
document.getElementById('missedImgPreview').style.display='none';
document.getElementById('missedImgPreview').src='';
document.getElementById('missedImgPreview').dataset.local='';
// Populate strategy selector
var stratSel=document.getElementById('missedStrategy');
stratSel.innerHTML='<option value="">No Strategy</option>'+strategies.map(function(s){return '<option value="'+s.id+'">'+s.name+'</option>'}).join('');
stratSel.value='';
if(id){
var mt=missedTrades.find(function(m){return m.id===id});
if(mt){
document.getElementById('editMissedId').value=id;
document.getElementById('missedDate').value=mt.date||'';
document.getElementById('missedPair').value=mt.pair||'';
document.getElementById('missedDirection').value=mt.direction||'Long';
document.getElementById('missedZone').value=mt.zone||'Demand';
document.getElementById('missedResult').value=mt.result||'Win';
document.getElementById('missedRR').value=mt.rr||'';
document.getElementById('missedReason').value=mt.reason||'Not at screen';
document.getElementById('missedNotes').value=mt.notes||'';
stratSel.value=mt.strategy||'';
if(mt.screenshot){document.getElementById('missedImgPreview').src=mt.screenshot;document.getElementById('missedImgPreview').style.display='block'}
}}
openModal('missedTradeModal')}

function previewMissedImg(){
var f=document.getElementById('missedScreenshot').files[0];
if(!f)return;
var preview=document.getElementById('missedImgPreview');
var reader=new FileReader();
reader.onload=function(e){preview.src=e.target.result;preview.style.display='block';preview.dataset.local='true'};
reader.readAsDataURL(f)}

function saveMissedTrade(){
var pair=document.getElementById('missedPair').value.trim().toUpperCase();
if(!pair){showToast('Enter pair','error');return}
var id=document.getElementById('editMissedId').value||'mt_'+Date.now();
var preview=document.getElementById('missedImgPreview');
var hasNewImg=preview.style.display==='block'&&preview.src&&preview.dataset.local==='true';
var doSave=function(imgUrl){
var mt={
id:id,
strategy:document.getElementById('missedStrategy').value,
date:document.getElementById('missedDate').value,
pair:pair,
direction:document.getElementById('missedDirection').value,
zone:document.getElementById('missedZone').value,
result:document.getElementById('missedResult').value,
rr:parseFloat(document.getElementById('missedRR').value)||0,
reason:document.getElementById('missedReason').value,
notes:document.getElementById('missedNotes').value,
screenshot:imgUrl
};
var idx=missedTrades.findIndex(function(m){return m.id===id});
if(idx!==-1)missedTrades[idx]=mt;
else missedTrades.unshift(mt);
localStorage.setItem('sdMissed',JSON.stringify(missedTrades));
updateMissedTrades();
closeModal('missedTradeModal');
showToast('Missed trade saved!')};
if(hasNewImg){uploadImage(preview.src,function(url){doSave(url)})}
else{doSave(preview.src||'')}}

function deleteMissedTrade(id){
if(!confirm('Delete this missed trade?'))return;
missedTrades=missedTrades.filter(function(m){return m.id!==id});
localStorage.setItem('sdMissed',JSON.stringify(missedTrades));
updateMissedTrades();
showToast('Deleted')}

function updateMissedTrades(){
var table=document.getElementById('missedTable');
var stats=document.getElementById('missedStats');
if(!table)return;
if(!missedTrades.length){
table.innerHTML='<tr><td colspan="9" style="text-align:center;color:var(--text2);padding:30px">No missed trades logged. Track setups you didn\'t take!</td></tr>';
stats.innerHTML='';
return}
var wins=missedTrades.filter(function(m){return m.result==='Win'}).length;
var losses=missedTrades.filter(function(m){return m.result==='Loss'}).length;
var winRate=missedTrades.length?(wins/missedTrades.length*100):0;
var missedProfit=missedTrades.filter(function(m){return m.result==='Win'&&m.rr>0}).reduce(function(s,m){return s+m.rr},0);
var reasonCounts={};
missedTrades.forEach(function(m){reasonCounts[m.reason]=(reasonCounts[m.reason]||0)+1});
var topReason=Object.keys(reasonCounts).sort(function(a,b){return reasonCounts[b]-reasonCounts[a]})[0]||'-';
stats.innerHTML='<div class="stat-card"><div class="stat-label">Missed Trades</div><div class="stat-value gold">'+missedTrades.length+'</div></div><div class="stat-card"><div class="stat-label">Would Have Won</div><div class="stat-value positive">'+winRate.toFixed(0)+'%</div></div><div class="stat-card"><div class="stat-label">Missed R:R</div><div class="stat-value negative">'+missedProfit.toFixed(1)+'R</div></div><div class="stat-card"><div class="stat-label">Top Reason</div><div class="stat-value" style="font-size:1rem;color:var(--gold)">'+topReason+'</div></div>';
table.innerHTML=missedTrades.map(function(m){
var strat=strategies.find(function(s){return s.id===m.strategy});
var stratName=strat?'<span style="color:'+strat.color+'">'+strat.name+'</span>':'<span style="color:var(--text2)">-</span>';
return '<tr><td>'+stratName+'</td><td>'+m.date+'</td><td><strong>'+m.pair+'</strong></td><td><span class="badge badge-'+m.direction.toLowerCase()+'">'+m.direction+'</span></td><td><span class="badge badge-'+m.zone.toLowerCase()+'">'+m.zone+'</span></td><td><span class="badge badge-'+(m.result==='Win'?'win':m.result==='Loss'?'loss':'be')+'">'+(m.result==='Win'?'âœ… Yes':m.result==='Loss'?'âŒ No':m.result==='BE'?'â– BE':'â“')+'</span></td><td>'+m.reason+'</td><td>'+(m.screenshot?'<img src="'+m.screenshot+'" style="width:50px;height:35px;object-fit:cover;border-radius:4px;cursor:pointer" onclick="window.open(\''+m.screenshot+'\')">':'-')+'</td><td><div class="action-btns"><button class="action-btn edit" onclick="openMissedTradeModal(\''+m.id+'\')">âœï¸</button><button class="action-btn delete" onclick="deleteMissedTrade(\''+m.id+'\')">ğŸ—‘ï¸</button></div></td></tr>'}).join('')}

// ============================================
// PAIR ANALYSIS FUNCTIONS
// ============================================
function savePairColumns(){localStorage.setItem('sdPairColumns',JSON.stringify(pairColumns))}
function savePairAnalysisData(){localStorage.setItem('sdPairAnalysis',JSON.stringify(pairAnalysis))}

function openColumnManager(){
document.getElementById('newColumnName').value='';
document.getElementById('newColumnType').value='text';
document.getElementById('newColumnOptions').value='';
document.getElementById('columnOptionsDiv').style.display='none';
renderColumnList();
openModal('columnManagerModal')}

function renderColumnList(){
var list=document.getElementById('columnList');
list.innerHTML=pairColumns.map(function(col,i){
var locked=col.locked?'<span style="color:var(--text2);font-size:.75rem">(required)</span>':'<button class="action-btn delete" onclick="deletePairColumn('+i+')" style="margin-left:auto">ğŸ—‘ï¸</button>';
return '<div style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg3);border-radius:6px;margin-bottom:8px"><span style="color:var(--gold)">â˜°</span><input type="text" value="'+col.name+'" onchange="renamePairColumn('+i+',this.value)" style="flex:1;padding:8px;background:var(--bg2);border:1px solid var(--border);border-radius:4px;color:var(--text)"'+(col.locked?' disabled':'')+' ><span style="color:var(--text2);font-size:.8rem;min-width:60px">'+col.type+'</span>'+locked+'</div>'}).join('')}

document.getElementById('newColumnType').addEventListener('change',function(){
document.getElementById('columnOptionsDiv').style.display=this.value==='select'?'block':'none'});

function addPairColumn(){
var name=document.getElementById('newColumnName').value.trim();
var type=document.getElementById('newColumnType').value;
if(!name){showToast('Enter column name','error');return}
var col={id:'col_'+Date.now(),name:name,type:type};
if(type==='select'){
var opts=document.getElementById('newColumnOptions').value.split(',').map(function(o){return o.trim()}).filter(Boolean);
if(!opts.length){showToast('Enter dropdown options','error');return}
col.options=opts}
pairColumns.push(col);
savePairColumns();
renderColumnList();
updatePairAnalysisTable();
document.getElementById('newColumnName').value='';
document.getElementById('newColumnOptions').value='';
showToast('Column added!')}

function renamePairColumn(index,newName){
pairColumns[index].name=newName;
savePairColumns();
updatePairAnalysisTable()}

function deletePairColumn(index){
if(!confirm('Delete this column? Data in this column will be lost.'))return;
var colId=pairColumns[index].id;
pairColumns.splice(index,1);
pairAnalysis.forEach(function(p){delete p[colId]});
savePairColumns();
savePairAnalysisData();
renderColumnList();
updatePairAnalysisTable();
showToast('Column deleted')}

function openPairAnalysisModal(id){
document.getElementById('editPairAnalysisId').value='';
document.getElementById('pairAnalysisModalTitle').textContent='ğŸ”¬ Add Pair Analysis';
var form=document.getElementById('pairAnalysisForm');
var html='<div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">';

// Get all pairs from customConfig
var allPairs=[];
var pairGroups=[
{name:'Major',pairs:['EURUSD','GBPUSD','USDJPY','USDCHF','AUDUSD','USDCAD','NZDUSD']},
{name:'Cross',pairs:['EURGBP','EURJPY','GBPJPY','AUDJPY','EURAUD','GBPAUD','EURNZD','GBPNZD','AUDNZD','CADJPY','CHFJPY']},
{name:'Indices',pairs:['US30','US100','US500','GER40','UK100','JPN225','AUS200']},
{name:'Commodities',pairs:['XAUUSD','XAGUSD','USOIL','UKOIL']},
{name:'Crypto',pairs:['BTCUSD','ETHUSD']}
];
if(customConfig&&customConfig.pairs&&customConfig.pairs.length){
pairGroups.unshift({name:'â˜… Custom',pairs:customConfig.pairs})}

pairColumns.forEach(function(col){
var fieldHtml='';
if(col.type==='text'||col.type==='number'){
fieldHtml='<input type="'+(col.type==='number'?'number':'text')+'" id="pa_'+col.id+'" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;color:var(--text)">'
}else if(col.type==='yesno'){
fieldHtml='<select id="pa_'+col.id+'" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;color:var(--text)"><option value="">Select...</option><option value="Yes">Yes</option><option value="No">No</option></select>'
}else if(col.type==='select'){
fieldHtml='<select id="pa_'+col.id+'" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;color:var(--text)"><option value="">Select...</option>'+(col.options||[]).map(function(o){return '<option>'+o+'</option>'}).join('')+'</select>'
}else if(col.type==='pairselect'){
fieldHtml='<select id="pa_'+col.id+'" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;color:var(--text)"><option value="">Select pair...</option>'+pairGroups.map(function(g){return '<optgroup label="'+g.name+'">'+g.pairs.map(function(p){return '<option>'+p+'</option>'}).join('')+'</optgroup>'}).join('')+'</select>'
}
html+='<div class="form-group"><label>'+col.name+'</label>'+fieldHtml+'</div>'});
html+='</div>';
form.innerHTML=html;
if(id){
var entry=pairAnalysis.find(function(p){return p.id===id});
if(entry){
document.getElementById('editPairAnalysisId').value=id;
document.getElementById('pairAnalysisModalTitle').textContent='ğŸ”¬ Edit Pair Analysis';
pairColumns.forEach(function(col){
var el=document.getElementById('pa_'+col.id);
if(el)el.value=entry[col.id]||''})}}
openModal('pairAnalysisModal')}

function savePairAnalysis(){
var id=document.getElementById('editPairAnalysisId').value||'pa_'+Date.now();
var entry={id:id};
pairColumns.forEach(function(col){
var el=document.getElementById('pa_'+col.id);
entry[col.id]=el?el.value:''});
if(!entry.pair){showToast('Enter pair name','error');return}
var idx=pairAnalysis.findIndex(function(p){return p.id===id});
if(idx!==-1)pairAnalysis[idx]=entry;
else pairAnalysis.push(entry);
savePairAnalysisData();
updatePairAnalysisTable();
closeModal('pairAnalysisModal');
showToast('Saved!')}

function deletePairAnalysis(id){
if(!confirm('Delete this entry?'))return;
pairAnalysis=pairAnalysis.filter(function(p){return p.id!==id});
savePairAnalysisData();
updatePairAnalysisTable();
showToast('Deleted')}

function updatePairAnalysisTable(){
var header=document.getElementById('pairAnalysisHeader');
var body=document.getElementById('pairAnalysisBody');
var statsDiv=document.getElementById('pairAnalyticsStats');
var detailedDiv=document.getElementById('pairAnalyticsDetailed');
var filterSelect=document.getElementById('pairAnalysisFilter');
if(!header||!body)return;

// Update filter dropdown with unique pairs
if(filterSelect){
var currentFilter=filterSelect.value;
var uniquePairs=[];
pairAnalysis.forEach(function(p){
if(p.pair&&uniquePairs.indexOf(p.pair)===-1)uniquePairs.push(p.pair)});
uniquePairs.sort();
filterSelect.innerHTML='<option value="">ğŸ“Š All Pairs ('+pairAnalysis.length+')</option>'+
uniquePairs.map(function(p){
var count=pairAnalysis.filter(function(x){return x.pair===p}).length;
return '<option value="'+p+'">'+p+' ('+count+')</option>'}).join('');
filterSelect.value=currentFilter}

// Get filtered data
var selectedPair=filterSelect?filterSelect.value:'';
var filteredData=selectedPair?pairAnalysis.filter(function(p){return p.pair===selectedPair}):pairAnalysis;

// Update table header
header.innerHTML=pairColumns.map(function(col){return '<th>'+col.name+'</th>'}).join('')+'<th>Actions</th>';

if(!pairAnalysis.length){
body.innerHTML='<tr><td colspan="'+(pairColumns.length+1)+'" style="text-align:center;color:var(--text2);padding:40px">No pair analysis entries yet. Add your first analysis!</td></tr>';
if(statsDiv)statsDiv.innerHTML='';
if(detailedDiv)detailedDiv.innerHTML='';
return}

if(!filteredData.length){
body.innerHTML='<tr><td colspan="'+(pairColumns.length+1)+'" style="text-align:center;color:var(--text2);padding:40px">No entries for selected pair</td></tr>';
if(statsDiv)statsDiv.innerHTML='';
if(detailedDiv)detailedDiv.innerHTML='';
return}

// Update table body with filtered data
body.innerHTML=filteredData.map(function(entry){
return '<tr>'+pairColumns.map(function(col){
var val=entry[col.id]||'-';
if(col.type==='yesno'){
val=val==='Yes'?'<span style="color:var(--green)">âœ“ Yes</span>':val==='No'?'<span style="color:var(--red)">âœ— No</span>':'-'}
else if(col.id==='result'){
val=val==='Win'?'<span class="badge badge-win">âœ“ Win</span>':val==='SL'?'<span class="badge badge-loss">âœ— SL</span>':val==='BE'?'<span class="badge badge-be">â– BE</span>':'-'}
return '<td>'+val+'</td>'}).join('')+'<td><div class="action-btns"><button class="action-btn edit" onclick="openPairAnalysisModal(\''+entry.id+'\')">âœï¸</button><button class="action-btn delete" onclick="deletePairAnalysis(\''+entry.id+'\')">ğŸ—‘ï¸</button></div></td></tr>'}).join('');

// Calculate Analytics using filtered data
if(statsDiv){
var total=filteredData.length;
var pairLabel=selectedPair?selectedPair:'All Pairs';

// Count Yes/No columns
var yesNoCounts={};
pairColumns.forEach(function(col){
if(col.type==='yesno'){
var yesCount=filteredData.filter(function(p){return p[col.id]==='Yes'}).length;
yesNoCounts[col.id]={yes:yesCount,no:total-yesCount,pct:Math.round(yesCount/total*100)}}});

// Parse time fields (2R, Max to opposing) - extract numbers and "days"
function parseDays(val){
if(!val||val==='-')return null;
var match=val.match(/(\d+)\s*days?/i);
if(match)return parseInt(match[1]);
var num=parseFloat(val);
return isNaN(num)?null:num}

var timeToRValues=filteredData.map(function(p){return parseDays(p.timeToR)}).filter(function(v){return v!==null});
var avgTimeToR=timeToRValues.length?timeToRValues.reduce(function(a,b){return a+b},0)/timeToRValues.length:0;

var maxOppValues=filteredData.map(function(p){return parseDays(p.maxToOpposing)}).filter(function(v){return v!==null});
var avgMaxOpp=maxOppValues.length?maxOppValues.reduce(function(a,b){return a+b},0)/maxOppValues.length:0;

// Parse R values
function parseR(val){
if(!val||val==='-')return null;
var match=val.match(/([\d.]+)\s*R/i);
if(match)return parseFloat(match[1]);
return null}

var rValues=filteredData.map(function(p){return parseR(p.maxToOpposing)}).filter(function(v){return v!==null});
var avgR=rValues.length?rValues.reduce(function(a,b){return a+b},0)/rValues.length:0;

// Calculate Win Rate from Result column
var wins=filteredData.filter(function(p){return p.result==='Win'}).length;
var losses=filteredData.filter(function(p){return p.result==='SL'}).length;
var winRate=wins+losses>0?Math.round(wins/(wins+losses)*100):0;

// Main stats
statsDiv.innerHTML='<div class="stat-card"><div class="stat-label">'+(selectedPair?'Entries for '+selectedPair:'Total Pairs Analyzed')+'</div><div class="stat-value gold">'+total+'</div></div>'+
'<div class="stat-card"><div class="stat-label">Win Rate</div><div class="stat-value '+(winRate>=50?'positive':'negative')+'">'+winRate+'%</div><div style="font-size:.75rem;color:var(--text2)">'+wins+'W / '+losses+'L</div></div>'+
(yesNoCounts.weeklyCoverage?'<div class="stat-card"><div class="stat-label">Weekly Coverage</div><div class="stat-value '+(yesNoCounts.weeklyCoverage.pct>=50?'positive':'negative')+'">'+yesNoCounts.weeklyCoverage.pct+'%</div><div style="font-size:.75rem;color:var(--text2)">'+yesNoCounts.weeklyCoverage.yes+' / '+total+'</div></div>':'')+
(yesNoCounts.dailyZone?'<div class="stat-card"><div class="stat-label">Daily Zone</div><div class="stat-value '+(yesNoCounts.dailyZone.pct>=50?'positive':'negative')+'">'+yesNoCounts.dailyZone.pct+'%</div><div style="font-size:.75rem;color:var(--text2)">'+yesNoCounts.dailyZone.yes+' / '+total+'</div></div>':'')+
(yesNoCounts.shortTermVal?'<div class="stat-card"><div class="stat-label">Short Term Valuation</div><div class="stat-value '+(yesNoCounts.shortTermVal.pct>=50?'positive':'negative')+'">'+yesNoCounts.shortTermVal.pct+'%</div><div style="font-size:.75rem;color:var(--text2)">'+yesNoCounts.shortTermVal.yes+' / '+total+'</div></div>':'')+
(yesNoCounts.longTermVal?'<div class="stat-card"><div class="stat-label">Long Term Valuation</div><div class="stat-value '+(yesNoCounts.longTermVal.pct>=50?'positive':'negative')+'">'+yesNoCounts.longTermVal.pct+'%</div><div style="font-size:.75rem;color:var(--text2)">'+yesNoCounts.longTermVal.yes+' / '+total+'</div></div>':'')+
(yesNoCounts.pocHighVol?'<div class="stat-card"><div class="stat-label">POC High Volume</div><div class="stat-value '+(yesNoCounts.pocHighVol.pct>=50?'positive':'negative')+'">'+yesNoCounts.pocHighVol.pct+'%</div><div style="font-size:.75rem;color:var(--text2)">'+yesNoCounts.pocHighVol.yes+' / '+total+'</div></div>':'')+
(avgTimeToR?'<div class="stat-card"><div class="stat-label">Avg Time to 2R</div><div class="stat-value gold">'+avgTimeToR.toFixed(1)+' days</div></div>':'')+
(avgR?'<div class="stat-card"><div class="stat-label">Avg Max R</div><div class="stat-value positive">'+avgR.toFixed(1)+'R</div></div>':'')
}

// Detailed Analytics using filtered data
if(detailedDiv){
var total=filteredData.length;
var html='';

// Yes/No breakdown chart
var yesNoData=[];
pairColumns.forEach(function(col){
if(col.type==='yesno'){
var yesCount=filteredData.filter(function(p){return p[col.id]==='Yes'}).length;
var pct=total?Math.round(yesCount/total*100):0;
yesNoData.push({name:col.name,yes:yesCount,no:total-yesCount,pct:pct})}});

if(yesNoData.length){
html+='<div class="card" style="background:var(--bg2)"><div class="card-header"><h4>ğŸ“Š Criteria Breakdown'+(selectedPair?' - '+selectedPair:'')+'</h4></div><div class="card-body">';
yesNoData.forEach(function(d){
html+='<div style="margin-bottom:12px"><div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="font-size:.85rem">'+d.name+'</span><span style="font-size:.85rem;color:var(--gold)">'+d.pct+'%</span></div><div style="height:8px;background:var(--bg3);border-radius:4px;overflow:hidden"><div style="height:100%;width:'+d.pct+'%;background:linear-gradient(90deg,var(--green),var(--gold));border-radius:4px"></div></div></div>'});
html+='</div></div>'}

// Dropdown/Select breakdowns
pairColumns.forEach(function(col){
if(col.type==='select'&&col.options){
var counts={};
col.options.forEach(function(o){counts[o]=0});
filteredData.forEach(function(p){
var val=p[col.id];
if(val&&counts.hasOwnProperty(val))counts[val]++});
html+='<div class="card" style="background:var(--bg2)"><div class="card-header"><h4>ğŸ“ˆ '+col.name+'</h4></div><div class="card-body">';
col.options.forEach(function(o){
var pct=total?Math.round(counts[o]/total*100):0;
html+='<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border)"><span style="font-size:.85rem">'+o+'</span><span style="font-size:.85rem"><strong>'+counts[o]+'</strong> <span style="color:var(--text2)">('+pct+'%)</span></span></div>'});
html+='</div></div>'}});

// Time analysis
var timeToRVals=filteredData.map(function(p){
if(!p.timeToR||p.timeToR==='-')return null;
var match=p.timeToR.match(/(\d+)\s*days?/i);
if(match)return parseInt(match[1]);
var num=parseFloat(p.timeToR);
return isNaN(num)?null:num}).filter(function(v){return v!==null});

if(timeToRVals.length>=1){
var minTime=Math.min.apply(null,timeToRVals);
var maxTime=Math.max.apply(null,timeToRVals);
var avgTime=timeToRVals.reduce(function(a,b){return a+b},0)/timeToRVals.length;
html+='<div class="card" style="background:var(--bg2)"><div class="card-header"><h4>â±ï¸ Time Analysis'+(selectedPair?' - '+selectedPair:'')+'</h4></div><div class="card-body"><div class="trade-detail-grid"><div class="trade-detail-item"><label>Fastest 2R</label><span class="positive">'+minTime+' days</span></div><div class="trade-detail-item"><label>Slowest 2R</label><span class="negative">'+maxTime+' days</span></div><div class="trade-detail-item"><label>Average 2R</label><span class="gold">'+avgTime.toFixed(1)+' days</span></div>'+(timeToRVals.length>1?'<div class="trade-detail-item"><label>Data Points</label><span>'+timeToRVals.length+'</span></div>':'')+'</div></div></div>'}

detailedDiv.innerHTML=html}
}

function updateAll(){updateDashboard();updateCalendar();updateHistory();updateAnalytics();updateGallery();updateStrategies();updateBacktests();updateMissedTrades();updatePairAnalysisTable();populateFilters();updateDailyLimit()}
function showTab(id){document.querySelectorAll('.tab-content').forEach(function(t){t.classList.remove('active')});document.querySelectorAll('.tab').forEach(function(t){t.classList.remove('active')});document.getElementById(id).classList.add('active');var btn=document.querySelector('.tab[onclick="showTab(\''+id+'\')"]');if(btn)btn.classList.add('active');if(id==='analytics')setTimeout(updateAnalytics,100);if(id==='calendar')setTimeout(updateCalendar,100)}
function setDefaultDate(){var n=new Date();n.setMinutes(n.getMinutes()-n.getTimezoneOffset());document.getElementById('tradeDate').value=n.toISOString().slice(0,16);document.getElementById('tradeRisk').value=settings.risk}
function setDirection(d){document.getElementById('tradeDirection').value=d;document.querySelectorAll('.toggle-btn.long,.toggle-btn.short').forEach(function(b){b.classList.remove('selected')});document.querySelector('.toggle-btn.'+d.toLowerCase()).classList.add('selected');calculateRR()}
function setZone(z){document.getElementById('tradeZone').value=z;document.querySelectorAll('.toggle-btn.demand,.toggle-btn.supply').forEach(function(b){b.classList.remove('selected')});document.querySelector('.toggle-btn.'+z.toLowerCase()).classList.add('selected')}
function setEmotion(v){document.getElementById('tradeEmotion').value=v;document.querySelectorAll('.emotion-btn').forEach(function(b){b.classList.remove('selected')});document.querySelector('.emotion-btn[data-v="'+v+'"]').classList.add('selected')}
function setRating(v){document.getElementById('tradeRating').value=v;document.querySelectorAll('.rating-btn').forEach(function(b){b.classList.remove('selected')});document.querySelector('.rating-btn.'+v.toLowerCase()).classList.add('selected')}
function setupMistakes(){document.querySelectorAll('.mistake-tag').forEach(function(t){t.addEventListener('click',function(){t.classList.toggle('selected');document.getElementById('tradeMistakes').value=Array.from(document.querySelectorAll('.mistake-tag.selected')).map(function(x){return x.dataset.v}).join(',')})})}
function calculateRR(){var e=parseFloat(document.getElementById('tradeEntry').value),s=parseFloat(document.getElementById('tradeSL').value),t=parseFloat(document.getElementById('tradeTP').value),d=document.getElementById('tradeDirection').value;if(e&&s&&t&&d){var r=d==='Long'?(t-e)/(e-s):(e-t)/(s-e);var disp=document.getElementById('rrDisplay');if(r>0&&isFinite(r)){disp.textContent='1:'+r.toFixed(2);disp.style.color=r>=3?'var(--green)':r>=2?'var(--gold)':'var(--red)'}else{disp.textContent='Invalid';disp.style.color='var(--red)'}}}
function togglePnL(){document.getElementById('pnlGroup').style.display=document.getElementById('tradeOutcome').value==='Open'?'none':'block'}
function previewImg(){
var f=document.getElementById('tradeScreenshot').files[0];
if(!f)return;
var reader=new FileReader();
reader.onload=function(e){
var img=new Image();
img.onload=function(){
var canvas=document.createElement('canvas');
var maxW=800,maxH=600;
var w=img.width,h=img.height;
if(w>maxW){h=h*(maxW/w);w=maxW}
if(h>maxH){w=w*(maxH/h);h=maxH}
canvas.width=w;canvas.height=h;
var ctx=canvas.getContext('2d');
ctx.drawImage(img,0,0,w,h);
var compressed=canvas.toDataURL('image/jpeg',0.6);
var preview=document.getElementById('imgPreview');
preview.src=compressed;
preview.style.display='block';
preview.dataset.local='true';
};
img.src=e.target.result;
};
reader.readAsDataURL(f)}

function getStorageUsage(){
var total=0;
for(var key in localStorage){
if(localStorage.hasOwnProperty(key)){
total+=localStorage[key].length*2;
}
}
return total}

function checkStorage(){
var used=getStorageUsage();
var limit=5*1024*1024;
var pct=Math.round(used/limit*100);
if(pct>80){
showToast('âš ï¸ Storage '+pct+'% full! Export backup soon.','error');
}
return pct<95}

function saveTrades(){
// Skip storage check if cloud storage is configured (images are URLs, not base64)
var hasCloudStorage=(cloudinaryConfig.enabled&&cloudinaryConfig.cloudName&&cloudinaryConfig.uploadPreset)||cloudinaryConfig.imgurClientId;
if(!hasCloudStorage&&!checkStorage()){
if(!confirm('Storage almost full! Save without screenshots to free space?')){return false}
trades.forEach(function(t){if(t.screenshot&&t.screenshot.startsWith('data:')){t.screenshot=''}});
}
try{
localStorage.setItem('sdPro',JSON.stringify(trades));
return true;
}catch(e){
showToast('Storage full! Export & clear old trades.','error');
return false;
}}

document.getElementById('tradeForm').addEventListener('submit',function(e){e.preventDefault();
var dir=document.getElementById('tradeDirection').value;
var zone=document.getElementById('tradeZone').value;
var pair=document.getElementById('tradePair').value;
var session=document.getElementById('tradeSession').value;
var tf=document.getElementById('tradeTimeframe').value;
var setup=document.getElementById('tradeSetup').value;
var entryVal=document.getElementById('tradeEntry').value;
var slVal=document.getElementById('tradeSL').value;
var tpVal=document.getElementById('tradeTP').value;
var sizeVal=document.getElementById('tradeSize').value;
var riskVal=document.getElementById('tradeRisk').value;
if(!dir){showToast('Select Direction (Long/Short)','error');return}
if(!zone){showToast('Select Zone Type (Demand/Supply)','error');return}
if(!pair){showToast('Select a Pair','error');return}
if(!session){showToast('Select Session','error');return}
if(!tf){showToast('Select Timeframe','error');return}
if(!setup){showToast('Select Setup Quality','error');return}
if(!entryVal){showToast('Enter Entry Price','error');return}
if(!slVal){showToast('Enter Stop Loss','error');return}
if(!tpVal){showToast('Enter Take Profit','error');return}
if(!sizeVal){showToast('Enter Position Size','error');return}
if(!riskVal){showToast('Enter Risk Amount','error');return}
var editId=document.getElementById('editId').value;
var entry=parseFloat(entryVal),sl=parseFloat(slVal),tp=parseFloat(tpVal);
var rr=dir==='Long'?(tp-entry)/(entry-sl):(entry-tp)/(sl-entry);
var trade={id:editId||Date.now().toString(),account:document.getElementById('tradeAccount').value||'default',strategy:document.getElementById('tradeStrategy').value||'',date:document.getElementById('tradeDate').value,session:session,pair:pair,direction:dir,zone:zone,timeframe:tf,setup:setup,htfBias:document.getElementById('tradeHTFBias').value,htfTrend:document.getElementById('tradeHTFTrend').value,execTF:document.getElementById('tradeExecTF').value,execTrend:document.getElementById('tradeExecTrend').value,liquidity:document.getElementById('tradeLiquidity').value,arrival:document.getElementById('tradeArrival').value,baseCandles:document.getElementById('tradeBaseCandles').value,baseVolume:document.getElementById('tradeBaseVolume').value,legOut:document.getElementById('tradeLegOut').value,zoneFresh:document.getElementById('tradeZoneFresh').value,bigBro:document.getElementById('tradeBigBro').value,smallBro:document.getElementById('tradeSmallBro').value,flipZone:document.getElementById('tradeFlipZone').value,zoneScore:calculateZoneScore(),entry:entry,sl:sl,tp:tp,size:parseFloat(sizeVal),risk:parseFloat(riskVal),rr:rr,outcome:document.getElementById('tradeOutcome').value,pnl:parseFloat(document.getElementById('tradePnL').value)||0,emotion:parseInt(document.getElementById('tradeEmotion').value)||3,rating:document.getElementById('tradeRating').value,mistakes:document.getElementById('tradeMistakes').value,preNotes:document.getElementById('tradePreNotes').value,postNotes:document.getElementById('tradePostNotes').value,lessons:document.getElementById('tradeLessons').value,screenshot:''};
var preview=document.getElementById('imgPreview');
var hasNewImage=preview.style.display==='block'&&preview.src&&preview.dataset.local==='true';
if(hasNewImage){
document.querySelector('#tradeForm button[type="submit"]').disabled=true;
document.querySelector('#tradeForm button[type="submit"]').textContent='â³ Uploading...';
uploadImage(preview.src,function(url){
trade.screenshot=url;
finishSaveTrade(trade,editId);
document.querySelector('#tradeForm button[type="submit"]').disabled=false;
document.querySelector('#tradeForm button[type="submit"]').textContent='ğŸ’¾ Save Trade';
})}else{
trade.screenshot=preview.src||'';
finishSaveTrade(trade,editId)}});

function finishSaveTrade(trade,editId){
if(editId){var i=trades.findIndex(function(t){return t.id===editId});if(i!==-1)trades[i]=trade}else trades.unshift(trade);
saveTrades();resetForm();updateAll();showTab('history');showToast(editId?'Updated!':'Saved!')}

function resetForm(){document.getElementById('tradeForm').reset();document.getElementById('editId').value='';document.getElementById('editIndicator').style.display='none';var preview=document.getElementById('imgPreview');preview.style.display='none';preview.src='';preview.dataset.local='';document.querySelectorAll('.toggle-btn,.emotion-btn,.rating-btn,.mistake-tag').forEach(function(b){b.classList.remove('selected')});document.querySelector('.emotion-btn[data-v="3"]').classList.add('selected');document.getElementById('rrDisplay').textContent='-';document.getElementById('zoneScoreDisplay').textContent='-';setDefaultDate()}

function updateDashboard(){
var allTrades=getFilteredTrades();
var closed=allTrades.filter(function(t){return t.outcome!=='Open'});
var wins=closed.filter(function(t){return t.outcome==='Win'});
var losses=closed.filter(function(t){return t.outcome==='Loss'});
var totalPnL=closed.reduce(function(s,t){return s+(t.pnl||0)},0);
var winRate=closed.length?(wins.length/closed.length*100):0;
var avgWin=wins.length?wins.reduce(function(s,t){return s+t.pnl},0)/wins.length:0;
var avgLoss=losses.length?Math.abs(losses.reduce(function(s,t){return s+t.pnl},0)/losses.length):0;
var pf=avgLoss?(avgWin*wins.length)/(avgLoss*losses.length):0;
var rrTrades=closed.filter(function(t){return t.rr>0});
var avgRR=rrTrades.length?rrTrades.reduce(function(s,t){return s+t.rr},0)/rrTrades.length:0;
var exp=closed.length?(winRate/100*avgRR)+((1-winRate/100)*-1):0;
var streak=calcStreak();
var weekStart=getWeekStart(new Date());
var weekTrades=closed.filter(function(t){return new Date(t.date)>=weekStart});
var weekWins=weekTrades.filter(function(t){return t.outcome==='Win'}).length;
var weekPnL=weekTrades.reduce(function(s,t){return s+(t.pnl||0)},0);
var weekWR=weekTrades.length?(weekWins/weekTrades.length*100):0;

document.getElementById('weeklySummary').innerHTML='<h3>ğŸ“… This Week</h3><div class="weekly-stats"><div><div class="stat-label">Trades</div><div class="stat-value">'+weekTrades.length+'</div></div><div><div class="stat-label">Win Rate</div><div class="stat-value '+(weekWR>=50?'positive':'negative')+'">'+weekWR.toFixed(1)+'%</div></div><div><div class="stat-label">P&L</div><div class="stat-value '+(weekPnL>=0?'positive':'negative')+'">$'+weekPnL.toFixed(2)+'</div></div><div><div class="stat-label">Streak</div><div class="stat-value"><span class="streak-badge '+streak.type+'-streak">'+(streak.type==='win'?'ğŸ”¥':'â„ï¸')+' '+streak.count+'</span></div></div></div>';

document.getElementById('statsGrid').innerHTML='<div class="stat-card highlight"><div class="stat-label">Total P&L</div><div class="stat-value '+(totalPnL>=0?'positive':'negative')+'">$'+totalPnL.toFixed(2)+'</div></div><div class="stat-card"><div class="stat-label">Win Rate</div><div class="stat-value '+(winRate>=50?'positive':'negative')+'">'+winRate.toFixed(1)+'%</div></div><div class="stat-card"><div class="stat-label">Profit Factor</div><div class="stat-value '+(pf>=1.5?'positive':pf>=1?'gold':'negative')+'">'+pf.toFixed(2)+'</div></div><div class="stat-card"><div class="stat-label">Avg R:R</div><div class="stat-value gold">1:'+avgRR.toFixed(2)+'</div></div><div class="stat-card"><div class="stat-label">Expectancy</div><div class="stat-value '+(exp>=0?'positive':'negative')+'">'+exp.toFixed(2)+'R</div></div><div class="stat-card"><div class="stat-label">Avg Win</div><div class="stat-value positive">$'+avgWin.toFixed(2)+'</div></div><div class="stat-card"><div class="stat-label">Avg Loss</div><div class="stat-value negative">-$'+avgLoss.toFixed(2)+'</div></div><div class="stat-card"><div class="stat-label">Total Trades</div><div class="stat-value">'+closed.length+'</div></div>';

var demand=closed.filter(function(t){return t.zone==='Demand'});
var supply=closed.filter(function(t){return t.zone==='Supply'});
var demandWR=demand.length?(demand.filter(function(t){return t.outcome==='Win'}).length/demand.length*100):0;
var supplyWR=supply.length?(supply.filter(function(t){return t.outcome==='Win'}).length/supply.length*100):0;
var demandPnL=demand.reduce(function(s,t){return s+(t.pnl||0)},0);
var supplyPnL=supply.reduce(function(s,t){return s+(t.pnl||0)},0);
var todayPnL=getTodayPnL();

document.getElementById('breakdownGrid').innerHTML='<div class="breakdown-card"><h3>ğŸŸ¦ Demand vs ğŸŸ§ Supply</h3><div class="breakdown-row"><span class="breakdown-label">Demand Trades</span><span class="breakdown-value">'+demand.length+'</span></div><div class="breakdown-row"><span class="breakdown-label">Demand Win Rate</span><span class="breakdown-value '+(demandWR>=50?'positive':'')+'">'+demandWR.toFixed(1)+'%</span></div><div class="breakdown-row"><span class="breakdown-label">Demand P&L</span><span class="breakdown-value '+(demandPnL>=0?'positive':'negative')+'">$'+demandPnL.toFixed(2)+'</span></div><div class="breakdown-row"><span class="breakdown-label">Supply Trades</span><span class="breakdown-value">'+supply.length+'</span></div><div class="breakdown-row"><span class="breakdown-label">Supply Win Rate</span><span class="breakdown-value '+(supplyWR>=50?'positive':'')+'">'+supplyWR.toFixed(1)+'%</span></div><div class="breakdown-row"><span class="breakdown-label">Supply P&L</span><span class="breakdown-value '+(supplyPnL>=0?'positive':'negative')+'">$'+supplyPnL.toFixed(2)+'</span></div></div><div class="breakdown-card"><h3>ğŸ“Š Quick Stats</h3><div class="breakdown-row"><span class="breakdown-label">Open Positions</span><span class="breakdown-value">'+allTrades.filter(function(t){return t.outcome==='Open'}).length+'</span></div><div class="breakdown-row"><span class="breakdown-label">Today P&L</span><span class="breakdown-value '+(todayPnL>=0?'positive':'negative')+'">$'+todayPnL.toFixed(2)+'</span></div><div class="breakdown-row"><span class="breakdown-label">Best Trade</span><span class="breakdown-value positive">$'+(closed.length?Math.max.apply(null,closed.map(function(t){return t.pnl||0})).toFixed(2):'0.00')+'</span></div><div class="breakdown-row"><span class="breakdown-label">Worst Trade</span><span class="breakdown-value negative">$'+(closed.length?Math.min.apply(null,closed.map(function(t){return t.pnl||0})).toFixed(2):'0.00')+'</span></div><div class="breakdown-row"><span class="breakdown-label">A-Rated</span><span class="breakdown-value">'+closed.filter(function(t){return t.rating==='A'}).length+'</span></div></div>';

updateEquityChart();updateWinLossChart()}

function calcStreak(){var c=trades.filter(function(t){return t.outcome==='Win'||t.outcome==='Loss'});if(!c.length)return{type:'win',count:0};var count=1,first=c[0].outcome;for(var i=1;i<c.length;i++){if(c[i].outcome===first)count++;else break}return{type:first.toLowerCase(),count:count}}
function getWeekStart(d){var day=d.getDay(),diff=d.getDate()-day+(day===0?-6:1);return new Date(d.setDate(diff))}
function getTodayTrades(){var today=new Date().toISOString().split('T')[0];return getFilteredTrades().filter(function(t){return t.date&&t.date.startsWith(today)})}
function getTodayPnL(){return getTodayTrades().filter(function(t){return t.outcome!=='Open'}).reduce(function(s,t){return s+(t.pnl||0)},0)}
function updateDailyLimit(){var pnl=getTodayPnL();document.getElementById('todayPnL').textContent='$'+pnl.toFixed(0);document.getElementById('dailyLimit').textContent='-$'+settings.limit;var d=document.getElementById('dailyLimitDisplay');d.classList.remove('danger');if(pnl<=-settings.limit)d.classList.add('danger')}

function updateEquityChart(){var ctx=document.getElementById('equityChart');if(!ctx)return;var closed=trades.filter(function(t){return t.outcome!=='Open'}).reverse();var running=0;var data=closed.map(function(t){running+=t.pnl||0;return running});if(charts.equity)charts.equity.destroy();charts.equity=new Chart(ctx,{type:'line',data:{labels:data.map(function(_,i){return i+1}),datasets:[{data:data,borderColor:'#FFD700',backgroundColor:'rgba(255,215,0,.1)',fill:true,tension:.4,pointRadius:2}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{grid:{color:'#2a2a2a'},ticks:{color:'#888'}},y:{grid:{color:'#2a2a2a'},ticks:{color:'#888'}}}}})}
function updateWinLossChart(){var ctx=document.getElementById('winLossChart');if(!ctx)return;var closed=trades.filter(function(t){return t.outcome!=='Open'});var w=closed.filter(function(t){return t.outcome==='Win'}).length;var l=closed.filter(function(t){return t.outcome==='Loss'}).length;var b=closed.filter(function(t){return t.outcome==='BE'}).length;if(charts.winLoss)charts.winLoss.destroy();charts.winLoss=new Chart(ctx,{type:'doughnut',data:{labels:['Wins','Losses','BE'],datasets:[{data:[w,l,b],backgroundColor:['#00C853','#FF1744','#555'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{color:'#888'}}}}})}

function updateCalendar(){var y=currentMonth.getFullYear(),m=currentMonth.getMonth();document.getElementById('calendarTitle').textContent=currentMonth.toLocaleDateString('en-US',{month:'long',year:'numeric'});var first=new Date(y,m,1),last=new Date(y,m+1,0),startDay=first.getDay()||7;var html=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(function(d){return '<div class="calendar-day-header">'+d+'</div>'}).join('');var prev=new Date(y,m,0);for(var i=startDay-1;i>0;i--)html+='<div class="calendar-day other-month"><div class="day-number">'+(prev.getDate()-i+1)+'</div></div>';var today=new Date();var filteredTrades=getFilteredTrades();for(var d=1;d<=last.getDate();d++){var ds=y+'-'+String(m+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');var dayT=filteredTrades.filter(function(t){return t.date&&t.date.startsWith(ds)});var dayPnL=dayT.filter(function(t){return t.outcome!=='Open'}).reduce(function(s,t){return s+(t.pnl||0)},0);var isToday=today.getDate()===d&&today.getMonth()===m&&today.getFullYear()===y;html+='<div class="calendar-day '+(isToday?'today':'')+'" onclick="showDay(\''+ds+'\')"><div class="day-number">'+d+'</div><div>'+dayT.slice(0,2).map(function(t){return '<div class="day-trade '+t.outcome.toLowerCase()+'">'+t.pair+'</div>'}).join('')+(dayT.length>2?'<div style="font-size:.7rem;color:var(--text2)">+'+(dayT.length-2)+'</div>':'')+'</div>'+(dayT.length?'<div class="day-pnl '+(dayPnL>=0?'positive':'negative')+'">$'+dayPnL.toFixed(0)+'</div>':'')+'</div>'}var rem=42-(startDay-1+last.getDate());for(var i=1;i<=rem&&rem<7;i++)html+='<div class="calendar-day other-month"><div class="day-number">'+i+'</div></div>';document.getElementById('calendarGrid').innerHTML=html;
var monthT=filteredTrades.filter(function(t){if(!t.date)return false;var dd=new Date(t.date);return dd.getMonth()===m&&dd.getFullYear()===y&&t.outcome!=='Open'});var monthPnL=monthT.reduce(function(s,t){return s+(t.pnl||0)},0);var monthWins=monthT.filter(function(t){return t.outcome==='Win'}).length;var monthWR=monthT.length?(monthWins/monthT.length*100):0;
document.getElementById('calendarSummary').innerHTML='<div class="stat-card"><div class="stat-label">Month Trades</div><div class="stat-value">'+monthT.length+'</div></div><div class="stat-card"><div class="stat-label">Month P&L</div><div class="stat-value '+(monthPnL>=0?'positive':'negative')+'">$'+monthPnL.toFixed(2)+'</div></div><div class="stat-card"><div class="stat-label">Win Rate</div><div class="stat-value '+(monthWR>=50?'positive':'')+'">'+monthWR.toFixed(1)+'%</div></div>'}
function changeMonth(d){currentMonth.setMonth(currentMonth.getMonth()+d);updateCalendar()}
function goToToday(){currentMonth=new Date();updateCalendar()}
function showDay(ds){var dayT=getFilteredTrades().filter(function(t){return t.date&&t.date.startsWith(ds)});if(!dayT.length)return showToast('No trades');var pnl=dayT.filter(function(t){return t.outcome!=='Open'}).reduce(function(s,t){return s+(t.pnl||0)},0);document.getElementById('dayModalTitle').textContent='ğŸ“… '+new Date(ds).toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});document.getElementById('dayModalBody').innerHTML='<div style="margin-bottom:15px;padding:12px;background:var(--bg2);border-radius:8px"><strong>P&L: <span class="'+(pnl>=0?'positive':'negative')+'">$'+pnl.toFixed(2)+'</span></strong> | '+dayT.length+' trades</div><table><thead><tr><th>Account</th><th>Pair</th><th>Dir</th><th>Zone</th><th>Result</th><th>P&L</th></tr></thead><tbody>'+dayT.map(function(t){var acc=accounts.find(function(a){return a.id===t.account})||accounts[0];return '<tr onclick="viewTrade(\''+t.id+'\')" style="cursor:pointer"><td><span style="color:'+acc.color+'">'+acc.name+'</span></td><td><strong>'+t.pair+'</strong></td><td><span class="badge badge-'+(t.direction||'').toLowerCase()+'">'+t.direction+'</span></td><td><span class="badge badge-'+(t.zone||'').toLowerCase()+'">'+t.zone+'</span></td><td><span class="badge badge-'+(t.outcome||'').toLowerCase()+'">'+t.outcome+'</span></td><td class="'+((t.pnl||0)>=0?'positive':'negative')+'">$'+(t.pnl||0).toFixed(2)+'</td></tr>'}).join('')+'</tbody></table>';openModal('dayModal')}

function updateHistory(){filterTrades();populateFilters()}
function filterTrades(){var out=document.getElementById('filterOutcome').value,pair=document.getElementById('filterPair').value,zone=document.getElementById('filterZone').value,from=document.getElementById('filterFrom').value,to=document.getElementById('filterTo').value;var f=getFilteredTrades().slice();if(out)f=f.filter(function(t){return t.outcome===out});if(pair)f=f.filter(function(t){return t.pair===pair});if(zone)f=f.filter(function(t){return t.zone===zone});if(from)f=f.filter(function(t){return t.date>=from});if(to)f=f.filter(function(t){return t.date<=to+'T23:59'});var tb=document.getElementById('tradesTable');if(!f.length){tb.innerHTML='<tr><td colspan="14"><div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><h3>No trades</h3></div></td></tr>';return}tb.innerHTML=f.map(function(t,i){var acc=accounts.find(function(a){return a.id===t.account})||accounts[0];return '<tr><td>'+(f.length-i)+'</td><td><span style="color:'+acc.color+';font-weight:600">'+acc.name+'</span></td><td>'+(t.date?new Date(t.date).toLocaleDateString():'-')+'</td><td>'+(t.session||'-')+'</td><td><strong>'+t.pair+'</strong></td><td><span class="badge badge-'+(t.direction||'').toLowerCase()+'">'+(t.direction||'-')+'</span></td><td><span class="badge badge-'+(t.zone||'').toLowerCase()+'">'+(t.zone||'-')+'</span></td><td>'+(t.timeframe||'-')+'</td><td>'+(t.setup||'-')+'</td><td>1:'+(t.rr||0).toFixed(2)+'</td><td>'+(t.rating||'-')+'</td><td><span class="badge badge-'+(t.outcome||'').toLowerCase()+'">'+(t.outcome||'-')+'</span></td><td class="'+((t.pnl||0)>=0?'positive':'negative')+'">$'+(t.pnl||0).toFixed(2)+'</td><td><div class="action-btns"><button class="action-btn view" onclick="viewTrade(\''+t.id+'\')">ğŸ‘ï¸</button><button class="action-btn edit" onclick="editTrade(\''+t.id+'\')">âœï¸</button><button class="action-btn delete" onclick="deleteTrade(\''+t.id+'\')">ğŸ—‘ï¸</button></div></td></tr>'}).join('')}
function populateFilters(){var pairs=[];trades.forEach(function(t){if(t.pair&&pairs.indexOf(t.pair)===-1)pairs.push(t.pair)});pairs.sort();document.getElementById('filterPair').innerHTML='<option value="">All Pairs</option>'+pairs.map(function(p){return '<option>'+p+'</option>'}).join('')}

function viewTrade(id){var t=trades.find(function(x){return x.id===id});if(!t)return;var acc=accounts.find(function(a){return a.id===t.account})||accounts[0];var strat=strategies.find(function(s){return s.id===t.strategy});document.getElementById('tradeModalBody').innerHTML='<div class="trade-detail-grid"><div class="trade-detail-item"><label>Account</label><span style="color:'+acc.color+'">'+acc.name+'</span></div>'+(strat?'<div class="trade-detail-item"><label>Strategy</label><span style="color:'+strat.color+'">'+strat.name+'</span></div>':'')+'<div class="trade-detail-item"><label>Date</label><span>'+(t.date?new Date(t.date).toLocaleString():'-')+'</span></div><div class="trade-detail-item"><label>Session</label><span>'+(t.session||'-')+'</span></div><div class="trade-detail-item"><label>Pair</label><span>'+t.pair+'</span></div><div class="trade-detail-item"><label>Direction</label><span class="badge badge-'+(t.direction||'').toLowerCase()+'">'+t.direction+'</span></div><div class="trade-detail-item"><label>Zone</label><span class="badge badge-'+(t.zone||'').toLowerCase()+'">'+t.zone+'</span></div><div class="trade-detail-item"><label>Setup</label><span>'+t.setup+'</span></div><div class="trade-detail-item"><label>Analysis TF</label><span>'+(t.timeframe||'-')+'</span></div><div class="trade-detail-item"><label>HTF Trend</label><span>'+(t.htfTrend||'-')+'</span></div><div class="trade-detail-item"><label>Execution TF</label><span>'+(t.execTF||'-')+'</span></div><div class="trade-detail-item"><label>Exec vs HTF</label><span>'+(t.execTrend||'-')+'</span></div><div class="trade-detail-item"><label>R:R</label><span style="color:var(--gold)">1:'+(t.rr||0).toFixed(2)+'</span></div><div class="trade-detail-item"><label>Outcome</label><span class="badge badge-'+(t.outcome||'').toLowerCase()+'">'+t.outcome+'</span></div><div class="trade-detail-item"><label>P&L</label><span class="'+((t.pnl||0)>=0?'positive':'negative')+'">$'+(t.pnl||0).toFixed(2)+'</span></div><div class="trade-detail-item"><label>Rating</label><span>'+(t.rating||'-')+'</span></div><div class="trade-detail-item"><label>Emotion</label><span>'+(['ğŸ˜«','ğŸ˜•','ğŸ˜','ğŸ™‚','ğŸ˜'][t.emotion-1]||'-')+'</span></div><div class="trade-detail-item"><label>Zone Score</label><span style="color:'+(t.zoneScore>=70?'var(--green)':t.zoneScore>=50?'var(--gold)':'var(--red)')+'">'+(t.zoneScore||'-')+'%</span></div></div>'+(t.liquidity||t.arrival||t.baseCandles?'<div style="margin-top:15px;padding:15px;background:var(--bg2);border-radius:8px;border-left:4px solid var(--blue)"><strong style="color:var(--blue)">ğŸ¯ OTC Zone Quality</strong><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-top:10px"><div><small style="color:var(--text2)">Liquidity</small><div>'+(t.liquidity==='2'?'âœ… Taken First':t.liquidity==='1'?'â“ Unclear':'âŒ None')+'</div></div><div><small style="color:var(--text2)">Arrival</small><div>'+(t.arrival==='2'?'âœ… Fast & Clean':'âš ï¸ Choppy')+'</div></div><div><small style="color:var(--text2)">Base</small><div>'+(t.baseCandles||'-')+' candles</div></div><div><small style="color:var(--text2)">Volume Score</small><div>'+(t.baseVolume||'-')+'</div></div><div><small style="color:var(--text2)">Leg-Out</small><div>'+(t.legOut||'-')+'</div></div><div><small style="color:var(--text2)">Freshness</small><div>'+(t.zoneFresh||'-')+'</div></div><div><small style="color:var(--text2)">Big Brother</small><div>'+(t.bigBro||'-')+'</div></div><div><small style="color:var(--text2)">Small Brother</small><div>'+(t.smallBro||'-')+'</div></div><div><small style="color:var(--text2)">Flip Zone</small><div>'+(t.flipZone||'-')+'</div></div></div></div>':'')+(t.mistakes?'<div style="margin-top:15px"><strong>Mistakes:</strong> '+t.mistakes.split(',').map(function(m){return '<span class="badge" style="background:rgba(255,23,68,.15);color:var(--red);margin:2px">'+m+'</span>'}).join('')+'</div>':'')+(t.preNotes?'<div style="margin-top:15px"><strong>Pre-Trade:</strong><p style="background:var(--bg2);padding:10px;border-radius:6px;margin-top:5px">'+t.preNotes+'</p></div>':'')+(t.postNotes?'<div style="margin-top:15px"><strong>Post-Trade:</strong><p style="background:var(--bg2);padding:10px;border-radius:6px;margin-top:5px">'+t.postNotes+'</p></div>':'')+(t.lessons?'<div style="margin-top:15px"><strong>Lessons:</strong><p style="background:var(--bg2);padding:10px;border-radius:6px;margin-top:5px">'+t.lessons+'</p></div>':'')+(t.screenshot?'<img src="'+t.screenshot+'" style="width:100%;border-radius:8px;margin-top:15px">':'');openModal('tradeModal')}
function editTrade(id){closeModal('dayModal');var t=trades.find(function(x){return x.id===id});if(!t)return;document.getElementById('editId').value=id;document.getElementById('editIndicator').style.display='inline';document.getElementById('tradeAccount').value=t.account||'default';document.getElementById('tradeStrategy').value=t.strategy||'';document.getElementById('tradeDate').value=t.date||'';document.getElementById('tradeSession').value=t.session||'';document.getElementById('tradePair').value=t.pair||'';if(t.direction)setDirection(t.direction);if(t.zone)setZone(t.zone);document.getElementById('tradeTimeframe').value=t.timeframe||'';document.getElementById('tradeSetup').value=t.setup||'';document.getElementById('tradeHTFBias').value=t.htfBias||'';document.getElementById('tradeHTFTrend').value=t.htfTrend||'';document.getElementById('tradeExecTF').value=t.execTF||'';document.getElementById('tradeExecTrend').value=t.execTrend||'';document.getElementById('tradeLiquidity').value=t.liquidity||'';document.getElementById('tradeArrival').value=t.arrival||'';document.getElementById('tradeBaseCandles').value=t.baseCandles||'';document.getElementById('tradeBaseVolume').value=t.baseVolume||'';document.getElementById('tradeLegOut').value=t.legOut||'';document.getElementById('tradeZoneFresh').value=t.zoneFresh||'';document.getElementById('tradeBigBro').value=t.bigBro||'';document.getElementById('tradeSmallBro').value=t.smallBro||'';document.getElementById('tradeFlipZone').value=t.flipZone||'';document.getElementById('tradeEntry').value=t.entry;document.getElementById('tradeSL').value=t.sl;document.getElementById('tradeTP').value=t.tp;document.getElementById('tradeSize').value=t.size;document.getElementById('tradeRisk').value=t.risk;document.getElementById('tradeOutcome').value=t.outcome;document.getElementById('tradePnL').value=t.pnl;setEmotion(t.emotion||3);if(t.rating)setRating(t.rating);document.getElementById('tradePreNotes').value=t.preNotes||'';document.getElementById('tradePostNotes').value=t.postNotes||'';document.getElementById('tradeLessons').value=t.lessons||'';if(t.mistakes)t.mistakes.split(',').forEach(function(m){var tag=document.querySelector('.mistake-tag[data-v="'+m+'"]');if(tag)tag.classList.add('selected')});document.getElementById('tradeMistakes').value=t.mistakes||'';var preview=document.getElementById('imgPreview');preview.dataset.local='';if(t.screenshot){preview.src=t.screenshot;preview.style.display='block'}else{preview.src='';preview.style.display='none'}calculateRR();calculateZoneScore();togglePnL();showTab('entry')}
function deleteTrade(id){if(confirm('Delete this trade?')){trades=trades.filter(function(t){return t.id!==id});saveTrades();updateAll();showToast('Deleted','error')}}

function updateAnalytics(){var closed=getFilteredTrades().filter(function(t){return t.outcome!=='Open'});

// ========== STREAK CALCULATIONS ==========
var sortedTrades=closed.slice().sort(function(a,b){return new Date(a.date)-new Date(b.date)});
var currentStreak=0,bestWinStreak=0,worstLossStreak=0,tempStreak=0,lastOutcome='';
sortedTrades.forEach(function(t){
if(t.outcome==='Win'){
if(lastOutcome==='Win'||lastOutcome==='')tempStreak++;
else tempStreak=1;
if(tempStreak>bestWinStreak)bestWinStreak=tempStreak;
}else if(t.outcome==='Loss'){
if(lastOutcome==='Loss'||lastOutcome==='')tempStreak--;
else tempStreak=-1;
if(tempStreak<worstLossStreak)worstLossStreak=tempStreak;
}else{tempStreak=0}
lastOutcome=t.outcome;
currentStreak=tempStreak});
document.getElementById('currentStreak').textContent=(currentStreak>0?'+':'')+currentStreak+'W';
document.getElementById('currentStreak').className='stat-value '+(currentStreak>0?'positive':currentStreak<0?'negative':'');
document.getElementById('bestStreak').textContent='+'+bestWinStreak+'W';
document.getElementById('worstStreak').textContent=worstLossStreak+'L';

// ========== BEST DAY & SESSION ==========
var days=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
var dayWinRates=days.map(function(_,i){var dt=closed.filter(function(t){return new Date(t.date).getDay()===i});var wins=dt.filter(function(t){return t.outcome==='Win'}).length;return dt.length>=3?{day:days[i],rate:wins/dt.length*100,count:dt.length}:null}).filter(Boolean);
var bestDayObj=dayWinRates.sort(function(a,b){return b.rate-a.rate})[0];
document.getElementById('bestDay').textContent=bestDayObj?bestDayObj.day+' ('+bestDayObj.rate.toFixed(0)+'%)':'-';

var sessions=['Asian','London','New York','Overlap'];
var sessWinRates=sessions.map(function(s){var st=closed.filter(function(t){return t.session===s});var wins=st.filter(function(t){return t.outcome==='Win'}).length;return st.length>=3?{sess:s,rate:wins/st.length*100,count:st.length}:null}).filter(Boolean);
var bestSessObj=sessWinRates.sort(function(a,b){return b.rate-a.rate})[0];
document.getElementById('bestSession').textContent=bestSessObj?bestSessObj.sess+' ('+bestSessObj.rate.toFixed(0)+'%)':'-';

// ========== BACKTEST VS LIVE COMPARISON ==========
var compDiv=document.getElementById('backtestVsLiveComparison');
if(compDiv){
var stratCompare=strategies.map(function(s){
var liveTrades=closed.filter(function(t){return t.strategy===s.id});
var liveWins=liveTrades.filter(function(t){return t.outcome==='Win'}).length;
var liveRate=liveTrades.length?Math.round(liveWins/liveTrades.length*100):0;
var btTrades=backtests.filter(function(b){return b.strategy===s.id});
var btWins=btTrades.filter(function(b){return b.result==='Win'}).length;
var btRate=btTrades.length?Math.round(btWins/btTrades.length*100):0;
return{name:s.name,color:s.color,live:liveRate,liveCnt:liveTrades.length,bt:btRate,btCnt:btTrades.length}}).filter(function(s){return s.liveCnt>0||s.btCnt>0});
if(stratCompare.length){
compDiv.innerHTML=stratCompare.map(function(s){
var diff=s.live-s.bt;
return '<div style="margin-bottom:15px;padding:10px;background:var(--bg3);border-radius:8px;border-left:3px solid '+s.color+'"><div style="font-weight:600;margin-bottom:8px">'+s.name+'</div><div style="display:flex;justify-content:space-between"><span>Backtest: <strong class="'+(s.bt>=50?'positive':'negative')+'">'+s.bt+'%</strong> <span style="color:var(--text2)">('+s.btCnt+')</span></span><span>Live: <strong class="'+(s.live>=50?'positive':'negative')+'">'+s.live+'%</strong> <span style="color:var(--text2)">('+s.liveCnt+')</span></span><span class="'+(diff>=0?'positive':'negative')+'">'+(diff>=0?'â–²':'â–¼')+Math.abs(diff)+'%</span></div></div>'}).join('')}
else{compDiv.innerHTML='<p style="color:var(--text2);text-align:center">Add strategies and trades to compare</p>'}}

// ========== BEST/WORST PAIRS ==========
var pairStats={};
closed.forEach(function(t){
if(!pairStats[t.pair])pairStats[t.pair]={wins:0,losses:0,pnl:0};
if(t.outcome==='Win')pairStats[t.pair].wins++;
else if(t.outcome==='Loss')pairStats[t.pair].losses++;
pairStats[t.pair].pnl+=(t.pnl||0)});
var pairArr=Object.keys(pairStats).map(function(p){var s=pairStats[p];var total=s.wins+s.losses;return{pair:p,winRate:total?Math.round(s.wins/total*100):0,pnl:s.pnl,count:total}}).filter(function(p){return p.count>=2});
var bestPairs=pairArr.slice().sort(function(a,b){return b.winRate-a.winRate||b.pnl-a.pnl}).slice(0,5);
var worstPairs=pairArr.slice().sort(function(a,b){return a.winRate-b.winRate||a.pnl-b.pnl}).slice(0,5);

var bestDiv=document.getElementById('bestPairsRanking');
if(bestDiv){bestDiv.innerHTML=bestPairs.length?bestPairs.map(function(p,i){return '<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)"><span>'+(i+1)+'. <strong>'+p.pair+'</strong></span><span class="positive">'+p.winRate+'%</span><span class="'+(p.pnl>=0?'positive':'negative')+'">$'+p.pnl.toFixed(0)+'</span></div>'}).join(''):'<p style="color:var(--text2);text-align:center">Need more trades</p>'}

var worstDiv=document.getElementById('worstPairsRanking');
if(worstDiv){worstDiv.innerHTML=worstPairs.length?worstPairs.map(function(p,i){return '<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)"><span>'+(i+1)+'. <strong>'+p.pair+'</strong></span><span class="negative">'+p.winRate+'%</span><span class="'+(p.pnl>=0?'positive':'negative')+'">$'+p.pnl.toFixed(0)+'</span></div>'}).join(''):'<p style="color:var(--text2);text-align:center">Need more trades</p>'}

// ========== CHARTS ==========
var pairs=[];closed.forEach(function(t){if(pairs.indexOf(t.pair)===-1)pairs.push(t.pair)});var pairData=pairs.map(function(p){return closed.filter(function(t){return t.pair===p}).reduce(function(s,t){return s+(t.pnl||0)},0)});createBar('pairChart','pair',pairs,pairData);
var sessData=sessions.map(function(s){var st=closed.filter(function(t){return t.session===s});return st.length?(st.filter(function(t){return t.outcome==='Win'}).length/st.length*100):0});createBar('sessionChart','session',sessions,sessData,'#FFD700');
var tfs=[];closed.forEach(function(t){if(t.timeframe&&tfs.indexOf(t.timeframe)===-1)tfs.push(t.timeframe)});var tfData=tfs.map(function(tf){var tt=closed.filter(function(t){return t.timeframe===tf});return tt.length?(tt.filter(function(t){return t.outcome==='Win'}).length/tt.length*100):0});createBar('tfChart','tf',tfs,tfData,'#448AFF');
var setups=[];closed.forEach(function(t){if(t.setup&&setups.indexOf(t.setup)===-1)setups.push(t.setup)});var setupData=setups.map(function(s){var st=closed.filter(function(t){return t.setup===s});return st.length?(st.filter(function(t){return t.outcome==='Win'}).length/st.length*100):0});createBar('setupChart','setup',setups,setupData,'#FFA500');
var emotions=['ğŸ˜«','ğŸ˜•','ğŸ˜','ğŸ™‚','ğŸ˜'];var emData=[1,2,3,4,5].map(function(e){var et=closed.filter(function(t){return t.emotion===e});return et.length?(et.filter(function(t){return t.outcome==='Win'}).length/et.length*100):0});createBar('emotionChart','emotion',emotions,emData,'#E040FB');
var monthly={};closed.forEach(function(t){var m=new Date(t.date).toLocaleDateString('en-US',{year:'numeric',month:'short'});monthly[m]=(monthly[m]||0)+(t.pnl||0)});var months=Object.keys(monthly).slice(-12);createBar('monthlyChart','monthly',months,months.map(function(m){return monthly[m]}));
var dowData=days.map(function(_,i){return closed.filter(function(t){return new Date(t.date).getDay()===i}).reduce(function(s,t){return s+(t.pnl||0)},0)});createBar('dowChart','dow',days,dowData);
var allMist=[];trades.forEach(function(t){(t.mistakes||'').split(',').filter(Boolean).forEach(function(m){allMist.push(m)})});var mistCounts={};allMist.forEach(function(m){mistCounts[m]=(mistCounts[m]||0)+1});var sorted=Object.keys(mistCounts).map(function(k){return[k,mistCounts[k]]}).sort(function(a,b){return b[1]-a[1]}).slice(0,8);createBar('mistakesChart','mistakes',sorted.map(function(s){return s[0]}),sorted.map(function(s){return s[1]}),'#FF1744')}
function createBar(canvasId,key,labels,data,color){var ctx=document.getElementById(canvasId);if(!ctx)return;if(charts[key])charts[key].destroy();charts[key]=new Chart(ctx,{type:'bar',data:{labels:labels,datasets:[{data:data,backgroundColor:color||data.map(function(d){return d>=0?'#00C853':'#FF1744'})}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{grid:{color:'#2a2a2a'},ticks:{color:'#888'}},y:{grid:{color:'#2a2a2a'},ticks:{color:'#888'}}}}})}

function updateGallery(){var f=document.getElementById('galleryFilter').value;var filtered=getFilteredTrades().filter(function(t){return t.screenshot&&t.screenshot.length>10});if(f)filtered=filtered.filter(function(t){return t.outcome===f});var grid=document.getElementById('galleryGrid');if(!filtered.length){grid.innerHTML='<div class="empty-state" style="grid-column:1/-1"><div class="empty-state-icon">ğŸ“·</div><h3>No screenshots</h3><p style="color:var(--text2)">Add screenshots to your trades to see them here</p></div>';return}grid.innerHTML=filtered.map(function(t){return '<div class="gallery-item" onclick="viewTrade(\''+t.id+'\')"><img src="'+t.screenshot+'" onerror="this.src=\'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22150%22><rect fill=%22%23333%22 width=%22200%22 height=%22150%22/><text x=%2250%%22 y=%2250%%22 fill=%22%23888%22 text-anchor=%22middle%22>Image Error</text></svg>\'"><div class="gallery-item-badge"><span class="badge badge-'+t.outcome.toLowerCase()+'">'+t.outcome+'</span></div><div class="gallery-item-info"><h4>'+t.pair+' - '+t.direction+'</h4><p>'+new Date(t.date).toLocaleDateString()+' | $'+(t.pnl||0).toFixed(2)+'</p></div></div>'}).join('')}

function updateProgress(){var total=20,checked=document.querySelectorAll('#checklist input:checked').length;document.getElementById('checkCount').textContent=checked+'/'+total;document.getElementById('progressFill').style.width=(checked/total*100)+'%'}

// ============================================
// QUALITY SCORER SYSTEM
// ============================================
var qualityChecklists=JSON.parse(localStorage.getItem('sdQualityChecklists'))||{};
var defaultQualityTemplate={
sections:[
{name:'ğŸ“Š Analysis',items:[
{text:'Weekly price action',pro:true},
{text:'Daily S&D',pro:true},
{text:'4H Swing MS',pro:true},
{text:'4H Internal MS',pro:true},
{text:'4H S&D',pro:true},
{text:'FVG 50%',pro:true},
{text:'0.382 level',pro:true},
{text:'0.5 level',pro:true},
{text:'GP (Golden Pocket)',pro:true},
{text:'Balance levels',pro:true},
{text:'15m Swing MS',pro:true},
{text:'15m Internal MS',pro:true},
{text:'15m S&D',pro:true},
{text:'LQ (Liquidity)',pro:true},
{text:'nPOC',pro:true},
{text:'Daily Bias',pro:true},
{text:'Volume',pro:true},
{text:'VWAP',pro:true},
{text:'dOpen',pro:true},
{text:'wOpen',pro:true},
{text:'Asia session',pro:true},
{text:'Market open time',pro:true},
{text:'Premium/Discount',pro:true},
{text:'DXY correlation',pro:true},
{text:'Entry Model',pro:true}
]},
{name:'ğŸ¯ Entry',items:[
{text:'Structure change 1m/5m',pro:true},
{text:'S/D 1m/5m',pro:true},
{text:'0.382',pro:true},
{text:'0.5',pro:true},
{text:'GP',pro:true},
{text:'FVG',pro:true},
{text:'Compound candle',pro:true}
]},
{name:'ğŸ¯ Take Profit',items:[
{text:'Strong S&D zone',pro:true},
{text:'Local LQ',pro:true},
{text:'Close VWAP',pro:true},
{text:'nPOC / POC',pro:true},
{text:'Asian low/high',pro:true},
{text:'Close of candles',pro:true}
]},
{name:'ğŸ›‘ Stop Loss',items:[
{text:'EURUSD - London 8-12 pips',pro:true},
{text:'XAUUSD - Frankfurt min 400 pips',pro:true}
]}
]};

function initQualityScorer(){
var sel=document.getElementById('qualityStrategy');
if(!sel)return;
sel.innerHTML='<option value="">Select Strategy...</option>'+strategies.map(function(s){
return '<option value="'+s.id+'">'+s.name+'</option>'}).join('');
}

function loadQualityChecklist(){
var stratId=document.getElementById('qualityStrategy').value;
var area=document.getElementById('qualityChecklistArea');
if(!stratId){
area.innerHTML='<p style="color:var(--text2);text-align:center;padding:40px">Select a strategy to load its checklist</p>';
resetQualityDisplay();
return}
var config=qualityChecklists[stratId]||JSON.parse(JSON.stringify(defaultQualityTemplate));
var html='<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px">';
config.sections.forEach(function(sec,si){
html+='<div style="background:var(--bg2);border-radius:10px;padding:15px"><h4 style="color:var(--gold);margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--border)">'+sec.name+'</h4>';
sec.items.forEach(function(item,ii){
var id='qc_'+si+'_'+ii;
html+='<div class="quality-item" style="display:flex;align-items:center;padding:8px;margin:4px 0;background:var(--bg3);border-radius:6px;cursor:pointer" onclick="toggleQualityItem(this,\''+id+'\')">';
html+='<input type="checkbox" id="'+id+'" style="margin-right:10px" onchange="updateQualityScore()">';
html+='<label for="'+id+'" style="flex:1;cursor:pointer;font-size:.9rem">'+item.text+'</label></div>'});
html+='</div>'});
html+='</div>';
area.innerHTML=html;
updateQualityScore();
}

function toggleQualityItem(el,id){
var cb=document.getElementById(id);
cb.checked=!cb.checked;
el.style.background=cb.checked?'rgba(0,200,83,0.2)':'var(--bg3)';
el.style.borderLeft=cb.checked?'3px solid var(--green)':'none';
updateQualityScore();
}

function updateQualityScore(){
var checks=document.querySelectorAll('#qualityChecklistArea input[type="checkbox"]');
var total=checks.length;
var pro=0;
checks.forEach(function(c){if(c.checked)pro++});
var proti=total-pro;
var pct=total?Math.round(pro/total*100):0;
document.getElementById('qualityPro').textContent=pro;
document.getElementById('qualityCon').textContent=proti;
document.getElementById('qualityScoreValue').textContent=pct+'%';
document.getElementById('qualityScoreValue').style.color=pct>=80?'var(--green)':pct>=60?'var(--gold)':'var(--red)';
var grade=pct>=90?'A+ Setup':pct>=80?'A Setup':pct>=70?'B Setup':pct>=60?'C Setup':'D Setup (Avoid)';
document.getElementById('qualityGrade').textContent=grade;
document.getElementById('qualityGrade').style.color=pct>=80?'var(--green)':pct>=60?'var(--gold)':'var(--red)';
// Update visual state of items
checks.forEach(function(c){
var item=c.closest('.quality-item');
if(item){
item.style.background=c.checked?'rgba(0,200,83,0.15)':'var(--bg3)';
item.style.borderLeft=c.checked?'3px solid var(--green)':'3px solid transparent'}});
}

function resetQualityDisplay(){
document.getElementById('qualityPro').textContent='0';
document.getElementById('qualityCon').textContent='0';
document.getElementById('qualityScoreValue').textContent='-';
document.getElementById('qualityScoreValue').style.color='var(--text)';
document.getElementById('qualityGrade').textContent='-';
}

function resetQualityChecklist(){
document.querySelectorAll('#qualityChecklistArea input[type="checkbox"]').forEach(function(c){
c.checked=false;
var item=c.closest('.quality-item');
if(item){item.style.background='var(--bg3)';item.style.borderLeft='3px solid transparent'}});
updateQualityScore();
showToast('Checklist reset!');
}

function copyQualityToTrade(){
var stratId=document.getElementById('qualityStrategy').value;
var checks=document.querySelectorAll('#qualityChecklistArea input[type="checkbox"]');
var total=checks.length;
var pro=0;
checks.forEach(function(c){if(c.checked)pro++});
var pct=total?Math.round(pro/total*100):0;
var grade=pct>=90?'A+':pct>=80?'A':pct>=70?'B':pct>=60?'C':'D';
// Store in session for new trade
sessionStorage.setItem('qualityScore',pct);
sessionStorage.setItem('qualityGrade',grade);
sessionStorage.setItem('qualityStrategy',stratId);
showToast('Score copied! Open New Trade to use it.');
showTab('newtrade');
if(stratId){document.getElementById('tradeStrategy').value=stratId}
document.getElementById('tradeSetup').value=grade;
}

function openQualityEditor(){
var sel=document.getElementById('editQualityStrategy');
sel.innerHTML='<option value="">Select strategy to edit...</option>'+strategies.map(function(s){
return '<option value="'+s.id+'">'+s.name+'</option>'}).join('');
document.getElementById('qualityEditorSections').innerHTML='<p style="color:var(--text2);text-align:center;padding:30px">Select a strategy to edit its checklist</p>';
openModal('qualityEditorModal');
}

function loadQualityEditorItems(){
var stratId=document.getElementById('editQualityStrategy').value;
var container=document.getElementById('qualityEditorSections');
if(!stratId){
container.innerHTML='<p style="color:var(--text2);text-align:center;padding:30px">Select a strategy to edit its checklist</p>';
return}
var config=qualityChecklists[stratId]||JSON.parse(JSON.stringify(defaultQualityTemplate));
var html='';
config.sections.forEach(function(sec,si){
html+='<div class="quality-editor-section" style="background:var(--bg2);border-radius:10px;padding:15px;margin-bottom:15px" data-si="'+si+'">';
html+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">';
html+='<input type="text" value="'+sec.name+'" class="section-name-input" style="background:transparent;border:none;color:var(--gold);font-size:1.1rem;font-weight:600;flex:1" onchange="updateSectionName('+si+',this.value)">';
html+='<button class="btn btn-sm" style="background:var(--red);color:#fff;padding:4px 8px" onclick="deleteQualitySection('+si+')">ğŸ—‘ï¸</button></div>';
html+='<div class="section-items">';
sec.items.forEach(function(item,ii){
html+='<div style="display:flex;align-items:center;gap:8px;margin:6px 0;padding:8px;background:var(--bg3);border-radius:6px">';
html+='<span style="cursor:move;color:var(--text2)">â˜°</span>';
html+='<input type="text" value="'+item.text+'" style="flex:1;padding:6px;background:var(--bg1);border:1px solid var(--border);border-radius:4px;color:var(--text)" onchange="updateQualityItem('+si+','+ii+',this.value)">';
html+='<button onclick="deleteQualityItem('+si+','+ii+')" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:1.2rem">Ã—</button></div>'});
html+='<button class="btn btn-sm btn-secondary" style="margin-top:8px" onclick="addQualityItem('+si+')">+ Add Item</button>';
html+='</div></div>'});
container.innerHTML=html;
}

function createNewQualitySection(){
var stratId=document.getElementById('editQualityStrategy').value;
if(!stratId){showToast('Select a strategy first','error');return}
if(!qualityChecklists[stratId])qualityChecklists[stratId]=JSON.parse(JSON.stringify(defaultQualityTemplate));
qualityChecklists[stratId].sections.push({name:'ğŸ“Œ New Section',items:[{text:'New item',pro:true}]});
loadQualityEditorItems();
}

function updateSectionName(si,val){
var stratId=document.getElementById('editQualityStrategy').value;
if(qualityChecklists[stratId])qualityChecklists[stratId].sections[si].name=val;
}

function deleteQualitySection(si){
if(!confirm('Delete this section?'))return;
var stratId=document.getElementById('editQualityStrategy').value;
if(qualityChecklists[stratId])qualityChecklists[stratId].sections.splice(si,1);
loadQualityEditorItems();
}

function addQualityItem(si){
var stratId=document.getElementById('editQualityStrategy').value;
if(qualityChecklists[stratId])qualityChecklists[stratId].sections[si].items.push({text:'New item',pro:true});
loadQualityEditorItems();
}

function updateQualityItem(si,ii,val){
var stratId=document.getElementById('editQualityStrategy').value;
if(qualityChecklists[stratId])qualityChecklists[stratId].sections[si].items[ii].text=val;
}

function deleteQualityItem(si,ii){
var stratId=document.getElementById('editQualityStrategy').value;
if(qualityChecklists[stratId])qualityChecklists[stratId].sections[si].items.splice(ii,1);
loadQualityEditorItems();
}

function saveQualityConfig(){
localStorage.setItem('sdQualityChecklists',JSON.stringify(qualityChecklists));
closeModal('qualityEditorModal');
loadQualityChecklist();
showToast('Checklist saved!');
}

// ============================================
// SEASONALITY DATA & FUNCTIONS
// ============================================
var defaultSeasonals=[
// INDICES - Santa Claus Rally & January Effect
{instrument:'S&P 500',months:[12],monthNames:'December',direction:'bullish',winRate:75,category:'indices',description:'Santa Claus Rally - Last 5 trading days of Dec + first 2 of Jan. Since 1950: +1.3% avg'},
{instrument:'S&P 500',months:[1],monthNames:'January',direction:'bullish',winRate:62,category:'indices',description:'January Effect - Small caps outperform. First 5 days often predict the year'},
{instrument:'S&P 500',months:[10],monthNames:'October',direction:'bearish',winRate:55,category:'indices',description:'October Effect - Historically volatile, many crashes occurred (1929, 1987, 2008)'},
{instrument:'S&P 500',months:[5,6,7,8,9],monthNames:'May-September',direction:'bearish',winRate:65,category:'indices',description:'Sell in May - Summer months historically weaker. "Sell in May and go away"'},
{instrument:'S&P 500',months:[11,12,1,2,3,4],monthNames:'November-April',direction:'bullish',winRate:70,category:'indices',description:'Best 6 Months - Nov-Apr historically strongest period for stocks'},
{instrument:'Nasdaq',months:[12],monthNames:'December',direction:'bullish',winRate:72,category:'indices',description:'Tech Rally - End of year tech buying, tax-loss harvesting rebound'},
{instrument:'Nasdaq',months:[9],monthNames:'September',direction:'bearish',winRate:60,category:'indices',description:'September Swoon - Historically worst month for Nasdaq'},
{instrument:'DAX',months:[12],monthNames:'December',direction:'bullish',winRate:70,category:'indices',description:'German year-end rally, follows US Santa Claus pattern'},
{instrument:'Nikkei',months:[4],monthNames:'April',direction:'bullish',winRate:65,category:'indices',description:'Japanese fiscal year starts April - new money inflows'},

// FOREX
{instrument:'EURUSD',months:[1],monthNames:'January',direction:'bullish',winRate:60,category:'forex',description:'Euro strength - Repatriation flows after year-end'},
{instrument:'EURUSD',months:[8],monthNames:'August',direction:'bearish',winRate:58,category:'forex',description:'Summer doldrums - Low liquidity, EUR weakness'},
{instrument:'USDJPY',months:[3],monthNames:'March',direction:'bearish',winRate:62,category:'forex',description:'Japanese fiscal year-end repatriation - Yen strength'},
{instrument:'USDJPY',months:[12],monthNames:'December',direction:'bullish',winRate:58,category:'forex',description:'Year-end dollar demand'},
{instrument:'GBPUSD',months:[4],monthNames:'April',direction:'bullish',winRate:57,category:'forex',description:'UK tax year end flows'},
{instrument:'AUDUSD',months:[2,3],monthNames:'Feb-March',direction:'bearish',winRate:60,category:'forex',description:'Aussie weakness - Post-harvest, China slowdown'},
{instrument:'USDCAD',months:[6,7],monthNames:'June-July',direction:'bearish',winRate:58,category:'forex',description:'Canadian dollar strength - Oil demand, summer driving'},
{instrument:'DXY',months:[1],monthNames:'January',direction:'bearish',winRate:55,category:'forex',description:'Dollar Index weakness - Risk-on start of year'},
{instrument:'DXY',months:[9],monthNames:'September',direction:'bullish',winRate:60,category:'forex',description:'Dollar strength - Risk-off, flight to safety'},

// METALS
{instrument:'XAUUSD',months:[1,2],monthNames:'January-February',direction:'bullish',winRate:65,category:'metals',description:'Gold Chinese New Year - Jewelry demand, Asian buying'},
{instrument:'XAUUSD',months:[8,9],monthNames:'August-September',direction:'bullish',winRate:68,category:'metals',description:'Gold Indian Wedding Season - Massive jewelry demand'},
{instrument:'XAUUSD',months:[12],monthNames:'December',direction:'bullish',winRate:62,category:'metals',description:'Gold Santa Rally - Safe haven + jewelry demand'},
{instrument:'XAUUSD',months:[3],monthNames:'March',direction:'bearish',winRate:55,category:'metals',description:'Gold post-CNY correction - Demand drops after festivals'},
{instrument:'XAGUSD',months:[12,1,2],monthNames:'Dec-February',direction:'bullish',winRate:60,category:'metals',description:'Silver follows gold seasonal + industrial demand'},
{instrument:'XAGUSD',months:[6],monthNames:'June',direction:'bearish',winRate:58,category:'metals',description:'Silver summer weakness'},
{instrument:'Copper',months:[1,2,3],monthNames:'Jan-March',direction:'bullish',winRate:62,category:'metals',description:'Copper China construction season restocking'},
{instrument:'Copper',months:[8],monthNames:'August',direction:'bearish',winRate:55,category:'metals',description:'Copper summer slowdown'},
{instrument:'Platinum',months:[4,5],monthNames:'April-May',direction:'bullish',winRate:58,category:'metals',description:'Platinum auto industry demand peak'},

// ENERGY
{instrument:'Crude Oil',months:[2,3,4],monthNames:'Feb-April',direction:'bullish',winRate:65,category:'energy',description:'Oil refinery maintenance ends, summer driving prep'},
{instrument:'Crude Oil',months:[6,7,8],monthNames:'June-August',direction:'bullish',winRate:62,category:'energy',description:'Oil summer driving season - Peak gasoline demand'},
{instrument:'Crude Oil',months:[9,10],monthNames:'Sept-October',direction:'bearish',winRate:58,category:'energy',description:'Oil post-summer weakness, hurricane disruptions'},
{instrument:'Crude Oil',months:[12],monthNames:'December',direction:'bearish',winRate:55,category:'energy',description:'Oil year-end weakness - Tax selling, lower demand'},
{instrument:'Natural Gas',months:[10,11],monthNames:'Oct-November',direction:'bullish',winRate:70,category:'energy',description:'Nat Gas heating season begins - Winter demand surge'},
{instrument:'Natural Gas',months:[1,2],monthNames:'Jan-February',direction:'bullish',winRate:65,category:'energy',description:'Nat Gas peak winter - Cold weather spikes'},
{instrument:'Natural Gas',months:[4,5],monthNames:'April-May',direction:'bearish',winRate:68,category:'energy',description:'Nat Gas shoulder season - Post-winter selloff'},
{instrument:'Gasoline',months:[3,4,5],monthNames:'March-May',direction:'bullish',winRate:72,category:'energy',description:'Gasoline refinery switch to summer blend + driving season prep'},
{instrument:'Heating Oil',months:[9,10,11],monthNames:'Sept-November',direction:'bullish',winRate:65,category:'energy',description:'Heating oil winter prep buying'},

// AGRICULTURE
{instrument:'Sugar',months:[11,12],monthNames:'November-December',direction:'bearish',winRate:68,category:'agriculture',description:'Sugar Brazil harvest peaks - Maximum supply pressure'},
{instrument:'Sugar',months:[2,3,4],monthNames:'Feb-April',direction:'bullish',winRate:62,category:'agriculture',description:'Sugar inter-harvest period - Supply tightens'},
{instrument:'Coffee',months:[6,7],monthNames:'June-July',direction:'bullish',winRate:65,category:'agriculture',description:'Coffee Brazil frost risk - Winter in Southern hemisphere'},
{instrument:'Coffee',months:[12],monthNames:'December',direction:'bearish',winRate:58,category:'agriculture',description:'Coffee Brazil harvest arrives'},
{instrument:'Cocoa',months:[2,3],monthNames:'Feb-March',direction:'bearish',winRate:60,category:'agriculture',description:'Cocoa West Africa main crop harvest'},
{instrument:'Cocoa',months:[7,8],monthNames:'July-August',direction:'bullish',winRate:58,category:'agriculture',description:'Cocoa mid-crop shortage period'},
{instrument:'Corn',months:[6,7],monthNames:'June-July',direction:'bullish',winRate:70,category:'agriculture',description:'Corn weather market - Pollination crucial, drought risk'},
{instrument:'Corn',months:[10,11],monthNames:'Oct-November',direction:'bearish',winRate:72,category:'agriculture',description:'Corn harvest pressure - Maximum supply'},
{instrument:'Soybeans',months:[7,8],monthNames:'July-August',direction:'bullish',winRate:68,category:'agriculture',description:'Soybeans weather premium - Pod-filling stage critical'},
{instrument:'Soybeans',months:[10],monthNames:'October',direction:'bearish',winRate:65,category:'agriculture',description:'Soybeans US harvest pressure'},
{instrument:'Wheat',months:[5,6],monthNames:'May-June',direction:'bullish',winRate:60,category:'agriculture',description:'Wheat weather market - US winter wheat stress'},
{instrument:'Wheat',months:[7,8],monthNames:'July-August',direction:'bearish',winRate:65,category:'agriculture',description:'Wheat Northern hemisphere harvest'},
{instrument:'Cotton',months:[7,8],monthNames:'July-August',direction:'bullish',winRate:62,category:'agriculture',description:'Cotton weather market - Texas drought risk'},
{instrument:'Cotton',months:[11,12],monthNames:'Nov-December',direction:'bearish',winRate:58,category:'agriculture',description:'Cotton harvest complete, supply peaks'},
{instrument:'OJ (Orange Juice)',months:[12,1,2],monthNames:'Dec-February',direction:'bullish',winRate:72,category:'agriculture',description:'OJ Florida freeze risk - Cold weather spikes'},
{instrument:'Cattle',months:[1,2,3],monthNames:'Jan-March',direction:'bullish',winRate:60,category:'agriculture',description:'Cattle grilling season prep, tight supplies'},
{instrument:'Lean Hogs',months:[6,7],monthNames:'June-July',direction:'bullish',winRate:58,category:'agriculture',description:'Hogs summer grilling demand'},

// CRYPTO
{instrument:'Bitcoin',months:[10,11,12],monthNames:'Oct-December',direction:'bullish',winRate:75,category:'crypto',description:'Bitcoin Q4 historically strongest - "Uptober", year-end rally'},
{instrument:'Bitcoin',months:[1],monthNames:'January',direction:'bearish',winRate:58,category:'crypto',description:'Bitcoin January dump - Post-rally correction, tax selling'},
{instrument:'Bitcoin',months:[4],monthNames:'April',direction:'bullish',winRate:65,category:'crypto',description:'Bitcoin halving anticipation (every 4 years) + tax refund flows'},
{instrument:'Bitcoin',months:[9],monthNames:'September',direction:'bearish',winRate:62,category:'crypto',description:'Bitcoin "Septembear" - Historically weak month'},
{instrument:'Ethereum',months:[11,12],monthNames:'Nov-December',direction:'bullish',winRate:70,category:'crypto',description:'Ethereum follows BTC Q4 rally + DeFi activity'},
{instrument:'Ethereum',months:[5,6],monthNames:'May-June',direction:'bearish',winRate:55,category:'crypto',description:'Ethereum "Sell in May" applies to crypto too'}
];

var customSeasonals=JSON.parse(localStorage.getItem('sdCustomSeasonals'))||[];

function getAllSeasonals(){
return defaultSeasonals.concat(customSeasonals);
}

function renderSeasonality(){
var month=parseInt(document.getElementById('seasonalityMonth').value)||0;
var category=document.getElementById('seasonalityCategory').value;
var all=getAllSeasonals();

// Filter
var filtered=all.filter(function(s){
if(month&&s.months.indexOf(month)===-1)return false;
if(category&&s.category!==category)return false;
return true;
});

// Current month highlight
var currentMonth=new Date().getMonth()+1;
var currentSeasonals=all.filter(function(s){return s.months.indexOf(currentMonth)!==-1});
var currentDiv=document.getElementById('currentMonthSeasonals');
var monthNames=['','January','February','March','April','May','June','July','August','September','October','November','December'];

if(currentSeasonals.length&&!month){
currentDiv.innerHTML='<div style="background:linear-gradient(135deg,var(--bg2),var(--bg3));border-radius:12px;padding:20px;border:2px solid var(--gold)"><h3 style="color:var(--gold);margin-bottom:15px">ğŸ”¥ Active This Month ('+monthNames[currentMonth]+')</h3><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px">'+
currentSeasonals.map(function(s){
return '<div style="background:var(--bg1);padding:12px;border-radius:8px;border-left:4px solid '+(s.direction==='bullish'?'var(--green)':'var(--red)')+'"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><strong>'+s.instrument+'</strong><span style="padding:3px 8px;border-radius:4px;font-size:.75rem;background:'+(s.direction==='bullish'?'rgba(0,200,83,0.2);color:var(--green)':'rgba(255,23,68,0.2);color:var(--red)')+'">'+(s.direction==='bullish'?'ğŸŸ¢ BULLISH':'ğŸ”´ BEARISH')+'</span></div><div style="font-size:.8rem;color:var(--text2)">'+s.winRate+'% historical win rate</div></div>'
}).join('')+'</div></div>';
}else{
currentDiv.innerHTML='';
}

// All seasonals grid grouped by category
var grid=document.getElementById('seasonalityGrid');
var categories={indices:'ğŸ“Š Indices',forex:'ğŸ’± Forex',metals:'ğŸ¥‡ Metals',energy:'â›½ Energy',agriculture:'ğŸŒ¾ Agriculture',crypto:'â‚¿ Crypto'};

if(!filtered.length){
grid.innerHTML='<p style="color:var(--text2);text-align:center;padding:40px;grid-column:1/-1">No seasonals match your filters</p>';
return;
}

var grouped={};
filtered.forEach(function(s){
if(!grouped[s.category])grouped[s.category]=[];
grouped[s.category].push(s);
});

var html='';
Object.keys(grouped).forEach(function(cat){
html+='<div style="background:var(--bg2);border-radius:12px;padding:20px"><h4 style="color:var(--gold);margin-bottom:15px">'+(categories[cat]||cat)+'</h4>';
grouped[cat].forEach(function(s){
html+='<div style="background:var(--bg3);padding:12px;border-radius:8px;margin-bottom:10px;border-left:4px solid '+(s.direction==='bullish'?'var(--green)':'var(--red)')+'">';
html+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">';
html+='<strong>'+s.instrument+'</strong>';
html+='<span style="padding:3px 8px;border-radius:4px;font-size:.75rem;background:'+(s.direction==='bullish'?'rgba(0,200,83,0.2);color:var(--green)':'rgba(255,23,68,0.2);color:var(--red)')+'">'+(s.direction==='bullish'?'ğŸŸ¢ LONG':'ğŸ”´ SHORT')+'</span>';
html+='</div>';
html+='<div style="font-size:.85rem;color:var(--gold);margin-bottom:4px">ğŸ“… '+s.monthNames+' â€¢ '+s.winRate+'% win rate</div>';
html+='<div style="font-size:.8rem;color:var(--text2)">'+s.description+'</div>';
html+='</div>';
});
html+='</div>';
});

grid.innerHTML=html;
}

function filterSeasonality(){
renderSeasonality();
}

function openAddSeasonalModal(){
document.getElementById('seasonalInstrument').value='';
document.getElementById('seasonalMonths').value='';
document.getElementById('seasonalDirection').value='bullish';
document.getElementById('seasonalWinRate').value='';
document.getElementById('seasonalCategory').value='indices';
document.getElementById('seasonalDescription').value='';
openModal('addSeasonalModal');
}

function saveCustomSeasonal(){
var instrument=document.getElementById('seasonalInstrument').value.trim();
var monthsStr=document.getElementById('seasonalMonths').value.trim();
if(!instrument||!monthsStr){showToast('Fill instrument and months','error');return}

// Parse months
var monthMap={jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,oct:10,nov:11,dec:12,
january:1,february:2,march:3,april:4,june:6,july:7,august:8,september:9,october:10,november:11,december:12};
var months=[];
monthsStr.toLowerCase().split(/[,\-\s]+/).forEach(function(m){
if(monthMap[m])months.push(monthMap[m]);
else if(parseInt(m)>=1&&parseInt(m)<=12)months.push(parseInt(m));
});

if(!months.length){showToast('Invalid months format','error');return}

var seasonal={
instrument:instrument,
months:months,
monthNames:monthsStr,
direction:document.getElementById('seasonalDirection').value,
winRate:parseInt(document.getElementById('seasonalWinRate').value)||50,
category:document.getElementById('seasonalCategory').value,
description:document.getElementById('seasonalDescription').value,
custom:true
};

customSeasonals.push(seasonal);
localStorage.setItem('sdCustomSeasonals',JSON.stringify(customSeasonals));
closeModal('addSeasonalModal');
renderSeasonality();
showToast('Custom seasonal added!');
}

// ============================================
// TRADING PLAN FUNCTIONS
// ============================================
var tradingPlan=JSON.parse(localStorage.getItem('sdTradingPlan'))||{};

function loadTradingPlan(){
document.getElementById('planIdentity').value=tradingPlan.identity||'';
document.getElementById('planGoals').value=tradingPlan.goals||'';
document.getElementById('planSessions').value=tradingPlan.sessions||'';
document.getElementById('planPairs').value=tradingPlan.pairs||'';
document.getElementById('planAvoid').value=tradingPlan.avoid||'';
document.getElementById('planHTF').value=tradingPlan.htf||'';
document.getElementById('planLTF').value=tradingPlan.ltf||'';
document.getElementById('planEntryChecklist').value=tradingPlan.entryChecklist||'';
document.getElementById('planTP').value=tradingPlan.tp||'';
document.getElementById('planSL').value=tradingPlan.sl||'';
document.getElementById('planRisk').value=tradingPlan.risk||'';
document.getElementById('planDrawdown').value=tradingPlan.drawdown||'';
document.getElementById('planPreRoutine').value=tradingPlan.preRoutine||'';
document.getElementById('planRules').value=tradingPlan.rules||'';
document.getElementById('planPostRoutine').value=tradingPlan.postRoutine||'';
document.getElementById('planNotes').value=tradingPlan.notes||'';
}

function saveTradingPlan(){
tradingPlan={
identity:document.getElementById('planIdentity').value,
goals:document.getElementById('planGoals').value,
sessions:document.getElementById('planSessions').value,
pairs:document.getElementById('planPairs').value,
avoid:document.getElementById('planAvoid').value,
htf:document.getElementById('planHTF').value,
ltf:document.getElementById('planLTF').value,
entryChecklist:document.getElementById('planEntryChecklist').value,
tp:document.getElementById('planTP').value,
sl:document.getElementById('planSL').value,
risk:document.getElementById('planRisk').value,
drawdown:document.getElementById('planDrawdown').value,
preRoutine:document.getElementById('planPreRoutine').value,
rules:document.getElementById('planRules').value,
postRoutine:document.getElementById('planPostRoutine').value,
notes:document.getElementById('planNotes').value
};
localStorage.setItem('sdTradingPlan',JSON.stringify(tradingPlan));
showToast('Trading plan saved!');
}

function exportTradingPlan(){
var html='<!DOCTYPE html><html><head><meta charset="UTF-8"><title>My Trading Plan</title><style>';
html+='body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#1a1a2e;color:#eee;padding:40px;max-width:900px;margin:0 auto}';
html+='h1{color:#FFD700;border-bottom:2px solid #FFD700;padding-bottom:10px}h2{color:#FFD700;margin-top:30px;font-size:1.2rem}';
html+='.section{background:#252540;padding:20px;border-radius:10px;margin:15px 0;border-left:4px solid #FFD700}';
html+='.section h3{margin:0 0 10px 0;color:#FFD700}';
html+='p{white-space:pre-wrap;color:#ccc;margin:0;line-height:1.6}';
html+='</style></head><body>';
html+='<h1>ğŸ“ My Trading Plan</h1>';
html+='<p style="color:#888">Generated: '+new Date().toLocaleDateString()+'</p>';

if(tradingPlan.identity){html+='<div class="section"><h3>ğŸ¯ Trading Identity</h3><p>'+tradingPlan.identity+'</p></div>'}
if(tradingPlan.goals){html+='<div class="section"><h3>ğŸ¯ Goals</h3><p>'+tradingPlan.goals+'</p></div>'}
if(tradingPlan.sessions){html+='<div class="section"><h3>ğŸ“Š Sessions</h3><p>'+tradingPlan.sessions+'</p></div>'}
if(tradingPlan.pairs){html+='<div class="section"><h3>ğŸ“Š Pairs</h3><p>'+tradingPlan.pairs+'</p></div>'}
if(tradingPlan.avoid){html+='<div class="section"><h3>ğŸ“Š Conditions to Avoid</h3><p>'+tradingPlan.avoid+'</p></div>'}
if(tradingPlan.htf){html+='<div class="section"><h3>ğŸ“¥ HTF Analysis</h3><p>'+tradingPlan.htf+'</p></div>'}
if(tradingPlan.ltf){html+='<div class="section"><h3>ğŸ“¥ LTF Entry</h3><p>'+tradingPlan.ltf+'</p></div>'}
if(tradingPlan.entryChecklist){html+='<div class="section"><h3>ğŸ“¥ Entry Checklist</h3><p>'+tradingPlan.entryChecklist+'</p></div>'}
if(tradingPlan.tp){html+='<div class="section"><h3>ğŸ“¤ Take Profit</h3><p>'+tradingPlan.tp+'</p></div>'}
if(tradingPlan.sl){html+='<div class="section"><h3>ğŸ“¤ Stop Loss</h3><p>'+tradingPlan.sl+'</p></div>'}
if(tradingPlan.risk){html+='<div class="section"><h3>âš ï¸ Position Sizing</h3><p>'+tradingPlan.risk+'</p></div>'}
if(tradingPlan.drawdown){html+='<div class="section"><h3>âš ï¸ Drawdown Rules</h3><p>'+tradingPlan.drawdown+'</p></div>'}
if(tradingPlan.preRoutine){html+='<div class="section"><h3>ğŸ§  Pre-Trading Routine</h3><p>'+tradingPlan.preRoutine+'</p></div>'}
if(tradingPlan.rules){html+='<div class="section"><h3>ğŸ§  Rules to Follow</h3><p>'+tradingPlan.rules+'</p></div>'}
if(tradingPlan.postRoutine){html+='<div class="section"><h3>ğŸ§  Post-Trading Routine</h3><p>'+tradingPlan.postRoutine+'</p></div>'}
if(tradingPlan.notes){html+='<div class="section"><h3>ğŸ“‹ Notes</h3><p>'+tradingPlan.notes+'</p></div>'}

html+='<p style="text-align:center;color:#444;margin-top:40px">Generated by S&D Trading Journal Pro</p>';
html+='</body></html>';

var win=window.open('','_blank');
win.document.write(html);
win.document.close();
win.print();
}

var showPlanPopup=JSON.parse(localStorage.getItem('sdShowPlanPopup'))||false;

function showPlanBeforeTrade(){
showPlanPopup=!showPlanPopup;
localStorage.setItem('sdShowPlanPopup',JSON.stringify(showPlanPopup));
showToast(showPlanPopup?'Plan will show before new trades':'Plan popup disabled');
}

function checkShowPlanPopup(){
if(showPlanPopup&&tradingPlan.rules){
var msg='ğŸ“ TRADING PLAN REMINDER\n\n';
msg+='âœ… Rules to Follow:\n'+tradingPlan.rules+'\n\n';
if(tradingPlan.entryChecklist)msg+='âœ… Entry Checklist:\n'+tradingPlan.entryChecklist+'\n\n';
msg+='Ready to follow your plan?';
if(!confirm(msg)){return false}
}
return true;
}

// ============================================
// PDF REPORT GENERATOR
// ============================================
function generateWeeklyReport(){
var today=new Date();
var weekAgo=new Date(today.getTime()-7*24*60*60*1000);
var weekTrades=trades.filter(function(t){
var d=new Date(t.date);
return d>=weekAgo&&d<=today&&t.outcome!=='Open'});
var wins=weekTrades.filter(function(t){return t.outcome==='Win'}).length;
var losses=weekTrades.filter(function(t){return t.outcome==='Loss'}).length;
var totalPnL=weekTrades.reduce(function(s,t){return s+(t.pnl||0)},0);
var winRate=weekTrades.length?Math.round(wins/weekTrades.length*100):0;
var avgRR=weekTrades.length?weekTrades.reduce(function(s,t){return s+(t.rr||0)},0)/weekTrades.length:0;
var bestTrade=weekTrades.reduce(function(best,t){return(t.pnl||0)>(best.pnl||0)?t:best},{pnl:0});
var worstTrade=weekTrades.reduce(function(worst,t){return(t.pnl||0)<(worst.pnl||0)?t:worst},{pnl:0});

var html='<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Weekly Trading Report</title><style>';
html+='body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#1a1a2e;color:#eee;padding:40px;max-width:900px;margin:0 auto}';
html+='h1{color:#FFD700;border-bottom:2px solid #FFD700;padding-bottom:10px}h2{color:#FFD700;margin-top:30px}';
html+='.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin:20px 0}';
html+='.stat-card{background:#252540;padding:20px;border-radius:10px;text-align:center}';
html+='.stat-value{font-size:2rem;font-weight:700}.positive{color:#00C853}.negative{color:#FF1744}.gold{color:#FFD700}';
html+='.stat-label{color:#888;font-size:.85rem;margin-top:5px}';
html+='table{width:100%;border-collapse:collapse;margin:20px 0}th,td{padding:12px;text-align:left;border-bottom:1px solid #333}';
html+='th{background:#252540;color:#FFD700}.badge{padding:4px 10px;border-radius:4px;font-size:.85rem}';
html+='.badge-win{background:#00C853;color:#fff}.badge-loss{background:#FF1744;color:#fff}';
html+='</style></head><body>';
html+='<h1>ğŸ“Š Weekly Trading Report</h1>';
html+='<p style="color:#888">'+weekAgo.toLocaleDateString()+' - '+today.toLocaleDateString()+'</p>';
html+='<div class="stats-grid">';
html+='<div class="stat-card"><div class="stat-value gold">'+weekTrades.length+'</div><div class="stat-label">Total Trades</div></div>';
html+='<div class="stat-card"><div class="stat-value '+(winRate>=50?'positive':'negative')+'">'+winRate+'%</div><div class="stat-label">Win Rate</div></div>';
html+='<div class="stat-card"><div class="stat-value '+(totalPnL>=0?'positive':'negative')+'">$'+totalPnL.toFixed(2)+'</div><div class="stat-label">Total P&L</div></div>';
html+='<div class="stat-card"><div class="stat-value gold">'+avgRR.toFixed(2)+'</div><div class="stat-label">Avg R:R</div></div>';
html+='</div>';
html+='<div class="stats-grid" style="grid-template-columns:1fr 1fr">';
html+='<div class="stat-card"><div class="stat-label">Best Trade</div><div class="stat-value positive">$'+(bestTrade.pnl||0).toFixed(2)+'</div><div style="color:#888;margin-top:5px">'+(bestTrade.pair||'-')+' '+(bestTrade.direction||'')+'</div></div>';
html+='<div class="stat-card"><div class="stat-label">Worst Trade</div><div class="stat-value negative">$'+(worstTrade.pnl||0).toFixed(2)+'</div><div style="color:#888;margin-top:5px">'+(worstTrade.pair||'-')+' '+(worstTrade.direction||'')+'</div></div>';
html+='</div>';
html+='<h2>ğŸ“œ Trade Log</h2><table><thead><tr><th>Date</th><th>Pair</th><th>Direction</th><th>R:R</th><th>Result</th><th>P&L</th></tr></thead><tbody>';
weekTrades.forEach(function(t){
html+='<tr><td>'+new Date(t.date).toLocaleDateString()+'</td><td><strong>'+t.pair+'</strong></td><td>'+t.direction+'</td><td>'+t.rr.toFixed(2)+'</td><td><span class="badge badge-'+t.outcome.toLowerCase()+'">'+t.outcome+'</span></td><td class="'+(t.pnl>=0?'positive':'negative')+'">$'+(t.pnl||0).toFixed(2)+'</td></tr>'});
html+='</tbody></table>';
html+='<h2>ğŸ“ Weekly Review</h2>';
html+='<div style="background:#252540;padding:20px;border-radius:10px">';
html+='<p><strong>What went well:</strong></p><p style="color:#888;min-height:50px">___________________________________</p>';
html+='<p><strong>What to improve:</strong></p><p style="color:#888;min-height:50px">___________________________________</p>';
html+='<p><strong>Focus for next week:</strong></p><p style="color:#888;min-height:50px">___________________________________</p>';
html+='</div>';
html+='<p style="text-align:center;color:#444;margin-top:40px">Generated by S&D Trading Journal Pro</p>';
html+='</body></html>';

var win=window.open('','_blank');
win.document.write(html);
win.document.close();
win.print();
}

function openSettings(){document.getElementById('setLimit').value=settings.limit;document.getElementById('setRisk').value=settings.risk;document.getElementById('setAccount').value=settings.account;document.getElementById('setCloudName').value=cloudinaryConfig.cloudName||'';document.getElementById('setUploadPreset').value=cloudinaryConfig.uploadPreset||'';document.getElementById('setImgurClientId').value=cloudinaryConfig.imgurClientId||'';updateImageSettingsStatus();openModal('settingsModal')}

function updateImageSettingsStatus(){
var status=document.getElementById('imageSettingsStatus');
if(cloudinaryConfig.cloudName&&cloudinaryConfig.uploadPreset){
status.innerHTML='<span style="color:var(--green)">âœ… Cloudinary configured - images will be stored permanently</span>'}
else if(cloudinaryConfig.imgurClientId){
status.innerHTML='<span style="color:var(--gold)">âš ï¸ Using your Imgur - images may expire after 6 months</span>'}
else{
status.innerHTML='<span style="color:var(--red)">âŒ No image storage configured - please set up Cloudinary or Imgur above</span>'}}

function saveCloudinarySettings(){
cloudinaryConfig.cloudName=document.getElementById('setCloudName').value.trim();
cloudinaryConfig.uploadPreset=document.getElementById('setUploadPreset').value.trim();
cloudinaryConfig.imgurClientId=document.getElementById('setImgurClientId').value.trim();
cloudinaryConfig.enabled=!!(cloudinaryConfig.cloudName&&cloudinaryConfig.uploadPreset);
saveCloudinaryConfig();
updateImageSettingsStatus();
showToast('Image settings saved!')}

function testImageUpload(){
// Save settings first
saveCloudinarySettings();

// Create a small test image (1x1 red pixel)
var canvas = document.createElement('canvas');
canvas.width = 100;
canvas.height = 100;
var ctx = canvas.getContext('2d');
ctx.fillStyle = '#FFD700';
ctx.fillRect(0, 0, 100, 100);
ctx.fillStyle = '#000';
ctx.font = '14px Arial';
ctx.fillText('TEST', 30, 55);
var testBase64 = canvas.toDataURL('image/jpeg', 0.8);

document.getElementById('imageSettingsStatus').innerHTML = '<span style="color:var(--gold)">â³ Testing upload...</span>';

uploadImage(testBase64, function(url){
if(url && url.startsWith('http')){
document.getElementById('imageSettingsStatus').innerHTML = '<span style="color:var(--green)">âœ… SUCCESS! Upload works!</span><br><a href="'+url+'" target="_blank" style="color:var(--gold);font-size:.75rem">View test image â†’</a>';
}else{
document.getElementById('imageSettingsStatus').innerHTML = '<span style="color:var(--red)">âŒ Upload failed. Check settings above.</span>';
}
});
}
function saveSettings(){settings.limit=parseFloat(document.getElementById('setLimit').value)||200;settings.risk=parseFloat(document.getElementById('setRisk').value)||50;settings.account=parseFloat(document.getElementById('setAccount').value)||10000;localStorage.setItem('sdSettings',JSON.stringify(settings));updateDailyLimit();showToast('Saved!')}
function loadSettings(){var s=localStorage.getItem('sdSettings');if(s)settings=JSON.parse(s)}
function clearAll(){if(confirm('Delete ALL trades?')&&confirm('Are you sure?')){trades=[];saveTrades();updateAll();closeModal('settingsModal');showToast('Cleared','error')}}

function openModal(id){document.getElementById(id).classList.add('active')}
function closeModal(id){document.getElementById(id).classList.remove('active')}
document.querySelectorAll('.modal').forEach(function(m){m.addEventListener('click',function(e){if(e.target===m)m.classList.remove('active')})});

function exportData(){
var data={
trades:trades,
accounts:accounts,
strategies:strategies,
settings:settings,
exportDate:new Date().toISOString()
};
var blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
var a=document.createElement('a');
a.href=URL.createObjectURL(blob);
a.download='sd_journal_backup_'+new Date().toISOString().split('T')[0]+'.json';
a.click();
showToast('Backup exported!')}

function importData(event){
var file=event.target.files[0];
if(!file)return;
var reader=new FileReader();
reader.onload=function(e){
try{
var data=JSON.parse(e.target.result);
if(!data.trades){showToast('Invalid backup file','error');return}
if(!confirm('Import '+data.trades.length+' trades? This will MERGE with existing data.')){return}
var existingIds=trades.map(function(t){return t.id});
var newTrades=data.trades.filter(function(t){return existingIds.indexOf(t.id)===-1});
trades=trades.concat(newTrades);
if(data.accounts){
var existingAccIds=accounts.map(function(a){return a.id});
data.accounts.forEach(function(a){if(existingAccIds.indexOf(a.id)===-1)accounts.push(a)});
}
if(data.strategies){
var existingStratIds=strategies.map(function(s){return s.id});
data.strategies.forEach(function(s){if(existingStratIds.indexOf(s.id)===-1)strategies.push(s)});
}
saveTrades();
localStorage.setItem('sdAccounts',JSON.stringify(accounts));
localStorage.setItem('sdStrategies',JSON.stringify(strategies));
updateAccountSelectors();
updateStrategySelectors();
updateAll();
showToast('Imported '+newTrades.length+' new trades!');
}catch(err){showToast('Error reading file','error')}
};
reader.readAsText(file);
event.target.value=''}

function showToast(msg,type){var t=document.getElementById('toast');t.textContent=msg;t.className='toast show '+(type||'');setTimeout(function(){t.classList.remove('show')},3000)}

function calculateZoneScore(){
var liq=parseInt(document.getElementById('tradeLiquidity').value)||0;
var arr=parseInt(document.getElementById('tradeArrival').value)||0;
var base=parseInt(document.getElementById('tradeBaseCandles').value)||0;
var vol=parseFloat(document.getElementById('tradeBaseVolume').value)||0;
var leg=document.getElementById('tradeLegOut').value==='Massive'?2:document.getElementById('tradeLegOut').value==='Normal'?1:0;
var fresh=document.getElementById('tradeZoneFresh').value;
var freshScore=fresh==='Fresh'?3:fresh==='1 Touch'?2:fresh==='2 Touch'?1:0;
var bigBro=document.getElementById('tradeBigBro').value&&document.getElementById('tradeBigBro').value!=='None'?1:0;
var smallBro=document.getElementById('tradeSmallBro').value&&document.getElementById('tradeSmallBro').value!=='None'?1:0;
var flip=document.getElementById('tradeFlipZone').value==='Yes'?1:0;
var baseScore=base<=2?2:base<=4?1:0;
var volScore=vol>=70?2:vol>=40?1:0;
var total=liq+arr+baseScore+volScore+leg+freshScore+bigBro+smallBro+flip;
var maxScore=15;
var pct=Math.round(total/maxScore*100);
var disp=document.getElementById('zoneScoreDisplay');
if(disp){disp.textContent=pct+'%';disp.style.color=pct>=70?'var(--green)':pct>=50?'var(--gold)':'var(--red)'}
return pct}

// ============================================
// IMAGE UPLOAD - Imgur (default) or Cloudinary
// ============================================
var imgurClientId='c4a4a563c6b9ac6';

var cloudinaryConfig=JSON.parse(localStorage.getItem('sdCloudinary'))||{
cloudName:'',
uploadPreset:'',
enabled:false,
imgurClientId:''
};

function saveCloudinaryConfig(){
localStorage.setItem('sdCloudinary',JSON.stringify(cloudinaryConfig));
}

function uploadImage(base64,callback){
if(cloudinaryConfig.cloudName&&cloudinaryConfig.uploadPreset){
uploadToCloudinary(base64,callback);
}else{
uploadToImgur(base64,callback);
}}

function uploadToImgur(base64,callback){
var clientId=cloudinaryConfig.imgurClientId||imgurClientId;
if(!clientId){
alert('âŒ No Imgur Client ID!\n\nGo to Settings and either:\n1. Set up Cloudinary (recommended)\n2. Or add your own Imgur Client ID');
callback('');
return}
var base64Data=base64.split(',')[1];
showToast('Uploading to Imgur...');
var formData=new FormData();
formData.append('image',base64Data);
formData.append('type','base64');
fetch('https://api.imgur.com/3/image',{
method:'POST',
headers:{
'Authorization':'Client-ID '+clientId
},
body:formData
})
.then(function(res){return res.json()})
.then(function(data){
if(data.success){
callback(data.data.link);
showToast('âœ… Image uploaded to Imgur!');
}else{
alert('âŒ Imgur Upload Failed!\n\nError: '+(data.data?data.data.error:'Unknown')+'\n\nThe default Imgur API key may be rate-limited. Try:\n1. Set up Cloudinary (free, recommended)\n2. Or get your own Imgur Client ID');
callback('');
}
})
.catch(function(err){
alert('âŒ Imgur Upload Failed!\n\nError: '+err.message+'\n\nCheck your internet connection.');
callback('');
})}

function uploadToCloudinary(base64,callback){
if(!cloudinaryConfig.cloudName || !cloudinaryConfig.uploadPreset){
alert('âŒ Cloudinary not configured!\n\nGo to Settings and enter:\n- Cloud Name\n- Upload Preset');
uploadToImgur(base64,callback);
return}

showToast('Uploading to Cloudinary...');

// Convert base64 to blob for better upload
var base64Data = base64.split(',')[1];
var byteChars = atob(base64Data);
var byteNumbers = new Array(byteChars.length);
for(var i = 0; i < byteChars.length; i++){
byteNumbers[i] = byteChars.charCodeAt(i)}
var byteArray = new Uint8Array(byteNumbers);
var blob = new Blob([byteArray], {type: 'image/jpeg'});

var formData = new FormData();
formData.append('file', blob, 'screenshot.jpg');
formData.append('upload_preset', cloudinaryConfig.uploadPreset);

var url = 'https://api.cloudinary.com/v1_1/' + cloudinaryConfig.cloudName + '/image/upload';

fetch(url, {
method: 'POST',
body: formData
})
.then(function(res){return res.json()})
.then(function(data){
if(data.secure_url){
callback(data.secure_url);
showToast('âœ… Image uploaded!');
}else{
var errMsg = data.error ? data.error.message : 'Unknown error';
alert('âŒ Cloudinary Failed: ' + errMsg + '\n\nTrying Imgur as backup...');
uploadToImgur(base64,callback);
}
})
.catch(function(err){
alert('âŒ Cloudinary Failed: ' + err.message + '\n\nTrying Imgur as backup...');
uploadToImgur(base64,callback);
})}

function saveTradeWithImage(trade,callback){
var preview=document.getElementById('imgPreview');
if(preview.style.display==='block'&&preview.src&&preview.dataset.local==='true'){
uploadToImgur(preview.src,function(url){
trade.screenshot=url;
callback(trade);
});
}else{
trade.screenshot=preview.src||'';
callback(trade);
}}

function saveCustomConfig(){localStorage.setItem('sdCustom',JSON.stringify(customConfig))}

function resetCustomConfig(){
if(!confirm('Reset all customizations to defaults?'))return;
customConfig=JSON.parse(JSON.stringify(defaultCustomConfig));
saveCustomConfig();
buildCustomLists();
rebuildFormSelects();
showToast('Reset to defaults!')}

function buildCustomLists(){
var keys=['sessions','timeframes','setups','mistakes','htfBias','htfTrend','execTrend','liquidity','arrival','legOut','zoneFresh','outcomes','ratings','emotions','pairs'];
keys.forEach(function(key){
var containerId='custom'+key.charAt(0).toUpperCase()+key.slice(1);
var container=document.getElementById(containerId);
if(!container)return;
var items=customConfig[key]||[];
container.innerHTML=items.map(function(item,i){
return '<div class="custom-item"><input type="text" value="'+item+'" onchange="updateCustomItem(\''+key+'\','+i+',this.value)"><button onclick="deleteCustomItem(\''+key+'\','+i+')">Ã—</button></div>';
}).join('');
})}

function getInputId(key){
var map={
sessions:'newSession',timeframes:'newTimeframe',setups:'newSetup',mistakes:'newMistake',
htfBias:'newHtfBias',htfTrend:'newHtfTrend',execTrend:'newExecTrend',
liquidity:'newLiquidity',arrival:'newArrival',legOut:'newLegOut',zoneFresh:'newZoneFresh',
outcomes:'newOutcome',ratings:'newRating',emotions:'newEmotion',pairs:'newPair'
};
return map[key]}

function addCustomItem(key){
var inputId=getInputId(key);
var input=document.getElementById(inputId);
var val=input.value.trim();
if(!val)return;
if(key==='pairs')val=val.toUpperCase();
if(!customConfig[key])customConfig[key]=[];
customConfig[key].push(val);
input.value='';
saveCustomConfig();
buildCustomLists();
rebuildFormSelects();
showToast('Added!')}

function updateCustomItem(key,index,value){
customConfig[key][index]=value;
saveCustomConfig();
rebuildFormSelects()}

function deleteCustomItem(key,index){
customConfig[key].splice(index,1);
saveCustomConfig();
buildCustomLists();
rebuildFormSelects();
showToast('Deleted')}

function rebuildFormSelects(){
rebuildSelect('tradeSession',customConfig.sessions);
rebuildSelect('tradeTimeframe',customConfig.timeframes);
rebuildSelect('tradeExecTF',customConfig.timeframes);
rebuildSelect('tradeSetup',customConfig.setups);
rebuildSelect('tradeHTFBias',customConfig.htfBias);
rebuildSelect('tradeHTFTrend',customConfig.htfTrend);
rebuildSelect('tradeExecTrend',customConfig.execTrend);
rebuildSelect('tradeLiquidity',customConfig.liquidity);
rebuildSelect('tradeArrival',customConfig.arrival);
rebuildSelect('tradeLegOut',customConfig.legOut);
rebuildSelect('tradeZoneFresh',customConfig.zoneFresh);
rebuildSelect('tradeOutcome',customConfig.outcomes,'â³ Open');
rebuildMistakeTags();
rebuildRatingButtons();
rebuildEmotionButtons();
rebuildCustomPairs()}

function rebuildSelect(id,options,defaultVal){
var sel=document.getElementById(id);
if(!sel)return;
var current=sel.value;
var html='<option value="">Select...</option>';
options.forEach(function(opt){
var val=opt.replace(/^[^\w\s]+\s*/,'');
html+='<option value="'+val+'">'+opt+'</option>';
});
sel.innerHTML=html;
sel.value=current||defaultVal||''}

function rebuildMistakeTags(){
var container=document.getElementById('mistakeTags');
if(!container)return;
var selected=(document.getElementById('tradeMistakes').value||'').split(',').filter(Boolean);
container.innerHTML=customConfig.mistakes.map(function(m){
var isSelected=selected.indexOf(m)!==-1;
return '<button type="button" class="mistake-tag'+(isSelected?' selected':'')+'" data-v="'+m+'" onclick="toggleMistakeTag(this)">'+m+'</button>';
}).join('')}

function rebuildRatingButtons(){
var container=document.querySelector('.form-group:has(#tradeRating) div');
if(!container)return;
var current=document.getElementById('tradeRating').value;
container.innerHTML=customConfig.ratings.map(function(r){
var cls=r.toLowerCase();
return '<button type="button" class="rating-btn '+cls+(current===r?' selected':'')+'" onclick="setRating(\''+r+'\')">'+r+'</button>';
}).join('')}

function rebuildEmotionButtons(){
var container=document.querySelector('.emotion-rating');
if(!container)return;
var current=parseInt(document.getElementById('tradeEmotion').value)||3;
container.innerHTML=customConfig.emotions.map(function(e,i){
var val=i+1;
return '<button type="button" class="emotion-btn'+(current===val?' selected':'')+'" onclick="setEmotion('+val+')" data-v="'+val+'">'+e+'</button>';
}).join('')}

function rebuildCustomPairs(){
var pairSel=document.getElementById('tradePair');
if(!pairSel||!customConfig.pairs.length)return;
var customGroup=pairSel.querySelector('optgroup[label="â˜… Custom"]');
if(!customGroup){
customGroup=document.createElement('optgroup');
customGroup.label='â˜… Custom';
pairSel.insertBefore(customGroup,pairSel.firstChild)}
customGroup.innerHTML=customConfig.pairs.map(function(p){return '<option>'+p+'</option>'}).join('')}

function toggleMistakeTag(btn){
btn.classList.toggle('selected');
var selected=Array.from(document.querySelectorAll('.mistake-tag.selected')).map(function(b){return b.dataset.v});
document.getElementById('tradeMistakes').value=selected.join(',')}

// ============================================
// PASSWORD PROTECTION
// ============================================
// CHANGE THIS PASSWORD TO YOUR OWN!
var APP_PASSWORD = 'Swingelite1313-';

function checkPassword(){
var input=document.getElementById('passwordInput').value;
if(input===APP_PASSWORD){
document.getElementById('loginScreen').classList.add('hidden');
document.getElementById('mainApp').classList.add('visible');
sessionStorage.setItem('journalAuth','true');
}else{
document.getElementById('loginError').style.display='block';
document.getElementById('passwordInput').value='';
setTimeout(function(){document.getElementById('loginError').style.display='none'},2000);
}}

// Check if already logged in this session
if(sessionStorage.getItem('journalAuth')==='true'){
document.getElementById('loginScreen').classList.add('hidden');
document.getElementById('mainApp').classList.add('visible');
}
</script>
</div><!-- close mainApp -->
</body>
</html>
