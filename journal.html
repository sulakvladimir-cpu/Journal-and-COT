<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>S&D Trading Journal Pro</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#000;--bg2:#0a0a0a;--bg3:#141414;--gold:#FFD700;--gold2:#FFA500;--green:#00C853;--red:#FF1744;--blue:#448AFF;--purple:#E040FB;--text:#fff;--text2:#888;--border:#2a2a2a}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}

/* Password Screen */
#loginScreen{position:fixed;top:0;left:0;width:100%;height:100%;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:9999}
#loginScreen.hidden{display:none}
.login-box{background:var(--bg3);padding:40px;border-radius:16px;border:1px solid var(--border);text-align:center;max-width:400px;width:90%}
.login-box .logo-icon{width:60px;height:60px;background:linear-gradient(135deg,var(--gold),var(--gold2));border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:2rem;margin:0 auto 20px}
.login-box h2{color:var(--gold);margin-bottom:10px}
.login-box p{color:var(--text2);margin-bottom:25px;font-size:.9rem}
.login-box input{width:100%;padding:15px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:1rem;margin-bottom:15px;text-align:center;letter-spacing:2px}
.login-box input:focus{outline:none;border-color:var(--gold)}
.login-box button{width:100%;padding:15px;background:linear-gradient(135deg,var(--gold),var(--gold2));border:none;border-radius:8px;color:#000;font-weight:600;font-size:1rem;cursor:pointer}
.login-box button:hover{transform:scale(1.02)}
.login-error{color:var(--red);font-size:.85rem;margin-top:10px;display:none}
#mainApp{display:none}
#mainApp.visible{display:block}

.container{max-width:1800px;margin:0 auto;padding:20px}
header{display:flex;justify-content:space-between;align-items:center;padding:20px 0;border-bottom:1px solid var(--border);margin-bottom:25px;flex-wrap:wrap;gap:15px}
.logo{display:flex;align-items:center;gap:12px}
.logo-icon{width:45px;height:45px;background:linear-gradient(135deg,var(--gold),var(--gold2));border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.5rem}
header h1{font-size:1.5rem;color:var(--gold)}
.header-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.daily-limit{padding:8px 15px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;font-size:.85rem}
.daily-limit.danger{border-color:var(--red);background:rgba(255,23,68,.1);animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
.btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:.9rem;transition:all .2s}
.btn-primary{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#000}
.btn-secondary{background:var(--bg3);color:var(--text);border:1px solid var(--border)}
.btn-icon{width:38px;height:38px;padding:0;display:flex;align-items:center;justify-content:center;border-radius:8px;background:var(--bg3);border:1px solid var(--border);color:var(--text2);cursor:pointer}
.tabs{display:flex;gap:5px;margin-bottom:25px;background:var(--bg2);padding:6px;border-radius:12px;border:1px solid var(--border);overflow-x:auto}
.tab{padding:12px 20px;background:transparent;border:none;color:var(--text2);cursor:pointer;border-radius:8px;font-weight:500;white-space:nowrap}
.tab.active{background:var(--gold);color:#000}
.tab:hover:not(.active){background:var(--bg3);color:var(--text)}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:25px}
.stat-card{background:var(--bg3);padding:18px;border-radius:12px;border:1px solid var(--border)}
.stat-card.highlight{border-color:var(--gold);background:linear-gradient(135deg,rgba(255,215,0,.05),rgba(255,165,0,.05))}
.stat-label{color:var(--text2);font-size:.8rem;margin-bottom:6px;text-transform:uppercase}
.stat-value{font-size:1.6rem;font-weight:700}
.stat-value.positive,.positive{color:var(--green)}
.stat-value.negative,.negative{color:var(--red)}
.stat-value.gold{color:var(--gold)}
.tab-content{display:none}.tab-content.active{display:block}
.card{background:var(--bg3);border-radius:16px;border:1px solid var(--border);overflow:hidden}
.card-header{padding:18px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}
.card-body{padding:20px}
.form-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:20px}
.form-group{display:flex;flex-direction:column;gap:8px}
.form-group.col-2{grid-column:span 2}.form-group.col-4{grid-column:span 4}
.form-group label{color:var(--text2);font-size:.85rem}
.form-group input,.form-group select,.form-group textarea{padding:12px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:.95rem}
.form-group input:focus,.form-group select:focus{outline:none;border-color:var(--gold)}
.form-group textarea{min-height:80px;resize:vertical}
.form-actions{display:flex;gap:15px;margin-top:25px;padding-top:25px;border-top:1px solid var(--border)}
.toggle-group{display:flex;gap:10px}
.toggle-btn{flex:1;padding:12px;border:2px solid var(--border);background:var(--bg2);color:var(--text2);border-radius:8px;cursor:pointer;font-weight:600;text-align:center}
.toggle-btn.long.selected{border-color:var(--green);background:rgba(0,200,83,.1);color:var(--green)}
.toggle-btn.short.selected{border-color:var(--red);background:rgba(255,23,68,.1);color:var(--red)}
.toggle-btn.demand.selected{border-color:var(--blue);background:rgba(68,138,255,.1);color:var(--blue)}
.toggle-btn.supply.selected{border-color:var(--gold2);background:rgba(255,165,0,.1);color:var(--gold2)}
table{width:100%;border-collapse:collapse}
th{padding:14px 12px;text-align:left;color:var(--text2);font-weight:600;font-size:.8rem;border-bottom:1px solid var(--border);background:var(--bg2)}
td{padding:14px 12px;border-bottom:1px solid var(--border)}
tr:hover{background:rgba(255,255,255,.02)}
.badge{padding:5px 10px;border-radius:6px;font-size:.8rem;font-weight:600}
.badge-long{background:rgba(0,200,83,.15);color:var(--green)}
.badge-short{background:rgba(255,23,68,.15);color:var(--red)}
.badge-win{background:rgba(0,200,83,.15);color:var(--green)}
.badge-loss{background:rgba(255,23,68,.15);color:var(--red)}
.badge-be,.badge-open{background:rgba(136,136,136,.15);color:var(--text2)}
.action-btns{display:flex;gap:6px}
.action-btn{padding:6px 10px;border:none;border-radius:6px;cursor:pointer;font-size:.85rem}
.action-btn.view{background:rgba(255,215,0,.1);color:var(--gold)}
.action-btn.edit{background:rgba(68,138,255,.1);color:var(--blue)}
.action-btn.delete{background:rgba(255,23,68,.1);color:var(--red)}
.filter-bar{display:flex;gap:10px;flex-wrap:wrap}
.filter-select{padding:8px 15px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;color:var(--text)}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);z-index:1000;align-items:center;justify-content:center;padding:20px}
.modal.active{display:flex}
.modal-content{background:var(--bg3);border-radius:16px;max-width:800px;width:100%;max-height:90vh;overflow-y:auto;border:1px solid var(--border)}
.modal-header{display:flex;justify-content:space-between;align-items:center;padding:20px;border-bottom:1px solid var(--border)}
.modal-close{background:none;border:none;color:var(--text2);font-size:1.8rem;cursor:pointer}
.modal-body{padding:20px}
.toast{position:fixed;bottom:30px;right:30px;padding:15px 25px;background:var(--green);color:#000;border-radius:8px;font-weight:600;transform:translateY(100px);opacity:0;transition:all .3s;z-index:1001}
.toast.show{transform:translateY(0);opacity:1}
.toast.error{background:var(--red);color:#fff}
@media(max-width:768px){.form-grid{grid-template-columns:1fr}.form-group.col-2,.form-group.col-4{grid-column:span 1}.stats-grid{grid-template-columns:repeat(2,1fr)}}
</style>
</head>
<body>

<div id="loginScreen">
<div class="login-box">
<div class="logo-icon">üîê</div>
<h2>S&D Trading Journal</h2>
<p>Enter password to access your journal</p>
<input type="password" id="passwordInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeypress="if(event.key==='Enter')checkPassword()">
<button onclick="checkPassword()">üîì Unlock</button>
<div class="login-error" id="loginError">Incorrect password</div>
</div>
</div>

<div id="mainApp">
<div class="container">
<header>
<div class="logo"><div class="logo-icon">üìä</div><h1>S&D Journal Pro</h1></div>
<div class="header-actions">
<div class="daily-limit" id="dailyLimitDisplay">Today: <span id="todayPnL">$0</span></div>
<button class="btn btn-secondary" onclick="exportData()">üì• Export</button>
<button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">üì§ Import</button>
<input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
<button class="btn btn-primary" onclick="showTab('entry')">+ New Trade</button>
</div>
</header>

<div class="tabs">
<button class="tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
<button class="tab" onclick="showTab('entry')">‚úèÔ∏è New Trade</button>
<button class="tab" onclick="showTab('history')">üìú History</button>
<button class="tab" onclick="showTab('strategies')">üìã Strategies</button>
</div>

<div id="dashboard" class="tab-content active">
<div class="stats-grid" id="statsGrid"></div>
</div>

<div id="entry" class="tab-content">
<div class="card">
<div class="card-header"><h3>‚úèÔ∏è Log Trade</h3></div>
<div class="card-body">
<form id="tradeForm">
<input type="hidden" id="editId">
<div class="form-grid">
<div class="form-group"><label>Date</label><input type="datetime-local" id="tradeDate" required></div>
<div class="form-group"><label>Pair</label><input type="text" id="tradePair" placeholder="EURUSD" required></div>
<div class="form-group"><label>Direction</label>
<div class="toggle-group">
<button type="button" class="toggle-btn long" onclick="setDirection('Long')">üü¢ LONG</button>
<button type="button" class="toggle-btn short" onclick="setDirection('Short')">üî¥ SHORT</button>
</div>
<input type="hidden" id="tradeDirection" required>
</div>
<div class="form-group"><label>Entry</label><input type="number" id="tradeEntry" step="any" required></div>
<div class="form-group"><label>Stop Loss</label><input type="number" id="tradeSL" step="any" required></div>
<div class="form-group"><label>Take Profit</label><input type="number" id="tradeTP" step="any" required></div>
<div class="form-group"><label>Risk ($)</label><input type="number" id="tradeRisk" step="0.01" required></div>
<div class="form-group"><label>Outcome</label>
<select id="tradeOutcome" required>
<option value="Open">‚è≥ Open</option>
<option value="Win">‚úÖ Win</option>
<option value="Loss">‚ùå Loss</option>
<option value="BE">‚ûñ BE</option>
</select>
</div>
<div class="form-group"><label>P&L ($)</label><input type="number" id="tradePnL" step="0.01"></div>
<div class="form-group col-2"><label>Notes</label><textarea id="tradeNotes" placeholder="Notes..."></textarea></div>
</div>
<div class="form-actions">
<button type="submit" class="btn btn-primary">üíæ Save Trade</button>
<button type="button" class="btn btn-secondary" onclick="resetForm()">üîÑ Reset</button>
</div>
</form>
</div>
</div>
</div>

<div id="history" class="tab-content">
<div class="card">
<div class="card-header"><h3>üìú Trade History</h3>
<div class="filter-bar">
<select class="filter-select" id="filterOutcome" onchange="filterTrades()">
<option value="">All</option>
<option value="Win">Wins</option>
<option value="Loss">Losses</option>
</select>
</div>
</div>
<div style="overflow-x:auto">
<table>
<thead><tr><th>#</th><th>Date</th><th>Pair</th><th>Dir</th><th>Result</th><th>P&L</th><th>Actions</th></tr></thead>
<tbody id="tradesTable"></tbody>
</table>
</div>
</div>
</div>

<div id="strategies" class="tab-content">
<div class="card" style="margin-bottom:20px">
<div class="card-header"><h3>üìã My Strategies</h3>
<button class="btn btn-primary" onclick="openStrategyModal()">+ New Strategy</button>
</div>
<div class="card-body"><div id="strategiesList"></div></div>
</div>

<div class="card">
<div class="card-header"><h3>üß™ Strategy Backtester</h3>
<button class="btn btn-primary" onclick="openBacktestModal()">+ Add Backtest</button>
</div>
<div class="card-body">
<p style="color:var(--text2);margin-bottom:15px">Log backtested trades to track strategy win rates. Import COT data here!</p>
<div id="backtestStats" class="stats-grid" style="margin-bottom:20px"></div>
<div style="overflow-x:auto">
<table>
<thead><tr><th>Strategy</th><th>Date</th><th>Pair</th><th>Direction</th><th>Result</th><th>R:R</th><th>Notes</th><th>Actions</th></tr></thead>
<tbody id="backtestTable"></tbody>
</table>
</div>
</div>
</div>
</div>

</div>
</div>

<!-- Strategy Modal -->
<div class="modal" id="strategyModal">
<div class="modal-content" style="max-width:500px">
<div class="modal-header"><h3>üìã Strategy</h3><button class="modal-close" onclick="closeModal('strategyModal')">√ó</button></div>
<div class="modal-body">
<input type="hidden" id="editStrategyId">
<div class="form-group" style="margin-bottom:15px">
<label>Name</label>
<input type="text" id="strategyName" placeholder="Strategy name..." style="width:100%;padding:12px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)">
</div>
<div class="form-group" style="margin-bottom:15px">
<label>Description</label>
<textarea id="strategyDesc" placeholder="Description..." style="width:100%;padding:12px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);min-height:80px"></textarea>
</div>
<div class="form-group" style="margin-bottom:15px">
<label>Color</label>
<input type="color" id="strategyColor" value="#FFD700" style="width:60px;height:40px">
</div>
<button class="btn btn-primary" onclick="saveStrategy()">üíæ Save</button>
</div>
</div>
</div>

<!-- Backtest Modal -->
<div class="modal" id="backtestModal">
<div class="modal-content" style="max-width:500px">
<div class="modal-header"><h3>üß™ Backtest</h3><button class="modal-close" onclick="closeModal('backtestModal')">√ó</button></div>
<div class="modal-body">
<input type="hidden" id="editBacktestId">
<div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
<div class="form-group"><label>Strategy</label><select id="backtestStrategy" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"></select></div>
<div class="form-group"><label>Date</label><input type="date" id="backtestDate" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"></div>
<div class="form-group"><label>Pair</label><input type="text" id="backtestPair" placeholder="EURUSD" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"></div>
<div class="form-group"><label>Direction</label><select id="backtestDirection" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"><option>Long</option><option>Short</option></select></div>
<div class="form-group"><label>Result</label><select id="backtestResult" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"><option>Win</option><option>Loss</option><option>BE</option></select></div>
<div class="form-group"><label>R:R</label><input type="number" id="backtestRR" step="0.1" placeholder="2.0" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text)"></div>
</div>
<div class="form-group" style="margin-top:15px"><label>Notes</label><textarea id="backtestNotes" placeholder="Notes..." style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);min-height:60px"></textarea></div>
<button class="btn btn-primary" style="margin-top:15px" onclick="saveBacktest()">üíæ Save</button>
</div>
</div>
</div>

<div class="toast" id="toast"></div>

<script>
let trades=JSON.parse(localStorage.getItem('sdPro'))||[];
let strategies=JSON.parse(localStorage.getItem('sdStrategies'))||[];
let backtests=JSON.parse(localStorage.getItem('sdBacktests'))||[];

document.addEventListener('DOMContentLoaded',function(){
setDefaultDate();
updateAll();
});

function setDefaultDate(){
var n=new Date();
n.setMinutes(n.getMinutes()-n.getTimezoneOffset());
document.getElementById('tradeDate').value=n.toISOString().slice(0,16);
}

function setDirection(d){
document.getElementById('tradeDirection').value=d;
document.querySelectorAll('.toggle-btn.long,.toggle-btn.short').forEach(function(b){b.classList.remove('selected')});
document.querySelector('.toggle-btn.'+d.toLowerCase()).classList.add('selected');
}

function showTab(id){
document.querySelectorAll('.tab-content').forEach(function(t){t.classList.remove('active')});
document.querySelectorAll('.tab').forEach(function(t){t.classList.remove('active')});
document.getElementById(id).classList.add('active');
var btn=document.querySelector('.tab[onclick="showTab(\''+id+'\')"]');
if(btn)btn.classList.add('active');
}

function saveTrades(){
localStorage.setItem('sdPro',JSON.stringify(trades));
}

document.getElementById('tradeForm').addEventListener('submit',function(e){
e.preventDefault();
var editId=document.getElementById('editId').value;
var trade={
id:editId||Date.now().toString(),
date:document.getElementById('tradeDate').value,
pair:document.getElementById('tradePair').value.toUpperCase(),
direction:document.getElementById('tradeDirection').value,
entry:parseFloat(document.getElementById('tradeEntry').value),
sl:parseFloat(document.getElementById('tradeSL').value),
tp:parseFloat(document.getElementById('tradeTP').value),
risk:parseFloat(document.getElementById('tradeRisk').value),
outcome:document.getElementById('tradeOutcome').value,
pnl:parseFloat(document.getElementById('tradePnL').value)||0,
notes:document.getElementById('tradeNotes').value
};
if(editId){
var i=trades.findIndex(function(t){return t.id===editId});
if(i!==-1)trades[i]=trade;
}else{
trades.unshift(trade);
}
saveTrades();
resetForm();
updateAll();
showTab('history');
showToast(editId?'Updated!':'Saved!');
});

function resetForm(){
document.getElementById('tradeForm').reset();
document.getElementById('editId').value='';
document.querySelectorAll('.toggle-btn').forEach(function(b){b.classList.remove('selected')});
setDefaultDate();
}

function updateAll(){
updateDashboard();
updateHistory();
updateStrategies();
updateBacktests();
}

function updateDashboard(){
var closed=trades.filter(function(t){return t.outcome!=='Open'});
var wins=closed.filter(function(t){return t.outcome==='Win'}).length;
var totalPnL=closed.reduce(function(s,t){return s+(t.pnl||0)},0);
var winRate=closed.length?(wins/closed.length*100):0;

document.getElementById('statsGrid').innerHTML=
'<div class="stat-card highlight"><div class="stat-label">Total P&L</div><div class="stat-value '+(totalPnL>=0?'positive':'negative')+'">$'+totalPnL.toFixed(2)+'</div></div>'+
'<div class="stat-card"><div class="stat-label">Win Rate</div><div class="stat-value '+(winRate>=50?'positive':'negative')+'">'+winRate.toFixed(1)+'%</div></div>'+
'<div class="stat-card"><div class="stat-label">Total Trades</div><div class="stat-value">'+closed.length+'</div></div>'+
'<div class="stat-card"><div class="stat-label">Wins</div><div class="stat-value positive">'+wins+'</div></div>';

var today=new Date().toISOString().split('T')[0];
var todayPnL=trades.filter(function(t){return t.date&&t.date.startsWith(today)&&t.outcome!=='Open'}).reduce(function(s,t){return s+(t.pnl||0)},0);
document.getElementById('todayPnL').textContent='$'+todayPnL.toFixed(0);
}

function updateHistory(){
filterTrades();
}

function filterTrades(){
var out=document.getElementById('filterOutcome').value;
var f=trades.slice();
if(out)f=f.filter(function(t){return t.outcome===out});

var tb=document.getElementById('tradesTable');
if(!f.length){
tb.innerHTML='<tr><td colspan="7" style="text-align:center;color:var(--text2);padding:30px">No trades yet</td></tr>';
return;
}
tb.innerHTML=f.map(function(t,i){
return '<tr><td>'+(f.length-i)+'</td><td>'+(t.date?new Date(t.date).toLocaleDateString():'-')+'</td><td><strong>'+t.pair+'</strong></td><td><span class="badge badge-'+(t.direction||'').toLowerCase()+'">'+t.direction+'</span></td><td><span class="badge badge-'+(t.outcome||'').toLowerCase()+'">'+t.outcome+'</span></td><td class="'+((t.pnl||0)>=0?'positive':'negative')+'">$'+(t.pnl||0).toFixed(2)+'</td><td><div class="action-btns"><button class="action-btn edit" onclick="editTrade(\''+t.id+'\')">‚úèÔ∏è</button><button class="action-btn delete" onclick="deleteTrade(\''+t.id+'\')">üóëÔ∏è</button></div></td></tr>';
}).join('');
}

function editTrade(id){
var t=trades.find(function(x){return x.id===id});
if(!t)return;
document.getElementById('editId').value=id;
document.getElementById('tradeDate').value=t.date||'';
document.getElementById('tradePair').value=t.pair||'';
if(t.direction)setDirection(t.direction);
document.getElementById('tradeEntry').value=t.entry;
document.getElementById('tradeSL').value=t.sl;
document.getElementById('tradeTP').value=t.tp;
document.getElementById('tradeRisk').value=t.risk;
document.getElementById('tradeOutcome').value=t.outcome;
document.getElementById('tradePnL').value=t.pnl;
document.getElementById('tradeNotes').value=t.notes||'';
showTab('entry');
}

function deleteTrade(id){
if(confirm('Delete this trade?')){
trades=trades.filter(function(t){return t.id!==id});
saveTrades();
updateAll();
showToast('Deleted','error');
}
}

// STRATEGIES
function updateStrategies(){
var list=document.getElementById('strategiesList');
if(!strategies.length){
list.innerHTML='<p style="color:var(--text2);text-align:center;padding:30px">No strategies yet</p>';
return;
}
list.innerHTML=strategies.map(function(s){
return '<div style="display:flex;justify-content:space-between;align-items:center;padding:15px;background:var(--bg2);border-radius:8px;margin-bottom:10px;border-left:4px solid '+s.color+'"><div><strong style="color:'+s.color+'">'+s.name+'</strong>'+(s.description?'<p style="color:var(--text2);font-size:.85rem;margin-top:5px">'+s.description+'</p>':'')+'</div><div class="action-btns"><button class="action-btn edit" onclick="editStrategy(\''+s.id+'\')">‚úèÔ∏è</button><button class="action-btn delete" onclick="deleteStrategy(\''+s.id+'\')">üóëÔ∏è</button></div></div>';
}).join('');
updateBacktestStrategySelect();
}

function openStrategyModal(id){
document.getElementById('editStrategyId').value='';
document.getElementById('strategyName').value='';
document.getElementById('strategyDesc').value='';
document.getElementById('strategyColor').value='#FFD700';
if(id){
var s=strategies.find(function(x){return x.id===id});
if(s){
document.getElementById('editStrategyId').value=id;
document.getElementById('strategyName').value=s.name;
document.getElementById('strategyDesc').value=s.description||'';
document.getElementById('strategyColor').value=s.color||'#FFD700';
}
}
openModal('strategyModal');
}

function editStrategy(id){openStrategyModal(id);}

function saveStrategy(){
var name=document.getElementById('strategyName').value.trim();
if(!name){showToast('Enter name','error');return;}
var id=document.getElementById('editStrategyId').value||'strat_'+Date.now();
var s={
id:id,
name:name,
description:document.getElementById('strategyDesc').value,
color:document.getElementById('strategyColor').value
};
var idx=strategies.findIndex(function(x){return x.id===id});
if(idx!==-1)strategies[idx]=s;
else strategies.push(s);
localStorage.setItem('sdStrategies',JSON.stringify(strategies));
updateStrategies();
closeModal('strategyModal');
showToast('Saved!');
}

function deleteStrategy(id){
if(!confirm('Delete?'))return;
strategies=strategies.filter(function(s){return s.id!==id});
localStorage.setItem('sdStrategies',JSON.stringify(strategies));
updateStrategies();
showToast('Deleted','error');
}

// BACKTESTS
function updateBacktestStrategySelect(){
var sel=document.getElementById('backtestStrategy');
sel.innerHTML='<option value="">Select...</option>'+strategies.map(function(s){
return '<option value="'+s.id+'">'+s.name+'</option>';
}).join('');
}

function openBacktestModal(id){
document.getElementById('editBacktestId').value='';
document.getElementById('backtestDate').value=new Date().toISOString().split('T')[0];
document.getElementById('backtestPair').value='';
document.getElementById('backtestDirection').value='Long';
document.getElementById('backtestResult').value='Win';
document.getElementById('backtestRR').value='';
document.getElementById('backtestNotes').value='';
updateBacktestStrategySelect();
if(id){
var b=backtests.find(function(x){return x.id===id});
if(b){
document.getElementById('editBacktestId').value=id;
document.getElementById('backtestStrategy').value=b.strategy||'';
document.getElementById('backtestDate').value=b.date||'';
document.getElementById('backtestPair').value=b.pair||'';
document.getElementById('backtestDirection').value=b.direction||'Long';
document.getElementById('backtestResult').value=b.result||'Win';
document.getElementById('backtestRR').value=b.rr||'';
document.getElementById('backtestNotes').value=b.notes||'';
}
}
openModal('backtestModal');
}

function saveBacktest(){
var pair=document.getElementById('backtestPair').value.trim().toUpperCase();
if(!pair){showToast('Enter pair','error');return;}
var id=document.getElementById('editBacktestId').value||'bt_'+Date.now();
var b={
id:id,
strategy:document.getElementById('backtestStrategy').value,
date:document.getElementById('backtestDate').value,
pair:pair,
direction:document.getElementById('backtestDirection').value,
result:document.getElementById('backtestResult').value,
rr:parseFloat(document.getElementById('backtestRR').value)||0,
notes:document.getElementById('backtestNotes').value
};
var idx=backtests.findIndex(function(x){return x.id===id});
if(idx!==-1)backtests[idx]=b;
else backtests.unshift(b);
localStorage.setItem('sdBacktests',JSON.stringify(backtests));
updateBacktests();
closeModal('backtestModal');
showToast('Saved!');
}

function deleteBacktest(id){
if(!confirm('Delete?'))return;
backtests=backtests.filter(function(b){return b.id!==id});
localStorage.setItem('sdBacktests',JSON.stringify(backtests));
updateBacktests();
showToast('Deleted','error');
}

function updateBacktests(){
var table=document.getElementById('backtestTable');
var stats=document.getElementById('backtestStats');

if(!backtests.length){
table.innerHTML='<tr><td colspan="8" style="text-align:center;color:var(--text2);padding:30px">No backtests yet. Import COT data or add manually!</td></tr>';
stats.innerHTML='';
return;
}

var wins=backtests.filter(function(b){return b.result==='Win'}).length;
var winRate=backtests.length?(wins/backtests.length*100):0;

stats.innerHTML=
'<div class="stat-card"><div class="stat-label">Total Backtests</div><div class="stat-value gold">'+backtests.length+'</div></div>'+
'<div class="stat-card"><div class="stat-label">Win Rate</div><div class="stat-value '+(winRate>=50?'positive':'negative')+'">'+winRate.toFixed(1)+'%</div></div>';

table.innerHTML=backtests.map(function(b){
var strat=strategies.find(function(s){return s.id===b.strategy});
return '<tr><td>'+(strat?'<span style="color:'+strat.color+'">'+strat.name+'</span>':'<span style="color:var(--text2)">-</span>')+'</td><td>'+b.date+'</td><td><strong>'+b.pair+'</strong></td><td><span class="badge badge-'+b.direction.toLowerCase()+'">'+b.direction+'</span></td><td><span class="badge badge-'+b.result.toLowerCase()+'">'+b.result+'</span></td><td>'+(b.rr?'1:'+b.rr.toFixed(1):'-')+'</td><td style="max-width:150px;overflow:hidden;text-overflow:ellipsis">'+(b.notes||'-')+'</td><td><div class="action-btns"><button class="action-btn edit" onclick="openBacktestModal(\''+b.id+'\')">‚úèÔ∏è</button><button class="action-btn delete" onclick="deleteBacktest(\''+b.id+'\')">üóëÔ∏è</button></div></td></tr>';
}).join('');
}

// IMPORT/EXPORT - UPDATED TO SUPPORT COT DATA!
function exportData(){
var data={
trades:trades,
strategies:strategies,
backtests:backtests,
exportDate:new Date().toISOString()
};
var blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
var a=document.createElement('a');
a.href=URL.createObjectURL(blob);
a.download='journal_backup_'+new Date().toISOString().split('T')[0]+'.json';
a.click();
showToast('Exported!');
}

function importData(event){
var file=event.target.files[0];
if(!file)return;
var reader=new FileReader();
reader.onload=function(e){
try{
var data=JSON.parse(e.target.result);

// Check if valid
if(!data.trades && !data.backtests){
showToast('Invalid file','error');
return;
}

var newTradesCount=0;
var newBacktestsCount=0;
var newStrategiesCount=0;

// Import strategies first
if(data.strategies && data.strategies.length){
var existingIds=strategies.map(function(s){return s.id});
data.strategies.forEach(function(s){
if(existingIds.indexOf(s.id)===-1){
strategies.push(s);
newStrategiesCount++;
}
});
localStorage.setItem('sdStrategies',JSON.stringify(strategies));
}

// Import trades
if(data.trades && data.trades.length){
var existingIds=trades.map(function(t){return t.id});
var newTrades=data.trades.filter(function(t){return existingIds.indexOf(t.id)===-1});
trades=trades.concat(newTrades);
newTradesCount=newTrades.length;
saveTrades();
}

// Import backtests (NEW - supports COT exports!)
if(data.backtests && data.backtests.length){
var existingIds=backtests.map(function(b){return b.id});
var newBacktests=data.backtests.filter(function(b){return existingIds.indexOf(b.id)===-1});
backtests=backtests.concat(newBacktests);
newBacktestsCount=newBacktests.length;
localStorage.setItem('sdBacktests',JSON.stringify(backtests));
}

updateAll();

var msg='Imported: ';
if(newTradesCount)msg+=newTradesCount+' trades, ';
if(newBacktestsCount)msg+=newBacktestsCount+' backtests, ';
if(newStrategiesCount)msg+=newStrategiesCount+' strategies';
msg=msg.replace(/, $/,'');
if(msg==='Imported: ')msg='No new data to import';

showToast(msg);

}catch(err){
console.error(err);
showToast('Error reading file','error');
}
};
reader.readAsText(file);
event.target.value='';
}

// MODALS
function openModal(id){document.getElementById(id).classList.add('active');}
function closeModal(id){document.getElementById(id).classList.remove('active');}
document.querySelectorAll('.modal').forEach(function(m){
m.addEventListener('click',function(e){if(e.target===m)m.classList.remove('active');});
});

function showToast(msg,type){
var t=document.getElementById('toast');
t.textContent=msg;
t.className='toast show '+(type||'');
setTimeout(function(){t.classList.remove('show')},3000);
}

// PASSWORD
var APP_PASSWORD='Swingelite1313-';
function checkPassword(){
var input=document.getElementById('passwordInput').value;
if(input===APP_PASSWORD){
document.getElementById('loginScreen').classList.add('hidden');
document.getElementById('mainApp').classList.add('visible');
sessionStorage.setItem('journalAuth','true');
}else{
document.getElementById('loginError').style.display='block';
document.getElementById('passwordInput').value='';
setTimeout(function(){document.getElementById('loginError').style.display='none'},2000);
}
}
if(sessionStorage.getItem('journalAuth')==='true'){
document.getElementById('loginScreen').classList.add('hidden');
document.getElementById('mainApp').classList.add('visible');
}
</script>
</div>
</body>
</html>
